<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="keywords" content="Gridea静态个人博客">
<meta name="description" content="&lt;font color=green&gt;温故而知新&lt;/font&gt;">
<meta name="theme-color" content="#fff0f6">
<title>「TBtools-Plugin」Bubble Plot升级版-TBtools插件 | Shawn の Blog</title>
<link rel="shortcut icon" href="/favicon.ico?v=1722222579663">
<link rel="stylesheet" href="/styles/main.css">
<link rel="stylesheet" href="/media/css/mist.css">

<link rel="stylesheet" href="/media/fonts/font-awesome.css">
<link
  href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Rosario:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"
  rel="stylesheet" type="text/css">

<link href="/media/hljs/styles/base16/dracula.css"
  rel="stylesheet">

<script src="/media/hljs/highlight.js"></script>
<script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.0/velocity.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.0/velocity.ui.min.js"></script>

<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>



  <meta name="description" content="「TBtools-Plugin」Bubble Plot升级版-TBtools插件" />
  <meta name="keywords" content="TBtools,插件,富集分析" />
  <link rel="stylesheet" type="text/css" href="https://shawnwx2019.github.io/highlight/styles/atom-one-dark-reasonable.min.css">
  <script src="https://shawnwx2019.github.io/highlight/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
  <div class="head-top-line"></div>
  <div class="header-box">
    
<div class="mist">
  <header class="header bg-color ">
    <div class="blog-header box-shadow-wrapper  " id="header">
      <div class="nav-toggle" id="nav_toggle">
        <div class="toggle-box">
          <div class="line line-top"></div>
          <div class="line line-center"></div>
          <div class="line line-bottom"></div>
        </div>
      </div>
      <div class="site-meta">       
        <div class="site-title">
          
            <a href="/" class="">
              <span class="logo-line-before">
                <i class=""></i>
              </span>
              <span class="main-title">Shawn の Blog</span>
              <span class="logo-line-after">
                <i class=""></i>
              </span>
            </a>  
          
        </div>
        
      </div>
      <nav class="site-nav" id="site_nav">
        <ul id="nav_ul">
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/" target="_self">
                  <i class="fa fa-home"></i> 首页
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/archives/" target="_self">
                  <i class="fa fa-archive"></i> 归档
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/tags/" target="_self">
                  <i class="fa fa-tags"></i> 标签
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/post/about/" target="_self">
                  <i class="fa fa-user"></i> 关于
                </a>
              
            </li>
          
          
            
              <li class="nav-item ">
                <a href="/friends/" target="_self">
                  
                    <i class="fa fa-address-book"></i> 友情链接
                  
                </a>
              </li>
            
          
        </ul>
      </nav>
    </div>
  </header>
</div>

<script type="text/javascript"> 
 
  let showNav = true;

  let navToggle = document.querySelector('#nav_toggle'),
  siteNav = document.querySelector('#site_nav');
  
  function navClick() {
    let sideBar = document.querySelector('.sidebar');
    let navUl = document.querySelector('#nav_ul');
    navToggle.classList.toggle('nav-toggle-active');
    siteNav.classList.toggle('nav-menu-active');
    if (siteNav.classList.contains('nav-menu-active')) {
      siteNav.style = "height: " + (navUl.children.length * 42) +"px !important";
    } else {
      siteNav.style = "";
    }
  }

  navToggle.addEventListener('click',navClick);  
</script>
  </div>
  <div class="main-continer">
    
    <div
      class="section-layout mist bg-color">
      <div class="section-layout-wrapper">
        

<div class="sidebar">
  
    <div class="sidebar-box box-shadow-wrapper  right-motion" id="sidebar">
      
        <div class="post-list-sidebar">
          <div class="sidebar-title">
            <span id="tocSideBar" class="sidebar-title-item sidebar-title-active">文章目录</span>
            <span id="metaSideBar" class="sidebar-title-item">站点概览</span>
          </div>
        </div>
      
      <div class="sidebar-body mist" id="sidebar_body">
        
          
            <div class="post-side-meta" id="post_side_meta">
              
<div class="sidebar-wrapper box-shadow-wrapper ">
  <div class="sidebar-item">
    <img class="site-author-image right-motion" src="/images/avatar.png"/>
    <p class="site-author-name">Shawn Wang</p>
    
    <div class="site-description right-motion">
      
      
      
        <p>Post-Doc Researcher </p>
      
        <p> Bioinformatics </p>
      
        <p> HENU</p>
      
      
    </div>
    
  </div>
  <div class="sidebar-item side-item-stat right-motion">
    <div class="sidebar-item-box">
      <a href="/archives/">
        
        <span class="site-item-stat-count">20</span>
        <span class="site-item-stat-name">文章</span>
      </a>
    </div>
    <div class="sidebar-item-box">
      <a href="">
        <span class="site-item-stat-count">17</span>
        <span class="site-item-stat-name">分类</span>
      </a>
    </div>
    <div class="sidebar-item-box">
      <a href="/tags/">
        <span class="site-item-stat-count">17</span>
        <span class="site-item-stat-name">标签</span>
      </a>
    </div>
  </div>
  
  
    <div class="sidebar-item sidebar-item-social">
      <div class="social-item">
        
          
            <a href="https://github.com/ShawnWx2019">
              <i class="fa fa-github-alt" title="Github"></i>
            </a>
          
        
        
      </div>
    </div>
  


</div>
            </div>
            <div class="post-toc sidebar-body-active" id="post_toc" style="opacity: 1;">
              <div class="toc-box right-motion">
  <div class="toc-wrapper auto-number auto"
    id="toc_wrapper">
    <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2%E7%9A%84%E5%BA%9F%E8%AF%9D">写在前面的废话</a></li>
<li><a href="#%E5%8F%82%E6%95%B0">参数</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">使用方法</a></li>
<li><a href="#%E5%A4%9A%E5%9B%BE%E9%A2%84%E8%AD%A6">多图预警</a></li>
<li><a href="#%E4%B8%8B%E6%9C%9F%E9%A2%84%E5%91%8A">下期预告</a></li>
</ul>
</li>
</ul>

  </div>
</div>

<script>

  let lastTop = 0, lList = [], hList = [], postBody, lastIndex = -1;
  let active = 'active-show', activeClass = 'active-current';
  let tocWrapper = document.querySelector('#toc_wrapper');
  let tocContent = tocWrapper.children[0];
  let autoNumber = tocWrapper && tocWrapper.classList.contains('auto-number');

  function addTocNumber(elem, deep) {
    if (!elem) {
      return;
    }
    let prop = elem.__proto__;

    if (prop === HTMLUListElement.prototype) {
      for (let i = 0; i < elem.children.length; i++) {
        addTocNumber(elem.children[i], deep + (i + 1) + '.');
      }
    } else if (prop === HTMLLIElement.prototype) {
      // 保存li元素
      if (elem.children[0].__proto__ === HTMLAnchorElement.prototype) {
        lList.push(elem);
      }
      for (let i = 0; i < elem.children.length; i++) {
        let cur = elem.children[i];
        if (cur.__proto__ === HTMLAnchorElement.prototype) {
          if (autoNumber) {
            cur.text = deep + ' ' + cur.text;
          }
        } else if (cur.__proto__ === HTMLUListElement.prototype) {
          addTocNumber(cur, deep);
        }
      }
    }
  }

  function removeParentActiveClass() {
    let parents = tocContent.querySelectorAll('.' + active)
    parents.forEach(function (elem) {
      elem.classList.remove(active);
    });
  }

  function addActiveClass(index) {
    if (index >= 0 && index < hList.length) {
      lList[index].classList.add(activeClass);
    }
  }

  function removeActiveClass(index) {
    if (index >= 0 && index < hList.length) {
      lList[index].classList.remove(activeClass);
    }
  }

  function addActiveLiElemment(elem, parent) {
    if (!elem || elem === parent) {
      return;
    } else {
      if (elem.__proto__ === HTMLLIElement.prototype) {
        elem.classList.add(active);
      }
      addActiveLiElemment(elem.parentElement, parent);
    }
  }

  function showToc() {
    if (tocWrapper) {
      postBody = document.querySelector('#post_body');
      for (let i = 0; i < postBody.children.length; i++) {
        if (postBody.children[i].__proto__ === HTMLHeadingElement.prototype) {
          hList.push(postBody.children[i]);
        }
      }
      if (tocWrapper.classList.contains('compress')) {
        tocContent.classList.add('closed');
      } else if (tocWrapper.classList.contains('no_compress')) {
        tocContent.classList.add('expanded');
      } else {
        if (hList.length > 10) {
          active = 'active-hidden'
          tocContent.classList.add('closed');
        } else {
          tocContent.classList.add('expanded');
        }
      }
    }
  }

  (function () {
    // 处理不是从#一级标题开始目录
    if (tocContent.children.length === 1 && tocContent.children[0].__proto__ === HTMLLIElement.prototype) {
      let con = tocContent.children[0].children[0];
      tocContent.innerHTML = con.innerHTML;
    }
    let markdownItTOC = document.querySelector('.markdownIt-TOC');
    let innerHeight = window.innerHeight;
    markdownItTOC.style = `max-height: ${innerHeight - 80 > 0 ? innerHeight - 80 : innerHeight}px`
    addTocNumber(tocContent, '');
  })();

  document.addEventListener('scroll', function (e) {
    if (lList.length <= 0) {
      return;
    }
    let scrollTop = document.scrollingElement.scrollTop + 10;
    let dir;

    if (lastTop - scrollTop > 0) {
      dir = 'up';
    } else {
      dir = 'down';
    }

    lastTop = scrollTop;
    if (scrollTop <= 0) {
      if (lastIndex >= 0 && lastIndex < hList.length) {
        lList[lastIndex].classList.remove(activeClass);
      }
      return;
    }

    let current = 0, hasFind = false;
    for (let i = 0; i < hList.length; i++) {
      if (hList[i].offsetTop > scrollTop) {
        current = i;
        hasFind = true;
        break;
      }
    }
    if (!hasFind && scrollTop > lList[lList.length - 1].offsetTop) {
      current = hList.length - 1;
    } else {
      current--;
    }
    if (dir === 'down') {
      if (current > lastIndex) {
        addActiveClass(current);
        removeActiveClass(lastIndex)
        lastIndex = current;
        removeParentActiveClass();
        lList[current] && addActiveLiElemment(lList[current].parentElement, tocContent);
      }
    } else {
      if (current < lastIndex) {
        addActiveClass(current);
        removeActiveClass(lastIndex);
        lastIndex = current;
        removeParentActiveClass();
        lList[current] && addActiveLiElemment(lList[current].parentElement, tocContent);
      }
    }
  });


  window.addEventListener('load', function () {
    showToc();
    document.querySelector('#sidebar').style = 'display: block;';
    tocWrapper.classList.add('toc-active');
    setTimeout(function () {
      if ("createEvent" in document) {
        let evt = document.createEvent("HTMLEvents");
        evt.initEvent("scroll", false, true);
        document.dispatchEvent(evt);
      }
      else {
        document.fireEvent("scroll");
      }
    }, 500)
  })

</script>
            </div>
          
        
      </div>
    </div>
  
</div>
<script>
  const SIDEBAR_TITLE_ACTIVE = 'sidebar-title-active';
  const SIDEBAR_BODY_ACTIVE = 'sidebar-body-active';
  const SLIDE_UP_IN = 'slide-up-in';

  let sidebar = document.querySelector('#sidebar'),
  tocSideBar = document.querySelector('#tocSideBar'),
  metaSideBar = document.querySelector('#metaSideBar'),
  postToc = document.querySelector('#post_toc'),
  postSiteMeta = document.querySelector('#post_side_meta'),
  sidebarTitle = document.querySelector('.sidebar-title'),
  sidebarBody = document.querySelector('#sidebar_body');

  tocSideBar && tocSideBar.addEventListener('click', (e) => {
    toggleSidebar(e);
  });

  metaSideBar && metaSideBar.addEventListener('click', (e) => {
    toggleSidebar(e);
  });

  function toggleSidebar(e) {
    let currentTitle = document.querySelector("."+SIDEBAR_TITLE_ACTIVE);
    if (currentTitle == e.srcElement) {
      return ;
    }
    let current, showElement, hideElement;
    if (e.srcElement == metaSideBar) {
      showElement = postSiteMeta;
      hideElement = postToc;
    } else if (e.srcElement == tocSideBar){
      showElement = postToc;
      hideElement = postSiteMeta;
    }
    currentTitle.classList.remove(SIDEBAR_TITLE_ACTIVE);
    e.srcElement.classList.add(SIDEBAR_TITLE_ACTIVE);

    window.Velocity(hideElement, 'stop');
    window.Velocity(hideElement, 'transition.slideUpOut', {
      display: 'none',
      duration: 200,
      complete: function () {
        window.Velocity(showElement, 'transition.slideDownIn', {
          duration: 200
        });
      }
    })
    hideElement.classList.remove(SIDEBAR_BODY_ACTIVE);
    showElement.classList.add(SIDEBAR_BODY_ACTIVE);
  }

  postToc && postToc.addEventListener('transitionend', function() {
    this.classList.remove(SLIDE_UP_IN);
  });

  if (sidebarBody) {
    if (sidebarBody.classList.contains('pisces') || sidebarBody.classList.contains('gemini')) {
      let hasFix = false;
      let scrollEl = document.querySelector('.main-continer');
      let limitTop = document.querySelector('#nav_ul').children.length * 42 + 162;
      window.addEventListener('scroll', function(e) {
        if (document.scrollingElement.scrollTop >= limitTop) {
          if (!hasFix) {
            sidebar.classList.add('sidebar-fixed');
            hasFix = true;
          }
        } else {
          if (hasFix) {
            sidebar.classList.remove('sidebar-fixed');
            hasFix = false;
          }
        }
      });
    }
  }
  
</script>
        <div class="section-box box-shadow-wrapper">
          <div class="section bg-color post post-page">
            <header class="post-header">
  <h1 class="post-title">
    <a class="post-title-link" href="https://shawnwx2019.github.io/「TBtools-Plugin」Bubble-Plot升级版-TBtools插件/">
      「TBtools-Plugin」Bubble Plot升级版-TBtools插件
    </a>
  </h1>
  <div class="post-meta">
    
    <span class="meta-item pc-show">
      <i class="fa fa-calendar-o"></i>
      <span>发布于</span>
      <span>2021-01-26</span>
      <span class="post-meta-divider pc-show">|</span>
    </span>
    
    <span class="meta-item">
      <i class="fa fa-folder-o"></i>
      <span class="pc-show">分类于</span>
      
      
      <a href="https://shawnwx2019.github.io/7IQ4dQhrNC/">
        <span>TBtools</span>
      </a>、
      
      
      
      <a href="https://shawnwx2019.github.io/fdXt7u8Hl5/">
        <span>插件</span>
      </a>、
      
      
      
      <a href="https://shawnwx2019.github.io/juU6QRjoHA/">
        <span>富集分析</span>
      </a>
      
      
    </span>
    <span class="post-meta-divider">|</span>
    
    <span class="meta-item">
      <i class="fa fa-clock-o"></i>
      <span>3分钟</span>
    </span>
    <span class="meta-item">
      <span class="post-meta-divider">|</span>
      <i class="fa fa-file-word-o"></i>
      <span>753<span class="pc-show">字数</span></span>
    </span>
    
    
    
    <span id="/「TBtools-Plugin」Bubble-Plot升级版-TBtools插件/" data-flag-title="「TBtools-Plugin」Bubble Plot升级版-TBtools插件" class="meta-item pc-show leancloud_visitors">
      <span class="post-meta-divider">|</span>
      <i class="fa fa-eye"></i>
      <span>浏览量：<span class="leancloud-visitors-count"></span></span>
    </span>
    
  </div>
</header>
            <div class="post-body next-md-body" id="post_body">
              <h2 id="写在前面的废话">写在前面的废话</h2>
<p>之前有老铁在群里问kegg的气泡图能不能整，其实基于TBtools-kegg富集结果的气泡图代码很早就撸好了，无非就是GO气泡图代码中数据清洗的时候改改df索引位置。后面一毛一样。</p>
<p>大家好像还是比较喜欢这种视觉冲击力强的图，确实在投文章的时候也能会加分。所以后来慢慢从搬运代码到<a href="https://www.jianshu.com/p/59428e69da05">自己用ggplot2实现</a>，最终是山寨了一下...</p>
<p>当然，如果要原汁原味的bubble plot还是推荐用Y叔的<a href="http://bioconductor.org/packages/release/bioc/html/clusterProfiler.html">clusterProfiler</a>包。这里放一个我之前基于所里测<a href="https://gitee.com/shawnmagic/TM1_CRIv2_OrgDb">陆地棉TM-1v2的OrgDB</a>,喜欢折腾的小伙伴可以玩一下，不过kegg目前无解，kegg数据库里收录的陆地棉的注释实在是太老了。</p>
<!--more-->
<h2 id="参数">参数</h2>
<figure data-type="image" tabindex="1"><img src="https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/Bubble%20plot.png" alt="参数" loading="lazy"></figure>
<p>这次干脆一勺烩了，柱状图，气泡图，基于GOplot那几个弦图，热图数据清洗起来有点麻烦，应该近期不会整....<br>
<img src="https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210126073636.jpg" alt="界面" loading="lazy"></p>
<ul>
<li>
<p>input file 输入文件：</p>
<ul>
<li>如果是TBtools 生成的GO和KEGG结果，直接把输出的文件拖进来就好。注意如果GO富集分析想分别按照GOterm类别可视化，需要输入padj校正过的那个文件。</li>
<li>如果自己定制的（customized）需要按照下表整理：<strong>表头写啥无所谓，顺序一定要正确！</strong></li>
</ul>
<p>| GO_Name                                                                                      | Gene_ratio  | HitsGenesCountsInSelectedSet | corrected p-value(BH method) |<br>
|----------------------------------------------------------------------------------------------|-------------|------------------------------|------------------------------|<br>
| steroid dehydrogenase activity, acting on the CH-OH group of donors, NAD or NADP as acceptor | 0.004023409 | 11                           | 0.496511055                  |<br>
| quinone binding                                                                              | 0.004754938 | 13                           | 0.281163809                  |<br>
| indole-3-acetic acid amido synthetase activity                                               | 0.002560351 | 7                            | 0.394598487                  |<br>
| peptide receptor activity                                                                    | 0.001828822 | 5                            | 0.441252581                  |</p>
</li>
<li>
<p>Term Number: 你想展示的GO term 或者KEGG Pathway数量，有时候富集分析结果会非常多，几百个结果全画出来不可能，这里筛选的条件就是Qvalue排名前<code>Term number</code>的数量。</p>
</li>
<li>
<p>Input Data Form： 输入数据的格式，有三个选项</p>
<ul>
<li>TBtools_GO</li>
<li>TBtools_KEGG</li>
<li>customized</li>
</ul>
</li>
<li>
<p>Graph type: 你想画什么图</p>
<ul>
<li>Bubble， 气泡图</li>
<li>bar， 柱状图</li>
</ul>
</li>
<li>
<p>min/max： 颜色是由Qvalue的大小定义的，越小越显著，这里是颜色变化范围的定义，从min到max渐变。</p>
</li>
<li>
<p>output file label： 输出文件标签，为了区分你做的不同结果。</p>
</li>
</ul>
<h2 id="使用方法">使用方法</h2>
<p>这个.... 拖进去，选好参数，点点点，然后看结果...</p>
<p>颜色方面...推荐下TBtools的colorPicker在</p>
<pre><code>Graphics -&gt; color palette -&gt;colorpicker
</code></pre>
<p><img src="https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210126090047.jpg" alt="color picker" loading="lazy"><br>
选中一个颜色后复制类似<code>#fb8072</code>这种颜色代码，关闭<code>colorpicker</code>，粘贴到<code>min</code>或者<code>max</code>中。</p>
<h2 id="多图预警">多图预警</h2>
<p><img src="https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBkeggbubble.jpg" alt="kegg bubble" loading="lazy"><br>
<img src="https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBkeggBar.jpg" alt="kegg bar" loading="lazy"><br>
<img src="https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBGObubble.jpg" alt="GO bubble" loading="lazy"><br>
<img src="https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBGObar.jpg" alt="GO bar" loading="lazy"><br>
<img src="https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/csbar.jpg" alt="cs bubble" loading="lazy"><br>
<img src="https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/cbub.jpg" alt="cs bar" loading="lazy"></p>
<h2 id="下期预告">下期预告</h2>
<p>下期会增加一个OneStepWGCNA的伴侣插件，有朋友反映如果取不到合适的<code>power</code>官网提供的那个经验<code>power</code>过于智障，想自己选择<code>power</code>构建...那么初步想法是把第一步跑完的结果写一个Rdata出来，然后扔到伴侣插件调参，包括<code>power</code>,<code>最小module size</code>，用新的<code>traitdata</code>和<code>datExpr</code>关联，还有后续关注的模块的<code>GS MM，hub</code>基因等...</p>
<p>毕竟不能辱没了我调包狗，调参侠的名头...</p>

            </div>
            <div class="post-footer">
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      Shawn Wang
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://shawnwx2019.github.io/「TBtools-Plugin」Bubble-Plot升级版-TBtools插件/" title="「TBtools-Plugin」Bubble Plot升级版-TBtools插件">https://shawnwx2019.github.io/「TBtools-Plugin」Bubble-Plot升级版-TBtools插件/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！
    </li>
  </ul>
  <div class="tags">
    
      <a href="https://shawnwx2019.github.io/7IQ4dQhrNC/"># TBtools</a>
    
      <a href="https://shawnwx2019.github.io/fdXt7u8Hl5/"># 插件</a>
    
      <a href="https://shawnwx2019.github.io/juU6QRjoHA/"># 富集分析</a>
    
  </div>
  <div class="nav">
    <div class="nav-prev">
      
        <i class="fa fa-chevron-left"></i>
        <a class="nav-pc-next" title="「TBtools Plugin」批量生成气泡图" href="https://shawnwx2019.github.io/「TBtools-Plugin」批量生成气泡图/">「TBtools Plugin」批量生成气泡图</a class="nav-pc-next">
        <a class="nav-mobile-prev" title="「TBtools Plugin」批量生成气泡图" href="https://shawnwx2019.github.io/「TBtools-Plugin」批量生成气泡图/">上一篇</a>
      
    </div>
    <div class="nav-next">
      
        <a class="nav-pc-next" title="「Comparative-Genomics」官方文档解读" href="https://shawnwx2019.github.io/「Comparative-Genomics」Orthofinder官方文件解读/">「Comparative-Genomics」官方文档解读</a>
        <a class="nav-mobile-next" title="「Comparative-Genomics」官方文档解读" href="https://shawnwx2019.github.io/「Comparative-Genomics」Orthofinder官方文件解读/">下一篇</a>
        <i class="fa fa-chevron-right"></i>
      
    </div>
  </div>
</div>
            
  <script src="https://cdn.jsdelivr.net/npm/valine@1.4.4/dist/Valine.min.js"></script>
<div id="vcomments" style="padding: 10px 0px 0px 0px"></div>

<style>
  .v .veditor {
    min-height: 10rem;
    background-image: url('https://upimage.alexhchu.com/2020/04/21/47eda59424daa.gif');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: right;
    background-color: rgba(255, 255, 255, 0);
    resize: none;
  }

  .v .vwrap {
    border: 1px solid #000 !important;
  }

  .v .vbtn {
    padding: .4rem 1.2rem !important;
    border-color: #fff !important;
    background-color: #49b1f5 !important;
    color: #fff !important;
    font-size: .7rem !important;
  }

  .v .vcards .vcard .vh .vmeta .vat {
    padding: 0 .8rem !important;
    border: 1px solid #00c4b6 !important;
    border-radius: 5px !important;
    color: #00c4b6 !important;
  }
</style>
<script>
  new Valine({
    el: '#vcomments',
    appId: '0xr2jkRPcocVEPKJWAv9Gy5s-gzGzoHsz',
    appKey: 'UlRhR7tqjR8o4iuMOkCreDxF',
    avatar: '',
    placeholder: 'What is your point？',
    pageSize: '10',
    lang: 'zh-cn',
    visitor: 'true' === 'true',
    highlight: 'true' === 'true',
    avatarForce: 'true' === 'false',
  });
</script>

          </div>
        </div>
      </div>
    </div>
    <div class="footer-box">
  <footer class="footer">
    <div class="copyright">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | © 2019-2020 Theme By <a href="https://github.com/hsxyhao/gridea-theme-next" target="_blank">HsxyHao</a>
    </div>
    <div class="poweredby">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
    </div>
  </footer>
  
  
    <div class="drawer-box left" id="drawer_box">
      <span class="muse-line muse-line-first"></span>
      <span class="muse-line muse-line-middle"></span>
      <span class="muse-line muse-line-last"></span>
    </div>
  
  <div class="mist back-to-top" id="back_to_top">
    <i class="fa fa-arrow-up"></i>
    
  </div>
  
    <div class="bg-img">
      <img src="/media/images/custom-bgImg.jpg" />
    </div>
  
  
    
<link rel="stylesheet" href="/media/live2d/css/live2d.css" />
<div class="box-scale">
  <div id="landlord" style="left: 1px;bottom: 0px;"
    data-key="">
    <canvas id="live2d" width="500" height="560" class="live2d"></canvas>
    

      <div class="message" style="opacity:0"></div>
      <div class="live_talk_input_body">
        <div class="live_talk_input_name_body">
          <input name="name" type="text" class="live_talk_name white_input" id="AIuserName" autocomplete="off"
            placeholder="你的名字" />
        </div>
        <div class="live_talk_input_text_body">
          <input name="talk" type="text" class="live_talk_talk white_input" id="AIuserText" autocomplete="off"
            placeholder="要和我聊什么呀？" />
          <button type="button" class="live_talk_send_btn" id="talk_send">发送</button>
        </div>
      </div>
      <input name="live_talk" id="live_talk" value="1" type="hidden" />
      <div class="live_ico_box">
        <div class="live_ico_item type_info" id="showInfoBtn"></div>
        <div class="live_ico_item type_talk" id="showTalkBtn"></div>
        
        <div class="live_ico_item type_youdu" id="youduButton"></div>
        <div class="live_ico_item type_quit" id="hideButton"></div>
        <input name="live_statu_val" id="live_statu_val" value="0" type="hidden" />
        <audio src="" style="display:none;" id="live2d_bgm" data-bgm="0" preload="none"></audio>
        <input id="duType" value="douqilai" type="hidden">
        
      </div>
    
  </div>
</div>
<div id="open_live2d">召唤看板娘</div>
<script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script>
  var message_Path = 'https://cdn.jsdelivr.net/gh/hsxyhao/live2d.github.io@master/';
  let landlord = document.querySelector('#landlord');
  var apiKey = landlord.dataset.key;
</script>
<script type="text/javascript" src="/media/live2d/js/live2d.js"></script>
<script>
	var home_Path = document.location.protocol + '//' + window.document.location.hostname + ":" + window.document.location.port + '/';
	var userAgent = window.navigator.userAgent.toLowerCase();
	var norunAI = ["android", "iphone", "ipod", "ipad", "windows phone", "mqqbrowser", "msie", "trident/7.0"];
	var norunFlag = false;

	for (var i = 0; i < norunAI.length; i++) {
		if (userAgent.indexOf(norunAI[i]) > -1) {
			norunFlag = true;
			break;
		}
	}

	if (!window.WebGLRenderingContext) {
		norunFlag = true;
	}

	if (!norunFlag) {
		var hitFlag = false;
		var AIFadeFlag = false;
		var liveTlakTimer = null;
		var sleepTimer_ = null;
		var AITalkFlag = false;
		var talkNum = 0;
		(function () {
			function renderTip(template, context) {
				var tokenReg = /(\\)?\{([^\{\}\\]+)(\\)?\}/g;
				return template.replace(tokenReg, function (word, slash1, token, slash2) {
					if (slash1 || slash2) {
						return word.replace('\\', '');
					}
					var variables = token.replace(/\s/g, '').split('.');
					var currentObject = context;
					var i, length, variable;
					for (i = 0, length = variables.length; i < length; ++i) {
						variable = variables[i];
						currentObject = currentObject[variable];
						if (currentObject === undefined || currentObject === null) return '';
					}
					return currentObject;
				});
			}

			String.prototype.renderTip = function (context) {
				return renderTip(this, context);
			};

			var re = /x/;
			re.toString = function () {
				showMessage('哈哈，你打开了控制台，是想要看看我的秘密吗？', 5000);
				return '';
			};

			$(document).on('copy', function () {
				showMessage('你都复制了些什么呀，转载要记得加上出处哦~~', 5000);
			});

			function initTips() {
				$.ajax({
					cache: true,
					url: message_Path + 'message.json',
					dataType: "json",
					success: function (result) {
						$.each(result.mouseover, function (index, tips) {
							$(tips.selector).mouseover(function () {
								var text = tips.text;
								if (Array.isArray(tips.text)) text = tips.text[Math.floor(Math.random() * tips.text.length + 1) - 1];
								text = text.renderTip({ text: $(this).text() });
								showMessage(text, 3000);
								talkValTimer();
								clearInterval(liveTlakTimer);
								liveTlakTimer = null;
							});
							$(tips.selector).mouseout(function () {
								showHitokoto();
								if (liveTlakTimer == null) {
									liveTlakTimer = window.setInterval(function () {
										showHitokoto();
									}, 15000);
								};
							});
						});
						$.each(result.click, function (index, tips) {
							$(tips.selector).click(function () {
								if (hitFlag) {
									return false
								}
								hitFlag = true;
								setTimeout(function () {
									hitFlag = false;
								}, 8000);
								var text = tips.text;
								if (Array.isArray(tips.text)) text = tips.text[Math.floor(Math.random() * tips.text.length + 1) - 1];
								text = text.renderTip({ text: $(this).text() });
								showMessage(text, 3000);
							});
							clearInterval(liveTlakTimer);
							liveTlakTimer = null;
							if (liveTlakTimer == null) {
								liveTlakTimer = window.setInterval(function () {
									showHitokoto();
								}, 15000);
							};
						});
					}
				});
			}
			initTips();

			var text;
			if (document.referrer !== '') {
				var referrer = document.createElement('a');
				referrer.href = document.referrer;
				text = '嗨！来自 <span style="color:#0099cc;">' + referrer.hostname + '</span> 的朋友！';
				var domain = referrer.hostname.split('.')[1];
				if (domain == 'baidu') {
					text = '嗨！ 来自 百度搜索 的朋友！<br>欢迎访问<span style="color:#0099cc;">「 ' + document.title.split(' - ')[0] + ' 」</span>';
				} else if (domain == 'so') {
					text = '嗨！ 来自 360搜索 的朋友！<br>欢迎访问<span style="color:#0099cc;">「 ' + document.title.split(' - ')[0] + ' 」</span>';
				} else if (domain == 'google') {
					text = '嗨！ 来自 谷歌搜索 的朋友！<br>欢迎访问<span style="color:#0099cc;">「 ' + document.title.split(' - ')[0] + ' 」</span>';
				}
			} else {
				if (window.location.href == home_Path) { //主页URL判断，需要斜杠结尾
					var now = (new Date()).getHours();
					if (now > 23 || now <= 5) {
						text = '你是夜猫子呀？这么晚还不睡觉，明天起的来嘛？';
					} else if (now > 5 && now <= 7) {
						text = '早上好！一日之计在于晨，美好的一天就要开始了！';
					} else if (now > 7 && now <= 11) {
						text = '上午好！工作顺利嘛，不要久坐，多起来走动走动哦！';
					} else if (now > 11 && now <= 14) {
						text = '中午了，工作了一个上午，现在是午餐时间！';
					} else if (now > 14 && now <= 17) {
						text = '午后很容易犯困呢，今天的运动目标完成了吗？';
					} else if (now > 17 && now <= 19) {
						text = '傍晚了！窗外夕阳的景色很美丽呢，最美不过夕阳红~~';
					} else if (now > 19 && now <= 21) {
						text = '晚上好，今天过得怎么样？';
					} else if (now > 21 && now <= 23) {
						text = '已经这么晚了呀，早点休息吧，晚安~~';
					} else {
						text = '嗨~ 快来逗我玩吧！';
					}
				} else {
					text = '欢迎阅读<span style="color:#0099cc;">「 ' + document.title.split(' - ')[0] + ' 」</span>';
				}
			}
			showMessage(text, 12000);
		})();

		liveTlakTimer = setInterval(function () {
			showHitokoto();
		}, 15000);

		function showHitokoto() {
			if (sessionStorage.getItem("Sleepy") !== "1") {
				if (!AITalkFlag) {
					$.getJSON('https://v1.hitokoto.cn/', function (result) {
						talkValTimer();
						showMessage(result.hitokoto, 0);
					});
				}
			} else {
				hideMessage(0);
				if (sleepTimer_ == null) {
					sleepTimer_ = setInterval(function () {
						checkSleep();
					}, 200);
				}
			}
		}

		function checkSleep() {
			var sleepStatu = sessionStorage.getItem("Sleepy");
			if (sleepStatu !== '1') {
				talkValTimer();
				showMessage('你回来啦~', 0);
				clearInterval(sleepTimer_);
				sleepTimer_ = null;
			}
		}

		function showMessage(text, timeout) {
			if (Array.isArray(text)) text = text[Math.floor(Math.random() * text.length + 1) - 1];
			$('.message').stop();
			$('.message').html(text);
			$('.message').fadeTo(200, 1);
			//if (timeout === null) timeout = 5000;
			//hideMessage(timeout);
		}
		function talkValTimer() {
			$('#live_talk').val('1');
		}

		function hideMessage(timeout) {
			//$('.message').stop().css('opacity',1);
			if (timeout === null) timeout = 5000;
			$('.message').delay(timeout).fadeTo(200, 0);
		}

		function initLive2d() {
			$('#hideButton').on('click', function () {
				if (AIFadeFlag) {
					return false;
				} else {
					AIFadeFlag = true;
					localStorage.setItem("live2dhidden", "0");
					$('#landlord').fadeOut(200);
					$('#open_live2d').delay(200).fadeIn(200);
					setTimeout(function () {
						AIFadeFlag = false;
					}, 300);
				}
			});
			$('#open_live2d').on('click', function () {
				if (AIFadeFlag) {
					return false;
				} else {
					AIFadeFlag = true;
					localStorage.setItem("live2dhidden", "1");
					$('#open_live2d').fadeOut(200);
					$('#landlord').delay(200).fadeIn(200);
					setTimeout(function () {
						AIFadeFlag = false;
					}, 300);
				}
			});
			$('#youduButton').on('click', function () {
				if ($('#youduButton').hasClass('doudong')) {
					var typeIs = $('#youduButton').attr('data-type');
					$('#youduButton').removeClass('doudong');
					$('body').removeClass(typeIs);
					$('#youduButton').attr('data-type', '');
				} else {
					var duType = $('#duType').val();
					var duArr = duType.split(",");
					var dataType = duArr[Math.floor(Math.random() * duArr.length)];

					$('#youduButton').addClass('doudong');
					$('#youduButton').attr('data-type', dataType);
					$('body').addClass(dataType);
				}
			});
			if (apiKey) {
				$('#showInfoBtn').on('click', function () {
					var live_statu = $('#live_statu_val').val();
					if (live_statu == "0") {
						return
					} else {
						$('#live_statu_val').val("0");
						$('.live_talk_input_body').fadeOut(500);
						AITalkFlag = false;
						showHitokoto();
						$('#showTalkBtn').show();
						$('#showInfoBtn').hide();
					}
				});
				$('#showTalkBtn').on('click', function () {
					var live_statu = $('#live_statu_val').val();
					if (live_statu == "1") {
						return
					} else {
						$('#live_statu_val').val("1");
						$('.live_talk_input_body').fadeIn(500);
						AITalkFlag = true;
						$('#showTalkBtn').hide();
						$('#showInfoBtn').show();

					}
				});
				$('#talk_send').on('click', function () {
					var info_ = $('#AIuserText').val();
					var userid_ = $('#AIuserName').val();
					if (info_ == "") {
						showMessage('写点什么吧！', 0);
						return;
					}
					if (userid_ == "") {
						showMessage('聊之前请告诉我你的名字吧！', 0);
						return;
					}
					showMessage('思考中~', 0);
					let protocol = window.location.protocol.indexOf("s") > 0 ? "https" : "http";
					$.ajax({
						type: "get",
						url: `${protocol}://www.tuling123.com/openapi/api?key=${apiKey}&info=${info_}`,
						dataType: "json",
						success: function (res) {
							talkValTimer();
							showMessage(res.text, 0);
							$('#AIuserText').val("");
							sessionStorage.setItem("live2duser", userid_);
						},
						error: function (e) {
							talkValTimer();
							showMessage('似乎有什么错误，请和站长联系！', 0);
						}
					});
				});
			} else {
				$('#showInfoBtn').hide();
				$('#showTalkBtn').hide();
			}
			//获取音乐信息初始化
			var bgmListInfo = $('input[name=live2dBGM]');
			if (bgmListInfo.length == 0) {
				$('#musicButton').hide();
			} else {
				var bgmPlayNow = parseInt($('#live2d_bgm').attr('data-bgm'));
				var bgmPlayTime = 0;
				var live2dBGM_Num = sessionStorage.getItem("live2dBGM_Num");
				var live2dBGM_PlayTime = sessionStorage.getItem("live2dBGM_PlayTime");
				if (live2dBGM_Num) {
					if (live2dBGM_Num <= $('input[name=live2dBGM]').length - 1) {
						bgmPlayNow = parseInt(live2dBGM_Num);
					}
				}
				if (live2dBGM_PlayTime) {
					bgmPlayTime = parseInt(live2dBGM_PlayTime);
				}
				var live2dBGMSrc = bgmListInfo.eq(bgmPlayNow).val();
				$('#live2d_bgm').attr('data-bgm', bgmPlayNow);
				$('#live2d_bgm').attr('src', live2dBGMSrc);
				$('#live2d_bgm')[0].currentTime = bgmPlayTime;
				$('#live2d_bgm')[0].volume = 0.5;
				var live2dBGM_IsPlay = sessionStorage.getItem("live2dBGM_IsPlay");
				var live2dBGM_WindowClose = sessionStorage.getItem("live2dBGM_WindowClose");
				if (live2dBGM_IsPlay == '0' && live2dBGM_WindowClose == '0') {
					$('#live2d_bgm')[0].play();
					$('#musicButton').addClass('play');
				}
				sessionStorage.setItem("live2dBGM_WindowClose", '1');
				$('#musicButton').on('click', function () {
					if ($('#musicButton').hasClass('play')) {
						$('#live2d_bgm')[0].pause();
						$('#musicButton').removeClass('play');
						sessionStorage.setItem("live2dBGM_IsPlay", '1');
					} else {
						$('#live2d_bgm')[0].play();
						$('#musicButton').addClass('play');
						sessionStorage.setItem("live2dBGM_IsPlay", '0');
					}
				});
				window.onbeforeunload = function () {
					sessionStorage.setItem("live2dBGM_WindowClose", '0');
					if ($('#musicButton').hasClass('play')) {
						sessionStorage.setItem("live2dBGM_IsPlay", '0');
					}
				}
				document.getElementById('live2d_bgm').addEventListener("timeupdate", function () {
					var live2dBgmPlayTimeNow = document.getElementById('live2d_bgm').currentTime;
					sessionStorage.setItem("live2dBGM_PlayTime", live2dBgmPlayTimeNow);
				});
				document.getElementById('live2d_bgm').addEventListener("ended", function () {
					var listNow = parseInt($('#live2d_bgm').attr('data-bgm'));
					listNow++;
					if (listNow > $('input[name=live2dBGM]').length - 1) {
						listNow = 0;
					}
					var listNewSrc = $('input[name=live2dBGM]').eq(listNow).val();
					sessionStorage.setItem("live2dBGM_Num", listNow);
					$('#live2d_bgm').attr('src', listNewSrc);
					$('#live2d_bgm')[0].play();
					$('#live2d_bgm').attr('data-bgm', listNow);
				});
				document.getElementById('live2d_bgm').addEventListener("error", function () {
					$('#live2d_bgm')[0].pause();
					$('#musicButton').removeClass('play');
					showMessage('音乐似乎加载不出来了呢！', 0);
				});
			}
			//获取用户名
			var live2dUser = sessionStorage.getItem("live2duser");
			if (live2dUser !== null) {
				$('#AIuserName').val(live2dUser);
			}
			//获取位置
			var landL = sessionStorage.getItem("historywidth");
			var landB = sessionStorage.getItem("historyheight");
			if (landL == null || landB == null) {
				landL = '5px'
				landB = '0px'
			}
			$('#landlord').css('left', landL + 'px');
			$('#landlord').css('bottom', landB + 'px');
			//移动
			function getEvent() {
				return window.event || arguments.callee.caller.arguments[0];
			}
			var smcc = document.getElementById("landlord");
			var moveX = 0;
			var moveY = 0;
			var moveBottom = 0;
			var moveLeft = 0;
			var moveable = false;
			var docMouseMoveEvent = document.onmousemove;
			var docMouseUpEvent = document.onmouseup;
			smcc.onmousedown = function () {
				var ent = getEvent();
				moveable = true;
				moveX = ent.clientX;
				moveY = ent.clientY;
				var obj = smcc;
				moveBottom = parseInt(obj.style.bottom);
				moveLeft = parseInt(obj.style.left);
				if (isFirefox = navigator.userAgent.indexOf("Firefox") > 0) {
					window.getSelection().removeAllRanges();
				}
				document.onmousemove = function () {
					if (moveable) {
						var ent = getEvent();
						var x = moveLeft + ent.clientX - moveX;
						var y = moveBottom + (moveY - ent.clientY);
						obj.style.left = x + "px";
						obj.style.bottom = y + "px";
					}
				};
				document.onmouseup = function () {
					if (moveable) {
						var historywidth = obj.style.left;
						var historyheight = obj.style.bottom;
						historywidth = historywidth.replace('px', '');
						historyheight = historyheight.replace('px', '');
						sessionStorage.setItem("historywidth", historywidth);
						sessionStorage.setItem("historyheight", historyheight);
						document.onmousemove = docMouseMoveEvent;
						document.onmouseup = docMouseUpEvent;
						moveable = false;
						moveX = 0;
						moveY = 0;
						moveBottom = 0;
						moveLeft = 0;
					}
				};
			};
		}
		$(document).ready(function () {
			var AIimgSrc = [];
			let chooseLive2d = 'Aoba'
			if (chooseLive2d === 'histoire') {
				AIimgSrc.push(message_Path + "model/histoire/histoire.1024/texture_00.png");
				AIimgSrc.push(message_Path + "model/histoire/histoire.1024/texture_01.png");
				AIimgSrc.push(message_Path + "model/histoire/histoire.1024/texture_02.png");
				AIimgSrc.push(message_Path + "model/histoire/histoire.1024/texture_03.png");
			} else if (chooseLive2d === 'rem') {
				AIimgSrc.push(message_Path + "model/rem/remu2048/texture_00.png");
			} else if (chooseLive2d === 'Aoba') {
				AIimgSrc.push(message_Path + "model/Aoba/textures/texture_00.png");
			} else if (chooseLive2d === 'hijiki') {
				AIimgSrc.push(message_Path + "model/hijiki/moc/hijiki.2048/texture_00.png");
			} else if (chooseLive2d === 'tororo') {
				AIimgSrc.push(message_Path + "model/tororo/moc/tororo.2048/texture_00.png");
			}
			var images = [];
			var imgLength = AIimgSrc.length;
			var loadingNum = 0;
			for (var i = 0; i < imgLength; i++) {
				images[i] = new Image();
				images[i].src = AIimgSrc[i];
				images[i].onload = function () {
					loadingNum++;
					if (loadingNum === imgLength) {
						var live2dhidden = localStorage.getItem("live2dhidden");
						if (live2dhidden === "0") {
							setTimeout(function () {
								$('#open_live2d').fadeIn(200);
							}, 1300);
						} else {
							setTimeout(function () {
								$('#landlord').fadeIn(200);
							}, 1300);
						}
						let model = '';
						if (chooseLive2d === 'histoire') {
							model = message_Path + "model/histoire/model.json";
						} else if (chooseLive2d === 'rem') {
							model = message_Path + "model/rem/model.json";
						} else if (chooseLive2d === 'Aoba') {
							model = message_Path + "model/Aoba/model.json";
						} else if (chooseLive2d === 'hijiki') {
							model = message_Path + "model/hijiki/hijiki.model.json";
						} else if (chooseLive2d === 'tororo') {
							model = message_Path + "model/tororo/tororo.model.json";
						}
						setTimeout(function () {
							loadlive2d("live2d", model);
						}, 1000);
						initLive2d();
						images = null;
					}
				}
			}
		});
	}
</script>
  
  
</div>
<script>

  let sideBarOpen = 'sidebar-open';
  let body = document.body;
  let back2Top = document.querySelector('#back_to_top'),
  back2TopText = document.querySelector('#back_to_top_text'),
  drawerBox = document.querySelector('#drawer_box'),
  rightSideBar = document.querySelector('.sidebar'),
  viewport = document.querySelector('body');

  function scrollAnimation(currentY, targetY) {
   
    let needScrollTop = targetY - currentY
    let _currentY = currentY
    setTimeout(() => {
      const dist = Math.ceil(needScrollTop / 10)
      _currentY += dist
      window.scrollTo(_currentY, currentY)
      if (needScrollTop > 10 || needScrollTop < -10) {
        scrollAnimation(_currentY, targetY)
      } else {
        window.scrollTo(_currentY, targetY)
      }
    }, 1)
  }

  back2Top.addEventListener("click", function(e) {
    scrollAnimation(document.scrollingElement.scrollTop, 0);
    e.stopPropagation();
    return false;
  });
  
  window.addEventListener('scroll', function(e) {
    let percent = document.scrollingElement.scrollTop / (document.scrollingElement.scrollHeight - document.scrollingElement.clientHeight) * 100;
    if (percent > 1 && !back2Top.classList.contains('back-top-active')) {
      back2Top.classList.add('back-top-active');
    }
    if (percent == 0) {
      back2Top.classList.remove('back-top-active');
    }
    if (back2TopText) {
      back2TopText.textContent = Math.floor(percent);
    }
  });

  
  let hasCacu = false;
  window.onresize = function() {
    if (window.width > 991) {
      calcuHeight();
    } else {
      hasCacu = false;
    }
  }

  function calcuHeight() {
    // 动态调整站点概览高度
    if (!hasCacu && back2Top.classList.contains('pisces') || back2Top.classList.contains('gemini')) {
      let sideBar = document.querySelector('.sidebar');
      let navUl = document.querySelector('#site_nav');
      sideBar.style = 'margin-top:' + (navUl.offsetHeight + navUl.offsetTop + 15) + 'px;';
      hasCacu = true;
    }
  }
  calcuHeight();
  
  let open = false, MOTION_TIME = 300, RIGHT_MOVE_DIS = '320px';

  if (drawerBox) {
    let rightMotions = document.querySelectorAll('.right-motion');
    let right = drawerBox.classList.contains('right');

    let transitionDir = right ? "transition.slideRightIn" : "transition.slideLeftIn";

    let openProp, closeProp;
    if (right) {
      openProp = {
        paddingRight: RIGHT_MOVE_DIS 
      };
      closeProp = {
        paddingRight: '0px'
      };
    } else {
      openProp = {
        paddingLeft: RIGHT_MOVE_DIS 
      };
      closeProp = {
        paddingLeft: '0px'
      };
    }

    drawerBox.onclick = function() {
      open = !open;
      window.Velocity(rightSideBar, 'stop');
      window.Velocity(viewport, 'stop');
      window.Velocity(rightMotions, 'stop');
      if (open) {
        window.Velocity(rightSideBar, {
          width: RIGHT_MOVE_DIS
        }, {
          duration: MOTION_TIME,
          begin: function() {
            window.Velocity(rightMotions, transitionDir,{ });
          }
        })
        window.Velocity(viewport, openProp,{
          duration: MOTION_TIME
        });
      } else {
        window.Velocity(rightSideBar, {
          width: '0px'
        }, {
          duration: MOTION_TIME,
          begin: function() {
            window.Velocity(rightMotions, {
              opacity: 0
            });
          }
        })
        window.Velocity(viewport, closeProp ,{
          duration: MOTION_TIME
        });
      }
      for (let i = 0; i < drawerBox.children.length; i++) {
        drawerBox.children[i].classList.toggle('muse-line');
      }
      drawerBox.classList.toggle(sideBarOpen);
    }
  }

  // 链接跳转
  let newWindow = 'false'
  if (newWindow === 'true') {
    let links = document.querySelectorAll('.post-body a')
    links.forEach(item => {
      if (!item.classList.contains('btn')) {
        item.setAttribute("target","_blank");
      }
    })
  }
  // 代码高亮
  hljs.initHighlightingOnLoad();

</script>
    <div class="light-box" id="light_box"></div>
<script>
  let imgs = document.querySelectorAll('.post-body img');
  let lightBox = document.querySelector('#light_box');
  lightBox.addEventListener('mousedown', (e) => {
    e.preventDefault()
  })
  lightBox.addEventListener('mousewheel', (e) => {
    e.preventDefault()
  })
  let width = window.innerWidth * 0.8;
  lightBox.onclick = () => {
    let img = lightBox.querySelector('img');
    lightBox.style = '';
    img && img.remove();
  }
  imgs.forEach(item => {
    item.onclick = function (e) {
      let lightImg = document.createElement('img');
      lightImg.src = this.src;
      lightBox.style = `height: 100%; opacity: 1; background-color: rgba(0, 0, 0, 0.5);cursor: zoom-out;`;
      lightImg.style = `width: ${width}px; border: 1px solid #fff; border-radius: 2px;`;
      lightImg.onclick = function () {
        lightBox.style = '';
        this.remove();
      }
      lightBox.append(lightImg);
    }
  })
</script>
  </div>
</body>
<input hidden id="copy" />
<script>
  //拿来主义(真香)^_^，Clipboard 实现摘自掘金 https://juejin.im/post/5aefeb6e6fb9a07aa43c20af
  window.Clipboard = (function (window, document, navigator) {
    var textArea,
      copy;

    // 判断是不是ios端
    function isOS() {
      return navigator.userAgent.match(/ipad|iphone/i);
    }
    //创建文本元素
    function createTextArea(text) {
      textArea = document.createElement('textArea');
      textArea.value = text;
      textArea.style.width = 0;
      textArea.style.height = 0;
      textArea.clientHeight = 0;
      textArea.clientWidth = 0;
      document.body.appendChild(textArea);
    }
    //选择内容
    function selectText() {
      var range,
        selection;

      if (isOS()) {
        range = document.createRange();
        range.selectNodeContents(textArea);
        selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        textArea.setSelectionRange(0, 999999);
      } else {
        textArea.select();
      }
    }

    //复制到剪贴板
    function copyToClipboard() {
      try {
        document.execCommand("Copy")
      } catch (err) {
        alert("复制错误！请手动复制！")
      }
      document.body.removeChild(textArea);
    }

    copy = function (text) {
      createTextArea(text);
      selectText();
      copyToClipboard();
    };

    return {
      copy: copy
    };
  })(window, document, navigator);

  function copyCode(e) {
    if (e.srcElement.tagName === 'SPAN' && e.srcElement.classList.contains('copy-code')) {
      let code = e.currentTarget.querySelector('code');
      var text = code.innerText;
      if (e.srcElement.textContent === '复制成功') {
        console.log('复制操作频率过高');
        return;
      }
      e.srcElement.textContent = '复制成功';
      (function (elem) {
        setTimeout(() => {
          if (elem.textContent === '复制成功') {
            elem.textContent = '复制代码'
          }
        }, 1000);
      })(e.srcElement)
      Clipboard.copy(text);
    }
  }

  let pres = document.querySelectorAll('pre');
  pres.forEach(pre => {
    let code = pre.querySelector('code');
    let copyElem = document.createElement('span');
    copyElem.classList.add('copy-code');
    copyElem.textContent = '复制代码';
    pre.appendChild(copyElem);
    pre.onclick = copyCode
  })
</script>
<script src="/media/js/motion.js"></script>

<script src="https://cdn.jsdelivr.net/gh/cferdinandi/smooth-scroll/dist/smooth-scroll.polyfills.min.js"></script>
<script>
  var scroll = new SmoothScroll('a[href*="#"]', {
    speed: 500
  });
</script>

<!-- <div class="search-mask" id="search_mask">
  <div class="search-box">
    <div class="search-title">
      <i class="fa fa-search"></i>
      <div class="input-box">
        <input type="text" placeholder="搜索">
      </div>
      <i class="fa fa-times-circle"></i>
    </div>
    <div class="result">
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/metminer-datacleaing-outlier/"" data-c="
          &lt;p&gt;在引言部分我们讲过离群样本的判别，很大程度上和实验设计相关，对于无样本异质性，变量较少的实验设计是一种方案，而对于存在样本异质性，或者引入了多样化变量的实验设计这里需要慎重去除...&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2 id=&#34;原理&#34;&gt;原理&lt;/h2&gt;
&lt;p&gt;离群样本（outlier）出现的原因，一方面可能是样本本身的原因，比如处理方式不当，生长状态，遗传背景变异等，也可能是实验操作问题，总之会影响结果的准确性。对于实验设计简单，引发差异变量较少的代谢组学实验，outlier判别相对简单，生物学重复之间差异较小，而组间差异较大，如果出现个别与整体差异显著的材料，应该是各种原因造成的离群样本，tidyMass提供了&lt;code&gt;detect_outlier()&lt;/code&gt;来判断离群值，其原理基于&lt;a href=&#34;https://privefl.github.io/blog/detecting-outlier-samples-in-pca/&#34;&gt;Detecting outlier samples in PCA – Florian Privé – R(cpp) enthusiast&lt;/a&gt; 结果会输出一个判断表格，基于以下判断结果我们可以根据自己的实验设计的实际情况，自助判断离群样本：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;根据样本中代谢物的缺失率；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;根据标准偏差；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;根据绝对中为差（MAD）；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;根据稳健马氏距离推导的p值来判别；&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;操作界面&#34;&gt;操作界面&lt;/h2&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407290957499.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;操作相对简单，对应的设置好阈值之后点击&lt;code&gt;find outlier&lt;/code&gt;即可，MetMiner中默认的值和tidyMass提供的默认阈值一致。比如Demo中我们制造了一个虚拟的离群样本，根据缺失率和马氏距离该样本在正谱中都为离群样本，本试验的唯一变量是遗传背景的不同，所以这里可以将Outlier样本视为离群值去除，去除过程操作如下:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;可以直接在Pick outliers中查找到Outlier去除，也可根据样本缺失值统计散点图直观的选择需要去除的样本；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;开启图形交互；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;将鼠标悬浮到缺失值统计的高缺失率的样本查看sample_id；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;在Pick outlier中选择要去除的样本；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;点击remove and update；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;在静态图模式下，可以看到去除前后缺失率统计图。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;2&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgoiShot_2024-07-29_09.59.02.gif&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;h2 id=&#34;其它&#34;&gt;其它&lt;/h2&gt;
&lt;p&gt;这里仍旧需要再次提醒包含不同物种、不同组织、时序效应等复杂实验设计，在离群值去除时需要慎重！&lt;/p&gt;
&lt;p&gt;---The end---&lt;/p&gt;
&lt;p&gt;Jul 27, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;
">「MetMiner」数据清洗 - 离群样本</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/metminer-remove-noise/"" data-c="
          &lt;p&gt;数据清洗的第一步是根据统计样本中代谢物的缺失率（missing value rate）来标记噪音。MetMiner中标记噪音的具体方式较为多样化...&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2 id=&#34;原理&#34;&gt;原理&lt;/h2&gt;
&lt;p&gt;之前提到过理论上&lt;code&gt;QC&lt;/code&gt;样本包含了所有的代谢物信息，而且从实验操作也可以看出，不同时间段的&lt;code&gt;QC&lt;/code&gt;样本都来自于一个混样，所以&lt;strong&gt;理论上所有QC样本中代谢物的缺失率是较为一致的，且缺失率较低&lt;/strong&gt;；&lt;/p&gt;
&lt;p&gt;经验上，我们认为在&lt;code&gt;QC&lt;/code&gt;样本中缺失率低于&lt;code&gt;20%&lt;/code&gt;的代谢物是较为稳定的，这些代谢物检出率较高，可信度也较高，针对大部分的实验设计，该评价条件式较为稳健的；&lt;/p&gt;
&lt;p&gt;此外针对无样本异质性的实验设计，我们还可以结合对测试样本中代谢物的缺失率来判断，例如，在对&lt;code&gt;QC&lt;/code&gt;样本缺失率筛选过后的feature，我们也可以加上更加严格的条件，比如在测试样本中至少一般以上的样本要检测到，这里就可以针对筛选；&lt;/p&gt;
&lt;p&gt;对于有样本异质性的实验设计，只需要关注他在&lt;code&gt;QC&lt;/code&gt;样本中的缺失率即可；&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;注意，QC中缺失阈值和样本中缺失阈值之间的关系是and！而不是or！可以理解为在符合QC阈值的情况下增加更加严格的条件！&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&#34;操作界面&#34;&gt;操作界面&lt;/h2&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407271712403.png&#34; alt=&#34;noisy remove&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;首先看sidebar中的参数：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Group by：&lt;/strong&gt; 比如下面sample information表格中，class将样本分为了QC和Subject，group代表了样本的分组，这里面包含了两个变量，一个是基因型（col0 or mutant）另一个是处理（water or drought），这样将样本分成了4组。如果我们想在控制QC缺失的同时至少在&lt;strong&gt;一半的测试样本中存在&lt;/strong&gt;，那么这里需要将Group by 选择为&lt;code&gt;class&lt;/code&gt;，同时&lt;code&gt;missing value frequency&lt;/code&gt;选择&lt;code&gt;50%&lt;/code&gt;; 如果我们想更加严格一点，至少&lt;strong&gt;在5个生物学重复中至少3个可以检测到&lt;/strong&gt;，那么这里需要将Group by选择为&lt;code&gt;group&lt;/code&gt;, &lt;code&gt;missing value frequency&lt;/code&gt;选择&lt;code&gt;40%&lt;/code&gt;;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Missing value frequency&lt;/strong&gt; 样本缺失率阈值，如果不卡测试样本的缺失阈值，这里直接拉到&lt;code&gt;100%&lt;/code&gt;；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Missing value frequency in QC&lt;/strong&gt; &lt;code&gt;QC&lt;/code&gt;中的缺失率阈值；&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;style&gt;
&lt;/style&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;sample_id&lt;/th&gt;
&lt;th&gt;injection.order&lt;/th&gt;
&lt;th&gt;class&lt;/th&gt;
&lt;th&gt;group&lt;/th&gt;
&lt;th&gt;batch&lt;/th&gt;
&lt;th&gt;group&lt;/th&gt;
&lt;th&gt;treatment&lt;/th&gt;
&lt;th&gt;genotype&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;QC_01&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;QC_02&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;QC_03&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;QC_04&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;QC_05&lt;/td&gt;
&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;QC_06&lt;/td&gt;
&lt;td&gt;6&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0001&lt;/td&gt;
&lt;td&gt;7&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;WT-Water&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;WT-Water-1&lt;/td&gt;
&lt;td&gt;Water&lt;/td&gt;
&lt;td&gt;col0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0002&lt;/td&gt;
&lt;td&gt;8&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;WT-Water&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;WT-Water-2&lt;/td&gt;
&lt;td&gt;Water&lt;/td&gt;
&lt;td&gt;col0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0003&lt;/td&gt;
&lt;td&gt;9&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;WT-Water&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;WT-Water-3&lt;/td&gt;
&lt;td&gt;Water&lt;/td&gt;
&lt;td&gt;col0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0004&lt;/td&gt;
&lt;td&gt;10&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;WT-Water&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;WT-Water-4&lt;/td&gt;
&lt;td&gt;Water&lt;/td&gt;
&lt;td&gt;col0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0005&lt;/td&gt;
&lt;td&gt;11&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;WT-Water&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;WT-Water-5&lt;/td&gt;
&lt;td&gt;Water&lt;/td&gt;
&lt;td&gt;col0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0006&lt;/td&gt;
&lt;td&gt;12&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;WT-drought&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;WT-drought-1&lt;/td&gt;
&lt;td&gt;drought&lt;/td&gt;
&lt;td&gt;col0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0007&lt;/td&gt;
&lt;td&gt;13&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;WT-drought&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;WT-drought-2&lt;/td&gt;
&lt;td&gt;drought&lt;/td&gt;
&lt;td&gt;col0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0008&lt;/td&gt;
&lt;td&gt;14&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;WT-drought&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;WT-drought-3&lt;/td&gt;
&lt;td&gt;drought&lt;/td&gt;
&lt;td&gt;col0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0009&lt;/td&gt;
&lt;td&gt;15&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;WT-drought&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;WT-drought-4&lt;/td&gt;
&lt;td&gt;drought&lt;/td&gt;
&lt;td&gt;col0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0010&lt;/td&gt;
&lt;td&gt;16&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;WT-drought&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;WT-drought-5&lt;/td&gt;
&lt;td&gt;drought&lt;/td&gt;
&lt;td&gt;col0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;QC_07&lt;/td&gt;
&lt;td&gt;17&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0011&lt;/td&gt;
&lt;td&gt;18&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;MT-Water&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;MT-Water-1&lt;/td&gt;
&lt;td&gt;Water&lt;/td&gt;
&lt;td&gt;mutant&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0012&lt;/td&gt;
&lt;td&gt;19&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;MT-Water&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;MT-Water-2&lt;/td&gt;
&lt;td&gt;Water&lt;/td&gt;
&lt;td&gt;mutant&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0013&lt;/td&gt;
&lt;td&gt;20&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;MT-Water&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;MT-Water-3&lt;/td&gt;
&lt;td&gt;Water&lt;/td&gt;
&lt;td&gt;mutant&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0014&lt;/td&gt;
&lt;td&gt;21&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;MT-Water&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;MT-Water-4&lt;/td&gt;
&lt;td&gt;Water&lt;/td&gt;
&lt;td&gt;mutant&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0015&lt;/td&gt;
&lt;td&gt;22&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;MT-Water&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;MT-Water-5&lt;/td&gt;
&lt;td&gt;Water&lt;/td&gt;
&lt;td&gt;mutant&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0016&lt;/td&gt;
&lt;td&gt;23&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;MT-drought&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;MT-drought-1&lt;/td&gt;
&lt;td&gt;drought&lt;/td&gt;
&lt;td&gt;mutant&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0017&lt;/td&gt;
&lt;td&gt;24&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;MT-drought&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;MT-drought-2&lt;/td&gt;
&lt;td&gt;drought&lt;/td&gt;
&lt;td&gt;mutant&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0018&lt;/td&gt;
&lt;td&gt;25&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;MT-drought&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;MT-drought-3&lt;/td&gt;
&lt;td&gt;drought&lt;/td&gt;
&lt;td&gt;mutant&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0019&lt;/td&gt;
&lt;td&gt;26&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;MT-drought&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;MT-drought-4&lt;/td&gt;
&lt;td&gt;drought&lt;/td&gt;
&lt;td&gt;mutant&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;S_0020&lt;/td&gt;
&lt;td&gt;27&lt;/td&gt;
&lt;td&gt;Subject&lt;/td&gt;
&lt;td&gt;MT-drought&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;MT-drought-5&lt;/td&gt;
&lt;td&gt;drought&lt;/td&gt;
&lt;td&gt;mutant&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;QC_08&lt;/td&gt;
&lt;td&gt;28&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;QC_09&lt;/td&gt;
&lt;td&gt;29&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;QC_10&lt;/td&gt;
&lt;td&gt;30&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;QC_11&lt;/td&gt;
&lt;td&gt;31&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;QC&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;---The end---&lt;/p&gt;
&lt;p&gt;Jul 27, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;
">「MetMiner」数据清洗 - 去噪</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/metminer-datacleaning-overview/"" data-c="
          &lt;p&gt;该部分是数据清洗前的准备工作，主要的作用是通过观测QC样本的峰面积的boxplot以及整体样本中代谢物的缺失情况来补充batch信息，如果没有观测到明显的批次效应则可以直接进行后续分析。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h1 id=&#34;操作界面&#34;&gt;操作界面&lt;/h1&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407271550481.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;Data Cleaning =&amp;gt; Overview&lt;/strong&gt; 左侧&lt;code&gt;sidebar&lt;/code&gt; 一般为设置参数的选项，这部分参数主要是针对可视化颜色选项的，第一个图就是QC样本峰面积箱线图，这里提供了两个选项，一个是根据批次上色，另一个是根据上样顺序上色，比如这里我们已知该实验分了两个批次，批次产生的原因主要是前期样品通过上样瓶进行上样，而后期样品通过96孔板上样，在上样体积上出现了显著差异，如果前期不知道换了上样方式会带来批次效应，从该图也可以明显观测到。&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;2&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407271555589.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;同样，通过所有样本散点图的分布可以看出batch3的缺失值显著升高，这可能是更换上样方式后代谢物含量下降，低Intensity的代谢物检出效率变低，导致缺失率升高。&lt;/p&gt;
&lt;p&gt;基于此我们一方面可以核对&lt;code&gt;sample info&lt;/code&gt;中的批次效应信息，同时结合实验记录我们也可以补充遗漏的批次效应信息。&lt;/p&gt;
&lt;h2 id=&#34;交互操作&#34;&gt;交互操作&lt;/h2&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;3&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgooverview-interac.gif&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;交互操作使得我们可以很快的从图中提取出有用的信息，比如上图中我们发现在负谱中一个叫&lt;code&gt;Outlier&lt;/code&gt;的样本缺失值达到了90%以上，通过交互操作我们可以快速的获得该样本的id，方便我们后期对该离群样本进行删除或者重新补测。&lt;br&gt;
---The end---&lt;br&gt;
Jul 27, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;
">「MetMiner」数据清洗 - Overview</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/metminer-datacleaning-Introduce/"" data-c="
          &lt;p&gt;我们将代谢组学数据分析大致的分为了两部分，第一部分数据清洗，也就是将包含&lt;strong&gt;系统误差&lt;/strong&gt;、&lt;strong&gt;批次效应&lt;/strong&gt;、&lt;strong&gt;噪音&lt;/strong&gt;、&lt;strong&gt;离群样本&lt;/strong&gt;，等多种干扰因素的「原始数据」&lt;strong&gt;清洗&lt;/strong&gt;成「干净数据」。MetMiner在执行数据清洗前会对原始数据进行质控，尽早的基于质控样本（QC）来观测是否具有严重批次效应的出现，以及由于实验操作失误产生的异常数据；&lt;/p&gt;
&lt;p&gt;该部分主要介绍两点：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;代谢组数据误差来源原理和解决方案；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;数据清洗步骤简介；&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;!--more--&gt;
&lt;h1 id=&#34;误差来源&#34;&gt;误差来源&lt;/h1&gt;
&lt;p&gt;在代谢组学实验中，&lt;strong&gt;仪器漂移和批次效应&lt;/strong&gt;是两个主要的系统误差来源，它们会影响数据的质量和分析结果的可靠性。以下是对这两个现象的详细解释：&lt;/p&gt;
&lt;h3 id=&#34;仪器漂移&#34;&gt;仪器漂移&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;定义&lt;/strong&gt;：仪器漂移是指在长时间的实验过程中，分析仪器（如质谱仪、色谱仪等）性能的逐渐变化。这种变化可能是由于温度、压力、样品负载、仪器部件老化等因素引起的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;表现&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;信号强度变化&lt;/strong&gt;：随着时间的推移，仪器的检测灵敏度可能会变化，导致相同样品在不同时间点测得的信号强度不同。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;保留时间漂移&lt;/strong&gt;：在色谱分离过程中，化合物的保留时间可能会随着时间的推移发生变化，导致峰位偏移。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;质量偏移&lt;/strong&gt;：质谱分析中，质量数（m/z）的测量可能会发生轻微的偏移，影响质量准确度。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;解决方法&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;定期校准&lt;/strong&gt;：对仪器进行定期校准和维护，保持仪器性能的稳定。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;使用QC样品&lt;/strong&gt;：在实验过程中定期插入QC样品，通过比较QC样品的检测结果，监控和校正仪器漂移。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;数据归一化&lt;/strong&gt;：利用QC样品数据进行归一化处理，校正仪器漂移对实验数据的影响。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;批次效应&#34;&gt;批次效应&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;定义&lt;/strong&gt;：批次效应是指在不同实验批次中，由于实验条件、操作人员、试剂、设备等的变化，导致的系统性误差。这种误差会使得不同批次之间的实验数据出现系统性差异。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;表现&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;系统偏差&lt;/strong&gt;：同一实验在不同批次中进行时，测得的结果可能会存在系统性的偏差，导致无法直接比较不同批次的数据。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;变异增大&lt;/strong&gt;：不同批次之间的变异会增加数据的总变异，影响统计分析的结果和结论。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;解决方法&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;实验设计&lt;/strong&gt;：在实验设计阶段，通过随机化和平衡化减少批次效应。例如，将样品随机分配到不同的批次中进行检测。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;使用QC样品&lt;/strong&gt;：在每个批次中都插入相同的QC样品，利用QC样品数据进行校正，减小批次效应对实验结果的影响。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;数据归一化和校正&lt;/strong&gt;：采用数据归一化和批次校正方法，如多元统计分析、批次效应校正，来减少批次效应的影响。&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&#34;qc-based-normalization&#34;&gt;QC-based normalization&lt;/h1&gt;
&lt;h3 id=&#34;qc-based-normalization的优点&#34;&gt;QC-based Normalization的优点&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;校正系统误差&lt;/strong&gt;：通过使用QC样品，可以有效校正因仪器漂移和批次效应引起的系统误差，保证数据的准确性。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;提高数据一致性&lt;/strong&gt;：在实验过程中定期插入QC样品，确保数据在不同时间点和不同批次中的一致性，提高实验结果的可比性。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;增强数据的可靠性&lt;/strong&gt;：QC样品提供了一个标准参考，有助于减少假阳性和假阴性结果，增强数据分析的可靠性。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;监控实验过程&lt;/strong&gt;：QC样品可以用于实时监控仪器性能和实验过程，及时发现和纠正实验中的问题。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;简化数据处理&lt;/strong&gt;：QC样品的使用使得数据归一化和校正过程更加简便和标准化，提高数据处理的效率。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;常用的qc-based-normalization算法&#34;&gt;常用的QC-based Normalization算法&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;LOESS（Locally Estimated Scatterplot Smoothing）&lt;/strong&gt;：&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;原理&lt;/strong&gt;：LOESS算法通过局部回归的方法，对QC样品的信号强度进行平滑，校正仪器漂移和批次效应。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;优点&lt;/strong&gt;：能够处理复杂的非线性关系，适用于大规模数据集。&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;&lt;strong&gt;SVR（Support Vector Regression）&lt;/strong&gt;：&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;原理&lt;/strong&gt;：利用支持向量回归模型，对QC样品的信号强度进行建模，校正仪器漂移和批次效应。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;优点&lt;/strong&gt;：适用于高维数据，具有良好的泛化能力。&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;&lt;strong&gt;SERRF（Systematic Error Removal using Random Forest）：&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;原理&lt;/strong&gt;：使用随机森林模型来校正系统误差。首先，利用QC样品的数据构建随机森林模型，学习QC样品的信号强度与实验条件（如批次、时间等）之间的关系。然后，利用训练好的模型预测每个样品的系统误差，并进行校正。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;优点&lt;/strong&gt;：SERRF能够有效地校正由于仪器漂移和批次效应引起的系统误差，提高数据的准确性。&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;数据清洗步骤简介&#34;&gt;数据清洗步骤简介&lt;/h1&gt;
&lt;h2 id=&#34;检测批次效应和离群样本&#34;&gt;检测批次效应和离群样本&lt;/h2&gt;
&lt;p&gt;首先我们从上述原理可知QC样本的设置对于数据清洗来说是非常重要的，一般在我们的实验过程中，会在开头先上3针左右的QC，然后再上样本，每个10个样本左右穿插一针QC。在上样结束再补3针QC。&lt;/p&gt;
&lt;p&gt;理论上QC样本是所有sample等量混样获得的，包含了所有的variable信息，而且他们是一致的，我们通过QC样本代谢物峰面积的boxplot、PCA、以及样本中的代谢物的缺失率可以观测到批次效应和系统偏移。通观测这些图，如果我们发现了随着上样时间的推移，QC样本呈现较大幅度的偏移，而且具有一定的规律，结合实验记录我们需要在&lt;code&gt;sample_info&lt;/code&gt;中补充实验的批次信息。其次，如果实验设计中不包括样本异质性，也就是说测试样本基本属于同一物种、同一（近似的）发育时期、相同组织的话，那么变量较为单一。分为以下情况：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;同一材料不同处理： 变量为处理条件；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;不同遗传背景相同处理：变量为遗传背景；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;不同遗传背景不同处理：变量为遗传背景+处理；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;相同材料时序：变量为时间序列；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;不同遗传背景时序：变量为遗传背景+时间序列；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;...&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;总之实验设计越简单，差异构成因素越小，越容易从差异代谢物入手聚焦生物学问题；相反，需要更多的数据分析手段，逐步排除干扰，聚焦生物学问题。&lt;/p&gt;
&lt;p&gt;针对这类实验设计，我们经验得知代谢水平 &lt;strong&gt;物种特异性 ≈ 组织特异性 &amp;gt;&amp;gt; 处理-对照 ≈ 遗传背景差异&lt;/strong&gt; 。那么当你的实验设计包含了样品异质性后，物种间特异性和组织间特异性会大幅度掩盖遗传背景和处理造成的差异，反映到代谢组数据上就是在不同物种，不同组织间的样本在代谢物类别上具有明显差异，通过样本中代谢物的缺失率（missing value rate）在不同组织间具有显著差异；这里我们提供一个参考的阈值，&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;如果对于&lt;strong&gt;无样本异质性的实验设计&lt;/strong&gt;，mv &amp;gt; 0.5可以被认为是outlier，这个可能是样本本身的问题，也可能是实验操作的问题（进样瓶有气泡，浓度不足），因为同一种材料超过50%的代谢物检测不到肯定不正常。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果对于&lt;strong&gt;有样本异质性的实验设计&lt;/strong&gt;，mv &amp;gt; 0.8可以被认为是outlier，我们实操和经验中，这类样本一般是由于实验操作引起的失误，从TIC图可以看出这类样本提峰的结果就很奇怪，遇到这种情况需要及时在补一针样品，所以在遇到大样本量的非靶代谢时，需要阶段性的观测跑完样本结果，及时纠正实验失误引发的错误样本结果；&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;标准数据清洗步骤&#34;&gt;标准数据清洗步骤&lt;/h2&gt;
&lt;p&gt;离群样本和批次效应在规范化的实验操作流程中根据实验记录和对结果的观测是可以提前避免的，但也不能保证每次实验均可以，那么在我们获得原始数据后，通过后期数据质控，数据清洗过程也可以亡羊补牢；&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;在MetMiner中 Data cleaning的第一步是『Overview』这里展示了原始数据QC样本峰面积的统计结果；随着上样顺序的排列，我们可以观测是否具有批次效应或者系统偏移，如果观测到了批次效应，需要及时修改&lt;code&gt;sample_info&lt;/code&gt;中的&lt;code&gt;batch&lt;/code&gt;信息；第二块展示了所有样本的代谢物缺失率，同样可以观测到是否具有明显的&lt;code&gt;样本异质性&lt;/code&gt;或者&lt;code&gt;批次效应&lt;/code&gt;；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;第二步是『remove noisy features』称为去噪，通过统计每个feature在QC样本中或者测试Subject样本中的缺失率来判断是否为噪音；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;第三步是『remove outlier』去除离群值，这里tidymass提供了多种离群值检测指标&lt;a href=&#34;https://privefl.github.io/blog/detecting-outlier-samples-in-pca/&#34;&gt;Detecting outlier samples in PCA – Florian Privé – R(cpp) enthusiast&lt;/a&gt;, 这里不能非黑即白的刻板的套用软件提供的参考结果，正如前文提到的一样，需要结合自己的实验设计灵活的判断；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;第四步是『missing value imputation』缺失值的插补，在后续进行数据标准化时不允许出现缺失值，所以这里需要使用合适的算法对缺失的值进行插补；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;第四步为『Normalization』数据标准化，也就是前面提到的标准化的过程，其实还隐含了另外一个就是batch align，在tidymass中是通过batch integrate将不同batch的结果整合到一起。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;---The end---&lt;br&gt;
Jul 27, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;
">「MetMiner」数据清洗 - 引言</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/metminer-data-import/"" data-c="
          &lt;p&gt;MetMiner流程整合了mass_dataset数据输入格式，所以具有灵活多变的数据输入模式，本文介绍了通过metMiner进行代谢组数据分析前的数据准备及项目初始化工作。&lt;/p&gt;
&lt;p&gt;主要从一下几方面说明：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;原始数据格式转换和文件结构（从原始数据导入）；&lt;/li&gt;
&lt;li&gt;提峰表格准备（从其它软件提峰表格导入）；&lt;/li&gt;
&lt;li&gt;mass_dataset准备（从mass_dataset类型数据导入）；&lt;/li&gt;
&lt;/ol&gt;
&lt;!--more--&gt;
&lt;h2 id=&#34;原始数据格式转换&#34;&gt;原始数据格式转换&lt;/h2&gt;
&lt;p&gt;这里以ThermoFisher的Q Exactive™ Plus产生的数据为例， LC-MS产生的原始数据为&lt;code&gt;.raw&lt;/code&gt;格式，需要通过&lt;a href=&#34;https://proteowizard.sourceforge.io/download.html&#34;&gt;ProteoWizard-MSCovert&lt;/a&gt;软件转换为包含&lt;code&gt;MS1&lt;/code&gt;信息的&lt;code&gt;mzXML&lt;/code&gt;格式和包含&lt;code&gt;MS2&lt;/code&gt;信息的&lt;code&gt;mgf&lt;/code&gt;格式。windows用户可以直接在界面软件按照下图进行格式转换：&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgoMSConvert.png&#34; alt=&#34;数据转换&#34; loading=&#34;lazy&#34;&gt;, MSConvert图形化界面软件只可以在windows下运行，MacOS或者linux系统可以根据tidyMass project提供的基于docker的&lt;code&gt;massconverter&lt;/code&gt;的数据转换方式&lt;a href=&#34;https://www.tidymass.org/docs/chapter3/2-data_convert/&#34;&gt;Convert data using massconverter&lt;/a&gt;完成原始数据的转换，具体参数及设置参考以上连接。&lt;/p&gt;
&lt;h2 id=&#34;从原始数据输入&#34;&gt;从原始数据输入&lt;/h2&gt;
&lt;p&gt;前文提到MetMiner在数据导入时调用了&lt;code&gt;tidyMass project&lt;/code&gt;, tidyMass通过&lt;code&gt;xcms&lt;/code&gt;对原始数据进行&lt;code&gt;peak picking and grouping&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;我们这里了解下tidymass对原始数据进行格式转换的过程；&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;首先将LC-MS原始下机数据&lt;code&gt;.raw&lt;/code&gt;格式转换为开源的&lt;code&gt;.mzxml&lt;/code&gt;格式的文件，然后读取进来，然后通过&lt;code&gt;massprocesser::process_data()&lt;/code&gt;对原始数据进行&lt;code&gt;peak picking and grouping&lt;/code&gt;, 获得高可信的特征峰（features），这里定义为&lt;code&gt;variable&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;这些&lt;code&gt;variable&lt;/code&gt;的一级质谱信息&lt;code&gt;m/z&lt;/code&gt;(质荷比)，&lt;code&gt;rt&lt;/code&gt;(保留时间)被记录在&lt;code&gt;variable_info&lt;/code&gt;表格中，而根据&lt;code&gt;m/z&lt;/code&gt; &lt;code&gt;rt&lt;/code&gt;, 这些variable被赋予了例如&lt;code&gt;M92T430_NEG&lt;/code&gt;的id，代表该代谢的质荷比为92, 保留时间为430，检出模式为负离子模式；&lt;/li&gt;
&lt;li&gt;此外，根据提峰结果，从不同样本中提取这些variable的峰面积值，这样就形成了一个不同样本中代谢物的积累矩阵，纵向为variable_id, 横向为样本的名称，这个代谢物积累矩阵被称为&lt;code&gt;expression data&lt;/code&gt;；&lt;/li&gt;
&lt;li&gt;同时tidymass还会提供一个初始化的&lt;code&gt;sample_info&lt;/code&gt;，也就是样本信息表，默认的包含了4个主要（必要）的元素，样本名称&lt;code&gt;sample_id&lt;/code&gt;,&lt;code&gt;injection order&lt;/code&gt;,&lt;code&gt;class&lt;/code&gt;,&lt;code&gt;group&lt;/code&gt;; 这些在后续会详细说明；&lt;/li&gt;
&lt;li&gt;接下来，通过&lt;code&gt;.mgf&lt;/code&gt;格式的文件将捕获到的&lt;code&gt;ms2 spectra&lt;/code&gt;信息读取进来，通过比对代谢物&lt;code&gt;m/z&lt;/code&gt;信息和&lt;code&gt;MS2 spectra&lt;/code&gt;中的&lt;code&gt;precursor ion&lt;/code&gt;信息以及&lt;code&gt;rt&lt;/code&gt;信息，通过一定的阈值进行过滤筛选，最终给第一步提峰结果获得的&lt;code&gt;variables&lt;/code&gt;填匹配的&lt;code&gt;MS2&lt;/code&gt;信息;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;下面是一个feature的MS2信息，&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;BEGIN IONS
TITLE=QC_01.500.500. ## 该feature的ID
RTINSECONDS=60.242274 ## 保留时间（秒）
PEPMASS=146.044738769531 113043348.585899993777  ##（precursor 质荷比 | Intensity）
51.51658919 2715.7590332031  ## 以下为碎裂片段的质荷比和Intensity
57.03285633 7999.3442382813
59.0122181 7026.62109375
61.98706248 182087.59375
70.4917399 4920.7504882813
71.01212618 3894.3942871094
74.02344975 9476.15234375
82.02797575 2661.8305664063
84.04428931 7634.880859375
85.02770882 14845.5263671875
87.00760154 13859.4775390625
98.02348564 4059.72265625
102.0547299 323569.375
103.0582669 9390.1201171875
128.0340961 135462.1875
129.0372687 9628.765625
146.0448944 58732.953125
146.6037865 2932.517578125
147.0289467 7400.3515625
155.2126706 2777.9907226563
160.1064809 2709.7451171875
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;在上集中我们准备好metadata, 组织好数据结构，设置好工作路径后准备将原始数据导入MetMiner，如下图：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;选则MS1和MS2文件路径；&lt;/li&gt;
&lt;li&gt;点击&lt;code&gt;Check input file&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;在MS file check页面检查输入文件统计和列表，看是否有遗漏或者错误文件，对应修改，比如有文件名不符合我们上篇提到的不符合命名规则以及和sample_info表格中不一致的，要做到统一；&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407131037694.png&#34; alt=&#34;输入文件检查&#34; loading=&#34;lazy&#34;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;点击&lt;code&gt;Peak picking&lt;/code&gt;页面，在parameter setting下面的&lt;code&gt;Show | Hide&lt;/code&gt;, 在左边可以弹出提峰参数选择的选项卡，进行提峰参数选择，如果对参数不熟悉，可以点击&lt;code&gt;Show | Hide&lt;/code&gt;下面的连接到&lt;code&gt;XCMS&lt;/code&gt;和&lt;code&gt;tidyMass&lt;/code&gt;网站了解具体参数意义，根据实际情况进行参数选择；&lt;/li&gt;
&lt;li&gt;运行过程中在右下方会有一个progress bar，提醒提峰运行步骤，运行完毕，下面会有提峰结果自动保存路径和参数记录；&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407131052692.png&#34; alt=&#34;开始提峰&#34; loading=&#34;lazy&#34;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;-------------------- 
massdataset version: 1.0.29 
-------------------- 
1.expression_data:[ 4132 x 10 data.frame]
2.sample_info:[ 10 x 4 data.frame]
10 samples:QC_01 QC_02 QC_03 ... S_03 S_04
3.variable_info:[ 4132 x 3 data.frame]
4132 variables:M70T62_POS M70T72_POS M70T921_POS ... M1031T354_POS M1031T353_POS
4.sample_info_note:[ 4 x 2 data.frame]
5.variable_info_note:[ 3 x 2 data.frame]
6.ms2_data:[ 1322 variables x 1207 MS2 spectra]
-------------------- 
Processing information
3 processings in total
create_mass_dataset ---------- 
      Package         Function.used                Time
1 massdataset create_mass_dataset() 2024-07-13 10:51:07
process_data ---------- 
        Package Function.used                Time
1 massprocesser  process_data 2024-07-13 10:49:36
mutate_ms2 ---------- 
      Package Function.used                Time
1 massdataset  mutate_ms2() 2024-07-13 10:52:39
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;在完成从原始数据导入后，我们可以在mass_dataset information界面查看到目前质谱数据的状态。这里也直接显示了提峰结果，例如在正离子模式下，&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;expression_data&lt;/code&gt;: 表达量表格，我们获得了4132个代谢物，共有10个sample(包括QC样本)；&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sample_info&lt;/code&gt;: 样本信息，包含了10个样本，共有4列信息，包含了&lt;br&gt;
a. &lt;code&gt;sample_id&lt;/code&gt; 样本id;&lt;br&gt;
b. &lt;code&gt;injection.order&lt;/code&gt; 上样顺序；&lt;br&gt;
c. &lt;code&gt;class&lt;/code&gt; 样本分类，分为&lt;code&gt;QC&lt;/code&gt;和&lt;code&gt;Subject&lt;/code&gt;,说明样本属性，QC代表QC样本，Subject代表测试样本；&lt;br&gt;
d. &lt;code&gt;group&lt;/code&gt; 样本分组，和前一篇文章提到的一样，这里代表样本的分组，比如case， control，该信息比较重要，是后续噪音去除，PCA，差异分析等的重要依赖信息。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;variable_info&lt;/code&gt; 代谢物信息表, 包含4132个代谢物和3列信息：&lt;br&gt;
a. &lt;code&gt;variable_id&lt;/code&gt; 代谢物id，一般是MxxxTxxx，就是该代谢物的m/z+rt;&lt;br&gt;
b. &lt;code&gt;m/z&lt;/code&gt; 质荷比，单位为道尔顿;&lt;br&gt;
c. &lt;code&gt;rt&lt;/code&gt; 保留时间，单位为秒&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sample_info_note&lt;/code&gt; 就是介绍&lt;code&gt;sample_info&lt;/code&gt;表格中每列的含义；&lt;/li&gt;
&lt;li&gt;&lt;code&gt;variable_info_note&lt;/code&gt; 同样，介绍&lt;code&gt;variable_info&lt;/code&gt;表格中每列的含义；&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ms2_data&lt;/code&gt; 代谢物的ms2信息存储，只有通过&lt;code&gt;mutate_ms2()&lt;/code&gt;将&lt;code&gt;peak picking and grouping&lt;/code&gt;得到的feature和从&lt;code&gt;.mgf&lt;/code&gt;文件中得到的&lt;code&gt;ms2 spectra&lt;/code&gt;进行匹配，只有质荷比和保留时间均符合我们设定的tolerance时，才会匹配成功；&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;从原提峰表格导入&#34;&gt;从原提峰表格导入&lt;/h2&gt;
&lt;p&gt;有时候，我们也会从一些经典的提峰软件，比如&lt;code&gt;xcms&lt;/code&gt;,&lt;code&gt;CD&lt;/code&gt;,&lt;code&gt;mzmine&lt;/code&gt;,&lt;code&gt;MS-DIAL&lt;/code&gt;等软件获得代谢物积累矩阵表格，那么，我们也可以从提峰表格导入&lt;code&gt;metMiner&lt;/code&gt;进行下游分析，这里我们需要从这些提峰软件导出提峰结果中的variable_info 和 expression data两个表格，然后合并成一个表格。如下图：&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202403201018539.png&#34; alt=&#34;peak picking table&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
&lt;code&gt;metMiner&lt;/code&gt;要求将正负谱检出结果合并到一个表格中，除了&lt;code&gt;variable_id&lt;/code&gt;,&lt;code&gt;mz&lt;/code&gt;,&lt;code&gt;rt&lt;/code&gt;外，还需要加入&lt;code&gt;ion&lt;/code&gt;,这里可以是&lt;code&gt;+ -&lt;/code&gt;,也可以是&lt;code&gt;pos neg&lt;/code&gt;,或者&lt;code&gt;positive negative&lt;/code&gt;，软件会自动判断；同时，还需要将原始数据转换过的&lt;code&gt;.mgf&lt;/code&gt;文件也准备好，后续同样会进行匹配；&lt;/p&gt;
&lt;p&gt;整个数据导入过程如下图：&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407261551466.png&#34; alt=&#34;从提峰表格导入&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;同样，我们设置了&lt;code&gt;variable_info&lt;/code&gt; 表格审查，如果你上传的表格中&lt;code&gt;variable_id&lt;/code&gt;,&lt;code&gt;mz&lt;/code&gt;,&lt;code&gt;rt&lt;/code&gt;,&lt;code&gt;ion&lt;/code&gt;的列名或者顺序和&lt;code&gt;demo&lt;/code&gt;中不一致，需要在这里对应的调整；确保无误，同时上传了&lt;code&gt;MS2&lt;/code&gt;文件路径后点击&lt;code&gt;1. Input file summary&lt;/code&gt;后，会弹出数据核对信息⑤，variable_info⑥以及Accumulation profile⑦，确保这些信息都无误后，点击&lt;code&gt;2.Generate massdataset object&lt;/code&gt;来将质谱数据格式转换为&lt;code&gt;mass_dataset&lt;/code&gt; class，此时右下角会出现进度条，这时主要是进行&lt;code&gt;MS2 spectra&lt;/code&gt;的匹配; 完成后在&lt;code&gt;Mass_dataset information&lt;/code&gt;选项卡中查看mass_dataset打印的信息。&lt;/p&gt;
&lt;h2 id=&#34;从mass_dataset导入&#34;&gt;从mass_dataset导入&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;Tidymass project&lt;/code&gt;最大的优点就是质谱数据处理的&lt;strong&gt;可重复性、透明性、可追溯性&lt;/strong&gt;，前面我们通过&lt;code&gt;mass_dataset&lt;/code&gt; class的内容就可以体会到&lt;code&gt;透明性、可追溯性&lt;/code&gt;，这里从mass_dataset导入也是&lt;code&gt;MetMiner&lt;/code&gt;实现可重复性的一种手段。在协作，或者重复已发表数据时，质谱数据已经经过依赖于&lt;code&gt;tidymass&lt;/code&gt;的流程处理获得了&lt;code&gt;mass_dataset&lt;/code&gt; class类型的质谱数据，我们可以直接加载前人分析的结果重新分析，或者继续下游分析，整个数据导入过程更加简单，只需要获得从R中导入的mass_dataset对象即可，这里我们一般会通过例如&lt;code&gt;save(object_neg, &amp;quot;object_neg.rda&amp;quot;)&lt;/code&gt;将数据保存为&lt;code&gt;.rda&lt;/code&gt;格式，整个操作过程如下图。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407131740385.png&#34; alt=&#34;从mass_dataset导入&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;这里需要提醒的是，如果ms2信息在之前的分析中没有添加，才需要再这里上传&lt;code&gt;.mgf&lt;/code&gt;文件，如果已经包含，则不需要再次上传；&lt;/p&gt;
&lt;p&gt;---The end---&lt;br&gt;
Jul 26, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;
">「MetMiner」数据导入</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/metminer-fei-ba-dai-xie-zu-shu-ju-zhun-bei-he-xiang-mu-chu-shi-hua/"" data-c="
          &lt;p&gt;MetMiner流程整合了mass_dataset数据输入格式，所以具有灵活多变的数据输入模式，本文介绍了通过metMiner进行代谢组数据分析前的数据准备及项目初始化工作。&lt;/p&gt;
&lt;p&gt;主要从一下几方面说明：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Metadata准备（实验数据管理及样本命名规则）；&lt;/li&gt;
&lt;li&gt;原始数据格式转换和文件结构（从原始数据导入）；&lt;/li&gt;
&lt;li&gt;提峰表格准备（从其它软件提峰表格导入）；&lt;/li&gt;
&lt;li&gt;mass_dataset准备（从mass_dataset类型数据导入）；&lt;/li&gt;
&lt;/ol&gt;
&lt;!--more--&gt;
&lt;h1 id=&#34;1-实验数据准备和样本命名规则&#34;&gt;1. 实验数据准备和样本命名规则&lt;/h1&gt;
&lt;p&gt;为了对接&lt;code&gt;MetMiner&lt;/code&gt;分析流程，在实验时候需要严格遵守样本命名规则，这样后续的分析流程才会顺畅，不容易报错。&lt;/p&gt;
&lt;p&gt;原因是在数据处理时，样本名称有时候会被当做&lt;code&gt;row names &lt;/code&gt;或者 &lt;code&gt;column names&lt;/code&gt;，在用bash脚本或者R语言处理文件时，一些特殊符号会造成报错，而我们又不可能耗费巨大的经理去写海量的判断语句来甄别这些错误，所以我们在数据分析流程端采用特定的命名规则，通过&lt;code&gt;meta data&lt;/code&gt;来规范样本名称。&lt;/p&gt;
&lt;p&gt;规范化的元数据记录可以帮助我们更好的管理数据。&lt;/p&gt;
&lt;h2 id=&#34;11-准备元数据meta-data&#34;&gt;1.1 准备元数据（meta data）&lt;/h2&gt;
&lt;p&gt;元数据表格一般包含以下内容&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;原始样本名称(sample name raw)&lt;/strong&gt;: 这个是实验前期对于采样样本的原始命名，例如&lt;code&gt;col0-leaf-1 max2-leaf-1&lt;/code&gt;，这个按照自己的理解以及一定的命名规则对各个样本进行标记，这里不做要求，但尽量避免用中文，因为可能有些机器在处理中文字符时可能出现乱码；&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;样本类型(class)&lt;/strong&gt;: QC样本标记为大写的**&lt;code&gt;QC&lt;/code&gt;&lt;strong&gt;，测试样本标记为&lt;/strong&gt;&lt;code&gt;Subject&lt;/code&gt;**，S大写；&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;规范样本id(sample_id)&lt;/strong&gt;：这个id是我们在数据处理时对样本的编码，需要遵循以下规则：
&lt;ul&gt;
&lt;li&gt;对于QC（quality control）样本，以大写的**&lt;code&gt;&amp;quot;QC_&amp;quot;&lt;/code&gt;**开头，&lt;/li&gt;
&lt;li&gt;对于测试（Subject）样本，以大写的**&lt;code&gt;&amp;quot;S_&amp;quot;&lt;/code&gt;**开头，&lt;/li&gt;
&lt;li&gt;数字编号补齐：&lt;code&gt;QC_&lt;/code&gt;或者&lt;code&gt;S_ &lt;/code&gt;后面接序号，根据QC样本的数量增加&lt;code&gt;pad 0&lt;/code&gt;，意思是如果QC的数量为两位数，那么在QC 1-9的命名需要再1-9前面添加一个0即：&lt;code&gt;QC_01&lt;/code&gt;, &lt;code&gt;QC_02&lt;/code&gt;, &lt;code&gt;QC_03&lt;/code&gt; ...， 同样如果QC样本的数量为3位数，需要在1-9前面加两个&lt;code&gt;0&lt;/code&gt;，在10-99前面加一个&lt;code&gt;0&lt;/code&gt; ，即&lt;code&gt;QC_001&lt;/code&gt;， &lt;code&gt;QC_002&lt;/code&gt;， &lt;code&gt;QC_003&lt;/code&gt;， ... &lt;code&gt;QC_010&lt;/code&gt;。原因是&lt;code&gt;QC_xx&lt;/code&gt; 在excel以及R时字符型数据，在排序时，会根据第一个检测到的数字进行排序，如果不进行补零填充，那么对QC序列进行排序时顺序会变为&lt;code&gt;QC_1&lt;/code&gt;, &lt;code&gt;QC_10&lt;/code&gt;, &lt;code&gt;QC_100&lt;/code&gt; &lt;code&gt;QC_1000&lt;/code&gt;,&lt;code&gt;QC_1001&lt;/code&gt; ,在后续可视化或者分析过程中可能会出错；同样对于Subject样本编号方式也是如此。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;样本分组(group)&lt;/strong&gt;：样本所属的组别，对于设置了生物学重复的样本，需要表明每个样本所属的组别，比如&lt;code&gt;case&lt;/code&gt;， &lt;code&gt;control&lt;/code&gt;，&lt;code&gt;treat&lt;/code&gt;，&lt;code&gt;mock&lt;/code&gt;；&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;进样顺序(injection.order)&lt;/strong&gt;: 根据样本实际上样顺序标记，这里为纯数字形式；&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;其它信息&lt;/strong&gt;：如果对样本包含的变量非常丰富，可以依次增加信息，比如 &lt;code&gt;tissue&lt;/code&gt;， &lt;code&gt;treat&lt;/code&gt;， &lt;code&gt;day&lt;/code&gt;， &lt;code&gt;gender&lt;/code&gt;，&lt;code&gt;species&lt;/code&gt; 这些信息的加入，在数据清洗及数据挖掘步骤，可以通过选择这些属性来专注这些单一变量带来的代谢水平差异。对于QC样本这里可以不标注，空着即可，也可以标注为QC。&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;2-数据准备&#34;&gt;2. 数据准备&lt;/h1&gt;
&lt;p&gt;首先介绍从LC-MS下机数据开始处理。&lt;/p&gt;
&lt;h2 id=&#34;21-选项1-原始数据格式转换&#34;&gt;2.1 选项1 - 原始数据格式转换&lt;/h2&gt;
&lt;p&gt;获得LC-MS下机数据后，需要将原始数据转换为&lt;code&gt;.mzxml&lt;/code&gt;以及&lt;code&gt;.mgf&lt;/code&gt;格式，以Thermo QE Plus下机数据为例，获得&lt;code&gt;.raw&lt;/code&gt;文件后通过&lt;a href=&#34;https://proteowizard.sourceforge.io/download.html&#34;&gt;proteowizard&lt;/a&gt;提供的msConvert进行转换。整体数据格式转换过程可以参考TidyMass提供的教程：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.tidymass.org/docs/chapter3/1-proteowizard/&#34;&gt;数据转换方法-proteowizard&lt;/a&gt;；&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.tidymass.org/docs/chapter3/2-data_convert/&#34;&gt;数据转换方法-massconverter&lt;/a&gt;;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;对于DIA采集的数据可能需要其它的软件导出.mgf文件，例如waters MSe需要通过UNIFI软件导出&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&#34;22-原始数据文件路径结构&#34;&gt;2.2 原始数据文件路径结构&lt;/h2&gt;
&lt;p&gt;我们在 1.0 的部分建议的命名规则对数据进行整理，然后按照下图整理文件，文件夹的名字也必须和图片中一致。&lt;br&gt;
&lt;strong&gt;MS1 文件结构&lt;/strong&gt;  MS1/MS2文件夹下分NEG和POS两个子文件夹，而后分别将QC和Subject的&lt;code&gt;.mzxml&lt;/code&gt;或者&lt;code&gt;.mgf&lt;/code&gt;格式的文件放到对应的文件夹下。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;MS1
├── NEG
│   ├── QC
│   └── Subject
└── POS
    ├── QC
    └── Subject
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;MS2
├── NEG
│   ├── QC
│   └── Subject
└── POS
    ├── QC
    └── Subject
&lt;/code&gt;&lt;/pre&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgoFigure01.png&#34; alt=&#34;文件结构&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;h2 id=&#34;23-选项2-原始提峰表格&#34;&gt;2.3  选项2 原始提峰表格&lt;/h2&gt;
&lt;p&gt;当我们从其它提峰软件获得提峰表格后，将feature的MS1信息以及提峰表格信息整理成下表,&lt;br&gt;
其中前4列为&lt;code&gt;variable information&lt;/code&gt; 尽量保证列名和图中一致，代谢物id，质荷比，保留时间，离子模式。后面为QC和样本中峰面积。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202403201018539.png&#34; alt=&#34;peak picking table&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;24-选项3-mass_dataset-object&#34;&gt;2.4 选项3 mass_dataset object&lt;/h2&gt;
&lt;p&gt;我们用TidyMass软件处理过数据后如果想重新分析，通过&lt;code&gt;save()&lt;/code&gt;将&lt;code&gt;mass_dataset&lt;/code&gt;数据保存为&lt;code&gt;.rda&lt;/code&gt;后缀的文件。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202406221746740.png&#34; alt=&#34;mass dataset&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;25-样品信息表-必须&#34;&gt;2.5 样品信息表 (必须)&lt;/h2&gt;
&lt;p&gt;基本和metadata中的信息一致 ，但是要注意添加了&lt;code&gt;injection.order&lt;/code&gt;和&lt;code&gt;batch&lt;/code&gt;两个信息, 这两个信息在数据清洗时用来校正系统误差。如果不确定是否存在批次效应，&lt;code&gt;batch&lt;/code&gt;可以全部填1，后续如果检查出批次效应，在回来校正该数据。&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;2&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo20240319180805.png&#34; alt=&#34;sample information&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;h1 id=&#34;3-项目初始化&#34;&gt;3. 项目初始化&lt;/h1&gt;
&lt;p&gt;首先我们需要选择一个路径（文件夹）为项目的工作目录，最好将输入数据都放到该文件夹下，同时运行过程中需要保存的数据会自动保存到该路径下。&lt;/p&gt;
&lt;p&gt;其次需要将样本信息表格上传，上传后在左侧&lt;code&gt;sidebar&lt;/code&gt;处会自动提取上传表格中的列名，如果顺序和软件默认顺序以及列名和默认列名不匹配，需要对前5列信息一一对应匹配，然后软件会校正统计表格；&lt;/p&gt;
&lt;p&gt;确认好后点击&lt;code&gt;initialize project&lt;/code&gt;项目会初始化，&lt;code&gt;file check&lt;/code&gt;会返回工作目录的路径，sample information中包含的信息。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;File check
----------------------
The working directory: /Volumes/ShawnWang/DemoHeter
The sample information: sample_id | injection.order | class | group | batch | tissue
Restart your jobs from: Start from raw data.
The mass_dataset object:
Positive file path: no old .rda file uploaded, skip this step
Nagetive file path: no old .rda file uploaded, skip this step
Annotation database: No need to upload this file, pass.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;Sample information&lt;/code&gt;部分会将初始化后的样品信息表格打印出来，详细检查下对应关系，确保没有问题，可以进行下一步。&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;3&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202406221805830.png&#34; alt=&#34;项目初始化&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;---The end---&lt;br&gt;
Jun 22, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;
">「MetMiner」非靶代谢组数据准备和项目初始化</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/tbtools-plugin-you-shou-jiu-xing-rang-gpt4-gei-ni-xie-ge-shinyapp-shi-xian-wen-jian-he-bing/"" data-c="
          &lt;p&gt;突然有个需求，然后花了差不多半个小时指挥GPT4干完了... 说实话，这效率也太快了，要是让我从头手打，估计要折腾一下午。&lt;/p&gt;
&lt;p&gt;这篇博客就记录下如何和GPT打配合搞定ShinyApp，并且通过CLI program wapper creator工具将shinyapp制作成插件分享给大家。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h1 id=&#34;省流版本工具使用&#34;&gt;省流版本（工具使用）&lt;/h1&gt;
&lt;h2 id=&#34;需求&#34;&gt;需求&lt;/h2&gt;
&lt;p&gt;在磕盐（ban zhuan）的过程中难免会遇到合并表格这种破事，比如你拿到了几百个基因，想去找他的注释，看表达量，当然可以通过vlookup等操作可以实现，但是遇到一对多的情况就比较捉🐔了，R语言的dplyr包提供了join系列函数来通过不同的方式连接两个表格，相当方便，博士期间为了搞定表格合并的问题整的人都快头秃了，所以我相信这一定会是一个重要的需求，不如通过shinyapp实现。简单的通过上传文件，选择连接方式，下载合并后的表格。&lt;/p&gt;
&lt;h2 id=&#34;连接方式解释&#34;&gt;连接方式解释&lt;/h2&gt;
&lt;p&gt;感觉文字是苍白的，&lt;a href=&#34;https://www.garrickadenbuie.com/&#34;&gt;Garrick Aden-Buie&lt;/a&gt; 大佬搞了个动态图来解释左连接（left join），右连接（right join），全连接（full join），半连接（semi join），内连接（inner join）和反连接（anti join）的解释，这个.... 再看不懂说不过去了吧....&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309190932854.gif&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;下载和使用&#34;&gt;下载和使用&lt;/h2&gt;
&lt;h3 id=&#34;下载&#34;&gt;下载&lt;/h3&gt;
&lt;p&gt;目前还没登录TBtools插件商店，后续CJ会搞上去，安装方法就是在插件商店找到&lt;code&gt;File-Join ShinyApp&lt;/code&gt;插件，会定位到牛奶快传，下载安装。目前迫不及待想体验的可以去github下载，windows用户下载&lt;code&gt;FileJoin-win.plugin&lt;/code&gt;, intel mac用户下载&lt;code&gt;filejoin.plugin&lt;/code&gt;, arm mac用户再等等吧... 或者直接通过Rstudio启动。&lt;/p&gt;
&lt;h3 id=&#34;运行&#34;&gt;运行&lt;/h3&gt;
&lt;p&gt;使用很简单，运行插件弹出网页后，根据下图上传文件，设置参数直接会获得表格... 没啥门槛，上传表格后，程序会自动获得文件的列名，分别选择两个文件中用来查找的列名，然后选择合并方式进行合并，如果忘了，左侧选项卡还有对不同类型join的解释。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Soure file demo&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;GeneID&lt;/th&gt;
&lt;th&gt;Sample_01&lt;/th&gt;
&lt;th&gt;Sample_02&lt;/th&gt;
&lt;th&gt;Sample_03&lt;/th&gt;
&lt;th&gt;Sample_04&lt;/th&gt;
&lt;th&gt;Sample_05&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Gene_001&lt;/td&gt;
&lt;td&gt;312&lt;/td&gt;
&lt;td&gt;214&lt;/td&gt;
&lt;td&gt;406&lt;/td&gt;
&lt;td&gt;616&lt;/td&gt;
&lt;td&gt;289&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_002&lt;/td&gt;
&lt;td&gt;465&lt;/td&gt;
&lt;td&gt;180&lt;/td&gt;
&lt;td&gt;422&lt;/td&gt;
&lt;td&gt;605&lt;/td&gt;
&lt;td&gt;994&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_003&lt;/td&gt;
&lt;td&gt;687&lt;/td&gt;
&lt;td&gt;658&lt;/td&gt;
&lt;td&gt;276&lt;/td&gt;
&lt;td&gt;218&lt;/td&gt;
&lt;td&gt;53&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_004&lt;/td&gt;
&lt;td&gt;369&lt;/td&gt;
&lt;td&gt;215&lt;/td&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;691&lt;/td&gt;
&lt;td&gt;155&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_005&lt;/td&gt;
&lt;td&gt;903&lt;/td&gt;
&lt;td&gt;215&lt;/td&gt;
&lt;td&gt;887&lt;/td&gt;
&lt;td&gt;203&lt;/td&gt;
&lt;td&gt;777&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_006&lt;/td&gt;
&lt;td&gt;154&lt;/td&gt;
&lt;td&gt;240&lt;/td&gt;
&lt;td&gt;162&lt;/td&gt;
&lt;td&gt;272&lt;/td&gt;
&lt;td&gt;823&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_007&lt;/td&gt;
&lt;td&gt;35&lt;/td&gt;
&lt;td&gt;553&lt;/td&gt;
&lt;td&gt;739&lt;/td&gt;
&lt;td&gt;505&lt;/td&gt;
&lt;td&gt;248&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_008&lt;/td&gt;
&lt;td&gt;10&lt;/td&gt;
&lt;td&gt;946&lt;/td&gt;
&lt;td&gt;306&lt;/td&gt;
&lt;td&gt;946&lt;/td&gt;
&lt;td&gt;658&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_009&lt;/td&gt;
&lt;td&gt;359&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;346&lt;/td&gt;
&lt;td&gt;484&lt;/td&gt;
&lt;td&gt;757&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_010&lt;/td&gt;
&lt;td&gt;277&lt;/td&gt;
&lt;td&gt;181&lt;/td&gt;
&lt;td&gt;493&lt;/td&gt;
&lt;td&gt;636&lt;/td&gt;
&lt;td&gt;409&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_011&lt;/td&gt;
&lt;td&gt;588&lt;/td&gt;
&lt;td&gt;688&lt;/td&gt;
&lt;td&gt;956&lt;/td&gt;
&lt;td&gt;51&lt;/td&gt;
&lt;td&gt;463&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_012&lt;/td&gt;
&lt;td&gt;502&lt;/td&gt;
&lt;td&gt;30&lt;/td&gt;
&lt;td&gt;105&lt;/td&gt;
&lt;td&gt;905&lt;/td&gt;
&lt;td&gt;42&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_013&lt;/td&gt;
&lt;td&gt;595&lt;/td&gt;
&lt;td&gt;41&lt;/td&gt;
&lt;td&gt;55&lt;/td&gt;
&lt;td&gt;838&lt;/td&gt;
&lt;td&gt;600&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_014&lt;/td&gt;
&lt;td&gt;66&lt;/td&gt;
&lt;td&gt;64&lt;/td&gt;
&lt;td&gt;524&lt;/td&gt;
&lt;td&gt;726&lt;/td&gt;
&lt;td&gt;355&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;Probe file demo&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Probe&lt;/th&gt;
&lt;th&gt;Type&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Gene_001&lt;/td&gt;
&lt;td&gt;case&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_005&lt;/td&gt;
&lt;td&gt;case&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_006&lt;/td&gt;
&lt;td&gt;case&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_007&lt;/td&gt;
&lt;td&gt;case&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_008&lt;/td&gt;
&lt;td&gt;case&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_012&lt;/td&gt;
&lt;td&gt;case&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_013&lt;/td&gt;
&lt;td&gt;case&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_014&lt;/td&gt;
&lt;td&gt;case&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_015&lt;/td&gt;
&lt;td&gt;case&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_016&lt;/td&gt;
&lt;td&gt;case&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_017&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_018&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_019&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_020&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_021&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_022&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_023&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_024&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_025&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_026&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_027&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_028&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_029&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Gene_030&lt;/td&gt;
&lt;td&gt;control&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;start your job&lt;/strong&gt;&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309190947552.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;可以通过右侧预览合并结果。通过下载按钮下载合并文件，默认导出.csv格式。&lt;/p&gt;
&lt;h1 id=&#34;开发篇&#34;&gt;开发篇&lt;/h1&gt;
&lt;h2 id=&#34;让gpt给你写shiny&#34;&gt;让GPT给你写shiny&lt;/h2&gt;
&lt;h3 id=&#34;写初步框架&#34;&gt;写初步框架&lt;/h3&gt;
&lt;p&gt;有手就行有点夸张了，GPT虽然智能，但也很智障，灵活运用会提高干活的效率，所以这里有手就行的前提是你对shinyapp的开发已经有了一些了解。&lt;/p&gt;
&lt;p&gt;比如在让这货写代码之前，脑子里已经有了UI大致的结构，所以我告诉他：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;写一个shiny插件，主要是用来做表格合并，数据导入用bruceR的import函数，需要两个输入数据框，输入文件大小控制在2GB，UI界面为一个tabPanel，sidesidebar中放置两个上传文件的组间，接着是两个selectInput，selectInput内容需要通过类似&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt; observe({
    updateSelectInput(session, &amp;quot;outlier&amp;quot;,choices = s_outlier())
  })
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;根据输入文件的colname来提供选项，作用是在上传文件后自动获得文件的列名。&lt;br&gt;
然后用户通过选择两个的列名，根据两个文件的这两列通过dplyr join系列函数进行合并，最后在mainPanel中通过renderDataTable预览结果，并且通过download下载。&lt;/p&gt;
&lt;p&gt;它很快给出了整体的框架，但是运行后发现他造了个不存在的参数, 就是需求中让限制上传文件大小的代码正确的应该是&lt;br&gt;
&lt;code&gt;options(shiny.maxRequestSize = 300*1024^2)&lt;/code&gt;&lt;br&gt;
而&lt;code&gt; fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE, sizeLimit = 2*1024^3)&lt;/code&gt;中的 sizeLimit 参数并不存在。这需要修改下。 下面是它给的代码最终修改版本，也跳网页了，说明能用 就是丑了点。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;library(shiny)
library(DT)
library(bruceR)
library(dplyr)
options(shiny.maxRequestSize = 300*1024^2)
ui &amp;lt;- fluidPage(
  tabsetPanel(
    tabPanel(&amp;quot;数据合并&amp;quot;,
             sidebarLayout(
               sidebarPanel(
                 # fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE, sizeLimit = 2*1024^3), ## sizeLimit参数不存在
                 # fileInput(&amp;quot;file2&amp;quot;, &amp;quot;选择第二个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE, sizeLimit = 2*1024^3),
                 fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),
                 fileInput(&amp;quot;file2&amp;quot;, &amp;quot;选择第二个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),
                 selectInput(&amp;quot;select1&amp;quot;, &amp;quot;选择第一个文件的列&amp;quot;, &amp;quot;&amp;quot;),
                 selectInput(&amp;quot;select2&amp;quot;, &amp;quot;选择第二个文件的列&amp;quot;, &amp;quot;&amp;quot;)
               ),
               mainPanel(
                 DTOutput(&amp;quot;table&amp;quot;),
                 downloadButton(&amp;quot;downloadData&amp;quot;, &amp;quot;下载合并的数据&amp;quot;)
               )
             )
    )
  )
)

server &amp;lt;- function(input, output, session) {
  data1 &amp;lt;- reactive({
    req(input$file1)
    import(input$file1$datapath)
  })
  
  data2 &amp;lt;- reactive({
    req(input$file2)
    import(input$file2$datapath)
  })
  
  observe({
    updateSelectInput(session, &amp;quot;select1&amp;quot;, choices = names(data1()))
  })
  
  observe({
    updateSelectInput(session, &amp;quot;select2&amp;quot;, choices = names(data2()))
  })
  
  # merged_data &amp;lt;- reactive({
  #   req(input$select1, input$select2)
  #  left_join(data1(), data2(), by = c(input$select1 = input$select2))
  #   
  # })
  merged_data &amp;lt;- reactive({
    req(input$select1, input$select2)
    left_join(data1(), data2(), by = setNames(input$select2, input$select1))
  })

  
  output$table &amp;lt;- renderDT({
    merged_data()
  })
  
  output$downloadData &amp;lt;- downloadHandler(
    filename = function() {
      paste(&amp;quot;merged_data.csv&amp;quot;)
    },
    content = function(file) {
      write.csv(merged_data(), file)
    }
  )
}

shinyApp(ui = ui, server = server)
&lt;/code&gt;&lt;/pre&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;2&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309191004965.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;但是我们发现他没有理解我的意思，默认的只用了left join，所以我又让他加上其他类型的，然后在加上一个action button来执行。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;User 增加一个selectInput，合并方式，分为left ，right，inner，full，semi，默认为left，然后增加一个action button，参数设置好在显示表格。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这次它没有出问题，添加了action button，而且在切换不同方法的时候聪明的使用了&lt;code&gt;switch&lt;/code&gt;函数。我也偷学了一招。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;library(shiny)
library(DT)
library(bruceR)
library(dplyr)
options(shiny.maxRequestSize = 300*1024^2)

ui &amp;lt;- fluidPage(
  tabsetPanel(
    tabPanel(&amp;quot;数据合并&amp;quot;,
             sidebarLayout(
               sidebarPanel(
                 fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),
                 fileInput(&amp;quot;file2&amp;quot;, &amp;quot;选择第二个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),
                 selectInput(&amp;quot;select1&amp;quot;, &amp;quot;选择第一个文件的列&amp;quot;, &amp;quot;&amp;quot;),
                 selectInput(&amp;quot;select2&amp;quot;, &amp;quot;选择第二个文件的列&amp;quot;, &amp;quot;&amp;quot;),
                 selectInput(&amp;quot;joinType&amp;quot;, &amp;quot;选择合并方式&amp;quot;, choices = c(&amp;quot;left&amp;quot;, &amp;quot;right&amp;quot;, &amp;quot;inner&amp;quot;, &amp;quot;full&amp;quot;, &amp;quot;semi&amp;quot;), selected = &amp;quot;left&amp;quot;),
                 actionButton(&amp;quot;mergeBtn&amp;quot;, &amp;quot;合并数据&amp;quot;)
               ),
               mainPanel(
                 DTOutput(&amp;quot;table&amp;quot;),
                 downloadButton(&amp;quot;downloadData&amp;quot;, &amp;quot;下载合并的数据&amp;quot;)
               )
             )
    )
  )
)

server &amp;lt;- function(input, output, session) {
  data1 &amp;lt;- reactive({
    req(input$file1)
    import(input$file1$datapath)
  })
  
  data2 &amp;lt;- reactive({
    req(input$file2)
    import(input$file2$datapath)
  })
  
  observe({
    updateSelectInput(session, &amp;quot;select1&amp;quot;, choices = names(data1()))
  })
  
  observe({
    updateSelectInput(session, &amp;quot;select2&amp;quot;, choices = names(data2()))
  })
  
  merged_data &amp;lt;- eventReactive(input$mergeBtn, {
    req(input$select1, input$select2, input$joinType)
    switch(input$joinType,
           &amp;quot;left&amp;quot; = left_join(data1(), data2(), by = setNames(input$select2, input$select1)),
           &amp;quot;right&amp;quot; = right_join(data1(), data2(), by = setNames(input$select2, input$select1)),
           &amp;quot;inner&amp;quot; = inner_join(data1(), data2(), by = setNames(input$select2, input$select1)),
           &amp;quot;full&amp;quot; = full_join(data1(), data2(), by = setNames(input$select2, input$select1)),
           &amp;quot;semi&amp;quot; = semi_join(data1(), data2(), by = setNames(input$select2, input$select1))
    )
  })
  
  output$table &amp;lt;- renderDT({
    req(merged_data())
    merged_data()
  })
  
  output$downloadData &amp;lt;- downloadHandler(
    filename = function() {
      paste(&amp;quot;merged_data.csv&amp;quot;)
    },
    content = function(file) {
      write.csv(merged_data(), file)
    }
  )
}

shinyApp(ui = ui, server = server)

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;基本上没问题了，其实到这里就完全OK了，也好用，就是有点丑。所以我后续有加了一些要求&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;3&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309191010809.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;h3 id=&#34;进阶美化&#34;&gt;进阶美化&lt;/h3&gt;
&lt;p&gt;首先我记得之前在学tidyverse的时候看到过join的动画，当时看了半天书没整明白一个gif图给我搞明白了，但是找不到了，就开了联网插件让他帮忙找了下，果然效率很高找到了大佬的github，然后就开始让&lt;br&gt;
它搞定app终极形态。&lt;/p&gt;
&lt;p&gt;首先让他将UI转换为dashboard。而且我手动的加上了依赖检测和安装的代码，并且添加了说明的链接。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;改下成shinydashboard风格，Gally中链接tidyexplain中对应的动画图片&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;# 检查依赖 --------------------------------------------------------------------
options(&amp;quot;repos&amp;quot; = c(CRAN=&amp;quot;https://mirrors.tuna.tsinghua.edu.cn/CRAN/&amp;quot;))
if (!require(&amp;quot;DT&amp;quot;)) install.packages(&#39;DT&#39;);
if (!require(&amp;quot;bruceR&amp;quot;)) install.packages(&#39;bruceR&#39;);
if (!require(&amp;quot;shiny&amp;quot;)) install.packages(&#39;shiny&#39;);
if (!require(&amp;quot;dplyr&amp;quot;)) install.packages(&#39;dplyr&#39;);
if (!require(&amp;quot;shinydashboard&amp;quot;)) install.packages(&#39;shinydashboard&#39;);
library(shiny)
library(DT)
library(bruceR)
library(dplyr)
library(shinydashboard)

# 设置输入文件大小限制 --------------------------------------------------------------
options(shiny.maxRequestSize = 300*1024^2)

# 前端代码 --------------------------------------------------------------------
ui &amp;lt;- dashboardPage(
  dashboardHeader(title = &amp;quot;数据合并工具&amp;quot;),
  dashboardSidebar(
    sidebarMenu(
      menuItem(&amp;quot;数据合并&amp;quot;, tabName = &amp;quot;merge&amp;quot;, icon = icon(&amp;quot;database&amp;quot;))
    )
  ),
  dashboardBody(
    tabItems(
      tabItem(tabName = &amp;quot;merge&amp;quot;,
              fluidRow(
                box(
                  title = &amp;quot;文件上传与设置&amp;quot;,
                  fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),
                  fileInput(&amp;quot;file2&amp;quot;, &amp;quot;选择第二个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),
                  selectInput(&amp;quot;select1&amp;quot;, &amp;quot;选择第一个文件的列&amp;quot;, &amp;quot;&amp;quot;),
                  selectInput(&amp;quot;select2&amp;quot;, &amp;quot;选择第二个文件的列&amp;quot;, &amp;quot;&amp;quot;),
                  selectInput(&amp;quot;joinType&amp;quot;, &amp;quot;选择合并方式&amp;quot;, choices = c(&amp;quot;left&amp;quot;, &amp;quot;right&amp;quot;, &amp;quot;inner&amp;quot;, &amp;quot;full&amp;quot;, &amp;quot;anti&amp;quot;), selected = &amp;quot;left&amp;quot;),
                  actionButton(&amp;quot;mergeBtn&amp;quot;, &amp;quot;合并数据&amp;quot;)
                ),
                box(
                  title = &amp;quot;合并结果&amp;quot;,
                  dataTableOutput(&amp;quot;table&amp;quot;),
                  htmlOutput(&amp;quot;linkDescription&amp;quot;),
                  downloadButton(&amp;quot;downloadData&amp;quot;, &amp;quot;下载合并的数据&amp;quot;)
                ),
                box(
                  title = &amp;quot;连接方式图解&amp;quot;,
                  width = 12,
                  tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/master/images/join-inner.gif&amp;quot;, width = &amp;quot;100%&amp;quot;)
                )
              )
      )
    )
  )
)

# 后端代码 --------------------------------------------------------------------
server &amp;lt;- function(input, output, session) {
  # ... [保持server部分代码不变]
}

shinyApp(ui = ui, server = server)

&lt;/code&gt;&lt;/pre&gt;
&lt;blockquote&gt;
&lt;p&gt;这里的主要变化是：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;使用shinydashboard的dashboardPage, dashboardHeader, dashboardSidebar, 和 dashboardBody来创建一个dashboard风格的UI。&lt;br&gt;
在Gallery部分，我链接了tidyexplain项目中的inner_join动画图片作为示例。您可以根据需要更改或添加其他图片。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;请确保您的Shiny应用程序目录中没有其他与这些动画图片同名的文件，否则可能会出现冲突。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;4&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309191018733.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;和我想象中的不太一样，我想的是左边有两个选项卡，一个操作，一个帮助，而且图还挂了... 应该是连接搞错了。所以继续指挥：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;UI改下，shinydashboar中sidebarMenu中设置两个tag，一个为数据合并，另一个为合并方式说明，文件上传于设置的box宽度窄一些，大部分留给合并结果的box，链接方式图解制作成一个3*2的box，加入semi_join, 声明来源github地址。删除htmlOutput(&amp;quot;linkDescription&amp;quot;)相关信息&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这次没有啥问题了，除了最终我手动改了下连接和box的宽度,最终自动跳网页。完全成型了，达到了开始我脑补的效果，无论是从UI还是功能。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;# 检查依赖 --------------------------------------------------------------------
options(&amp;quot;repos&amp;quot; = c(CRAN=&amp;quot;https://mirrors.tuna.tsinghua.edu.cn/CRAN/&amp;quot;))
if (!require(&amp;quot;DT&amp;quot;)) install.packages(&#39;DT&#39;);
if (!require(&amp;quot;bruceR&amp;quot;)) install.packages(&#39;bruceR&#39;);
if (!require(&amp;quot;shiny&amp;quot;)) install.packages(&#39;shiny&#39;);
if (!require(&amp;quot;dplyr&amp;quot;)) install.packages(&#39;dplyr&#39;);
if (!require(&amp;quot;shinydashboard&amp;quot;)) install.packages(&#39;shinydashboard&#39;);
library(shiny)
library(DT)
library(bruceR)
library(dplyr)
library(shinydashboard)

# 设置输入文件大小限制 --------------------------------------------------------------
options(shiny.maxRequestSize = 300*1024^2)

# 前端代码 --------------------------------------------------------------------
ui &amp;lt;- dashboardPage(
  dashboardHeader(title = &amp;quot;数据合并工具&amp;quot;),
  dashboardSidebar(
    sidebarMenu(
      menuItem(&amp;quot;数据合并&amp;quot;, tabName = &amp;quot;merge&amp;quot;, icon = icon(&amp;quot;database&amp;quot;)),
      menuItem(&amp;quot;合并方式说明&amp;quot;, tabName = &amp;quot;explanation&amp;quot;, icon = icon(&amp;quot;info-circle&amp;quot;))
    )
  ),
  dashboardBody(
    tabItems(
      tabItem(tabName = &amp;quot;merge&amp;quot;,
              fluidRow(
                box(title = &amp;quot;文件上传与设置&amp;quot;, width = 3,
                    fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),
                    fileInput(&amp;quot;file2&amp;quot;, &amp;quot;选择第二个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),
                    selectInput(&amp;quot;select1&amp;quot;, &amp;quot;选择第一个文件的列&amp;quot;, &amp;quot;&amp;quot;),
                    selectInput(&amp;quot;select2&amp;quot;, &amp;quot;选择第二个文件的列&amp;quot;, &amp;quot;&amp;quot;),
                    selectInput(&amp;quot;joinType&amp;quot;, &amp;quot;选择合并方式&amp;quot;, choices = c(&amp;quot;left&amp;quot;, &amp;quot;right&amp;quot;, &amp;quot;inner&amp;quot;, &amp;quot;full&amp;quot;, &amp;quot;anti&amp;quot;,&amp;quot;semi&amp;quot;), selected = &amp;quot;left&amp;quot;),
                    actionButton(&amp;quot;mergeBtn&amp;quot;, &amp;quot;合并数据&amp;quot;)
                ),
                box(title = &amp;quot;合并结果&amp;quot;, width = 9,
                    dataTableOutput(&amp;quot;table&amp;quot;),
                    downloadButton(&amp;quot;downloadData&amp;quot;, &amp;quot;下载合并的数据&amp;quot;)
                )
              )
      ),
      tabItem(tabName = &amp;quot;explanation&amp;quot;,
              fluidRow(
                box(title = &amp;quot;连接方式图解&amp;quot;, width = 12,
                    tags$div(tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/inner-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;),
                             tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/left-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;),
                             tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/right-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;)
                    ),
                    tags$div(tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/full-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;),
                             tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/semi-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;),
                             tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/anti-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;)
                    ),
                    tags$div(style = &amp;quot;margin-top: 20px; text-align: center;&amp;quot;, 
                             &amp;quot;图片来源：&amp;quot;, tags$a(href = &amp;quot;https://github.com/gadenbuie/tidyexplain&amp;quot;, target = &amp;quot;_blank&amp;quot;, &amp;quot;tidyexplain GitHub项目&amp;quot;)
                    )
                )
              )
      )
    )
  )
)



# 后端代码 --------------------------------------------------------------------
server &amp;lt;- function(input, output, session) {
  data1 &amp;lt;- reactive({
    req(input$file1)
    import(input$file1$datapath)
  })
  
  data2 &amp;lt;- reactive({
    req(input$file2)
    import(input$file2$datapath)
  })
  
  observe({
    updateSelectInput(session, &amp;quot;select1&amp;quot;, choices = names(data1()))
  })
  
  observe({
    updateSelectInput(session, &amp;quot;select2&amp;quot;, choices = names(data2()))
  })
  
  merged_data &amp;lt;- eventReactive(input$mergeBtn, {
    req(input$select1, input$select2, input$joinType)
    switch(input$joinType,
           &amp;quot;left&amp;quot; = left_join(data1(), data2(), by = setNames(input$select2, input$select1)),
           &amp;quot;right&amp;quot; = right_join(data1(), data2(), by = setNames(input$select2, input$select1)),
           &amp;quot;inner&amp;quot; = inner_join(data1(), data2(), by = setNames(input$select2, input$select1)),
           &amp;quot;full&amp;quot; = full_join(data1(), data2(), by = setNames(input$select2, input$select1)),
           &amp;quot;anti&amp;quot; = anti_join(data1(), data2(), by = setNames(input$select2, input$select1)),
           &amp;quot;semi&amp;quot; = semi_join(data1(), data2(), by = setNames(input$select2, input$select1))
    )
  })

  
  output$table &amp;lt;- renderDataTable({
    req(merged_data())
    merged_data()
  })
  
  output$downloadData &amp;lt;- downloadHandler(
    filename = function() {
      paste(&amp;quot;merged_data.csv&amp;quot;)
    },
    content = function(file) {
      write.csv(merged_data(), file = file,row.names = F)
    }
  )
}

shinyApp(ui = ui, server = server,options = list(launch.browser = TRUE))

&lt;/code&gt;&lt;/pre&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;5&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309191032283.gif&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;h2 id=&#34;tbtools-插件打包&#34;&gt;TBtools 插件打包&lt;/h2&gt;
&lt;p&gt;之前要搞个shiny插件，最头疼的就是依赖，最后都要麻烦CJ来搞定，CLI program wapper creator的出现直接把难度降低成了0。太xxx6了！！！ 根据下图... 直接搞定，然后就联系CJ分享你的ShinyApp吧！&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;6&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309191027697.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
">「TBtools Plugin」有手就行，让GPT4给你写个ShinyApp实现文件合并</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/wgs_vep_snp_annotation/"" data-c="
          &lt;h1 id=&#34;背景&#34;&gt;背景&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;参考基因组： &lt;a href=&#34;https://download.maizegdb.org/B73_RefGen_v2/&#34;&gt;玉米B73_v2,数据来源-MaizeGDB&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;基因注释文件：&lt;a href=&#34;https://download.maizegdb.org/B73_RefGen_v2/ZmB73_5a.59_WGS.gff3.gz&#34;&gt;ZmB73_5a.59_WGS.gff3.gz&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;数据源：本课题自测的20个玉米的40x重测序数据。&lt;/li&gt;
&lt;/ul&gt;
&lt;!--more--&gt;
&lt;h1 id=&#34;软件安装&#34;&gt;软件安装&lt;/h1&gt;
&lt;p&gt;建议用conda新建环境安装，直接在其他环境下安装可能依赖会出问题。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# 新建一个叫vep的环境并且安装ensembl-vep
conda create -n vep -c bioconda ensembl-vep -y
# 激活环境
conda activate vep
# 测试
(vep) shawn@bio-Super-Server:~/02.project/01.maize_fatty_acid/04.result$ vep
# 如果成功会出现下面的提示
Possible precedence issue with control flow operator at /home/data/shawn/miniconda3/envs/vep/lib/site_perl/5.26.2/Bio/DB/IndexedBase.pm line 805.
#----------------------------------#
# ENSEMBL VARIANT EFFECT PREDICTOR #
#----------------------------------#

Versions:
  ensembl              : 101.856c8e8
  ensembl-funcgen      : 101.b918a49
  ensembl-io           : 101.943b6c2
  ensembl-variation    : 101.819eef2
  ensembl-vep          : 101.0

Help: dev@ensembl.org , helpdesk@ensembl.org
Twitter: @ensembl

http://www.ensembl.org/info/docs/tools/vep/script/index.html

Usage:
./vep [--cache|--offline|--database] [arguments]

Basic options
=============

--help                 Display this message and quit

-i | --input_file      Input file
-o | --output_file     Output file
--force_overwrite      Force overwriting of output file
--species [species]    Species to use [default: &amp;quot;human&amp;quot;]

--everything           Shortcut switch to turn on commonly used options. See web
                       documentation for details [default: off]
--fork [num_forks]     Use forking to improve script runtime

For full option documentation see:
http://www.ensembl.org/info/docs/tools/vep/script/vep_options.html
&lt;/code&gt;&lt;/pre&gt;
&lt;h1 id=&#34;问题与解决方案&#34;&gt;问题与解决方案&lt;/h1&gt;
&lt;p&gt;根据本次流程的搭建解决下面问题：&lt;/p&gt;
&lt;h2 id=&#34;问题1-如果物种没有被官方收录怎么做&#34;&gt;问题1 如果物种没有被官方收录怎么做&lt;/h2&gt;
&lt;p&gt;参考链接：&lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_custom.html&#34;&gt;vep custom annotation&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;VEP can integrate custom annotation from standard format  files into your results by using the &lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_custom&#34;&gt;--custom&lt;/a&gt; flag.&lt;/p&gt;
&lt;p&gt;These files may be hosted locally or remotely, with no limit to the  number or size of the files. The files must be indexed using the &lt;a href=&#34;http://samtools.sourceforge.net/tabix.shtml&#34;&gt;tabix&lt;/a&gt;  utility (BED, GFF, GTF, VCF); bigWig files contain their own indices.&lt;/p&gt;
&lt;p&gt;Annotations typically appear as key=value pairs in the Extra column of the VEP  output; they will also appear in the INFO column if using VCF format output.  The value for a particular annotation is defined as the identifier for each  feature; if not available, an identifier derived from the coordinates of the  annotation is used. Annotations will appear in each line of output for the  variant where multiple lines exist.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;通过增加&lt;code&gt;--custom&lt;/code&gt;标记来使用我们自己提供的注释文件，包括了&lt;code&gt;GFF,GTF,VCF,BED,BigWig&lt;/code&gt;等格式的文件。&lt;/p&gt;
&lt;p&gt;本次使用&lt;code&gt;.gff&lt;/code&gt;文件作为注释文件，首先需要对&lt;code&gt;.gff&lt;/code&gt;文件清洗一下，包括去掉注释行，对染色体排序，将&lt;code&gt;.gff&lt;/code&gt;文件压缩成&lt;code&gt;bgzip&lt;/code&gt;格式，最后构建&lt;code&gt;tabix&lt;/code&gt;索引&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Custom annotation files must be prepared in a particular way in order to  work with tabix and therefore with VEP. Files must be stripped of comment lines,  sorted in chromosome and position order, compressed using bgzip  and finally indexed using tabix.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# myData.gff为原始的gff文件 数据清洗过程
grep -v &amp;quot;#&amp;quot; myData.gff | sort -k1,1 -k4,4n -k5,5n -t$&#39;\t&#39; | bgzip -c &amp;gt; myData.gff.gz
# 构建索引
tabix -p gff myData.gff.gz
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;在使用的时候需要标清楚&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;./vep [...] --custom Filename , Short_name , File_type , Annotation_type , Force_report_coordinates , VCF_fields
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;这样你就可以使用多个注释文件同时对你的重测序结果进行注释了。&lt;/p&gt;
&lt;p&gt;最终的使用方法, 官方的例子：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# Compressed VCF file
curl -O ftp://ftp.ncbi.nlm.nih.gov/pub/clinvar/vcf_GRCh38/clinvar.vcf.gz
# Index file
curl -O ftp://ftp.ncbi.nlm.nih.gov/pub/clinvar/vcf_GRCh38/clinvar.vcf.gz.tbi

/vep [...] --custom clinvar.vcf.gz,ClinVar,vcf,exact,0,CLNSIG,CLNREVSTAT,CLNDN

## Where the selected ClinVar INFO fields (from the ClinVar VCF file) are:
# - CLNSIG:     Clinical significance for this single variant
# - CLNREVSTAT: ClinVar review status for the Variation ID
# - CLNDN:      ClinVar&#39;s preferred disease name for the concept specified by disease identifiers in CLNDISDB
# Of course you can select the INFO fields you want in the ClinVar VCF file

# Quick example on GRCh38:
./vep --id &amp;quot;1  230710048 230710048 A/G 1&amp;quot; --species homo_sapiens -o /path/to/output/output.txt --cache --offline --assembly GRCh38 --custom /path/to/custom_files/clinvar.vcf.gz,ClinVar,vcf,exact,0,CLNSIG,CLNREVSTAT,CLNDN

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;在使用转录本注释的&lt;code&gt;GFF&lt;/code&gt;时，如果搞不明白缓存&lt;code&gt;cache&lt;/code&gt;也可以不加，直接使用&lt;code&gt;--gff&lt;/code&gt;调用&lt;code&gt;gff&lt;/code&gt;文件也可以，也不需要使用&lt;code&gt;--custom&lt;/code&gt;来对&lt;code&gt;gff&lt;/code&gt;文件定义，例如：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;VEP can use transcript annotations defined in &lt;a href=&#34;https://github.com/The-Sequence-Ontology/Specifications/blob/master/gff3.md&#34;&gt;GFF&lt;/a&gt; or &lt;a href=&#34;https://asia.ensembl.org/info/website/upload/gff.html&#34;&gt;GTF&lt;/a&gt; files. The files must be bgzipped and indexed with tabix and a FASTA  file containing the genomic sequence is required in order to generate  transcript models.&lt;/p&gt;
&lt;p&gt;Your GFF or GTF file must be sorted in chromosomal order. VEP does not use header lines so it is safe to remove them.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;grep -v &amp;quot;#&amp;quot; data.gff | sort -k1,1 -k4,4n -k5,5n -t$&#39;\t&#39; | bgzip -c &amp;gt; data.gff.gz
tabix -p gff data.gff.gz
# 直接进行注释，注意这里出来的结果为tab分割的.txt文件
./vep -i input.vcf --gff data.gff.gz --fasta genome.fa.gz
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;问题2-如何提高效率&#34;&gt;问题2 如何提高效率&lt;/h2&gt;
&lt;p&gt;参考链接：&lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_other.html#faster&#34;&gt;Getting VEP to run faster&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;官方共提出了12点可以提高运行效率的方案，如果有精力可以都尝试一下，这里我采用了两个建议：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;第一点：&lt;/strong&gt; 设置&lt;code&gt;--fork&lt;/code&gt; flag&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Using forking enables VEP to run multiple parallel &amp;quot;threads&amp;quot;, with each thread processing a subset of your input. Most modern computers have      more than one processor core, so running VEP with forking enabled can give huge speed increases (3-4x faster in most cases). Even computers with a  single core will see speed benefits due to overheads associated with using object-oriented code in Perl.&lt;/p&gt;
&lt;p&gt;To use forking, you must choose a number of forks to use with the &lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_fork&#34;&gt;--fork&lt;/a&gt; flag. We recommend using 4 forks:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;./vep -i my_input.vcf --fork 4 --offline
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;but depending on various factors specific to your setup you may see faster performance with fewer or more forks.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;被这个&lt;code&gt;folk&lt;/code&gt; 整的有些懵逼，显然他不是线程数，而作者最后说由于设置不同，增加或者减少&lt;code&gt;forks&lt;/code&gt;的数量都有可能提速....&lt;/p&gt;
&lt;p&gt;**第二点：**按染色体拆分&lt;code&gt;.vcf.gz&lt;/code&gt;，并行&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;For very large files (for example those from whole-genome sequencing), VEP process can be easily parallelised by dividing your file into chunks      (e.g. by chromosome). VEP will also work with tabix-indexed, bgzipped  VCF files, and so the tabix utility could be used to divide the input file:&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;问题3-输出文件格式&#34;&gt;问题3 输出文件格式&lt;/h2&gt;
&lt;p&gt;参考链接：&lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#vcfout&#34;&gt;Variant Effect Predictor&lt;img src=&#34;data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==&#34; alt=&#34;img&#34; loading=&#34;lazy&#34;&gt; Data formats&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;如果不指定的话默认tab输出，但是为了方便后续，我们希望直接把注释信息写入&lt;code&gt;vcf&lt;/code&gt;文件的&lt;code&gt;info&lt;/code&gt;部分。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;VEP can return the results in different formats:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#defaultout&#34;&gt;Default VEP output&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#tab&#34;&gt;Tab-delimited output&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#vcfout&#34;&gt;VCF&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#json&#34;&gt;JSON output&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Along with the results VEP computes and returns some &lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#stats&#34;&gt;statistics&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这里统计了&lt;code&gt;VEP&lt;/code&gt;的输出格式，我们重点看下&lt;code&gt;vcf&lt;/code&gt;输出&lt;/p&gt;
&lt;blockquote&gt;
&lt;h2 id=&#34;vcf-output&#34;&gt;VCF output&lt;/h2&gt;
&lt;p&gt;The VEP script can also generate VCF output using the &lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_vcf&#34;&gt;--vcf&lt;/a&gt; flag.&lt;/p&gt;
&lt;p&gt;Main information about the specificity of the VEP VCF output format:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Consequences are added in the INFO field of the VCF file, using the key &amp;quot;&lt;strong&gt;CSQ&lt;/strong&gt;&amp;quot;           (you can change it using &lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_vcf_info_field&#34;&gt;--vcf_info_field&lt;/a&gt;).&lt;/li&gt;
&lt;li&gt;Data fields are encoded separated by the character &amp;quot;&lt;strong&gt;|&lt;/strong&gt;&amp;quot; (pipe). The order of fields is written in the VCF header.           Unpopulated fields are represented by an empty string.&lt;/li&gt;
&lt;li&gt;Output fields in the &amp;quot;CSQ&amp;quot; INFO field can be configured by using &lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_fields&#34;&gt;--fields&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;Each prediction, for a given variant, is separated by the character &amp;quot;&lt;strong&gt;,&lt;/strong&gt;&amp;quot; in the CSQ INFO field (e.g. when a variant overlaps more than 1 transcript)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;​    Here is a list of the (default) fields you can find within the CSQ field:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Allele|Consequence|IMPACT|SYMBOL|Gene|Feature_type|Feature|BIOTYPE|EXON|INTRON|HGVSc|HGVSp|cDNA_position|CDS_position|Protein_position|Amino_acids|Codons|Existing_variation|DISTANCE|STRAND|FLAGS|SYMBOL_SOURCE|HGNC_ID
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Some fields are not reported by default and need configuring including HGVS, Symbol and Existing_variation.&lt;/p&gt;
&lt;p&gt;Example of VEP command using the &lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_vcf&#34;&gt;--vcf&lt;/a&gt; and &lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_fields&#34;&gt;--fields&lt;/a&gt; options:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;./vep -i examples/homo_sapiens_GRCh38.vcf --cache --force_overwrite --vcf --fields &amp;quot;Allele,Consequence,Feature_type,Feature&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;VCFs produced by VEP can be filtered by &lt;a href=&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_filter.html&#34;&gt;filter_vep.pl&lt;/a&gt; in the same way as standard format    output files.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;简单来说就是在最后加上&lt;code&gt;--vcf&lt;/code&gt;的flag，可以用&lt;code&gt;--fields&lt;/code&gt; 来控制&lt;code&gt;INFO&lt;/code&gt;部分&lt;code&gt;CSQ&lt;/code&gt;的格式，如果不想麻烦，就直接加一个&lt;code&gt;--vcf&lt;/code&gt;的flag就可以了。最后通过&lt;code&gt;-o&lt;/code&gt;参数自定义输出&lt;code&gt;vcf&lt;/code&gt;的文件名通过&lt;code&gt;--sf&lt;/code&gt;自定义输出&lt;code&gt;html&lt;/code&gt;统计结果的文件名。&lt;/p&gt;
&lt;h1 id=&#34;实战代码&#34;&gt;实战代码&lt;/h1&gt;
&lt;p&gt;看下工作目录的结构：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;(vep) shawn@bio-Super-Server:~/working_dir/04.result$ tree
.
├── B73_RefGen_v2.fa -&amp;gt; /home/data/public/01.database/01.Database/01.genome_db/01.maize/03.B73_v2/B73_RefGen_v2.fa # B73_v2的参考基因组 
├── ZmB73_5a.59_WGS.gff3 -&amp;gt; /home/data/public/01.database/01.Database/01.genome_db/01.maize/03.B73_v2/ZmB73_5a.59_WGS.gff3 # MaizeGDB下载B73_v2的gff3注释文件
├── snp.all.filter.vcf.gz -&amp;gt; ../03.process/01.bamfile/vcf/snp.all.filter.vcf.gz # gatk call snp的结果
├── snp.all.filter.vcf.gz.tbi -&amp;gt; ../03.process/01.bamfile/vcf/snp.all.filter.vcf.gz.tbi # tabix 索引
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;第一步，分析环境建立与软件安装:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;## 建立重测序分析环境
conda create -n wgs -c bioconda gatk samtools bedtools bcftools bwa sambamba fastqc -y
## 安装vep 
conda create -n vep -c bioconda ensembl-vep=101.0 -y
# 用tmux新建一个窗口，方便放后台跑
tmux new -t vep
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;第二步，格式化&lt;code&gt;GFF&lt;/code&gt;文件&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# 将GFF文件软连接到工作目录下
ln -s /home/data/public/01.database/01.Database/01.genome_db/01.maize/03.B73_v2/ZmB73_5a.59_WGS.gff3 ./
# 格式化
grep -v &amp;quot;#&amp;quot; ZmB73_5a.59_WGS.gff3 | sort -k1,1 -k4,4n -k5,5n -t$&#39;\t&#39; | bgzip -c &amp;gt; data.gff.gz
# tabix索引
tabix -p gff data.gff.gz
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;第三步，拆分&lt;code&gt;vcf&lt;/code&gt;文件，参考链接 &lt;a href=&#34;https://www.biostars.org/p/9506417/&#34;&gt;Easy way to split VCF file by chromosome--biostar&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mkdir split
# 脚本来自于 https://www.biostars.org/p/9506417/
# 首先写一个运行脚本
vim spilt.sh
# 按i进入编辑模式，写入一下代码
vcf_in=$1

vcf_out_stem=$2

for i in {1..10} #10条染色体
do
        bcftools view ${vcf_in} --regions Chr${i} -o ${vcf_out_stem}_${i}.vcf.gz -Oz$
done
# 按esc退出编辑模式，按：进入命令模式，输入wq回车保存
# 授予脚本执行权限
chmod +x split.sh
# 运行脚本
./split.sh snp_all.vcf.gz split/snp_chr &amp;amp;

# 跑完后查看结果
tree split
split/
├── snp_chr_1.vcf.gz
├── snp_chr_10.vcf.gz
├── snp_chr_2.vcf.gz
├── snp_chr_3.vcf.gz
├── snp_chr_4.vcf.gz
├── snp_chr_5.vcf.gz
├── snp_chr_6.vcf.gz
├── snp_chr_7.vcf.gz
├── snp_chr_8.vcf.gz
└── snp_chr_9.vcf.gz

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;第四步，进行注释&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;## 写一个vep注释的单行脚本
vim run_vep_anno.sh
vep -i split/snp_chr_${1}.vcf.gz --gff data.gff.gz --fasta B73_RefGen_v2.fa --fork 4 --vcf -o split/snp_anno_chr_${1}.vcf --sf split/snp_anno_chr_${1}.html
## wq保存退出
## parallel 并行注释
parallel bash run_vep_anno.sh ::: 1 2 3 4 5 6 7 8 9 10 &amp;amp;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;第五步，查看结果&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;split/
├── snp_anno_chr_1.html # 统计结果报告
├── snp_anno_chr_1.vcf # 带注释的vcf文件
├── snp_anno_chr_1.vcf_warnings.txt # 运行过程的警告信息
├── snp_anno_chr_10.html
├── snp_anno_chr_10.vcf
├── snp_anno_chr_10.vcf_warnings.txt
├── snp_anno_chr_2.html
├── snp_anno_chr_2.vcf
├── snp_anno_chr_2.vcf_warnings.txt
├── snp_anno_chr_3.html
├── snp_anno_chr_3.vcf
├── snp_anno_chr_3.vcf_warnings.txt
├── snp_anno_chr_4.html
├── snp_anno_chr_4.vcf
├── snp_anno_chr_4.vcf_warnings.txt
├── snp_anno_chr_5.html
├── snp_anno_chr_5.vcf
├── snp_anno_chr_5.vcf_warnings.txt
├── snp_anno_chr_6.html
├── snp_anno_chr_6.vcf
├── snp_anno_chr_6.vcf_warnings.txt
├── snp_anno_chr_7.html
├── snp_anno_chr_7.vcf
├── snp_anno_chr_7.vcf_warnings.txt
├── snp_anno_chr_8.html
├── snp_anno_chr_8.vcf
├── snp_anno_chr_8.vcf_warnings.txt
├── snp_anno_chr_9.html
├── snp_anno_chr_9.vcf
├── snp_anno_chr_9.vcf_warnings.txt
├── snp_chr_1.vcf.gz
├── snp_chr_10.vcf.gz
├── snp_chr_2.vcf.gz
├── snp_chr_3.vcf.gz
├── snp_chr_4.vcf.gz
├── snp_chr_5.vcf.gz
├── snp_chr_6.vcf.gz
├── snp_chr_7.vcf.gz
├── snp_chr_8.vcf.gz
└── snp_chr_9.vcf.gz


&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;查看下结果发现&lt;code&gt;INFO&lt;/code&gt;以及加入了注释信息。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-tab&#34;&gt;#CHROM  POS     ID      REF     ALT     QUAL    FILTER  INFO    FORMAT  L01_114 L01_115 L01_117 L01_25  L01_26  L01_28  L01_29  L01_30  L01_32  L01_33  L01_34  L01_35  L01_36  L01_37  L01_38  L01_39  L01_49  L01_50
Chr1    15      .       A       G       289.14  PASS    AC=5;AF=0.139;AN=36;BaseQRankSum=1.53;DP=174;ExcessHet=0;FS=2.831;InbreedingCoeff=0.5213;MLEAC=4;MLEAF=0.111;MQ=51.54;MQRankSum=0.536;QD=12.57;ReadPosRankSum=-0.438;SOR=1.179;CSQ=G|downstream_gene_variant|MODIFIER|GRMZM2G059865|GRMZM2G059865|Transcript|GRMZM2G059865_T01|protein_coding|||||||||||4839|-1||||data.gff.gz|,G|downstream_gene_variant|MODIFIER|GRMZM2G059865|GRMZM2G059865|Transcript|GRMZM2G059865_T02|protein_coding|||||||||||4842|-1||||data.gff.gz|,G|downstream_gene_variant|MODIFIER|GRMZM2G059865|GRMZM2G059865|Transcript|GRMZM2G059865_T03|protein_coding|||||||||||4842|-1||||data.gff.gz|,G|5_prime_UTR_variant|MODIFIER|GRMZM2G060082|GRMZM2G060082|Transcript|GRMZM2G060082_T01|protein_coding|1/5||||13|||||||1||||data.gff.gz|,G|upstream_gene_variant|MODIFIER|GRMZM2G060082|GRMZM2G060082|Transcript|GRMZM2G060082_T02|protein_coding|||||||||||2592|1||||data.gff.gz|    GT:AD:DP:GQ:PL  0/0:5,0:5:15:0,15,197   0/1:14,4:18:99:113,0,429        0/0:3,0:3:9:0,9,126     0/0:6,0:6:18:0,18,190   0/0:4,0:4:12:0,12,169   0/0:3,0:3:9:0,9,89      0/0:12,0:12:36:0,36,464 0/0:6,0:6:18:0,18,199   0/0:11,0:11:33:0,33,425 0/0:9,0:9:27:0,27,287   0/0:9,0:9:0:0,0,252     0/0:5,0:5:15:0,15,192   0/0:5,0:5:15:0,15,191   0/0:4,0:4:12:0,12,148   1/1:0,2:2:6:85,6,0      1/1:0,3:3:9:126,9,0     0/0:11,0:11:33:0,33,412 0/0:10,0:10:30:0,30,318
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;建议输出表格形式，方便信息查阅&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;## 只需要把脚本里的代码修改一下
vep -i split/snp_chr_${1}.vcf.gz  --gff data.gff.gz --fasta B73_RefGen_v2.fa --fork 4 --tab -o
split/snp_anno_chr_${1}.xls split/snp_anno_chr_${1}.html 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;=== END ===&lt;/p&gt;
">「WGS」VEP进行SNP注释</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/metabolomics-serrf-dai-ma-chong-gou/"" data-c="
          &lt;h1 id=&#34;介绍&#34;&gt;介绍&lt;/h1&gt;
&lt;p&gt;SERRF是 U.C Davis Fiehn Lab的&lt;em&gt;S.L Fan&lt;/em&gt;开发的一款&lt;code&gt;QC-based&lt;/code&gt;数据标准化工具，用于校正非靶代谢组学数据的系统误差，具有出色的能力，校正后features RSD显著降低。目前使用方式有3种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;通过网页工具&lt;a href=&#34;https://slfan2013.github.io/SERRF-online/#&#34;&gt;https://slfan2013.github.io/SERRF-online/#&lt;/a&gt; 进行上传数据分析；&lt;/li&gt;
&lt;li&gt;通过本地运行shiny app，需要在将仓库克隆到本地，然后用Rstudio打开脚本运行&lt;code&gt;run app&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;通过本地运行normalize function运行。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;emmm... 经过尝试，第三种运行比较顺利。但是文件准备设置输出等步骤还是太麻烦，所以打算对&lt;code&gt;SERRF&lt;/code&gt;方法单独拿出来进行重构。并且接入&lt;code&gt;Tidymass&lt;/code&gt;的&lt;code&gt;massdataset&lt;/code&gt;，加入分析流程。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h1 id=&#34;脚本结构分析&#34;&gt;脚本结构分析&lt;/h1&gt;
&lt;p&gt;&lt;code&gt;Tidymass&lt;/code&gt;本身自带了很多数据标准化的方法，所以像&lt;code&gt;SERRF&lt;/code&gt;脚本中的其他标准化算法先不重构。主要对SERRF这种基于随机森林的标准化算法进行重构，当然方向也是趋于&lt;code&gt;tidyverse&lt;/code&gt;的风格。 首先看看这个脚本的步骤和逻辑。&lt;/p&gt;
&lt;h2 id=&#34;数据清洗&#34;&gt;数据清洗&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;首先对样品信息的数据进行了数据清洗，最后转换为&lt;code&gt;data.table&lt;/code&gt;格式。p&lt;/li&gt;
&lt;li&gt;然后对&lt;code&gt;feature&lt;/code&gt;的信息进行了清洗，同样转换为&lt;code&gt;data.table&lt;/code&gt;形式。f&lt;/li&gt;
&lt;li&gt;最后对代谢物积累矩阵的标准化, 最后转换为&lt;code&gt;matrix&lt;/code&gt;形式。e&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们观察了&lt;code&gt;SERRF&lt;/code&gt;的数据格式，和&lt;code&gt;tidymass&lt;/code&gt;的有很大的相似之处。所以打算将输入数据改成&lt;code&gt;tidymass&lt;/code&gt;的&lt;code&gt;mass_dataset&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;首先尝试都做&lt;code&gt;data.frame&lt;/code&gt;处理&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;serrf算法实现过程&#34;&gt;SERRF算法实现过程&lt;/h2&gt;
&lt;p&gt;整体将不同的&lt;code&gt;batch&lt;/code&gt;分开计算。所有的迭代也是建立在&lt;code&gt;batch&lt;/code&gt;个数上的&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;首先第一步把&lt;code&gt;dataset&lt;/code&gt;按照&lt;code&gt;batch&lt;/code&gt;拆开, 按&lt;code&gt;batch&lt;/code&gt;计算训练集和目标集的&lt;code&gt;spearman&lt;/code&gt;相关。&lt;/li&gt;
&lt;li&gt;第二步根据&lt;code&gt;feature&lt;/code&gt;个数进行迭代，对每个&lt;code&gt;feature&lt;/code&gt;分析建模做标准化。
&lt;ul&gt;
&lt;li&gt;首先从第一步计算的训练集和目标集相关性矩阵中分别将对应&lt;code&gt;feature&lt;/code&gt;的相关性结果提取出来；&lt;/li&gt;
&lt;li&gt;对该结果进行排序，不考虑相关性的正负属性，只要是高度相关就排在前面&lt;code&gt;corr_train_order = order(abs(corr_train[,j]),decreasing = TRUE)&lt;/code&gt;；&lt;/li&gt;
&lt;li&gt;第三步，从整体表达矩阵中筛选测试集，简单讲就是求第二步两个相关性向量的交集，但是有条件，具体方法如下：
&lt;ul&gt;
&lt;li&gt;首先设定一个交集数量的上限值&lt;code&gt;num&lt;/code&gt;，脚本这里默认10，然后引入一个空置的参数&lt;strong&gt;筛选出的变异值&lt;/strong&gt;&lt;code&gt;sel_var&lt;/code&gt;对该值进行迭代计算，迭代的条件是&lt;code&gt;sel_var&lt;/code&gt;中元素的数量 &lt;code&gt;&amp;gt;= 0&lt;/code&gt;的时候终止, 也就是说比对训练集和目标集相关性向量的排序表，从各自的&lt;code&gt;top10&lt;/code&gt;个开始做交集，每次迭代增加一个材料（第二次1:11，第三次1:12 ....）直到交集的数量大于了我们刚设定的&lt;code&gt;10&lt;/code&gt;这个阈值就终止。&lt;/li&gt;
&lt;li&gt;这样我们就确定了用作训练数据的材料（最终的交集）。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;首先训练集会对该&lt;code&gt;batch&lt;/code&gt;下的所有&lt;code&gt;qc&lt;/code&gt;做一个中心化&lt;code&gt;scale(x,center = T,scale = F)&lt;/code&gt;, 然后对交集材料做标准化；&lt;/li&gt;
&lt;li&gt;对应测试集只做标准化，这样我们就得到了这10个材料在&lt;code&gt;qc&lt;/code&gt;和&lt;code&gt;sample&lt;/code&gt;各自的标准化表；后续会检查有是否存在这些&lt;code&gt;feature&lt;/code&gt;在&lt;code&gt;sample&lt;/code&gt;是否都缺失了，只有在训练集和测试集中都不含&lt;code&gt;NA&lt;/code&gt;的&lt;code&gt;feature&lt;/code&gt;才会被保留；&lt;/li&gt;
&lt;li&gt;最终将去中心化的&lt;code&gt;train_data_x&lt;/code&gt;和标准化的&lt;code&gt;train_data_y&lt;/code&gt;合并为新的训练集；&lt;/li&gt;
&lt;li&gt;用&lt;code&gt;ranger&lt;/code&gt;构建模型；&lt;/li&gt;
&lt;li&gt;吐槽一下，这&lt;code&gt;baseR&lt;/code&gt;的代码直接给我看吐了。&lt;/li&gt;
&lt;li&gt;分解下下面鬼见愁就的代码（针对训练集的&lt;code&gt;qc&lt;/code&gt;）具体标准化过程如下：&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;norm[train.index_current_batch==&#39;qc&#39;] = e_current_batch[j, train.index_current_batch==&#39;qc&#39;]/((predict(model, data = train_data)$prediction+mean(e_current_batch[j,train.index_current_batch==&#39;qc&#39;],na.rm=TRUE))/mean(all[j,sampleType.==&#39;qc&#39;],na.rm=TRUE))
norm[train.index_current_batch==&#39;qc&#39;] = norm[train.index_current_batch==&#39;qc&#39;]/(median(norm[train.index_current_batch==&#39;qc&#39;],na.rm=TRUE)/median(all[j,sampleType.==&#39;qc&#39;],na.rm=TRUE))
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;  - 首先通过`predict`用构建的模型对`train_data`进行预测，取得观测值后加上该`batch`中`feature`所有QC样本峰面积的均值，然后用该数值除以所有QC样本峰面积的均值，得到一个比值，最后用该`batch`中`feature`所有QC样本峰面积对应的除去该比值实现对`QC`样本的的标准化。
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/mfrac&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;QC_{norm} = \frac {QC_{raw}}{\frac {QC_{model}+QC_{mean}}{ALL_{mean}}}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8777699999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathdefault&#34;&gt;Q&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathdefault&#34; style=&#34;margin-right:0.07153em;&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.151392em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1.818174em;vertical-align:-0.893735em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mopen nulldelimiter&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mfrac&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.924439em;&#34;&gt;&lt;span style=&#34;top:-2.4470650000000003em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mopen nulldelimiter sizing reset-size3 size6&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mfrac&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:1.0613357142857143em;&#34;&gt;&lt;span style=&#34;top:-2.656em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size3 size1 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.23056em;&#34;&gt;&lt;span style=&#34;top:-2.3em;margin-left:0em;margin-right:0.1em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.5em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.2em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;top:-3.2255000000000003em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;frac-line mtight&#34; style=&#34;border-bottom-width:0.049em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;top:-3.573242857142857em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size3 size1 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;Q&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.07153em;&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.3448em;&#34;&gt;&lt;span style=&#34;top:-2.3448em;margin-left:-0.07153em;margin-right:0.1em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.69444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.34963999999999995em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mbin mtight&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;Q&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.07153em;&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.23056em;&#34;&gt;&lt;span style=&#34;top:-2.3em;margin-left:-0.07153em;margin-right:0.1em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.5em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.2em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.4868571428571429em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mclose nulldelimiter sizing reset-size3 size6&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;top:-3.23em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;frac-line&#34; style=&#34;border-bottom-width:0.04em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;top:-3.446108em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;Q&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.07153em;&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.16454285714285719em;&#34;&gt;&lt;span style=&#34;top:-2.357em;margin-left:-0.07153em;margin-right:0.07142857142857144em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.5em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size3 size1 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.02691em;&#34;&gt;w&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.143em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.893735em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mclose nulldelimiter&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  - 得到标准化后的$QC_{norm}$后，用该值的中位值除以所有`QC`样品的中位值，然后每个值再除以这个比值
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;.&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/mfrac&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;QC_{norm} = \frac {QC_{norm}} {\frac {QC_{norm.median}}{ALL_{median}}}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8777699999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathdefault&#34;&gt;Q&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathdefault&#34; style=&#34;margin-right:0.07153em;&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.151392em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mrel&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2777777777777778em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1.8929939999999998em;vertical-align:-0.9685549999999999em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mopen nulldelimiter&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mfrac&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.924439em;&#34;&gt;&lt;span style=&#34;top:-2.4470650000000003em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mopen nulldelimiter sizing reset-size3 size6&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mfrac&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:1.0613357142857143em;&#34;&gt;&lt;span style=&#34;top:-2.656em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size3 size1 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.3448em;&#34;&gt;&lt;span style=&#34;top:-2.3448em;margin-left:0em;margin-right:0.1em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.69444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.34963999999999995em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;top:-3.2255000000000003em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;frac-line mtight&#34; style=&#34;border-bottom-width:0.049em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;top:-3.573242857142857em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size3 size1 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;Q&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.07153em;&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.3448em;&#34;&gt;&lt;span style=&#34;top:-2.3448em;margin-left:-0.07153em;margin-right:0.1em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.69444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.34963999999999995em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.5937428571428571em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mclose nulldelimiter sizing reset-size3 size6&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;top:-3.23em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;frac-line&#34; style=&#34;border-bottom-width:0.04em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;top:-3.446108em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:3em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;Q&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.07153em;&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.16454285714285719em;&#34;&gt;&lt;span style=&#34;top:-2.357em;margin-left:-0.07153em;margin-right:0.07142857142857144em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.5em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size3 size1 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.143em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.9685549999999999em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mclose nulldelimiter&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;下面分解对训练集中&lt;code&gt;sample&lt;/code&gt;标准化的部分&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;norm[!train.index_current_batch==&#39;qc&#39;] =(e_current_batch[j,!train.index_current_batch==&#39;qc&#39;])/((predict(model,data = test_data)$predictions  + mean(e_current_batch[j, !train.index_current_batch==&#39;qc&#39;],na.rm=TRUE))/(median(all[j,!sampleType.==&#39;qc&#39;],na.rm = TRUE)))
norm[!train.index_current_batch==&#39;qc&#39;][norm[!train.index_current_batch==&#39;qc&#39;]&amp;lt;0]=e_current_batch[j,!train.index_current_batch==&#39;qc&#39;][norm[!train.index_current_batch==&#39;qc&#39;]&amp;lt;0]
norm[!train.index_current_batch==&#39;qc&#39;] = norm[!train.index_current_batch==&#39;qc&#39;]/(median(norm[!train.index_current_batch==&#39;qc&#39;],na.rm=TRUE)/median(all[j,!sampleType.==&#39;qc&#39;],na.rm=TRUE))
norm[!is.finite(norm)] = rnorm(length(norm[!is.finite(norm)]),sd = sd(norm[is.finite(norm)],na.rm=TRUE)*0.01)
out = boxplot.stats(norm, coef = 3)$out
norm[!train.index_current_batch==&#39;qc&#39;][norm[!train.index_current_batch==&#39;qc&#39;]%in%out] = ((e_current_batch[j,!train.index_current_batch==&#39;qc&#39;])-((predict(model,data = test_data)$predictions  + mean(e_current_batch[j, !train.index_current_batch==&#39;qc&#39;],na.rm=TRUE))-(median(all[j,!sampleType.==&#39;qc&#39;],na.rm = TRUE))))[norm[!train.index_current_batch==&#39;qc&#39;]%in%out];
norm[!train.index_current_batch==&#39;qc&#39;][norm[!train.index_current_batch==&#39;qc&#39;]&amp;lt;0]=e_current_batch[j,!train.index_current_batch==&#39;qc&#39;][norm[!train.index_current_batch==&#39;qc&#39;]&amp;lt;0]
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;  - 第一步和上面一样同样的算法；第二步是探测了标准化后的`sample`值，如果有`＜0`的值，用原始的值填充；
  - 接下来和上面一样用标准化的值除以两中位值的比值；
  - 下一步检查结果中是否有无穷值，如果有的话用随机数填充，标准差选择非无穷值的标准差，最终的值`*0.01`；
  - 筛选出离群的值，然后填充离群值；
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;S&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi mathvariant=&#34;normal&#34;&gt;.&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;Sample_{raw}-((QC_{model}+QC_{mean}) - ALL_{all.median})&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8888799999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathdefault&#34; style=&#34;margin-right:0.05764em;&#34;&gt;S&lt;/span&gt;&lt;span class=&#34;mord mathdefault&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathdefault&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathdefault&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;mord mathdefault&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathdefault&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.151392em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.02778em;&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.02691em;&#34;&gt;w&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2222222222222222em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mbin&#34;&gt;−&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2222222222222222em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1em;vertical-align:-0.25em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mopen&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mord mathdefault&#34;&gt;Q&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathdefault&#34; style=&#34;margin-right:0.07153em;&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.33610799999999996em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;o&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2222222222222222em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mbin&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2222222222222222em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1em;vertical-align:-0.25em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathdefault&#34;&gt;Q&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathdefault&#34; style=&#34;margin-right:0.07153em;&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.151392em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mclose&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2222222222222222em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mbin&#34;&gt;−&lt;/span&gt;&lt;span class=&#34;mspace&#34; style=&#34;margin-right:0.2222222222222222em;&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:1em;vertical-align:-0.25em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathdefault&#34;&gt;A&lt;/span&gt;&lt;span class=&#34;mord mathdefault&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathdefault&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.33610799999999996em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mtight&#34;&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord mtight&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathdefault mtight&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mclose&#34;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  - 先用`QC`模型+`QC`均值减去所有矩阵中非`QC`的中位值，然后用sample的原始峰面积减去该值。然后用该值填充离群值
  - 如果有引入的负数，再用上面的公式填充一下负数。
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;最终标准化完毕。&lt;/li&gt;
&lt;li&gt;完成所有&lt;code&gt;feature&lt;/code&gt;的标准化后会对NA和负数进行重新填充；
&lt;ul&gt;
&lt;li&gt;对于NA进行随机数填充，均值为其他非NA值的最小值，sd为其他非NA值的sd，最终得到的随机数&lt;code&gt;*0.1&lt;/code&gt;；&lt;/li&gt;
&lt;li&gt;对负数的填充，&lt;code&gt;1*&lt;/code&gt;非负数值的最小值。&lt;/li&gt;
&lt;li&gt;至此SERRF标准化过程完毕&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;交叉检验
&lt;ul&gt;
&lt;li&gt;使用的数据集是原始的&lt;code&gt;qc&lt;/code&gt;峰面积数据。默认&lt;code&gt;5-fold&lt;/code&gt;。为啥要做5折？&lt;/li&gt;
&lt;li&gt;这里发现个错误，我们看下&lt;code&gt;any&lt;/code&gt;函数的用法&lt;/li&gt;
&lt;li&gt;，很明显作者在这里是想看所有&lt;code&gt;batch&lt;/code&gt;中是否存在某个&lt;code&gt;batch&lt;/code&gt;中的&lt;code&gt;qc&lt;/code&gt;样本数量小于&lt;code&gt;7&lt;/code&gt;，按照目前的代码&lt;code&gt;any(table(p_qc$batch))&lt;/code&gt;总是会返回一个逻辑值&lt;code&gt;TRUE&lt;/code&gt;，&lt;code&gt;any&lt;/code&gt;本来就是个做判断的函数，所以把&lt;code&gt;&amp;lt;7&lt;/code&gt;移动到括号内。这... 之前所有工作中&lt;code&gt;ratio&lt;/code&gt;都被默认成了&lt;code&gt;0.7&lt;/code&gt;. 0.7和0.8差异大吗？&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;## 原始的
if(any(table(p_qc$batch))&amp;lt;7){
  ratio = 0.7
}else{
  ratio = 0.8
}
## 改造后的
if(any(table(p_qc$batch)&amp;lt;7)){
  ratio = 0.7
}else{
  ratio = 0.8
}
&lt;/code&gt;&lt;/pre&gt;
">「Metabolomics」SERRF代码重构</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/r-crawler-gui-fan-hua-yu-ji-qiao/"" data-c="
          &lt;p&gt;之前在使用&lt;code&gt;rvest&lt;/code&gt;,&lt;code&gt;RCurl&lt;/code&gt;以及&lt;code&gt;XML&lt;/code&gt;包编写爬虫时只是单纯的考虑到了信息提取和格式转换，没有考虑到爬虫对目标服务器的负载压力，之前也使用过暴力并行，虽然速度很快，但是对目标网站服务器负载造成了很大压力，这样既不道德，也不安全。被反爬机制检测到会封ip等。本次就实战中遇到问题解决问题做个总结。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h1 id=&#34;爬虫代码&#34;&gt;爬虫代码&lt;/h1&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;mda_knapsack_spider &amp;lt;- function(input_data,type = &amp;quot;multiple&amp;quot;) {
  #&amp;gt; message setting
  msg_yes = green$bold$italic;
  msg_no = red$bold$italic;
  msg_warning = yellow$bold$italic;
  message(msg_yes(&amp;quot;---------------------------------------------------------\nStart analysis....\nGet compound information from KNApSAcK database. please wait...\n--------------------------------------------------------- &amp;quot;))
  #&amp;gt; functions
  #&amp;gt; name2cid
  name2cid_fun = function(x) {
    tbl &amp;lt;- 
      data.frame(
        Lab.ID = x,
        CAS.ID = NA,
        Compound_name = NA,
        Formula = NA,
        mw = NA,
        organism = NA,
        synonyms = NA,
        Judge_plant = FALSE,
        InChIKey = NA,
        SMILE = NA,
        Species_all = NA
      )
    tryCatch({
      ID = x
      ## use different user_agents.
      user_agents = c(
        &amp;quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.3 Safari/605.1.15&amp;quot;,
        &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/110.0&#39;,
        &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36 Edg/103.0.1264.37&#39;,
        &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36 Edg/103.0.1264.37&#39;,
        &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36&#39;,
        &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36&#39;,
        &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:101.0) Gecko/20100101 Firefox/101.0&#39;
      )
      random_agent &amp;lt;- sample(user_agents,1)
      
      headers = c(&#39;User_Agent&#39; = random_agent,&#39;Accept&#39; = &amp;quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&amp;quot;)
      url &amp;lt;- &amp;quot;http://www.knapsackfamily.com/knapsack_core/result.php?sname=all&amp;amp;word=&amp;quot;
      
      # fetch the HTML content of the page
      html &amp;lt;- RCurl::getURL(url = paste0(url,ID),header = headers,.encoding = &#39;UTF-8&#39;)
      
      # parse the HTML using XML package
      doc &amp;lt;- XML::htmlParse(html, asText = TRUE)
      
      # find the table on the page
      table &amp;lt;- XML::getNodeSet(doc, &amp;quot;//table&amp;quot;)[[1]]
      
      cell &amp;lt;- XML::xpathApply(table,&amp;quot;//td&amp;quot;)
      metabolite &amp;lt;- XML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;)[[1]]
      
      Lab.ID &amp;lt;- XML::xmlValue(cell[[1]])
      CAS.ID &amp;lt;- XML::xmlValue(cell[[2]])
      Compound_name &amp;lt;- XML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;)[[1]] %&amp;gt;% XML::xmlValue()
      Formula &amp;lt;- XML::xmlValue(cell[[4]])
      mw &amp;lt;- XML::xmlValue(cell[[5]])
      organism &amp;lt;- XML::xmlValue(cell[[6]])
      synonyms &amp;lt;- XML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;) %&amp;gt;% 
  						map_chr(.x = .,function(.x){ifelse(XML::xmlName(.x)==&amp;quot;br&amp;quot;, NA, XML::xmlValue(.x))}) %&amp;gt;% 
  						na.omit %&amp;gt;% 
  						paste(.,collapse = &amp;quot;|&amp;quot;) 
      url2 &amp;lt;- &amp;quot;http://www.knapsackfamily.com/knapsack_core/information.php?word=&amp;quot;
      html &amp;lt;- RCurl::getURL(url = paste0(url2,ID),header = headers)
      
      parsed_html &amp;lt;- XML::htmlParse(html, asText = TRUE)
      table_nodes &amp;lt;- XML::getNodeSet(parsed_html, &amp;quot;//table&amp;quot;)  # 选择所有表格节点
      table &amp;lt;- XML::readHTMLTable(table_nodes[[2]])  # 提取第一个表格节点的表格数据
      tbl = data.frame(
        Lab.ID = Lab.ID,
        CAS.ID = CAS.ID,
        Compound_name = Compound_name,
        Formula = Formula,
        mw = mw,
        organism = organism,
        synonyms = synonyms,
        Judge_plant = case_when(
          str_detect(table[9,2],&amp;quot;Plantae&amp;quot;) ~ TRUE,
          TRUE ~ FALSE
        ),
        InChIKey = table[5,2],
        SMILE = table[7,2],
        Species_all = table %&amp;gt;% pull(V3) %&amp;gt;% na.omit() %&amp;gt;% paste(.,collapse = &amp;quot;|&amp;quot;)
      )
    },error = function(e) {
      message(msg_no(x,&amp;quot; no match results\n&amp;quot;))
    })
  }
  
  multi_run_fun = function(name_list) {
    name &amp;lt;- name_list %&amp;gt;% pull(knapsack_id)
    p &amp;lt;- progressr::progressor(steps = length(name));
    repeat {
      b &amp;lt;- tryCatch({
        b &amp;lt;- purrr::map_dfr(.x = name, .f = function(.x) {
          s.time = sample(runif(n = 50,1,3) %&amp;gt;% round(.,digits = 2),1)
          Sys.sleep(s.time);
          p()
          a &amp;lt;- name2cid_fun(x = .x)
          return(a)
        })
        return(b)
      }, error = function(e) {
        message(&amp;quot;Error occurred: &amp;quot;, conditionMessage(e), &amp;quot;\n&amp;quot;)
        NULL
      })
      if (!is.null(b)) {
        if (nrow(b) == length(name)) {
          break
        } else {
          missing_names &amp;lt;- setdiff(name, b$Lab.ID)
          message(paste0(&amp;quot;Missing &amp;quot;, length(missing_names), &amp;quot; entries, retrying...&amp;quot;))
          name &amp;lt;- missing_names
        }
      } else {
        message(&amp;quot;Retrying...&amp;quot;)
      }
    }
    return(b)
  }
  
  #&amp;gt; run single search
  if(type == &#39;single&#39;) {
    cid_tbl &amp;lt;- name2cid_fun(
      x = input_data
    )
    message(msg_yes(&amp;quot;Done!&amp;quot;))
  }
  #&amp;gt; run multiple search
  if(type == &#39;multiple&#39;) {
    #&amp;gt; check format
    if (&amp;quot;knapsack_id&amp;quot; %in% colnames(input_data) ) {
      Name_clean = input_data %&amp;gt;% 
        select(knapsack_id) %&amp;gt;% 
        distinct() %&amp;gt;% 
        drop_na() %&amp;gt;% 
        mutate(order = seq(1:nrow(.)))
    } else {
      return();
      message(msg_no(&#39;Error in input data infomation, please set the colname of kanpsack id as &amp;quot;knapsack_id&amp;quot;&#39;))
    } 
    #&amp;gt; run
    with_progress({
      kns_tbl = multi_run_fun(name_list = Name_clean)
    })
    message(msg_yes(&amp;quot;Done!&amp;quot;))
    return(kns_tbl)
  }
}


library(RCurl)
library(XML)
library(tidyverse)
library(crayon)
library(progressr)

query &amp;lt;- read.csv(&amp;quot;~/SynologyDrive/database/02.MS/KNApSAcK/KNApSAcK_MS1_db.csv&amp;quot;)
query &amp;lt;- 
  query %&amp;gt;% 
  dplyr::select(Lab.ID,RT) %&amp;gt;% 
  setNames(c(&amp;quot;knapsack_id&amp;quot;,&amp;quot;tag&amp;quot;))


t.start &amp;lt;- Sys.time()
part1 &amp;lt;- mda_knapsack_spider(input_data = query[1:1000,])
t.end &amp;lt;- Sys.time()
cat(t.end -t.start)


&lt;/code&gt;&lt;/pre&gt;
&lt;h1 id=&#34;代码解析&#34;&gt;代码解析&lt;/h1&gt;
&lt;p&gt;首先我们去目标网站&lt;br&gt;
我们在KNApSAcK网站输入C_ID后首先会出现上面页面，从页面看，主要为一个表格，那么我们只需要把这个表格提取出来，该网站无需用户登录信息，所以一般request method为GET，从下图打开开发者模式后可以看到。所以在请求的时候思路就是用&lt;code&gt;RCurl::getURL&lt;/code&gt;函数请求网址，然后通过&lt;code&gt;XML::htmlParse&lt;/code&gt;函数来解析网址，再通过&lt;code&gt;XML::getNodeSet&lt;/code&gt;定位表格，用&lt;code&gt;XML::xpathApply&lt;/code&gt;将HTML转换为包含每个条目的&lt;code&gt;list&lt;/code&gt;。达到信息提取的目的。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202303010907129.png&#34; alt=&#34;xml&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;问题一化合物名字无法和同义词区分开&#34;&gt;问题一：化合物名字无法和同义词区分开&lt;/h2&gt;
&lt;p&gt;我们发现KNApSAcK数据库在化合物``Metabolite&lt;code&gt;这一栏会把名字和同义词放在一个&lt;/code&gt;cell&lt;code&gt;中，用换行符隔开（回车），那么在HTML中换行符的标志是&lt;/code&gt;&lt;br/&gt;&lt;code&gt;,所以我们看定位到表格后,直接输出&lt;/code&gt;cell`后结果如下：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;cell
[[1]]
&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;
  &amp;lt;a href=&amp;quot;information.php?word=C00000001&amp;quot; target=&amp;quot;_blank&amp;quot;&amp;gt;C00000001&amp;lt;/a&amp;gt;
&amp;lt;/td&amp;gt; 

[[2]]
&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;545-97-1&amp;lt;/td&amp;gt; 

[[3]]
&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;Gibberellin A1&amp;lt;br/&amp;gt;GA1&amp;lt;/td&amp;gt; 

[[4]]
&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;C19H24O6&amp;lt;/td&amp;gt; 

[[5]]
&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;348.1572885&amp;lt;/td&amp;gt; 

[[6]]
&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;Solanum lycopersicum&amp;lt;/td&amp;gt; 

attr(,&amp;quot;class&amp;quot;)
[1] &amp;quot;XMLNodeSet&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;我们发现化合物名字这个&lt;code&gt;cell&lt;/code&gt;中的内容为&lt;code&gt;&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;Gibberellin A1&amp;lt;br/&amp;gt;GA1&amp;lt;/td&amp;gt;&lt;/code&gt;。这样就会发生一个问题，如果我们直接用&lt;code&gt;XML::xmlValue&lt;/code&gt;函数将HTML转换为字符后所有的HTML标志都会被去掉，这样中间的&lt;code&gt;&amp;lt;br/&amp;gt;&lt;/code&gt;也被去掉了，这样输出的结果为：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;XML::xmlValue(cell[[3]])
[1] &amp;quot;Gibberellin A1GA1&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;那么，化合物名字Gibberellin A1和它的同义词GA1就收尾相连，这在后续处理的时候是非常麻烦的。&lt;/p&gt;
&lt;h2 id=&#34;问题一处理方式&#34;&gt;问题一：处理方式&lt;/h2&gt;
&lt;p&gt;既然不能等到先把表格提取出来再进行格式转换，那么就直接用xpathApply把这个cell的内容提取出来转换成list，然后选择第一个作为Compound_name, 剩下的通过&lt;code&gt;paste(x,collapse=”|“)&lt;/code&gt;将他们粘贴在一起然后用&lt;code&gt;|&lt;/code&gt;分开。具体实现代码如下：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;## 先看下这几对这个cell进行提取结果
XML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;)
[[1]]
Gibberellin A1 ## 每个元素都被提取出来，转换成字符，最后构建了个list

[[2]]
&amp;lt;br/&amp;gt; ## 换行符也被转换成了字符串

[[3]]
GA1 ## 同义词也被转换出来

attr(,&amp;quot;class&amp;quot;)
[1] &amp;quot;XMLNodeSet&amp;quot;
## 那么只要用[[1]]提取上述输出结果的第一个元素然后转换为字符即可提取化合物名字
## 注意，这个list里面每个元素并不是字符串格式，而是以下格式的数据类型，需要用xmlValue函数转换为字符串
class(cell[[1]])
[1] &amp;quot;XMLInternalElementNode&amp;quot; &amp;quot;XMLInternalNode&amp;quot;        &amp;quot;XMLAbstractNode&amp;quot;   
##&amp;gt; 提取化合物名字
Compound_name &amp;lt;- 
						 XML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;)[[1]] %&amp;gt;% ## 提取
						 XML::xmlValue()
##&amp;gt; 提取同义词
synonyms &amp;lt;- XML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;) %&amp;gt;% 
  			map_chr(.x = .,function(.x){ifelse(XML::xmlName(.x)==&amp;quot;br&amp;quot;, NA, XML::xmlValue(.x))}) %&amp;gt;% ## 如果html标识是&amp;lt;br/&amp;gt;,转换为NA，反之转换为字符串
  			na.omit %&amp;gt;% ## 去掉NA，也就是换行符
  			paste(.,collapse = &amp;quot;|&amp;quot;) ## 将字符串拼接用 | 隔开。


&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;然后将这些元素拼接到一个表格中。&lt;/p&gt;
&lt;h2 id=&#34;问题二缺少inchikey及smile等信息&#34;&gt;问题二：缺少&lt;code&gt;InChIKey&lt;/code&gt;及&lt;code&gt;SMILE&lt;/code&gt;等信息&lt;/h2&gt;
&lt;p&gt;后续分类的时候我们有可能会使用&lt;code&gt;pubchem&lt;/code&gt;数据库去再次确认这些化合物的信息，并且调取&lt;code&gt;Pubchem&lt;/code&gt;数据库的&lt;code&gt;InChIKey&lt;/code&gt;用于分类，因为&lt;code&gt;ClassyfireR&lt;/code&gt;貌似对&lt;code&gt;Pubchem&lt;/code&gt;数据库收录的&lt;code&gt;InChIKey&lt;/code&gt;支持较好。这是可能需要化合物名字和SMILE。&lt;br&gt;
这些信息在点击该网页的&lt;code&gt;C_ID&lt;/code&gt;的链接里面：&lt;/p&gt;
&lt;h2 id=&#34;问题二处理方式&#34;&gt;问题二：处理方式&lt;/h2&gt;
&lt;p&gt;于是我们对这个网页信息继续进行提取，该表格比较复杂，不过最终通过对源码的解析我们也顺利抓取到了需要的信息&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;url2 &amp;lt;- &amp;quot;http://www.knapsackfamily.com/knapsack_core/information.php?word=&amp;quot;
      html &amp;lt;- RCurl::getURL(url = paste0(url2,ID),header = headers)
      
      parsed_html &amp;lt;- XML::htmlParse(html, asText = TRUE)
      table_nodes &amp;lt;- XML::getNodeSet(parsed_html, &amp;quot;//table&amp;quot;)  # 选择所有表格节点
      table &amp;lt;- XML::readHTMLTable(table_nodes[[2]])  # 提取第一个表格节点的表格数据
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;再&lt;code&gt;table_nodes&lt;/code&gt; 的第二个元素中，我们找到了我们需要的内容，于是继续提取，同时我们把&lt;code&gt;kingdom&lt;/code&gt;列中的结果进行了检测，看该化合物是否来源于植物，用&lt;code&gt;str_detected&lt;/code&gt;如果检测到&lt;code&gt;Plantae&lt;/code&gt;我们认为该化合物在植物中存在。同时提取了物种信息，后续可能在做指定物种的非靶代谢时优先考虑这些化合物。&lt;/p&gt;
&lt;h2 id=&#34;结果整合&#34;&gt;结果整合&lt;/h2&gt;
&lt;p&gt;这个比较简单，就是构造一个数据框，把结果填写进去。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;      tbl = data.frame(
        Lab.ID = Lab.ID,
        CAS.ID = CAS.ID,
        Compound_name = Compound_name,
        Formula = Formula,
        mw = mw,
        organism = organism,
        synonyms = synonyms,
        Judge_plant = case_when(
          str_detect(table[9,2],&amp;quot;Plantae&amp;quot;) ~ TRUE,
          TRUE ~ FALSE
        ),
        InChIKey = table[5,2],
        SMILE = table[7,2],
        Species_all = table %&amp;gt;% pull(V3) %&amp;gt;% na.omit() %&amp;gt;% paste(.,collapse = &amp;quot;|&amp;quot;)
      )
## 提前构造好的空df
    tbl &amp;lt;- 
      data.frame(
        Lab.ID = x,
        CAS.ID = NA,
        Compound_name = NA,
        Formula = NA,
        mw = NA,
        organism = NA,
        synonyms = NA,
        Judge_plant = FALSE,
        InChIKey = NA,
        SMILE = NA,
        Species_all = NA
      )
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;此外在爬虫function中我们加入了&lt;code&gt;tryCatch&lt;/code&gt;机制，如果报错了，跳过该条目继续进行下一个，这是就要去我们有个default。也就是代码开头构造的&lt;code&gt;tbl&lt;/code&gt;，如果没有这个条目，或者网络方位失败，会跳过返回该提前构造的表格，不至于循环被打断。而且最终会提醒你哪些没有结果。&lt;/p&gt;
&lt;h2 id=&#34;迭代运行&#34;&gt;迭代运行&lt;/h2&gt;
&lt;p&gt;这里使用了&lt;code&gt;purrr&lt;/code&gt;包的map函数进行泛函迭代，使用&lt;code&gt;progressr&lt;/code&gt;监视脚本运行的进程。这里尝试了下对失败的结果重新爬取，但是失败了，还是需要优化。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;multi_run_fun = function(name_list) {
    name &amp;lt;- name_list %&amp;gt;% pull(knapsack_id) # 循环总数
    p &amp;lt;- progressr::progressor(steps = length(name)); # progress bar
    repeat {
      b &amp;lt;- tryCatch({
        b &amp;lt;- purrr::map_dfr(.x = name, .f = function(.x) { ## 泛函迭代
          s.time = sample(runif(n = 50,1,3) %&amp;gt;% round(.,digits = 2),1) ##生成随机间隔时间
          Sys.sleep(s.time);
          p()
          a &amp;lt;- name2cid_fun(x = .x) # 爬虫
          return(a)
        })
        return(b)
      }, error = function(e) {
        message(&amp;quot;Error occurred: &amp;quot;, conditionMessage(e), &amp;quot;\n&amp;quot;)
        NULL
      })
      if (!is.null(b)) {
        if (nrow(b) == length(name)) {
          break
        } else {
          missing_names &amp;lt;- setdiff(name, b$Lab.ID)
          message(paste0(&amp;quot;Missing &amp;quot;, length(missing_names), &amp;quot; entries, retrying...&amp;quot;))
          name &amp;lt;- missing_names
        }
      } else {
        message(&amp;quot;Retrying...&amp;quot;)
      }
    }
    return(b)
  }
&lt;/code&gt;&lt;/pre&gt;
&lt;h1 id=&#34;规范化和规避反爬机制老六必备&#34;&gt;规范化和规避反爬机制（老六必备）&lt;/h1&gt;
&lt;p&gt;规范化的爬虫代码不仅有利于我们快速批量获取信息，也能最大程度上不影响目标网站的负载，如果我们不考虑这些，直接上多线程，不设置间隔时间暴力爬取信息很可能造成网站服务器崩溃，或者被反爬机制检测到，被ban。&lt;br&gt;
逻辑上就是爬虫表现的越像人类的操作越好，人类不可能每秒进行上百次的网页点击操作。我们试想一下，同时全网有1000个人在某时段访问目标网页，使用的终端，访问的内容，查找的频率都不同。那么想模拟人类的操作注意：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ip地址不同&lt;/li&gt;
&lt;li&gt;使用的终端不同&lt;/li&gt;
&lt;li&gt;访问间隔不同&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;其中解决不同ip的问题可以使用代理池，获得稳定的代理池具有一定的难度，如果目标网站反爬机制没有那么严格的话，我感觉没必要折腾这个，特别是对于GET类型的请求。&lt;br&gt;
其次通过不同终端，这个比较好解决，多开几个不同厂家的浏览器，然后打开开发人员模式在&lt;code&gt;network&lt;/code&gt;查看&lt;code&gt;User_Agent&lt;/code&gt;,记录下来。然后建池，在R语言汇中使用&lt;code&gt;sample&lt;/code&gt;函数每次迭代随机选择。MAC电脑safari浏览器可以模拟不同的浏览器进行访问，这样就比较简单了，只需要在&lt;code&gt;Develop =&amp;gt; User Agent&lt;/code&gt;选项卡切换浏览器就可以了。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;user_agents = c(
  &amp;quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.3 Safari/605.1.15&amp;quot;,
  &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/110.0&#39;,
  &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36 Edg/103.0.1264.37&#39;,
  &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36 Edg/103.0.1264.37&#39;,
  &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36&#39;,
  &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36&#39;,
  &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:101.0) Gecko/20100101 Firefox/101.0&#39;
)
random_agent &amp;lt;- sample(user_agents,1)

headers = c(&#39;User_Agent&#39; = random_agent,&#39;Accept&#39; = &amp;quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&amp;quot;)
url &amp;lt;- &amp;quot;http://www.knapsackfamily.com/knapsack_core/result.php?sname=all&amp;amp;word=&amp;quot;

html &amp;lt;- RCurl::getURL(url = paste0(url,ID),header = headers,.encoding = &#39;UTF-8&#39;)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;第三设置随机访问间隔，同样，我们随机生成n个&lt;code&gt;1-3&lt;/code&gt;秒之间的随机数，用&lt;code&gt;round&lt;/code&gt;把他控制在两位小数（没啥卵用），然后在开头用&lt;code&gt;Sys.sleep()&lt;/code&gt;设置停顿，这样每次迭代的时等待的时间长短不一样。也就模拟了你两次点击网站的间隔也是不同的。&lt;br&gt;
这样我们每个1-3秒访问一次网站，对网站的负载影响也不会太剧烈。&lt;/p&gt;
">「R-Crawler」规范化与技巧</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/tbtools-plugin-wgcna-shiny-app-geng-xin/"" data-c="
          &lt;p&gt;年前CJ大佬深度体验了下WGCNAshiny， 提了一些非常好的建议和意见，过年的时候折腾了几天，改善了一些东西，距离上次发布更新已经过去很久了，期间随着课题的进展，我自己也添加了一些内容。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2 id=&#34;太长不看省流版本&#34;&gt;太长不看省流版本&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;安装方法：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;通过TBtools插件：&lt;a href=&#34;https://zhuanlan.zhihu.com/p/590982545&#34;&gt;新插件更新-TBtools&lt;/a&gt; 直接安装打包好的插件即可，非常方便！&lt;/li&gt;
&lt;li&gt;Rstudio &lt;a href=&#34;https://github.com/ShawnWx2019/WGCNA-shinyApp&#34;&gt;ShawnWx2019/WGCNA-shinyApp&lt;/a&gt; ， 更新shinyapp之前，通过下面代码更新依赖包.&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;devtools::install_github(&amp;quot;ShawnWx2019/WGCNAShinyFun&amp;quot;,ref = &amp;quot;master&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;更新内容：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;🔨 改动了表达量矩阵输入类型。从之前的&lt;code&gt;count&lt;/code&gt;和&lt;code&gt;FPKM&lt;/code&gt;更新为&lt;code&gt;count&lt;/code&gt; 、&lt;code&gt;expected count&lt;/code&gt; 、&lt;code&gt;normalized count&lt;/code&gt;、&lt;code&gt;peak area&lt;/code&gt; 以及&lt;code&gt;protein abundance&lt;/code&gt;。更加准确和符合逻辑；&lt;/li&gt;
&lt;li&gt;🍭 保留基因数量（reserved genes number）超过过滤后的基因数量会自动选择过滤后的基因数量；&lt;/li&gt;
&lt;li&gt;🎊 去除离群样本（Remove outlier）；&lt;/li&gt;
&lt;li&gt;🎊 在网络构建和模块-性状关系构建步骤增加progress bar，防止多次点击导致程序重复运行；&lt;/li&gt;
&lt;li&gt;💪加入迭代WGCNA（iterative WGCNA）选项，开发中.... 不过可以通过&lt;code&gt;method2&lt;/code&gt;的方式净化模块。&lt;/li&gt;
&lt;li&gt;🍭 参数输出，这里增加了&lt;code&gt;Env output&lt;/code&gt;选项卡，方便有R语言基础的同学保留shinyapp运行时使用的参数配置，结合R语言进行进一步分析，同时方便复现之前的结果。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;啰嗦版本&#34;&gt;啰嗦版本&lt;/h2&gt;
&lt;h3 id=&#34;为何要加入代谢组和蛋白组数据&#34;&gt;为何要加入代谢组和蛋白组数据&lt;/h3&gt;
&lt;p&gt;细心的同学注意到我在新版本中输入数据的&lt;code&gt;format&lt;/code&gt;有了很大改动。当然之前的count和FPKM太过随意了。下面从两部分解释下为何要修改成目前这样，当然也广泛接受大家的意见和建议，会在下个版本继续更新。&lt;/p&gt;
&lt;p&gt;首先整体其实还是分了两大块，总结一下就是read count类型数据和其他类型数据。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;格式&lt;/th&gt;
&lt;th&gt;特征&lt;/th&gt;
&lt;th&gt;备注&lt;/th&gt;
&lt;th&gt;标准化方法&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;count&lt;/td&gt;
&lt;td&gt;整数&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;vst&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;expected count&lt;/td&gt;
&lt;td&gt;不全是整数&lt;/td&gt;
&lt;td&gt;通过向上取整的方式转换为整数&lt;/td&gt;
&lt;td&gt;vst&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;normalized count&lt;/td&gt;
&lt;td&gt;归一化后的readcount&lt;/td&gt;
&lt;td&gt;Fpkm tpm cpm rpkm 等&lt;/td&gt;
&lt;td&gt;Raw/log10(x+1)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;peak area（metabolomics）&lt;/td&gt;
&lt;td&gt;一般数值会非常大&lt;/td&gt;
&lt;td&gt;不推荐直接使用原始峰面积，需要使用标准化后的数值，比如商业软件CD，开源软件tidymass等进行数据过滤和归一化后的代谢物积累矩阵&lt;/td&gt;
&lt;td&gt;Log10（x）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;protein abundance&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;同样需要归一化以后的蛋白质丰度。&lt;/td&gt;
&lt;td&gt;Log10（x）&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;这里值得注意的是我把非靶代谢和蛋白质组学的数据也放进来了，&lt;strong&gt;这并不意味着这类型的数据无论从数学原理出发还是生物学原理出发适合构建共表达网络。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;我这里将非靶代谢组学的数据和蛋白质组学数据加入进来，&lt;strong&gt;本意是并不是非要通过WGCNA构建共表达网络，而是将WGCNA作为一种高效数据挖掘的方法。&lt;/strong&gt; 例如当我们在做大规模（large-scale）非靶代谢组学数据分析时，会发现我们会面临很多问题，比如对自然群体的非靶代谢组学分析，如果通过k-means，hclust等方法去归纳群体材料和代谢物类型之间的关系会很吃力，但是同过WGCNA将积累规律类似的代谢物进行模块划分，有很大几率总结出材料-代谢物之间的规律，提高了数据挖掘的效率。而后续的代谢物共积累网络构建则成为锦上添花的内容，并非重点。后续有机会可能会展开讲一下想法，不一定准确。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;UI改动：&lt;/strong&gt;&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732870.png&#34; alt=&#34;Figure 1. 数据输入改动&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;代码改动：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;getdatExpr = function(rawdata,RcCutoff,samplePerc,datatype,method){
  ##&amp;gt; Noise filtering
  x &amp;lt;-
    rawdata %&amp;gt;%
    setNames(c(&amp;quot;id&amp;quot;,colnames(.)[-1])) %&amp;gt;%
    mutate(id = as.character(id)) %&amp;gt;% ## aviod numeric columns.
    column_to_rownames(&amp;quot;id&amp;quot;) %&amp;gt;%
    filter(
      rowSums(. &amp;gt; RcCutoff) &amp;gt; (samplePerc*ncol(.))
    )
  if (
    datatype == &amp;quot;expected count&amp;quot;
  ) {
    x &amp;lt;- x %&amp;gt;%
      mutate_if(is.numeric,ceiling)
  }
  ##&amp;gt; Normalization
  if(method == &amp;quot;vst&amp;quot;) {
    dx &amp;lt;- x %&amp;gt;%
      as.matrix() %&amp;gt;%
      varianceStabilizingTransformation(., blind = TRUE)
  } else if (method == &amp;quot;logarithm&amp;quot;) {
    if (datatype == &amp;quot;normalized count&amp;quot;) {
      dx &amp;lt;- log10(x+1)
    } else {
      dx &amp;lt;- log10(x)
    }
  } else if (method == &amp;quot;raw&amp;quot;) {
    dx &amp;lt;- x
  } else {
    return()
  }
  return(dx)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;程序防呆设计&#34;&gt;程序防呆设计&lt;/h3&gt;
&lt;p&gt;这些错误可以忽略掉了，放心造&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;规避纯数字基因名称&lt;/strong&gt; 根据用户的反馈，发现某些转录组数据的gene id是纯数字的，在R对纯数字的列转换成rownames如果不连续会报错，所以这里会把第一列直接转换成字符格式，防止该错误发生。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;自动转换标准化方式&lt;/strong&gt;，上面介绍了不同数据类型有对应的标准化方法，当然我知道不是每个用户都会认真读手册，所以这里做了自适应，在&lt;code&gt;format&lt;/code&gt;确定了格式后，&lt;code&gt;Normalized method&lt;/code&gt;只会显示对应的标准化方式选项。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;保留基因数量大于了过滤后总数&lt;/strong&gt; 这个也是常见的报错，如果你填写的&lt;code&gt;reserved gene Num.&lt;/code&gt;大于了过滤后的基因数量会导致报错，这里加了判断，如果这种情况发生，直接保留过滤后的基因数目。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;进度条&#34;&gt;进度条&lt;/h3&gt;
&lt;p&gt;CJ大佬在体验的时候发现在等待时间较长的Module-net阶段，不知道运行完没有，有些用户可能会觉得是不是没点到&lt;code&gt;start&lt;/code&gt; 于是就又按了几次，特别是对于没有更新新版本&lt;code&gt;Rserver&lt;/code&gt;以及Rstudio用户中没有折腾&lt;code&gt;blas&lt;/code&gt;的用户，这个等待时间会更长，所以现在在module-net和module-trait加入了和&lt;code&gt;SFT&lt;/code&gt;步骤中一样的进度条，你点了就会跳&lt;code&gt;progress bar&lt;/code&gt;运行完消失。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;UI画面：&lt;/strong&gt;&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;2&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732854.png&#34; alt=&#34;Figure 2. Progress bar 添加&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;3&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732855.png&#34; alt=&#34;Figure 3. Module-Trait改动&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;h3 id=&#34;去除离群样本&#34;&gt;去除离群样本&lt;/h3&gt;
&lt;p&gt;有时候数据量大的时候可能会出现离群样本，如下图，我们可以通过&lt;code&gt;RemoveOutlier（option）&lt;/code&gt;来去掉离群样本，由于shiny中比较难实现&lt;code&gt;do-over&lt;/code&gt;这样的过程，所以就得麻烦大家重新开始了，**开始上传前最好刷新下网页，并把鼠标点到第一个选项卡&lt;code&gt;input file check&lt;/code&gt;。然后再点&lt;code&gt;update information&lt;/code&gt;&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;4&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732856.png&#34; alt=&#34;Figure 4. 离群样本检测&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;5&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732858.png&#34; alt=&#34;Figure 5. 离群样本去除&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;h3 id=&#34;迭代wgcna&#34;&gt;迭代WGCNA&lt;/h3&gt;
&lt;p&gt;关于迭代WGCNA，推荐看&lt;a href=&#34;https://www.biorxiv.org/content/10.1101/234062v1&#34;&gt;iterativeWGCNA: iterative refinement to improve module detection from WGCNA co-expression networks&lt;/a&gt; 作者用python搭建的流程，有需要的可以通过&lt;a href=&#34;https://github.com/cstoeckert/iterativeWGCNA&#34;&gt;cstoechert/iterativeWGCNA&lt;/a&gt; 实现。&lt;strong&gt;这部分我并没有用shinyapp复现&lt;/strong&gt; 确实难度比较大，加上之前说的do over很难，基本做不到自动迭代。所以&lt;code&gt;method1&lt;/code&gt;是没有用的。可能后续有精力了尝试折腾下。&lt;/p&gt;
&lt;p&gt;这里&lt;code&gt;method2&lt;/code&gt;提到的迭代，原理和方法和上面是不一样的，我的目的也很明确，就是首先在可以获得到一个非常趋近于无标度网络的情况下（有非常合适的软阈值），这个网络首先是比较稳健的。然后在此基础上去掉无法分类的基因和一部分kME（eigengene based connectivity）较低的基因来纯化模块，迭代过程中sft可能发生细微的变化，但整体不会发生很大的变化。这样无论在数据挖掘还是后续的共表达网络可视化都会有一定程度的优化。&lt;/p&gt;
&lt;p&gt;基本操作就是&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;基本原理：&lt;/strong&gt;&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;6&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202206081018077.png&#34; alt=&#34;Figure 6.基本原理&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;方法：&lt;/strong&gt;&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;7&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732279.png&#34; alt=&#34;Figure 7.筛选方法&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;项目示例：&lt;/strong&gt;&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;8&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732859.png&#34; alt=&#34;Figure 8. 迭代去除结果&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;h3 id=&#34;环境变量导出&#34;&gt;环境变量导出&lt;/h3&gt;
&lt;p&gt;经常遇到这种问题，过了很长时间，想回来复现一下当时通过WGCNAshiny跑的结果，发现怎么也对应不上，后来发现是当时设置的参数忘记了，这里加入了&lt;code&gt;Env output&lt;/code&gt;，当做完&lt;code&gt;module-trait&lt;/code&gt;之后会看见该选项卡，点击数据整合&lt;code&gt;Integrate data&lt;/code&gt;会立刻把所有中间变量以&lt;code&gt;.rsd&lt;/code&gt;的形式保存下来，然后点击下载可以得到一个&lt;code&gt;EnvImg.rsd&lt;/code&gt;的文件。这个可以在Rstudio中通过&lt;code&gt;readRDS(&#39;filepath/EnvImg.rsd&#39;)&lt;/code&gt; 加载出来，这样不仅可以看到当时所有的参数，而且运行数据所有的中间变量都被保存，有R基础的可以直接拿去进行下游分析。&lt;/p&gt;
&lt;p&gt;比如我们把EnvImg.rsd放在家目录下的&lt;code&gt;Download&lt;/code&gt;文件夹下&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;x &amp;lt;- readRDS(&amp;quot;~/Downloads/EnvImg.rds&amp;quot;)
# 我们通过x$ 就可以查看参数和中间变量
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;x是一个列表&lt;code&gt;list&lt;/code&gt;，存放这所有的中间变量和参数&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;9&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732860.png&#34; alt=&#34;Figure 9. 环境变量预览&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;h2 id=&#34;最后&#34;&gt;最后&lt;/h2&gt;
&lt;p&gt;多谢CJ大佬提意见，还有群里的老铁们不断鞭策，鸽王又鸽了大家一回！😂&lt;/p&gt;
">「TBtools-Plugin」WGCNA shiny app 更新</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/「TBtools-Plugin」如何把Shiny-App搞成TBtools插件/"" data-c="
          &lt;p&gt;emmm， 这篇文章后半部分还是面向TBtools插件开发者。原因和上一篇一样，因为操作太简单了&lt;/p&gt;
&lt;p&gt;...&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;&lt;strong&gt;国际惯例，先上图&lt;/strong&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/shinyTBtoolsPlugin.jpg&#34; alt=&#34;Bubble_shiny&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;扯在前面的蛋&#34;&gt;扯在前面的蛋&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;紧急插播：&lt;/strong&gt;&lt;br&gt;
mac用户在安装插件之前，需要先打开Rserver输入以下代码：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;install.packages(&amp;quot;https://cran.r-project.org/bin/macosx/contrib/4.0/cachem_1.0.3.tgz&amp;quot;, repo=NULL,type=&amp;quot;source&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;原因是&lt;code&gt;cachem&lt;/code&gt;包前几天更新了，是shiny的依赖包，不知道是tuna没有更新&lt;code&gt;cachem&lt;/code&gt;在macos下的二进制包还是怎么回事，R会从源码（src）编译，在win下没问题，但是貌似在mac下编译会出错... 所以mac用户这段时期只能安装&lt;code&gt;cran&lt;/code&gt;的&lt;code&gt;binaries&lt;/code&gt;，而且测试了下新的1.0.4版本貌似不能用，（不清楚是shiny没更新还是tuna的问题）1.0.3版本目前没问题。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;自从CJ大佬打包了R之后，实现了不需要折腾linux或者unix终端，或者windows下用Rscript运行R脚本，直接通过点点点实现，其实这个操作在之前的Shiny中早就实现了，但是一直没有勇气去折腾... 潜哥和邵博建议我去鼓捣下，过年这段日子也没法干活，就跟着B站搬运油管的shiny app入门的视频教程学了起来。&lt;br&gt;
传送门：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;B站： &lt;a href=&#34;https://www.bilibili.com/video/BV1RJ411E7Fx?from=search&amp;amp;seid=4694507056464394541&#34;&gt;手把手 如何制作R Shiny app&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;油管： &lt;a href=&#34;https://www.youtube.com/watch?v=_0ORRJqctHE&amp;amp;list=UUbck9jjLpwj7U6HHNps_9Gw&amp;amp;t=0s&#34;&gt;R Shiny app tutorial # 1 - How to make shiny apps - An introduction to Shiny&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;github: &lt;a href=&#34;https://github.com/aagarw30/R-Shinyapp-Tutorial&#34;&gt;R-Shinyapp-Tutorial&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;作者：&lt;em&gt;Abhinav Agrawal&lt;/em&gt;&lt;br&gt;
这位老哥的教程可以说是一勺一勺喂，感觉在稍微精通R的情况下，只要不憨，把视频啃完，上手shiny App没问题...&lt;br&gt;
额，时间有限，没有看完大佬的讲解，直接上github把代码撸下来看着理解。现在也基本看了不到1/5，了解一点点皮毛，就开始上手搞了...依样画葫芦，用辣眼睛的代码把之前的那个bubble plot做成了shiny app。虽然很粗糙，but，又不是不能用！&lt;/p&gt;
&lt;p&gt;Shiny App的优点在于你可以实时调整参数而且看到调参后的结果，这个就很爽了。试想一下之后吧OneStepWGCNA写成Shiny App，可以放更多的参数，甚至可以分步做，第一步样品聚类剔除掉离群值，然后看sft选择合适的power，接着根据分模块的情况选择最小模块基因数量...后续还有拿出感兴趣的基因做GS MM，导出关系等...（我好像给自己挖了个坑...）&lt;/p&gt;
&lt;p&gt;而今天的推文主要是我发现shiny app其实可以写成脚本用Rscript启动，然后本地测试，既然能用Rscript跑，那么就能搞成插件... 所以在情人节那天，搞了一天整出来了。后续还是CJ大佬的一个常规操作，点击运行后直接弹出浏览器，运行Shiny App。&lt;/p&gt;
&lt;h2 id=&#34;shiny-app界面&#34;&gt;Shiny App界面&lt;/h2&gt;
&lt;p&gt;简单来讲可以把它看做一个网页工具。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/shiny1.jpg&#34; alt=&#34;shiny app page&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
我们把左边的灰色的这一栏叫做&lt;code&gt;side bar&lt;/code&gt;里面是一些调节参数的部件，&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Browse...&lt;/strong&gt; 点击后上传你的富集分析结果，&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Input File Type&lt;/strong&gt; 选择你输入的文件是什么软件导出的结果，TBtools的GO enrichment工具还是kegg enrichment工具，这两种结果可以直接上传软件生成的原始表格，但是其他富集分析的结果比如&lt;code&gt;David&lt;/code&gt;等一些其他软件导出的结果需要按照我之前提到的格式修改表格并且保存成&lt;strong&gt;制表符分隔符的txt文件&lt;/strong&gt;再进行导入。这里我放了GSEA的结果，这个是新加的。如果有GSEA的结果想要展示需要按照以下格式整理，就是将GSEA结果中&lt;code&gt;gsea_report_for_xxx.A.tsv&lt;/code&gt;和&lt;code&gt;gsea_report_for_xxx.B.tsv&lt;/code&gt;两个文件中的term合并，当然筛选条目的标准自己定义，这里不做推荐。GSEA结果的可视化现在还不完美，后续会继续调整...&lt;/li&gt;
&lt;/ul&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/GSEA.jpg&#34; alt=&#34;GSEA demo&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Select the value from Slider&lt;/strong&gt; 额，这里偷懒忘了改label了，这里其实想说的是&lt;strong&gt;The number of GO term (KEGG pathway) to be displayed&lt;/strong&gt; 就是图片上想展示的GO Term或者KEGG pathway数量。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Pvalue color Minimum/maxmum&lt;/strong&gt; pvalue的颜色范围，这个好理解，点开就是个取色板，玩过PS或者AI的同学应该熟悉。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Project name&lt;/strong&gt; 我执意保留的一个没啥用的选项... 用来区分你不同的富集分析结果导出图片的名字。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Graph size-width/height&lt;/strong&gt; 在插件版中，我自己写了一个&lt;code&gt;figsize&lt;/code&gt;的函数来自动调整图片大小随着 longest term和term number变化自动调节，这里吧这个权利还给了用户，让你自定义大小，输出自己看的顺眼的图片。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;右边有两个页面，一个Table，一个plot&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;table目前没有做扩展，只是简单的将你输入的表格显示出来，后续可能会出一些选项实现筛选，过滤等操作....&lt;/li&gt;
&lt;li&gt;plot就是简洁明了的图片展示，现在还没有找到调整height的合适方法，不过可以达到预览的效果... 凑合用吧...&lt;/li&gt;
&lt;li&gt;Download按钮
&lt;ul&gt;
&lt;li&gt;如果你GO term（或者kegg pathway）中最长的那个term又臭又长，我建议把size-width调大一点，如果你选择的GO term很多，比如100，建议把height也调大一点。不过那么大的图片基本放论文里不可能了....&lt;/li&gt;
&lt;li&gt;后续可能会把上限调高一点... 看用户反馈&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;p&gt;下面内容适合插件开发者。&lt;/p&gt;
&lt;h2 id=&#34;tbtools-plugin-shiny-app-脚本结构&#34;&gt;TBtools plugin Shiny App 脚本结构&lt;/h2&gt;
&lt;p&gt;可能有人觉得我是脱了裤放屁，多此一举，都整成shiny app了，为啥还要打成TBtools插件，难道是在搞套娃吗..&lt;br&gt;
其实不然，&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;首先，我没有自己的服务器去部署shiny app，即便之前买了3年的腾讯云，但是1核2G... 还是鸡肋。所以不如打包在自己的pc上跑；&lt;/li&gt;
&lt;li&gt;其次，就算写好了R脚本，运行起来，不管通过Rstudio还是Rscript，都有一定的门槛，虽然很低...&lt;/li&gt;
&lt;li&gt;不是说写成插件就所有人都会用了，还可能有一部分同学搞不明白，根据之前的反馈，多半是死在了包安装上... 但这是我能想到的目前可行的最方便的方法了...&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我们看Shiny App的脚本结构基本分为&lt;code&gt;ui&lt;/code&gt;和&lt;code&gt;server&lt;/code&gt;两部分，最后&lt;code&gt;shinyApp(ui = ui, server = server)&lt;/code&gt;,当然要让软件跑起来，还需要预先做好准备工作所以我的脚本大概分为下面4部分：&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBtools-plugin%20ShinyApp.png&#34; alt=&#34;代码结构&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;准备工作&#34;&gt;&lt;strong&gt;准备工作&lt;/strong&gt;&lt;/h2&gt;
&lt;p&gt;一些预设选项和包加载，其中&lt;code&gt;shiny&lt;/code&gt;和&lt;code&gt;htmltools&lt;/code&gt;是必须装的，而且独立安装htmltools的版本和&lt;code&gt;shiny&lt;/code&gt;要求的版本不符,所以建议先装shiny，然后library一下，会提示需要装哪个版本的&lt;code&gt;htmltools&lt;/code&gt; 然后再装&lt;code&gt;htmltools&lt;/code&gt;就搞定了，另外&lt;code&gt;jscode&lt;/code&gt;这里和&lt;code&gt;shinyjs&lt;/code&gt;也写上，这些是为后面在界面上出现一个关闭APP按钮而设置的，不然你用插件打开shinny app后没办法关闭它，在你关机或重启之前，你那个localhost的端口会一直被占用。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;## options and import packages
options(stringsAsFactors = F)
options(&amp;quot;repos&amp;quot; = c(CRAN=&amp;quot;https://mirrors.tuna.tsinghua.edu.cn/CRAN/&amp;quot;))
jscode &amp;lt;- &amp;quot;shinyjs.closeWindow = function() { window.close(); }&amp;quot; # using shinyjs to stop shiny app
if (!require(&#39;shiny&#39;)) install.packages(&#39;shiny&#39;)
library(shiny)
if (!require(&#39;htmltools&#39;)) install.packages(&#39;htmltools&#39;)
if (!require(&#39;ggplot2&#39;)) install.packages(&#39;ggplot2&#39;)
if (!require(&#39;dplyr&#39;)) install.packages(&#39;dplyr&#39;)
if (!require(&#39;stringr&#39;)) install.packages(&#39;stringr&#39;)
if (!require(&#39;magrittr&#39;)) install.packages(&#39;magrittr&#39;)
if (!require(&#39;shinyjs&#39;)) install.packages(&#39;shinyjs&#39;)
if (!require(&#39;colourpicker&#39;)) install.packages(&#39;colourpicker&#39;)
library(shiny)
library(shinyjs)
library(colourpicker)
library(ggplot2)
library(dplyr)
library(magrittr)
library(stringr)
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;提前写好function&#34;&gt;&lt;strong&gt;提前写好function&lt;/strong&gt;&lt;/h2&gt;
&lt;p&gt;主要是方便后面调用，如果到了server中再去写这些会使server部分的代码看起来很臃肿，其次是这些function我提前写好了....&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;## functions
## 01.GO Bubble Plot
## function中内容太长了，省略掉了
GOBubblePlot = function(expfile, num, name,colormin,colormax,Gtype){...}
KEGGBubblePlot = function(expfile, num, name,colormin,colormax,Gtype){...}
customBubblePlot = function(expfile, num, name,colormin,colormax,Gtype){...}
GSEAplot = function(expfile, num, name,colormin,colormax,Gtype){...}
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;ui界面&#34;&gt;&lt;strong&gt;ui（界面）&lt;/strong&gt;&lt;/h2&gt;
&lt;p&gt;没有用shinydashboard，就默认的...美化之类的是以后有空琢磨的事，现在的任务就是把它跑出来。 节省版面，具体设置省略 代码放在gitee.&lt;br&gt;
大框架就是先整一个fluidPage，下层分别是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;标题框&lt;/li&gt;
&lt;li&gt;调用shinyjs&lt;/li&gt;
&lt;li&gt;动作是关闭窗口&lt;/li&gt;
&lt;li&gt;动作按钮设置&lt;/li&gt;
&lt;li&gt;sidebar 框架
&lt;ul&gt;
&lt;li&gt;sidebar (参数调整界面）&lt;/li&gt;
&lt;li&gt;mainPanel （结果呈现界面）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;ui = shinyUI(fluidPage(
  titlePanel(h4(&amp;quot;Enrichment Bubble Plot&amp;quot;)),
  
  # stop shiny app via js code
  useShinyjs(),
  extendShinyjs(text = jscode, functions = c(&amp;quot;closeWindow&amp;quot;)),
  actionButton(&amp;quot;close&amp;quot;, &amp;quot;Stop the App&amp;quot;, class = &amp;quot;btn-warning&amp;quot;),
  # sidebar setting
  sidebarLayout(
    sidebarPanel(
      # Input files
      fileInput(inputId = &amp;quot;file&amp;quot;,
                label = &amp;quot;Upload enrichment result&amp;quot;),
      help(&amp;quot;The results of TBtools enrichment can be uploaded directly, results generated from other softwares need to be input in the required format&amp;quot;),
      # Select the input file type.
      radioButtons(...),
      # Term number, how many terms do you want to demonstrate
      sliderInput(...),
      # Min color
      colourpicker::colourInput(...),
      # Max color
      colourpicker::colourInput(...),
      # Graph type, bubble plot or bar plot
      radioButtons(...),
      # Project name
      textInput(...),
      # output graph size width
      sliderInput(...),
      # output graph size height
      sliderInput(...),
      p( &amp;quot;If there is a longer GO term or Pathway name, it is recommended to increase the width of the picture. If the number of terms you select is to large, it is recommended to increase the height of the picture.&amp;quot;)
    ),
    # demonstration part
    mainPanel(
      uiOutput(&amp;quot;tb&amp;quot;)
      )
    )
  )
)
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;server代码执行&#34;&gt;&lt;strong&gt;server(代码执行)&lt;/strong&gt;&lt;/h2&gt;
&lt;p&gt;辣眼睛的来了...&lt;br&gt;
如果把ui界面想成参数设置的板块，那么server这块就是用之前的参数，数据进行处理，最终生成结果。&lt;br&gt;
学艺不精... 本着能用就行的态度写了这一串又臭又长的reactive... 早上邵阳老铁指出可以精简的方法，哈哈，正在消化。其实也可以看出在写server板块之前先把function写好，确实会让server代码看起来更加清爽一点..&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;
server &amp;lt;- shinyServer(function(input,output){
  ## set para
  DataF &amp;lt;- reactive({
    as.character(input$DataF)
  })
  num &amp;lt;- reactive({
    as.numeric(input$num)
  })
  name &amp;lt;- reactive({
    as.character(input$name)
  })
  colormin &amp;lt;- reactive({
    as.character(input$colormin)
  })
  colormax &amp;lt;- reactive({
    as.character(input$colormax)
  })
  Gtype &amp;lt;- reactive({
    as.character(input$Gtype)
  })
  w &amp;lt;- reactive({
    as.numeric(input$w)
  })
  h &amp;lt;- reactive({
    as.numeric(input$h)
  })
  # import file
  data &amp;lt;- reactive({...
  })
  ## show tables
  output$finalTable &amp;lt;- renderTable({...
  })

  p &amp;lt;- reactive({
    if(is.null(data())){return()}
    if (DataF() == &amp;quot;TBtools_GO&amp;quot;) {
      GOBubblePlot(...)
    } else if (DataF() == &amp;quot;TBtools_KEGG&amp;quot;) {
      KEGGBubblePlot(...)
    } else if (DataF() == &amp;quot;customized&amp;quot;) {
      customBubblePlot(...)
    } else if (DataF() == &amp;quot;GSEA&amp;quot;) {
      GSEAplot(...)
    }
  })
  ## exhibit plot
  output$finalplot &amp;lt;- renderPlot({
    p()
  })
  ## download
  output$down &amp;lt;- downloadHandler(
    filename = function(){
      paste0(name(),&amp;quot;Bubble_plot.pdf&amp;quot;)
    },
    content = function(file){
      ggsave(file,plot = p(),width = w(),height = h(),dpi = 300)
    }
  )
  ## table sets
  output$tb &amp;lt;- renderUI({
    if(is.null(data()))
      h5(&amp;quot;Please upload your enrichment result&amp;quot;)
    else
      tabsetPanel(tabPanel(title = &amp;quot;Table&amp;quot;,tableOutput(&amp;quot;finalTable&amp;quot;)),
#                  tabPanel(title = &amp;quot;Information&amp;quot;,tableOutput(&amp;quot;info&amp;quot;)),
                  tabPanel(title = &amp;quot;plot&amp;quot;,
                           plotOutput(&amp;quot;finalplot&amp;quot;),
                           downloadButton(&amp;quot;down&amp;quot;,&amp;quot;Download the plot in PDF formate&amp;quot;)))
})
  ## close window
  observeEvent(input$close, {
    js$closeWindow()
    stopApp()
  })
}) 
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;总结&#34;&gt;总结&lt;/h2&gt;
&lt;p&gt;写shiny的确是一种挑战，我这次小试牛刀就感觉真的麻烦无比，但是这种感觉好像刚开始学习R一样，或许写着写着就熟练了... 先达到能用，再到界面布局优化，再到代码高效，整洁。蹒跚学步，抛砖引玉... 最后期待下各位大神的作品吧！&lt;br&gt;
献丑了...&lt;/p&gt;
">「TBtools Plugin」如何把Shiny App搞成TBtools插件 </a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/「R-Crawler」根据uniprot-ID批量提取GO-ID/"" data-c="
          &lt;p&gt;上次从uniprot网站用rvest提取了亚细胞定为的信息，这次还是冲uniprot用爬虫提取每个uniprotid对应的GOterm信息。&lt;/p&gt;
&lt;p&gt;...&lt;/p&gt;
&lt;!-- more --&gt;
&lt;h2 id=&#34;原理和收获&#34;&gt;原理和收获&lt;/h2&gt;
&lt;p&gt;这次又尝试了两个函数&lt;code&gt;html_elements&lt;/code&gt;和&lt;code&gt;html_attr&lt;/code&gt;&lt;br&gt;
之前直接粗暴的从&lt;code&gt;read_html&lt;/code&gt;+&lt;code&gt;html_text&lt;/code&gt;提取一堆信息，而这次则是有条理的查找，首先我们从edge（chrome）浏览器打开&lt;a href=&#34;https://www.uniprot.org/uniprot/C0LGQ9&#34;&gt;GOLGQ9&lt;/a&gt;的信息，然后用开发者模式查看html代码,我们可以通过移动鼠标选择特定位置查看他对应网页元素，最终我们一层一层打开后发现我们需要的GO ID在&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;&amp;lt;div class = &amp;quot;section&amp;quot; id = &amp;quot;function&amp;quot;&amp;gt;
    &amp;lt;ul class = noBumbering xxx&amp;gt;
        &amp;lt;li class=&amp;quot;GOxxx&amp;quot;&amp;gt;
            &amp;lt;a href=&amp;quot;http://url&amp;quot;...&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;当然除了BP应该还有CC，MF。 所以思路就是定位到&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20211129094658.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
">「R-Crawler」根据uniprot ID批量提取GO ID</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/「R-Crawler」根据uniprot-ID批量检测基因的亚细胞定位/"" data-c="
          &lt;p&gt;课题遇到一个需求，需要从&lt;code&gt;uniprot&lt;/code&gt; 网站数据库中查询目标蛋白的亚细胞定位情况，徒手一个一个搞肯定不行，这就需要使用爬虫了&lt;/p&gt;
&lt;p&gt;...&lt;/p&gt;
&lt;!-- more --&gt;
&lt;h2 id=&#34;应用场景&#34;&gt;应用场景&lt;/h2&gt;
&lt;p&gt;得到一组基因后想看这些基因或者蛋白质在&lt;a href=&#34;https://www.uniprot.org/&#34;&gt;uniprot&lt;/a&gt;中亚细胞定位的结果，我们以一个actin基因为例，我们之前从蛋白组数据中得知该基因的&lt;code&gt;UniprotKB&lt;/code&gt;号为：&lt;code&gt;P07830&lt;/code&gt;，打开uniprot搜索P07830得到：&lt;a href=&#34;https://www.uniprot.org/uniprot/P07830&#34;&gt;uniprot-P07830&lt;/a&gt;.&lt;br&gt;
在&lt;code&gt;uniprot annotation&lt;/code&gt;中我们发现定位只有细胞骨架（cytoskeleton），此外还有一个&lt;code&gt;GO term cell component&lt;/code&gt;的注释，这里面除了在细胞骨架外还有注释到其他部位。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20211103090404.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20211103090437.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;如果一个一个搜，5000多个要搜很久，关键是数量阅读，手工搜越容易出错，所以通过对网页观察，写一个爬虫，批量搜索是必要的。&lt;/p&gt;
&lt;h2 id=&#34;特征&#34;&gt;特征&lt;/h2&gt;
&lt;p&gt;首先我们在点击左边导航栏的Subcellular location，我们再看地址栏的url变成了&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;https://www.uniprot.org/uniprot/P07830#subcellular_location
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;其实对于不同的基因来说，亚细胞定位的网址规则就为&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;https://www.uniprot.org/uniprot/ + UniprotKB + #subcellular_location
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;整体信息提取的思路就清晰了：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;通过上述网址规则逐个将每个基因的亚细胞定位信息从uniprot爬取下来。&lt;/li&gt;
&lt;li&gt;通过正则或者其他手段检测我们需要的亚细胞定位信息。&lt;/li&gt;
&lt;li&gt;整理表格输出。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;运行&#34;&gt;运行&lt;/h2&gt;
&lt;p&gt;这里我们检测一系列蛋白是否会定位到叶绿体，&lt;br&gt;
所以我们需要提取的信息就很简单了，看亚细胞定位的结果中包不包含叶绿体（chloroplastic）&lt;/p&gt;
&lt;p&gt;这里用R的rvest包进行&lt;/p&gt;
&lt;p&gt;首先我们看用rvest爬取效果&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;## 先测试下 UniprotKB 为 P19366 
url_test = &amp;quot;https://www.uniprot.org/uniprot/P19366#subcellular_location&amp;quot;
read_html(url_test) %&amp;gt;% 
      rvest::html_text() 
## 结果
[1] &amp;quot;atpB - ATP synthase subunit beta, chloroplastic - Arabidopsis thaliana (Mouse-ear cress) - atpB gene &amp;amp; protein\n\t\t\tvar BASE = &#39;/&#39;;\n\t\t\n\t\t\t\tuniprot.isInternal = false;\n\t\t\t\tuniprot.namespace = &#39;uniprot&#39;;\n\t\t\t\tuniprot.releasedate = &#39;2021_03&#39;;\n\t\t\t\n\t\t\t;\n\t\t\n\t\t\t\t// variable to store annotation data\n\t\t\t\tvar annotations = [];\n\t\t\t\tvar entryId = &#39;P19366&#39;;\n\t\t\t\tvar isObsolete = false || !true;\n\t\t\t\r\n                                    &amp;lt;p&amp;gt;An evidence describes the source of an annotation, e.g. an experiment that has been published in the scientific literature, an orthologous protein, a record from another database, etc.&amp;lt;/p&amp;gt;\r\n\r\n&amp;lt;p&amp;gt;&amp;lt;a href=\&amp;quot;/manual/evidences\&amp;quot;&amp;gt;More...&amp;lt;/a&amp;gt;&amp;lt;/p&amp;gt;\r\n                                Skip Header   UniProtKBxUniProtKBProtein knowledgebaseUniParcSequence archiveHelpHelp pages, FAQs, UniProtKB manual, documents, news archive and Biocuration projects.UniRefSequence clustersProteomesProtein sets from fully sequenced genomesAnnotation systemsSystems used to automatically annotate proteins with high accuracy:UniRule (Expertly curated rules)ARBA (System generated rules)Supporting dataSelect one of the options below to target your search:Literature citationsTaxonomyKeywordsSubcellular locationsCross-referenced databasesHuman diseasesAdvancedSearchxHomeBLASTAlignRetrieve/ID mappingPeptide searchSPARQLContactHelpYou are using a version of browser that may not display all the features of this website. Please consider upgrading your browser.\n\t\tThe new UniProt website is here! \n\t\tTake me to UniProt BETAxUniProtKB - P19366\n\t\t\t(ATPB_ARATH)Basket 0(max 400 entries)x\n\t\t\t\t\tYou...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;我们看结果中有对该基因的注释中有大量的叶绿体（chloroplast）字段，看了下这些字段首先出现在.svg的图片中，说明是亚细胞定位的图片，其次是【pubmed】引用文献，最后是同源基因的描述，所以基本可以确定这个&lt;code&gt;P19366&lt;/code&gt;是定位在叶绿体了，同时从他的基因annotation中也可以看出这个基因是叶绿体基因组编码的。所以接下来就直接用&lt;code&gt;grepl&lt;/code&gt;去判断爬出来的这段乱七八糟的字符串中包不包含叶绿体（chloroplast）就可以判断了。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;# 加载包
library(rvest)
library(tidyverse)
## 读取UniprotKB 信息
test.p = read.delim(&amp;quot;~/15.PostDoc/02.Project/13.cyl/result.txt&amp;quot;,header = T,sep = &amp;quot;\t&amp;quot;)
head(test.p)
## 提取accession
acc = test.p$Accession
## 制作一个acc为第一列，第二列先填写0，用于后面循环中提取结果的放置
df = data.frame(
  Accession = acc,
  Chlo_TorF = 0
)

## 开始爬数据
for (i in 1:length(acc)) {
  Sys.sleep(0.5)
  tryCatch({
    url = paste0(&amp;quot;https://www.uniprot.org/uniprot/&amp;quot;,acc[i],&amp;quot;#subcellular_location&amp;quot;)
    torf = read_html(url) %&amp;gt;% 
      rvest::html_text() %&amp;gt;% 
      grepl(pattern = &amp;quot;chloroplast&amp;quot;,x = .)
    df[i,2] = as.character(torf)
    print(paste0(acc[i],&amp;quot; finish&amp;quot;))
  },error = function(e) {
    print(paste0(acc[i],&amp;quot; has no search result in uniprot&amp;quot;))}
  )
}
## 由于网络问题，有部分基因可能会爬取失败，没有打包function，就找到他们再来一遍最后合并一下。如果还有没有爬出来的，再重复一遍
## 给每个基因编号
df$seq = c(1:nrow(df)
## 找到搜索失败的基因对应的编号
df %&amp;gt;% 
  filter(x == 0) %&amp;gt;% 
  select(seq) %&amp;gt;% -&amp;gt;xx
## 处理成向量形式
xx = xx$seq
## 重新填充
for (i in xx) {
  Sys.sleep(0.5)
  tryCatch({
    url = paste0(&amp;quot;https://www.uniprot.org/uniprot/&amp;quot;,acc[i],&amp;quot;#subcellular_location&amp;quot;)
    torf = read_html(url) %&amp;gt;% 
      rvest::html_text() %&amp;gt;% 
      grepl(pattern = &amp;quot;chloroplast&amp;quot;,x = .)
    df[i,2] = as.character(torf)
    print(paste0(acc[i],&amp;quot; finish&amp;quot;))
  },error = function(e) {
    print(paste0(acc[i],&amp;quot; has no search result in uniprot&amp;quot;))}
  )
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;结果我们会得到一张表格，第一列是UniprotKB ID，第二列是判断是否包含叶绿体，这样就把我们query中的基因是否在亚细胞定位结果中出现叶绿体做了批量判断。&lt;/p&gt;
">「R-Crawler」根据uniprot ID批量检测基因的亚细胞定位</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/「TBtools-Plugin」WGCNAShiny保姆级教程/"" data-c="
          &lt;p&gt;原本以为毕业了就起飞了，没想到，喵的比没毕业还累...&lt;br&gt;
又鸽了仨月，这个小插件到时完善了不少，但是上次承诺的视频还是没有录。原因不说了，准备手打！ 还是写个教程为好。录视频，怕是要不知何年何月了...&lt;/p&gt;
&lt;p&gt;对比大佬的下班时间发现，忙从来不是借口，懒才是....&lt;/p&gt;
&lt;!-- more --&gt;
&lt;p&gt;本文只是对WGCNAShiny软件使用的介绍，关于WGCNA原理建议阅读文献，简书知乎B站各位大佬也有讲解，我自己并没有把握讲清楚。下面放一个生信技能树的原理讲解，推荐大家花点时间看一下。有能力的跟着操作一遍加深理解。关于结果怎么看，这个听别人讲听不明白，多看几篇文献就搞清楚了。&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.bilibili.com/video/BV1584y1F7pw?from=search&amp;amp;seid=2638791580096845062&amp;amp;spm_id_from=333.337.0.0&#34;&gt;生信技能树-WGCNA原理与实践part1 &lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.bilibili.com/video/BV1tf4y1s7fy?from=search&amp;amp;seid=2638791580096845062&amp;amp;spm_id_from=333.337.0.0&#34;&gt;生信技能树-WGCNA原理与实践part2&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://elifesciences.org/articles/29655&#34;&gt;elife-WGCNA经典文献&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;篇幅太长 就不扯淡了&lt;/p&gt;
&lt;h2 id=&#34;怎么安装&#34;&gt;怎么安装&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;方法一：&lt;/strong&gt; 对于熟练使用R和Rstudio的老铁们，而且遇见报错能通过google，Stack Overflow等途径自己搞定的同学，直接去我的&lt;a href=&#34;https://github.com/ShawnWx2019/WGCNA-shinyApp&#34;&gt;github仓库&lt;/a&gt; 克隆到本地或者直接下载&lt;code&gt;WGCNAbyClick.v1.R&lt;/code&gt;脚本。然后用Rstudio打开，点击下图中位置的&lt;code&gt;RunApp&lt;/code&gt;直接运行，如果你运气好，直接就装上了，然后弹出网页就可以直接做了，但大概率你运气会不太好，底下一堆报错，然后就靠你自己的本事debug把没有装上的包装上了，我的锅，为了让这个shinyapp更好用，调了一堆奇葩包。😂 &lt;strong&gt;「友情提示」：务必将你的R升级到4.1！！！！&lt;/strong&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA2.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;方法二：&lt;/strong&gt; 如果你不想折腾，就用TBtools插件安装吧！！CJ大佬为了帮大家搞定包安装专门开发了R Plugin Installer Helper插件！由于我太菜了，😭目前WGCNAShiny的&lt;code&gt;meta-package&lt;/code&gt;木有搞出来，不过很快会向大家见面。使用方法:&lt;a href=&#34;https://mp.weixin.qq.com/s/cYte0z-m1J6Rr22I-vRVvw&#34;&gt;&lt;strong&gt;生信药丸 解决方案！TBtools R Plugin 安装~ 终极奥义&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;更新内容&#34;&gt;更新内容&lt;/h2&gt;
&lt;p&gt;和之前的&lt;code&gt;OneStepWGCNA插件&lt;/code&gt;相比确实改变了很多，开放和更多的参数，也使大家体验一下调参侠的日常，&lt;code&gt;WGCNAshiny&lt;/code&gt;推出后我考虑要下架&lt;code&gt;OneStepWGCNA&lt;/code&gt;因为他不够&lt;strong&gt;智能&lt;/strong&gt;，很可能一些数据格式或者设置的错误会导致错误的结果。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;☆☆☆☆ 保留了极低表达量筛选的步骤，这个根据&lt;a href=&#34;https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/faq.html&#34;&gt;WGCNA-FAQ&lt;/a&gt;(对于所有想做WGCNA分析的同学，不管你会不会敲代码，这个真的推荐所有人看一遍，即使你不看WGCNA的原文，WGCNA tutorials，这个还是非常值得看一下的。因为你头顶很多问号这里面都给你掰扯明白了)&lt;/li&gt;
&lt;li&gt;☆ 增加了数据变异程度筛选方法&lt;code&gt;var&lt;/code&gt;,可以选择通过绝对中位差（MAD）筛还是变异系数（Var）筛。&lt;/li&gt;
&lt;li&gt;☆ 增加了原始数据格式防呆，比如有NA啦，有非数字形式的字符串啦。&lt;/li&gt;
&lt;li&gt;☆☆☆☆☆ 增加了sft的自由选择，这次直接把软阈值的选择权利完全放给你，可以通过软阈值计算结果自由选择，而不是在选择不到合适的软阈值时强行使用经验的软阈值。&lt;/li&gt;
&lt;li&gt;☆☆☆☆☆ 增加了当前软阈值下网络的non-scale检测。&lt;/li&gt;
&lt;li&gt;☆☆☆☆☆☆ 放开了&lt;code&gt;MaxBlockSize&lt;/code&gt;参数，这样就可以摆脱电脑内存大小的限制，可以加入更多的基因进行WGCNA分析，不过如果硬件条件允许的情况下尽量把所有的基因放到一个block计算。&lt;/li&gt;
&lt;li&gt;☆☆☆☆☆☆ 放开了&lt;code&gt;minModuleSize&lt;/code&gt;和&lt;code&gt;mergeCutHeight&lt;/code&gt;参数, 这样你就可以灵活的调整模块大小和模块数量。&lt;/li&gt;
&lt;li&gt;☆☆☆☆☆☆ 用&lt;code&gt;ggplot&lt;/code&gt;重画了WGCNA主要的图，修正了上一个shinyapp版本的一个错误。&lt;/li&gt;
&lt;li&gt;☆☆☆☆☆☆ 用&lt;code&gt;ComplexHeatmap&lt;/code&gt;画&lt;strong&gt;module-trait&lt;/strong&gt;图，放开了颜色选择，可以根据自己的喜好调整颜色，毕竟颜值即正义。&lt;/li&gt;
&lt;li&gt;☆☆☆☆☆☆ 用&lt;code&gt;updateSelectInput&lt;/code&gt;升级了之前手动填写module，trait的智障操作，现在可以根据module-trait的结果自动升级后续感兴趣模块性状和模块名字，直接选择就好。&lt;/li&gt;
&lt;li&gt;☆☆☆☆☆☆☆☆☆☆☆☆ 完善了WGCNA后续分析板块：hubgene筛选和cytoscape网络图数据导出。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;准备工作&#34;&gt;准备工作&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;首先建议所有用户折腾下这个：&lt;/strong&gt;&lt;a href=&#34;http://www.shawnlearnbioinfo.top/2021/03/11/%E3%80%8CTBtools-Plugin%E3%80%8D%E4%BD%BF%E7%94%A8openBLAS%E6%88%96Apple-s-BLAS%E6%98%AF%E4%BD%A0%E7%9A%84R%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E9%80%9F%E5%BA%A6%E8%B5%B7%E9%A3%9E/&#34;&gt;BLAS加速矩阵运算&lt;/a&gt;&lt;br&gt;
简单总结就是windows先去&lt;a href=&#34;http://pan.baidu.com/s/1gdow6sz&#34;&gt;这里下载文件&lt;/a&gt;，然后把这些文件复制到你R路径下比如&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;C:\Program Files\R\R-4.1\bin\x64
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;文件夹中，覆盖掉原来的文件。&lt;br&gt;
mac用户根据我博客那篇文章操作就好，linux用户直接搜索linux怎么装&lt;code&gt;openblas&lt;/code&gt;，跟着操作就ok啦。如果不替换&lt;code&gt;BLAS&lt;/code&gt;，你会发现WGCNA跑得非常非常慢！因为系统自带的BLAS矩阵处理速度太拉胯了.....&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;其次，基因名称最好不要是数字，材料名称也不要以数字开头,材料名称中有&#39;-&#39;号，转换成下划线&#39;_&#39;或者&#39;.&#39;同时最好不要有各种奇葩符合，中文空格等。&lt;/strong&gt; 有几个老铁发邮件问我老跑不出来，结果发现是这些问题，建议你们自己做的时候发现&lt;code&gt;geneid&lt;/code&gt;是纯数字的时候，自己新建一个excel做一个类似这个的表，然后用后面符合规则的基因名字和样品名称替代你上传的表达矩阵中的&lt;code&gt;geneid&lt;/code&gt;和&lt;code&gt;samplename&lt;/code&gt;。具体为啥有空再讲。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/wgcna.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;界面上的所有步骤请一步一步来，不要直接跳过步骤做后面，因为后面所有的步骤都是基于前面所有结果才能运行的&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;我自己承认这个shinyapp的操作可能有点反人类，毕竟不是商业软件会考虑到易用性，是根据我的思维模式来的，所以这里也没办法，只能你适应我，做不到我适应你&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&#34;使用方法&#34;&gt;使用方法&lt;/h2&gt;
&lt;h3 id=&#34;第一步-数据上传和数据清洗&#34;&gt;第一步 数据上传和数据清洗&lt;/h3&gt;
&lt;p&gt;手头没有数据的同学可以从&lt;a href=&#34;https://gitee.com/shawnmagic/swtbplugin/tree/master/02.testfile/03.OneStepWGCNA&#34;&gt;这里下载demo数据&lt;/a&gt;&lt;br&gt;
遵循图中7个步骤，每个步骤都有默认的参数，如果你不想改动可以不动他，需要再改动。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA4.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
点击升级信息后会出现一个小进度条，显示进度，&lt;strong&gt;如果屏幕变灰了说明报错了&lt;/strong&gt; 可能的原因就是你输入的文件有问题，或者想保留的基因数大于你总基因数之类的。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA6.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;看到进化树后，恭喜你，&lt;strong&gt;你的数据清洗步骤完成了！&lt;/strong&gt;，可以点击下面的download下载nwk文件，这个文件就可以用&lt;code&gt;figtree&lt;/code&gt;，&lt;code&gt;itol&lt;/code&gt;等工具美化了，而且这个树下面有个小三角，可以随意拖动改变图的大小。如果在这个树中你发下个别离群样本，就是几个样品和其他样品分的很开,比如第二个图中的&lt;code&gt;F2_221&lt;/code&gt;，就用excel打开你的表达量矩阵，对应删掉这个样品所在的列,重新上传。同样在&lt;code&gt;trait&lt;/code&gt;表中也删掉这个样品。如果要重新上传表达量数据，刷新一下网页就好了，运行开后如果遇见也没变灰，说明报错了，此后后面的步骤就不能运行了，这时候刷新下网页也能恢复到初始状态，不过你就要从头开始了。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA11.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA10.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
接下来就可以点击导航栏的&lt;code&gt;SFT and Power Select&lt;/code&gt;进入下一步软阈值筛选步骤了！&lt;/p&gt;
&lt;h3 id=&#34;软阈值筛选和网络无标度鉴定&#34;&gt;软阈值筛选和网络无标度鉴定&lt;/h3&gt;
&lt;p&gt;选择合适的软阈值（sft 或者 power）对于构建无标度网络来说至关重要，往往无法筛选出合适软阈值的原因和你输入的表达矩阵直接相关，最常见的原因就是样品异质性，比如说不同组织（器官），差别很大的发育时期等，或者有明显批次效应的样品，比如网上down的不同测序平台，不同文献来源的RNAseq数据合并一起。具体解决方案还是看&lt;a href=&#34;https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/faq.html&#34;&gt;WGCNA-FAQ&lt;/a&gt; 我说的没作者明白....&lt;/p&gt;
&lt;p&gt;选择&lt;code&gt;SFT and Power Select&lt;/code&gt;标签页（当时脑抽随便起的名字懒得改了），就是软阈值筛选的意思，我设定的默认&lt;code&gt;R2&lt;/code&gt;是0.8，不过有篇中文文献（忘记哪个了，具体大家可以知网搜一下）说R2到0.85时对应的软阈值构建的网络接近无标度网络，但是&lt;code&gt;power&lt;/code&gt;值越大，假阳性越高。所以尽量选择第一次到达0.8时对应的&lt;code&gt;power&lt;/code&gt;值。选择好&lt;code&gt;R2&lt;/code&gt;的cutoff后点击&lt;code&gt;start analysis&lt;/code&gt;就可以了，这里的R2阈值指的是让软件判断当R2等于xx是对应的&lt;code&gt;power&lt;/code&gt;是多少。如果你选择0.85，执行这个步骤后就会生成一个第一次&lt;code&gt;R2 ≥ 0.8&lt;/code&gt;时对应的&lt;code&gt;power&lt;/code&gt;值。 具体看下图2&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA9.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;该图就是点击&lt;code&gt;start analysis&lt;/code&gt;运行完成之后的界面，会返回一个图，左边是&lt;code&gt;power&lt;/code&gt;和&lt;code&gt;R2&lt;/code&gt;的关系，右边是&lt;code&gt;power&lt;/code&gt;和平均连连接度（Mean connectivity）之间的关系，&lt;code&gt;R2&lt;/code&gt;越接近1,平均连接度越接近0，网络越接近无标度。&lt;br&gt;
这次结果我设定的&lt;code&gt;R2&lt;/code&gt;阈值是0.8，对应的&lt;code&gt;Power&lt;/code&gt;值是5，屏幕中会出现&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;The power recommended by WGCNA is : 5
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;，说明在&lt;code&gt;power&lt;/code&gt;等于5时，&lt;code&gt;R2≥0.8&lt;/code&gt;，但是我们发下你当&lt;code&gt;Power&lt;/code&gt;等于7时&lt;code&gt;R2&lt;/code&gt;可以达到0.9，这是如果我们想选择&lt;code&gt;power = 7&lt;/code&gt;只需要把&lt;code&gt;Power type&lt;/code&gt;里面改成&lt;code&gt;customized&lt;/code&gt;,然后滑动下面滑块到7就可以了，这一步是为后续&lt;code&gt;scale free estimate&lt;/code&gt;设计的。同样在&lt;code&gt;set fig size&lt;/code&gt;之后可以下载到pdf格式的图片，win下网页中预览的字体可能有点丑，渲染问题，但是下载下来就没问题了。图片的大小同样可以通过拖动三角形调节。&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;2&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA12.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;3&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA13.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;第三部分是对你选择的&lt;code&gt;power&lt;/code&gt;所构建的网络进行无标度拓扑结构检测的，看在这个&lt;code&gt;power&lt;/code&gt;值下构建的网络是否符合无标度网络。我们首先对&lt;code&gt;R2=0.8&lt;/code&gt;对应的&lt;code&gt;power = 5&lt;/code&gt;进行检测这时&lt;code&gt;Power Type&lt;/code&gt;选择&lt;code&gt;Recommended&lt;/code&gt;系统使用刚才自动生成的&lt;code&gt;power&lt;/code&gt;值5,具体无标度网络（无尺度网络）和随机网络的区别我推荐生信技能树的视频中有讲解，当然你数学学的好也能理解（数学学渣撸过）..&lt;/p&gt;
&lt;p&gt;这里你可以测试所有Power值构成的网络，但是不推荐你这么玩，因为每次都要重新构建网络，这个速度还是很慢的，一般第一个图&lt;code&gt;R2&lt;/code&gt;最高能到多少你就检测对应的&lt;code&gt;power&lt;/code&gt;，但是不建议选择太大的&lt;code&gt;power&lt;/code&gt;，会造成假阳性，&lt;strong&gt;这个一般是在实在选择不到合适的软阈值，最高只有0.5，0.6之类的，不过这种数据一般也不会构成无标度网络，后续再去做共表达分析意义不是很大，但是这时你可以把WGCNA简单的当做类似Hclust或者K-means来用，直到表达模块分类之前都是可以用的，看你提供的基因到底可以分为多少个module，这些module内的基因是具有相似表达模式的。而后续的hubgene，调控网络就别做了，意义不大&lt;/strong&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA14.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA15.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;检测这一步必须进行，因为我写的脑残设定后续使用的power就是最后一次检测时你用的power，如果你不检测，没有power值。后续会报错。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这里我们用&lt;code&gt;R2&lt;/code&gt;第一次大于0.9时对应的&lt;code&gt;power&lt;/code&gt;值7进行后续测试。&lt;/p&gt;
&lt;h3 id=&#34;构建模块&#34;&gt;构建模块&lt;/h3&gt;
&lt;p&gt;点击最上面&lt;code&gt;module-net&lt;/code&gt;标签进入模块构建步骤。这里仍旧使用一步法构建模块，而且释放了3个关键参数用来调整模块数量，并且在CJ大佬的指点下开放了&lt;code&gt;MaxBlockSize&lt;/code&gt;参数来使低内存的PC也能跑上万+基因。&lt;strong&gt;请按照下表填写这里的数字，这里只能填整数！！！！！&lt;/strong&gt; 具体我也没有测试过，可能会报内存溢出的错误，报错了就吧数字调小点再来亿遍！（鬼知道我测试这玩意重跑了多少回...）&lt;br&gt;
&lt;strong&gt;tips:&lt;/strong&gt; 如果你的pc内存足够大，尽量把所有你选择做WGCNA的基因都放到一个&lt;code&gt;block&lt;/code&gt;中。比如你之前选择了2w个做，你的pc内存又大于等于16G，这里就选2w，如果内存溢出了就搞个1.5w也行。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;内存大小&lt;/th&gt;
&lt;th&gt;数字&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;0-4GB&lt;/td&gt;
&lt;td&gt;5000-8000&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;4-8GB&lt;/td&gt;
&lt;td&gt;8000-12000&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;8-16GB&lt;/td&gt;
&lt;td&gt;12000-20000&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;16-32GB&lt;/td&gt;
&lt;td&gt;20000-40000&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&amp;gt; 32GB&lt;/td&gt;
&lt;td&gt;土豪你好，请随意&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;整体步骤就是确定最小模块内基因数，确定剪枝高度（推荐不用动这俩参数）然后根据电脑内存大小选择好blocksize之后点击运行。如果模块数量太多了，可以适当提高前面两个参数。比如这次结果产生了很多模块，我们尝试把&lt;code&gt;min module size&lt;/code&gt; 提高到&lt;code&gt;50&lt;/code&gt;，把剪枝高度提高到&lt;code&gt;0.35&lt;/code&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA16.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;结果显示模块总数少了，&lt;code&gt;min Module Size&lt;/code&gt;的变大必然导致&lt;code&gt;grey&lt;/code&gt;模块基因数量的增加。同时模块数量的变少可能会导致&lt;code&gt;module-trait&lt;/code&gt;相关性变低。因为这种剪枝高度的提高可能会导致模块划分更加粗放。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA17.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;对比上面图显然模块数量变少了。第二个选项卡是邻接基因构建的相关性热图&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA18.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;第三个选项卡是一个很重要的结果，模块-基因的对应关系表&lt;/strong&gt; 可以下载下来，同样是点击download下载。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA19.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;module构建完毕之后，就是和性状，材料分类，或者其他你感兴趣的数据做相关性分析。&lt;/p&gt;
&lt;h3 id=&#34;模块-表型相关性分析&#34;&gt;模块-表型相关性分析&lt;/h3&gt;
&lt;p&gt;具体表型数据的格式参考&lt;a href=&#34;https://gitee.com/shawnmagic/OneStepWGCNA&#34;&gt;这个链接&lt;/a&gt; 由于代码里默认之后两列的表型数据表会转换成分类的0，1矩阵，所以想只和一个性状做关联的我写的这个shiny做不了.... 后续可能会改把。&lt;/p&gt;
&lt;p&gt;这里可以直接跑，也可以自己选择颜色后在跑&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;4&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA21.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;我们发现demo数据中&lt;code&gt;Luminal&lt;/code&gt;和&lt;code&gt;yellow&lt;/code&gt;模块成极显著负相关和&lt;code&gt;blue&lt;/code&gt;模块成极显著正相关。所以后续会分析这个性状和对应模块的关系。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA22.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
第二个选项卡是具体的画图数据，就是邻接基因和对应性状之间的相关性及显著性值。&lt;br&gt;
第三个选项卡非常重要，里面是基因的模块内连接度（kME），我们单纯从module角度出发kME越高，说明该基因在模块内越处于中心位置，可以被选为&lt;code&gt;hubgene&lt;/code&gt;。如果你的&lt;code&gt;module-trait&lt;/code&gt;结果不理想，也没必要非得死磕，换一个角度对所有的&lt;code&gt;module&lt;/code&gt;做富集分析，看这些模块哪个可以解释你的科学问题，对应的根据&lt;code&gt;kME&lt;/code&gt;筛选出&lt;code&gt;hubgene&lt;/code&gt;（排名前10，或者 &amp;gt; 0.9）,然后围绕&lt;code&gt;hubgene&lt;/code&gt;构建该模块的共表达网络。这时你把这个表下载下来，选择对应模块排序找出&lt;code&gt;kME&lt;/code&gt;排名靠前的基因拟定为&lt;code&gt;hubgene&lt;/code&gt;即可。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA23.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;我们从&lt;code&gt;module-trait&lt;/code&gt;找到感兴趣的模块和性状后可以进行后续&lt;code&gt;interested module&lt;/code&gt;步骤&lt;/p&gt;
&lt;h3 id=&#34;感兴趣模块信息挖掘&#34;&gt;感兴趣模块信息挖掘&lt;/h3&gt;
&lt;p&gt;首先是看基因显著性（GS gene significance）和模块特征值（MM module membership）之间的关系，如何理解基因显著性，我们在做module-trait时起始是用的该模块降维后的第一主成分或者叫邻接基因与表型做的相关，但是这个模块中有很多基因，邻接基因和表型相关不一定代表模块中所有基因都和表型相关，所以为了验证模块内基因与表型相关性，直接去做这个基因与表型的相关得到基因显著性（GS），同时我们看这个基因和邻接基因之间的关系也就是该基因模块内连接度（kME）来反映该基因的模块特征值（MM），当该基因既在模块中处于网络中心地位，又显著与性状相关，那么该基因极有可能是控制该性状的&lt;code&gt;hubgene&lt;/code&gt;。&lt;br&gt;
操作很简单，beta版本的用户可能知道这里之前需要纯手动输入，现在不需要了，只要前面&lt;code&gt;module-trait&lt;/code&gt;的结果作完，这里相应的选项会更新。只需要点击选择即可。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA24.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;然后我们会看模块内所有基因的表达模式热图，而下部柱状图表示邻接基因的表达模式。&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;5&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA25.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;下图表示你选择的表型和其他所有模块的&lt;code&gt;GS vs MM&lt;/code&gt;关系&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA26.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;我们对感兴趣模块探索完就可以进行下一步&lt;code&gt;hubgene&lt;/code&gt;筛选过程了。&lt;/p&gt;
&lt;h3 id=&#34;hubgene筛选和共表达网络关系输出&#34;&gt;hubgene筛选和共表达网络关系输出&lt;/h3&gt;
&lt;p&gt;我们点击&lt;code&gt;hubgene&lt;/code&gt;选项卡同样是选择好&lt;code&gt;trait&lt;/code&gt;和&lt;code&gt;module&lt;/code&gt;点击开始分析&lt;/p&gt;
&lt;p&gt;第一个选项卡给的hubgene 一般不推荐.. 这个是同过WGCNA作者的一个function实现的，但是往往感觉GS和MM都很低...&lt;/p&gt;
&lt;p&gt;第二个选项卡是基于GS和MM筛选的&lt;br&gt;
如果你的&lt;code&gt;module-trait&lt;/code&gt;中出现了R &amp;gt; 0.8的模块甚至0.9的模块，这时可以适当的把阈值卡严格一点，比如&lt;br&gt;
&lt;code&gt;|GS| &amp;gt; 0.85 &amp;amp; |MM| &amp;gt; 0.9&lt;/code&gt;&lt;br&gt;
来筛选hubgene，但是如果像本次demo数据一样，只有0.7左右或者更低，卡如此严格的阈值很可能筛选不到hubgene，这样就可以适当降低阈值。这里的阈值并没有一个金标准，当然越严格说明设计越合理，参数越准确。 如果发现这种情况，可以返回&lt;code&gt;module-net&lt;/code&gt;步骤，降低剪枝高度，缩小最小模块大小参数，让模块划分更加精细，再试一下。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA27.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA28.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
其实和你做湿实验一样，对于不同的材料，不同的仪器要灵活调整配方，仪器参数，如果老用default，很可能做不出来，这也是调参侠的日常，我们的目的是解决生物学问题，而不是死磕所谓的金标准。当然调整是否合理，这需要大量的实践和你对WGCNA背后算法的理解深度，这个无捷径可走，所以真的要做好WGCNA分析还是需要下功夫读点文献，多做几次尝试的。&lt;/p&gt;
&lt;p&gt;最后一部分就是输出共表达网络关系，用&lt;code&gt;cytoscape&lt;/code&gt;作图了&lt;/p&gt;
&lt;p&gt;操作也很简单，选一个阈值（建议不要大于0.1）点击开始下面就会出现edgefile 和nodefile的预览，具体权重阈值怎么选，选多少，我的建议是你自己选选看，default是0.02. 这个也没有标准。预览表出来后向下拉就可以下载nodefile 和edgefile了，然后就是cytoscape的事了，具体怎么可视化，B站教学一大堆，加油吧少年！&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;6&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA29.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;h2 id=&#34;终于写完了&#34;&gt;终于写完了！！&lt;/h2&gt;
&lt;p&gt;后续大概率会直接写个R包，更新一些内容，希望各位及时反馈软件的问题到我的gitee issue&lt;br&gt;
目前先在这个issue下吧 ：https://gitee.com/shawnmagic/swtbplugin/issues/I2DMHS&lt;br&gt;
各位大佬如果有好的建议也提一下，如果发现有错误请及时提醒我，用的人多了才能更好的完善。&lt;/p&gt;
&lt;p&gt;通过WGCNAshiny的开发我第一次深度接触shinyApp的编写，开启了我对R包编写的兴趣，并且把function打成了R package放在 https://github.com/ShawnWx2019/WGCNAShinyFun/tree/master&lt;/p&gt;
&lt;p&gt;虽然app和package写的都很辣眼睛，但我学到了更多知识，不断突破自己。作为副产品这个小脚本小插件或许会为方便各位，这就足够了，由于本人太菜怕自己的错误导致大家的分析出错，所以这个插件还是以一个beta版本出现，这需要大家共同努力积极反馈才能使这个小玩意更加完善。&lt;/p&gt;
&lt;p&gt;半条命已经废了...&lt;br&gt;
没时间扯淡了... 干活去了😭&lt;br&gt;
祝各位磕盐顺利！！&lt;/p&gt;
">「TBtools-Plugin」WGCNAShiny保姆级教程</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/「TBtools-Plugin」用shinyApp体验调参侠的日常工作-WGCNA-shiny尝鲜版/"" data-c="
          &lt;p&gt;失踪人口回归... 鸽了近半年，终于又要更新推文了...&lt;br&gt;
上次说过要把WGCNA后续的模块整理完成。这个工作其实过年的时候就做的差不多了，只是没有写成插件释放。前两天啃了些资料怎么制作R包，然后把我自己搞的辣眼睛的function打包了放在github。然后这个WGCNA的插件才顺利诞生，没有难产。&lt;/p&gt;
&lt;p&gt;...&lt;/p&gt;
&lt;!-- more --&gt;
&lt;h2 id=&#34;插件安装&#34;&gt;插件安装&lt;/h2&gt;
&lt;p&gt;目前可以在我的&lt;a href=&#34;https://gitee.com/shawnmagic/swtbplugin/tree/master/01.plugin&#34;&gt;gitee仓库&lt;/a&gt;下载，后续会在高速插件商店上架，到时候直接在软件内下载即可。&lt;br&gt;
这个插件安装比较麻烦，因为依赖太多了！！！ &lt;code&gt;shiny&lt;/code&gt;相关的，&lt;code&gt;WGCNA&lt;/code&gt;相关,&lt;code&gt;tidyvers&lt;/code&gt;家族。还有我写的那个辣眼睛的插件专用函数包&lt;a href=&#34;https://github.com/ShawnWx2019/WGCNAShinyFun/tree/master&#34;&gt;github地址&lt;/a&gt;。&lt;br&gt;
如果不用插件的话，可以去&lt;a href=&#34;https://github.com/ShawnWx2019/WGCNA-shinyApp&#34;&gt;WGCNA-shinyApp&lt;/a&gt;下载脚本，在Rstudio中运行，或者在terminal中&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;Rscript WGCNAbyClick.v1.R
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;直接运行Shiny App&lt;/p&gt;
&lt;h3 id=&#34;安装时报错解决方案&#34;&gt;安装时报错解决方案&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;校园网的话大概率会出现网络问题，我在家装插件就没遇见过问题😭，但是在所里就老出错，老样子，连热点，换wifi啥的多试几次&lt;/li&gt;
&lt;li&gt;目前发现第一次安装多少会出现点问题，但是多装几次就ok了。&lt;/li&gt;
&lt;li&gt;xfun版本问题，静等清华镜像更新。&lt;/li&gt;
&lt;li&gt;xxx退出状态不是0，可能是包版本和R版本的冲突。这个动手能力强的话可以自行百度解决。&lt;/li&gt;
&lt;li&gt;【谨慎操作】各种方法都没法搞定，各种奇葩报错的话，可能是一些奇怪操作把TBtools的R环境给搞凌乱了。win用户可以进c盘下的用户文件夹，选择你当前用户名的文件夹可以看见一个&lt;code&gt;.TBtools&lt;/code&gt;的文件进去后删掉Rserver文件夹，这样你TBtools中R环境就删掉了，重新再群里下载Rserver插件重新安装，安装好后再安装其他基于R的插件。mac用户插件在&lt;code&gt;~/.TBtools/.plugin&lt;/code&gt;&lt;strong&gt;这么操作的话你之前装的基于R的插件会重新安装依赖包，所以谨慎操作&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;准备工作&#34;&gt;准备工作&lt;/h2&gt;
&lt;p&gt;建议按照&lt;a href=&#34;http://www.shawnlearnbioinfo.top/2021/03/11/%E3%80%8CTBtools-Plugin%E3%80%8D%E4%BD%BF%E7%94%A8openBLAS%E6%88%96Apple-s-BLAS%E6%98%AF%E4%BD%A0%E7%9A%84R%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E9%80%9F%E5%BA%A6%E8%B5%B7%E9%A3%9E/&#34;&gt;BLAS加速R矩阵计算&lt;/a&gt;帖子加速R的矩阵运算速度，可以将&lt;code&gt;WGCNA&lt;/code&gt;在计算TOM矩阵的速度提高100倍。如果不这么搞，可能你计算10000个基因的WGCNA需要等上40分钟-1小时，如果用强化版的blas，也就一分钟出结果。&lt;/p&gt;
&lt;h2 id=&#34;插件结构&#34;&gt;插件结构&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA%20Shiny.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
大体还和之前OneStepWGCNA的一样，多了后续的分析，更有助于hubgene的挖掘。&lt;/p&gt;
&lt;h2 id=&#34;使用方法&#34;&gt;使用方法&lt;/h2&gt;
&lt;p&gt;插件安装完成后运行会弹出网页。&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210616182425.jpg&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
这个后续录个视频讲吧... 如果截屏写博客估计累死....&lt;/p&gt;
&lt;h2 id=&#34;最后have-fun&#34;&gt;最后have fun&lt;/h2&gt;
&lt;p&gt;ps： 正在鼓捣final cut pro. 后续会有详细视频讲解。目前大家先安装上玩玩吧.&lt;br&gt;
估计有会鸽一段时间。等尘埃落定，一定在会完善他！&lt;/p&gt;
">「TBtools-Plugin」用shinyApp体验调参侠的日常工作-WGCNA shiny尝鲜版</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/「TBtools-Plugin」使用openBLAS或Apple-s-BLAS是你的R矩阵运算速度起飞/"" data-c="
          &lt;h2 id=&#34;问题与思考&#34;&gt;问题与思考&lt;/h2&gt;
&lt;p&gt;在写&lt;strong&gt;OneStepWGCNA&lt;/strong&gt;插件的时候我就遇到过一个奇怪的现象，在Rstudio下计算TOM矩阵那一步很快，8000个基因基本是几十秒算完，但是一旦打包成插件，或者用Rscript跑脚本的时候，那一步会巨慢无比，8000个要等好几分钟。&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;当时也不知道怎么回事，就先放着，最近正在做WGCNA，想用插件跑跑，发现实在是太慢了！！！！然后就开始研究怎么回事，知道我看到terminal下卡主的步骤：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;    TOM calculation: adjacency..
    ..will not use multithreading.
     Fraction of slow calculations: 0.000000
    ..connectivity..
    ..matrix multiplication (system BLAS)..
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;BLAS&lt;/strong&gt; 之前在WGCNA-FAQ中好像看到过这么个名词，于是就回去查看了一下文件。果然，当时没搞懂的，现在一下明朗了：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;1 How can I make network construction execute faster?&lt;/strong&gt;&lt;br&gt;
When constructing a network from a data set of a typical genomic size (i.e., between 10 000 and 30 000 genes or other variables), the most time consuming step is the calculation of Topological Overlap Matrix which involves multiplying matrices with tens of thousands of rows and columns. With a standard R distribution, this may take multiple hours even on a modern workstation since matrix multiplication in standard R does not take advantage of multi-threading (parallel execution). It is possible to speed up this process by a factor of 10-100 by installing a speed-optimized Basic Linear Algebra Subprograms (BLAS) library and compiling R against it. The process of compiling R against an enhanced BLAS library is described in the R installation and adminitration manual. Compiling R on Linux and Unix flavors is usually relatively simple and straightforward. On Mac OSX and (more so) on Windows it requires installing additional tools and packages. Although it is helpful to have administrator privileges to compile and install R, it is usually not necessary. See the R installation and adminitration manual for full details.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;作者大致意思是如果你想提高R的矩阵运算能力，需要使用强化版的BLAS，R默认调用的是基础班的BLAS，强化版的要比基础版的快10-100倍。但是这玩意不好装，需要从源码编译，linux下简单，但是win和mac下就比较蛋疼了。&lt;/p&gt;
&lt;p&gt;But！ 我发现在win和mac下其实也没有那么难，虽然我也不懂什么BLAS，但是作为一个调包侠，最基础也是最重要的一个技能就是，善用各种搜索。不断的google下终于发下了mac和win下的解决方案，不需要编译，mac只需要敲两行命令，win复制几个文件就搞定了.&lt;/p&gt;
&lt;p&gt;先发参考链接：&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://mpopov.com/blog/2019/06/04/faster-matrix-math-in-r-on-macos/&#34;&gt;Faster matrix math in R on macOS&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://blog.csdn.net/a358463121/article/details/42713307&#34;&gt;Windows使用OpenBLAS加速R语言计算速度&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;方法&#34;&gt;方法&lt;/h2&gt;
&lt;h3 id=&#34;macos-big-sur-1121测试成功&#34;&gt;MacOS big sur 11.2.1测试成功&lt;/h3&gt;
&lt;p&gt;其实就是苹果系统下，调用苹果自己的BLAS，具体：&lt;a href=&#34;https://developer.apple.com/documentation/accelerate/blas&#34;&gt;Apple’s implementation of the Basic Linear Algebra Subprograms (BLAS).&lt;/a&gt;  参考上面大胡子老哥的操作，就是把苹果自己的BLAS文库替换掉R默认的BLAS&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;## TBtools的R安装在Rserver下，所以TBtoolsR的lib位置如下，先进入这个路径
cd ~/.TBtools/.Plugin/Rserver/bin/macR/lib 
## 将系统Apple的BLAS软连接过来
ln -sf /System/Library/Frameworks/Accelerate.framework/Frameworks/vecLib.framework/Versions/Current/libBLAS.dylib libRblas.dylib
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;如果这个操作过后发现你的Rserver挂了，用下面的命令恢复：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;ln -sf libRblas.0.dylib libRblas.dylib
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;虽然你测试&lt;code&gt;sessionInfo()&lt;/code&gt;发现没有和帖子里说的一样出现下面提示，但是确实是快了！反正我的Nuc8是直接风扇起飞了....感觉至少快了30倍，当然随着基因数目的增多，这个倍数也会翻倍....&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;win10下测试成功&#34;&gt;Win10下测试成功&lt;/h3&gt;
&lt;p&gt;win10下用的是openBLAS，具体请看&lt;a href=&#34;https://github.com/xianyi/OpenBLAS&#34;&gt;Github-openBLAS&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;原贴实在豆瓣看到的：&lt;a href=&#34;https://www.douban.com/note/296114898/&#34;&gt;让R在windows下开足马力进行计算&lt;/a&gt; 后来CSDN那个老哥都给下载整理好了，直接拿来用，刚开始担心版本问题，后来看来是想多了，直接把帖子中作者整理好的网盘里的文件替换掉：&lt;strong&gt;在操作之前先把x64文件夹下的文件备份一下&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-yml&#34;&gt;## 按顺序打开：
我的电脑 -&amp;gt; c盘 -&amp;gt; 用户 -&amp;gt; 你的用户名对应的文件夹 -&amp;gt; .TBtools -&amp;gt; .Plugin -&amp;gt; Rserver -&amp;gt; bin -&amp;gt; winR -&amp;gt; bin -&amp;gt; x64(32的对应打开32) -&amp;gt; 粘贴
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;然后就搞定了，再试试OneStepWGCNA吧，速度嗖嗖的！&lt;/p&gt;
">「TBtools Plugin」使用openBLAS或Apple's BLAS是你的R矩阵运算速度起飞 </a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/「TBtools-Plugin」批量生成气泡图/"" data-c="
          &lt;p&gt;说出来你可能不信，我刚才用TBtools插件卡了个Bug！&lt;/p&gt;
&lt;!--more--&gt;
&lt;p&gt;不过CJ大佬看完我调皮操作之后，马上甩出了一个功能：&lt;code&gt;支持输入路径（文件夹）&lt;/code&gt;，因为之前只支持输入单个文件。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;额，插件使用其实很简单，这次blog主要面向插件制作用户...&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&#34;如何卡bug成功&#34;&gt;如何卡Bug成功....&lt;/h2&gt;
&lt;p&gt;最近在搞多组合的转录组分析，于是有了好多个富集分析的结果，虽然我以及在电脑上写好了富集分析-出图的代码流程（全程TBtools+R）写一个配置文件，一键批量做，但是之前的出图代码多少有点粗糙，我也不想再回去改R代码..毕竟我这水平，改自己的代码如同在写bug，所以就直接把出图的代码给注释掉了，后续大概有40个go和kegg富集分析结果，一个一个扔插件里跑要累死... 于是想着把bubble plot插件改一下，最后出图的时候写个循环。那么就存在一个问题。批量读入R的过程。&lt;/p&gt;
&lt;p&gt;总结起来做TBtools的插件太简单了，如果你之前有现成的Rscript。完全可以直接写个config.txt的配置文件一打包就做成插件了...&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;我们先看下TBtools是怎么实现把你的参数可视化的。&lt;/strong&gt;&lt;br&gt;
首先看下config.txt的配置文件&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;App=Demo R-ggplot BarPlot
Script=script.r
# Optional
Icon=Icon.jpg
# Optional
Layout=2
# Optional
Demo=fpkm.xls
# Optional
Manual=Readme.txt
# Optional
Link=https://github.com/CJ-Chen/TBtools/releases
# All lines start with a &amp;quot;#&amp;quot; will be ignored.
# an input file/paste =&amp;gt; Type=Note
File=Set a Tab-delimited Table
# text input =&amp;gt; Type=Note=DefaultValue
Text=Plot Title:=R-ggplot2 BarPlot
# yes or no options =&amp;gt; Type=Note
CheckBox=Log-tranformed
# multiple choice  =&amp;gt; Type=Note=Choice1,Choice2,Choice3
Choice=Color Palette:=Set1,Set2,Set3
# Specify a Color
Color=Set a Color:=#e31a1c
# Demo Directory Select Panel
Directory=Set a Directory
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;这个是CJ释放的最新的插件demo中的config。最全参数的。其中&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;# an input file/paste =&amp;gt; Type=Note
File=Set a Tab-delimited Table
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;到了TBtools界面上就是&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210202090840.jpg&#34; alt=&#34;File&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
CJ也对File这个选项进行了说明，就是&lt;code&gt;输入的一个文件&lt;/code&gt;,而且存在一个&lt;code&gt;Paste input&lt;/code&gt;，虽然不太理解&lt;code&gt;Type=Note&lt;/code&gt;这种类型是什么，但是可以盲猜是&lt;strong&gt;字符&lt;/strong&gt;，比如在我GO bubble Plot插件中，在把Term Number这个变量赋值R的时候要用as.numeric转换成数字。实际上在使用R脚本的时候读入文件，&lt;code&gt;Rscript /path/file&lt;/code&gt; 这里变量所使用的也是路径，说白了就是一串字符。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;那么可以先做两个假设：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;CJ大佬使用了基于TBtools或者Java的骚操作把你读入的**“文件”**最后一顿操作最后生成一个专有的路径读近R... （可能产生一些中间文件，临时文件等...）&lt;/li&gt;
&lt;li&gt;大道至简，直接把你输入的路径给了R...（感觉是这样的....）&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;我感觉是第二个，这个就意味着我可以卡个bug。我把路径扔到文件选项框里，TBtools会提示你放入的不是一个文件，如果软件逻辑里面这里有个报错打断的话，后面可能就gg了，但是没有，这里估计会有个提示，但是后面的代码还是运行了。那么就实现了后面还继续跑，我把路径下包含特征字符的文件批量读近TBtools，最后批量生产气泡图。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Bug成功截图&lt;/strong&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/B8BFBA566496114A5916C78480FC3A98.png&#34; alt=&#34;Bug&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
虽然提示文件不可用，但是跑出来了，哈哈。&lt;/p&gt;
&lt;p&gt;然后群里卖了个萌，大佬一个滑铲插件的两个新功能诞生了：&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://mp.weixin.qq.com/s/6eM4T9pEbZ8kyz9MwSH1Bg&#34;&gt;Update | TBtools R Plugin 制备套件更新&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Color，不需要在手动输入16进制颜色代码，直接调用TBtools的调色板，点击选择就可以&lt;/li&gt;
&lt;li&gt;Directory，支持了路径输入。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;插件的使用&#34;&gt;插件的使用&lt;/h2&gt;
&lt;p&gt;先看下新的界面：&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210202093240.jpg&#34; alt=&#34;Batch Enrichment&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;界面和&lt;code&gt;GO bubble Plot&lt;/code&gt;类似，file input改成了directory input。&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;这里把你做好的富集分析文件放到一个文件夹下，为了不必要的麻烦，这些文件中最好不要有特殊字符（比如引号，括号，空格，/ \ |等....）而且&lt;strong&gt;这些文件名要有共同的特征&lt;/strong&gt; 比如TBtools直接输入的GO富集分析最终结果文件最后都有。 &lt;code&gt;*.final.xls&lt;/code&gt;如果有一定coding基础或者知道通配符的话可以知道，后续批量读入就是靠这些特征读取的。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;pattern只的就是你要批量富集的这些结果文件名共有的特征。&lt;/li&gt;
&lt;li&gt;剩下的参数参考GO Bubble Plot那篇文章：&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a href=&#34;https://mp.weixin.qq.com/s/AOuVZShZXBnmKH9ie_Vplg&#34;&gt;『TBtools-plugin』Bubble plot插件&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;这里吧min和max改成了TBtools新设定的Color类型。不在是之前的Text类型。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;如果你对TBtools插件制作感兴趣，继续看下面的内容&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&#34;配置文件和批量读入&#34;&gt;配置文件和批量读入&lt;/h2&gt;
&lt;p&gt;看下我的配置文件&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;App=Batch Bubble plot ## 插件显示的名字
Script=BatchBubble.R ## 执行的脚本文件名
# Optional
Icon=Icon.png  ## 插件上显示图片文件名
# Optional
Layout=4 ## 布局
# Optional
Manual=BatchBubble.html ## 操作手册
# Optional
Link=https://gitee.com/shawnmagic/swtbplugin ## 你想放入的链接
# All lines start with a &amp;quot;#&amp;quot; will be ignored.
# input dir
## 最后一个等号后面的值相当于默认值（default）会直接显示在插件上。
Directory=Set a Directory ## Directory就是设定插件上输入路径的方框 对应脚本中的第一个变量
## Pattern
Text=pattern:=*.final.xls ## 这里是输入参数Pattern这个参数，对应第二个变量
## go terms num 
Text=Term Number:=30 ## 展示的GOterm个数 对应第三个变量
# multiple choice  =&amp;gt; Type=Note=Choice1,Choice2,Choice3
Choice=Input Data Form:=TBtools_GO,TBtools_KEGG,customized ## 富集文件类型选项 第四个变量
Choice=Graph Type:=Bubble,bar ##图片类型选项 第5个变量
# color
Color=min:=#e41a1c ## 最小值颜色 第6个选项
Color=max:=#3300ff ## 最大值颜色 第7个选项
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;就这么多，这样就把插件的布局做好了。再看下对应脚本内的设置&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;参数设置和调试信息&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;##########################################################
#     prj:  Enrichment result Enrichment Visualization
#     date: 06 Jan 2021
#     Author: Shawn Wang
##########################################################
options(stringsAsFactors = F)
options(&amp;quot;repos&amp;quot; = c(CRAN=&amp;quot;https://mirrors.tuna.tsinghua.edu.cn/CRAN/&amp;quot;))
argv &amp;lt;- commandArgs(TRUE)
expfile &amp;lt;- argv[1] # &#39;file &#39;
pattern &amp;lt;- argv[2]
num &amp;lt;- argv[3] #  &amp;quot;how many go terms do you want to show&amp;quot;
num = as.numeric(num)
DataF &amp;lt;- argv[4] # &amp;quot;data formate&amp;quot;
Gtype &amp;lt;- argv[5] # &#39;barplot or Bubble&#39;
colormin &amp;lt;- argv[6] # &#39;pvalue color&#39;
colormax &amp;lt;- argv[7] # &#39;pvalue color&#39;
# print(Gtype)
if (!require(&#39;ggplot2&#39;)) install.packages(&#39;ggplot2&#39;)
if (!require(&#39;dplyr&#39;)) install.packages(&#39;dplyr&#39;)
if (!require(&#39;stringr&#39;)) install.packages(&#39;stringr&#39;)
if (!require(&#39;magrittr&#39;)) install.packages(&#39;magrittr&#39;)
library(ggplot2)
library(dplyr)
library(magrittr)
library(stringr)
## test set
# setwd(&amp;quot;~/03.project/01.Heterosis/03.process/02.Enrichment/01.GOEnrich/03.graph/&amp;quot;)
# expfile = &amp;quot;~/03.project/01.Heterosis/03.process/02.Enrichment/01.GOEnrich/03.graph/&amp;quot;
# pattern = &amp;quot;*.DEList.xls.GO.Enrichment.final.xls&amp;quot;
# num = 30
# DataF = &amp;quot;TBtools_GO&amp;quot;
# Gtype = &amp;quot;Bubble&amp;quot;
# colormin = &amp;quot;red&amp;quot;
# colormax = &amp;quot;blue&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;开始的两个&lt;code&gt;option&lt;/code&gt;是我的习惯... 根据自己习惯来&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;变量设置，可以对应回&lt;code&gt;config&lt;/code&gt;，config中的参数顺序和这里面argv中变量的顺序要保持一致。最好按顺序来，防止把自己搞懵逼了。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;argv &amp;lt;- commandArgs(TRUE)
expfile &amp;lt;- argv[1] # &#39;file &#39;
pattern &amp;lt;- argv[2]
num &amp;lt;- argv[3] #  &amp;quot;how many go terms do you want to show&amp;quot;
num = as.numeric(num)
DataF &amp;lt;- argv[4] # &amp;quot;data formate&amp;quot;
Gtype &amp;lt;- argv[5] # &#39;barplot or Bubble&#39;
colormin &amp;lt;- argv[6] # &#39;pvalue color&#39;
colormax &amp;lt;- argv[7] # &#39;pvalue color&#39;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;下面是检查有没有你需要的包，没有的话安装&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;if (!require(&#39;ggplot2&#39;)) install.packages(&#39;ggplot2&#39;)
if (!require(&#39;dplyr&#39;)) install.packages(&#39;dplyr&#39;)
if (!require(&#39;stringr&#39;)) install.packages(&#39;stringr&#39;)
if (!require(&#39;magrittr&#39;)) install.packages(&#39;magrittr&#39;)
library(ggplot2)
library(dplyr)
library(magrittr)
library(stringr)
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;调试，我有个习惯，写完脚本会先拿示例数据在Rstudio中调试一下能不能跑明白，所以我保留了调试信息，最后记得（cmd+shift+c或者ctrl+shift+c把这段代码注释掉...）;然后会用Rscript 在终端下跑一遍...最后再打包，不然打包好，再拆了改代码特别蛋疼....&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;最后放一个批量读入文件的function&lt;/strong&gt;&lt;br&gt;
当然大家有自己熟悉的方式，这里只是提供一个我习惯的解法...&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;## readfile
BatchReadTable = function(path, pattern,sep = &amp;quot;\t&amp;quot;, header = TRUE, quote = &amp;quot;&amp;quot;, stringsAsFactors = FALSE){
  fileNames.raw &amp;lt;- dir(path, pattern = pattern) 
  filePath.raw &amp;lt;- sapply(fileNames.raw, function(x){ 
    paste(path,x,sep=&#39;/&#39;)})
  data.raw &amp;lt;- lapply(filePath.raw, function(x){
    read.table(x, sep = sep,header = header,quote = quote,stringsAsFactors = FALSE)}) 
  x = list(Name = fileNames.raw,
           file = data.raw)
  return(x)
}
## 批量读入文件
raw = BatchReadTable(path = expfile,pattern = pattern, quote = NULL)
## 输出
rawdata = raw$file ## 输入富集分析文件
rawname = gsub(pattern,&amp;quot;&amp;quot;,raw$Name) ## 去掉共有的Pattern就是每个文件剩下独有的特征字符串.这些rawnames会作为最后输出文件的特征
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;function最后返回一个&lt;code&gt;list&lt;/code&gt;, &lt;code&gt;list&lt;/code&gt;包含两个内容&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Name&lt;/code&gt;是文件名，后续会用&lt;code&gt;gsub&lt;/code&gt;把你输入的&lt;code&gt;pattern&lt;/code&gt;去掉，留下每个文件独有的特征字符串。这个字符串最后会被用作命名输出文件，或者图片的title等。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;file&lt;/code&gt;也是一个list，里面包含了读入的文件。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;下面是输出的选项，分了3部分，第一部分根据你选择画图，第二部分根据最长的GO term或者KEGG Pathway确定输出图片的宽度，根据你挑选的输出的GO term数量确定高度生成图片的size。最后一部分输出图片。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;这里对list的取索引的操作就是&lt;code&gt;[[i]]&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;for (i in 1:length(rawdata)) {
  x = rawdata[[i]]
  y = rawname[i]
  colnames(x)
  if (DataF == &amp;quot;TBtools_GO&amp;quot;) {
    out = GOBubblePlot(dataraw = x,
                       num = num,
                       name = y,
                       colormin = colormin,
                       colormax = colormax,
                       Gtype = Gtype)
  } else if (DataF == &amp;quot;TBtools_KEGG&amp;quot;) {
    out = KEGGBubblePlot(dataraw = x,
                         num = num,
                         name = y,
                         colormin = colormin,
                         colormax = colormax,
                         Gtype = Gtype)
  } else if (DataF == &amp;quot;customized&amp;quot;) {
    out = customBubblePlot(dataraw = x,
                           num = num,
                           name = y,
                           colormin = colormin,
                           colormax = colormax,
                           Gtype = Gtype)
  }
  
  figsize = function(y,num){
    z = data.frame(ID = y,
                   wc = 0)
    
    for (i in 1:nrow(z)) {
      z[i,2] = nchar(as.character(z$ID[i]))
    }
    maxwc = max(z$wc)
    if (maxwc &amp;lt;= 50) {
      figwidth = 10
    } else if (maxwc &amp;gt;50 &amp;amp; maxwc &amp;lt;100) {
      figwidth = 12
    } else {
      figwidth = 15+(maxwc-50)/25
    }
    if (nrow(z) &amp;lt;= 30) {
      fighight = 10
    } else if (nrow(z) &amp;gt;30 &amp;amp; nrow(z) &amp;lt;60) {
      fighight = 12
    } else {
      fighight = nrow(z)/4
    }
    size = list(figwidth = figwidth,
                fighight = fighight)
    return(size)
  }
  size = figsize(y = out$y,
                 num = num)
  
  ggsave(filename = paste(rawname[i],DataF,Gtype,&amp;quot;plot.pdf&amp;quot;,sep = &amp;quot;.&amp;quot;),
         plot = out$p,
         width=size$figwidth,
         height=size$fighight,
         dpi = 300)
  
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;感觉工作就这么多啦，也挺简单的。菜鸟先抛转引玉，&lt;br&gt;
&lt;strong&gt;坐等各位大佬贡献更牛批的TBtools插件！&lt;/strong&gt;&lt;/p&gt;
">「TBtools Plugin」批量生成气泡图</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/「TBtools-Plugin」Bubble-Plot升级版-TBtools插件/"" data-c="
          &lt;h2 id=&#34;写在前面的废话&#34;&gt;写在前面的废话&lt;/h2&gt;
&lt;p&gt;之前有老铁在群里问kegg的气泡图能不能整，其实基于TBtools-kegg富集结果的气泡图代码很早就撸好了，无非就是GO气泡图代码中数据清洗的时候改改df索引位置。后面一毛一样。&lt;/p&gt;
&lt;p&gt;大家好像还是比较喜欢这种视觉冲击力强的图，确实在投文章的时候也能会加分。所以后来慢慢从搬运代码到&lt;a href=&#34;https://www.jianshu.com/p/59428e69da05&#34;&gt;自己用ggplot2实现&lt;/a&gt;，最终是山寨了一下...&lt;/p&gt;
&lt;p&gt;当然，如果要原汁原味的bubble plot还是推荐用Y叔的&lt;a href=&#34;http://bioconductor.org/packages/release/bioc/html/clusterProfiler.html&#34;&gt;clusterProfiler&lt;/a&gt;包。这里放一个我之前基于所里测&lt;a href=&#34;https://gitee.com/shawnmagic/TM1_CRIv2_OrgDb&#34;&gt;陆地棉TM-1v2的OrgDB&lt;/a&gt;,喜欢折腾的小伙伴可以玩一下，不过kegg目前无解，kegg数据库里收录的陆地棉的注释实在是太老了。&lt;/p&gt;
&lt;!--more--&gt;
&lt;h2 id=&#34;参数&#34;&gt;参数&lt;/h2&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/Bubble%20plot.png&#34; alt=&#34;参数&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;这次干脆一勺烩了，柱状图，气泡图，基于GOplot那几个弦图，热图数据清洗起来有点麻烦，应该近期不会整....&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210126073636.jpg&#34; alt=&#34;界面&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;input file 输入文件：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果是TBtools 生成的GO和KEGG结果，直接把输出的文件拖进来就好。注意如果GO富集分析想分别按照GOterm类别可视化，需要输入padj校正过的那个文件。&lt;/li&gt;
&lt;li&gt;如果自己定制的（customized）需要按照下表整理：&lt;strong&gt;表头写啥无所谓，顺序一定要正确！&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;| GO_Name                                                                                      | Gene_ratio  | HitsGenesCountsInSelectedSet | corrected p-value(BH method) |&lt;br&gt;
|----------------------------------------------------------------------------------------------|-------------|------------------------------|------------------------------|&lt;br&gt;
| steroid dehydrogenase activity, acting on the CH-OH group of donors, NAD or NADP as acceptor | 0.004023409 | 11                           | 0.496511055                  |&lt;br&gt;
| quinone binding                                                                              | 0.004754938 | 13                           | 0.281163809                  |&lt;br&gt;
| indole-3-acetic acid amido synthetase activity                                               | 0.002560351 | 7                            | 0.394598487                  |&lt;br&gt;
| peptide receptor activity                                                                    | 0.001828822 | 5                            | 0.441252581                  |&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Term Number: 你想展示的GO term 或者KEGG Pathway数量，有时候富集分析结果会非常多，几百个结果全画出来不可能，这里筛选的条件就是Qvalue排名前&lt;code&gt;Term number&lt;/code&gt;的数量。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Input Data Form： 输入数据的格式，有三个选项&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;TBtools_GO&lt;/li&gt;
&lt;li&gt;TBtools_KEGG&lt;/li&gt;
&lt;li&gt;customized&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Graph type: 你想画什么图&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Bubble， 气泡图&lt;/li&gt;
&lt;li&gt;bar， 柱状图&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;min/max： 颜色是由Qvalue的大小定义的，越小越显著，这里是颜色变化范围的定义，从min到max渐变。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;output file label： 输出文件标签，为了区分你做的不同结果。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;使用方法&#34;&gt;使用方法&lt;/h2&gt;
&lt;p&gt;这个.... 拖进去，选好参数，点点点，然后看结果...&lt;/p&gt;
&lt;p&gt;颜色方面...推荐下TBtools的colorPicker在&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Graphics -&amp;gt; color palette -&amp;gt;colorpicker
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210126090047.jpg&#34; alt=&#34;color picker&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
选中一个颜色后复制类似&lt;code&gt;#fb8072&lt;/code&gt;这种颜色代码，关闭&lt;code&gt;colorpicker&lt;/code&gt;，粘贴到&lt;code&gt;min&lt;/code&gt;或者&lt;code&gt;max&lt;/code&gt;中。&lt;/p&gt;
&lt;h2 id=&#34;多图预警&#34;&gt;多图预警&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBkeggbubble.jpg&#34; alt=&#34;kegg bubble&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBkeggBar.jpg&#34; alt=&#34;kegg bar&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBGObubble.jpg&#34; alt=&#34;GO bubble&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBGObar.jpg&#34; alt=&#34;GO bar&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/csbar.jpg&#34; alt=&#34;cs bubble&#34; loading=&#34;lazy&#34;&gt;&lt;br&gt;
&lt;img src=&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/cbub.jpg&#34; alt=&#34;cs bar&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;下期预告&#34;&gt;下期预告&lt;/h2&gt;
&lt;p&gt;下期会增加一个OneStepWGCNA的伴侣插件，有朋友反映如果取不到合适的&lt;code&gt;power&lt;/code&gt;官网提供的那个经验&lt;code&gt;power&lt;/code&gt;过于智障，想自己选择&lt;code&gt;power&lt;/code&gt;构建...那么初步想法是把第一步跑完的结果写一个Rdata出来，然后扔到伴侣插件调参，包括&lt;code&gt;power&lt;/code&gt;,&lt;code&gt;最小module size&lt;/code&gt;，用新的&lt;code&gt;traitdata&lt;/code&gt;和&lt;code&gt;datExpr&lt;/code&gt;关联，还有后续关注的模块的&lt;code&gt;GS MM，hub&lt;/code&gt;基因等...&lt;/p&gt;
&lt;p&gt;毕竟不能辱没了我调包狗，调参侠的名头...&lt;/p&gt;
">「TBtools-Plugin」Bubble Plot升级版-TBtools插件</a>
      </div>
      
      <div class="item">
        <a class="result-title" href="https://shawnwx2019.github.io/「Comparative-Genomics」Orthofinder官方文件解读/"" data-c="
          &lt;p&gt;在基因组进化分析和基因家族分析中少不了对同源基因（homologs）的分析,当然同源基因又分为直系同源(orthologs)和旁系同源(paralogs)，如图：&lt;/p&gt;
&lt;!-- more --&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;http://bitesizebio.s3.amazonaws.com/wp-content/uploads/2015/11/05153902/Homology.png&#34; alt=&#34;homologs&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;...&lt;/p&gt;
&lt;p&gt;&lt;font color = grey size =2&gt; Photo courtesy of:  Popo H. Liao (Own work), via Wikimedia Commons&lt;/font&gt;&lt;br&gt;
如何区分请看：&lt;a href=&#34;https://bitesizebio.com/26762/homology-terminology-never-say-wrong-word/&#34;&gt;Homology Terminology: Never Say the Wrong Word Again&lt;/a&gt;&lt;!--more--&gt;&lt;/p&gt;
&lt;h2 id=&#34;名词解释&#34;&gt;名词解释&lt;/h2&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;2&#34;&gt;&lt;img src=&#34;https://github.com/davidemms/OrthoFinder/raw/master/assets/Orthogroups_Orthologues_Paralogues.png&#34; alt=&#34;Orthologues, Orthogroups &amp;amp; Paralogues&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;Orthologs are pairs of genes that descended from a single gene in the last common ancestor (LCA) of two species (Figure 2A &amp;amp; B). An orthogroup is the extension of the concept of orthology to groups of species. An orthogroup is the group of genes descended from a single gene in the LCA of a group of species (Figure 2A).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;The example Figure 2 contains an orthogroup from three species, human, mouse and chicken. Human and mouse each have one gene in this orthogroup (HuA and MoA, respectively) while chicken has two genes (ChA1 and ChA2). The human and mouse genes are a pair of genes descended from a single gene in the last common ancestor of the two species, therefore these two genes are orthologs and there is a one-to-one orthology relationship between the two genes.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;The two chicken genes arose from a gene duplication event after the lineage leading to chicken split from the lineage leading to human and mouse. As gene duplication events give rise to paralogs, ChA1 and ChA2 are paralogs of each other. However, both chicken genes are descended from a single gene in the last common ancestor of the three species. Therefore, both chicken genes are orthologs of the human gene and the mouse gene. Although they are orthologs, sometimes these complex relationships are referred to as co-orthologs (e.g. ChA1 and ChA2 are co-orthologs of HuA). In this case there is a many-to-one orthology relationship between the chicken genes and the human gene. There are only three kinds of orthology relationships one-to-one, many-to-one, and many-to-many. All of these relationships are identified by OrthoFinder.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Speak English, 说人话:&lt;/strong&gt;  👴🏻、🐭和🐔有一个最近的共同的祖先（Last common ancestor，LCA），这个&lt;strong&gt;LCA&lt;/strong&gt;在进化中分化出了👴🏻，🐭和🐔，LCA的一个基因&lt;font color = red&gt;&lt;strong&gt;A&lt;/strong&gt;&lt;/font&gt;在🐔中复制了一次变成&lt;font color=green&gt;ChA1、ChA2&lt;/font&gt;,但是在哺乳动物中没有变，👴🏻中&lt;font color = orange&gt;HuA&lt;/font&gt;和🐭中&lt;font color = blue&gt;MoA&lt;/font&gt;，来掰扯下这4个基因的关系：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;直系同源: 可以理解为从老祖宗LCA那传下来的，压根没变就是figure2B中&lt;font color = orange&gt;HuA&lt;/font&gt;和&lt;font color = blue&gt;MoA&lt;/font&gt;，&lt;font color = orange&gt;HuA&lt;/font&gt;分别和&lt;font color=green&gt;ChA1、ChA2&lt;/font&gt;，&lt;font color = blue&gt;MoA&lt;/font&gt;分别和&lt;font color=green&gt;ChA1、ChA2&lt;/font&gt;。&lt;/li&gt;
&lt;li&gt;直系同源组： 这4个基因并称为直系同源组（有点基因家族的意思）&lt;/li&gt;
&lt;li&gt;旁系同源：在🐔中这个基因出现了复制事件，那么🐔里面的这两个基因：&lt;font color=green&gt;ChA1、ChA2&lt;/font&gt;称作旁系同源。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;软件介绍&#34;&gt;软件介绍&lt;/h2&gt;
&lt;p&gt;奉上软件地址：&lt;a href=&#34;https://github.com/davidemms/OrthoFinder&#34;&gt;davidemms/OrthoFinder&lt;/a&gt;&lt;br&gt;
官方分析流程：&lt;a href=&#34;https://davidemms.github.io/orthofinder_tutorials/exploring-orthofinders-results.html&#34;&gt;OrthoFinder Tutorials&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;orthofinder-能干啥&#34;&gt;orthofinder 能干啥&lt;/h3&gt;
&lt;p&gt;对于比较基因组学（comparative genomics）&lt;code&gt;OrthoFinder&lt;/code&gt;是一个快速的，准确的以及全面的平台，作用：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;找到同源群组orthogroups &lt;sup class=&#34;footnote-ref&#34;&gt;&lt;a href=&#34;#fn1&#34; id=&#34;fnref1&#34;&gt;[1]&lt;/a&gt;&lt;/sup&gt;（不知道怎么翻译合适）&lt;/li&gt;
&lt;li&gt;找到同源基因（orthologs）；&lt;/li&gt;
&lt;li&gt;对orthogroups构建有根树&lt;/li&gt;
&lt;li&gt;鉴定基因复制时间（gene duplication events）&lt;sup class=&#34;footnote-ref&#34;&gt;&lt;a href=&#34;#fn2&#34; id=&#34;fnref2&#34;&gt;[2]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;li&gt;构建物种树。&lt;/li&gt;
&lt;li&gt;将基因的复制时间对应到物种树上。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;软件安装&#34;&gt;软件安装&lt;/h3&gt;
&lt;p&gt;总结为2点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;linux和Mac用conda：这里要注意&lt;code&gt;orthofinder&lt;/code&gt;的&lt;code&gt;Python&lt;/code&gt;环境为python2，我之前在mac上装在&lt;code&gt;python3&lt;/code&gt;的&lt;code&gt;env&lt;/code&gt;下结果出现了各种奇葩报错，什么&lt;code&gt;diamond&lt;/code&gt;不在环境变量，python出错等，装到python2下面立马就消停了...&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;## 最好给orthoFinder建一个新的conda environment。
conda creat -n orthofinder orthofinder=2.27
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;windows 最好用docker, 没试过，不评价，官方给的教程应该没问题。&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-docker&#34;&gt;docker pull davidemms/orthofinder
docker run -it --rm davidemms/orthofinder orthofinder -h
docker run --ulimit nofile=1000000:1000000 -it --rm -v /full/path/to/fastas:/input:Z davidemms/orthofinder orthofinder -f /input
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;软件使用&#34;&gt;软件使用&lt;/h2&gt;
&lt;p&gt;官方给的命令也很简单,只需要把你要做的物种的蛋白序列放到一个空路径下，然后：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;OrthoFinder/orthofinder -f OrthoFinder/ExampleDataset &amp;amp;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;这个只是初级阶段的用法，还有大量的参数可以调。&lt;/p&gt;
&lt;h2 id=&#34;分析过程&#34;&gt;分析过程&lt;/h2&gt;
&lt;p&gt;自己尝试看了下没看懂，这里引用&lt;a href=&#34;https://www.jianshu.com/p/16e0bbb2ba19&#34;&gt;徐州更hoptop&lt;/a&gt;的博文&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;BLAST all-vs-all搜索。使用BLASTP以evalue=10e-3进行搜索，寻找潜在的同源基因。(除了BLAST, 还可以选择DIAMOND和MMSeq2)&lt;/li&gt;
&lt;li&gt;基于基因长度和系统发育距离对BLAST bit得分进行标准化。&lt;/li&gt;
&lt;li&gt;使用RBNHs确定同源组序列性相似度的阈值&lt;/li&gt;
&lt;li&gt;构建直系同源组图(orthogroup graph)，用作MCL的输入&lt;/li&gt;
&lt;li&gt;使用MCL对基因进行聚类，划分直系同源组&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;OrthoFinder2在OrthoFinder的基础上增加了物种系统发育树的构建，流程如下&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;为每个直系同源组构建基因系统发育树&lt;/li&gt;
&lt;li&gt;使用STAG算法从无根基因树上构建无根物种树&lt;/li&gt;
&lt;li&gt;使用STRIDE算法构建有根物种树&lt;/li&gt;
&lt;li&gt;有根物种树进一步辅助构建有根基因树。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;--未完待续...&lt;/p&gt;
&lt;hr class=&#34;footnotes-sep&#34;&gt;
&lt;section class=&#34;footnotes&#34;&gt;
&lt;ol class=&#34;footnotes-list&#34;&gt;
&lt;li id=&#34;fn1&#34; class=&#34;footnote-item&#34;&gt;&lt;p&gt;&lt;a href=&#34;https://github.com/davidemms/OrthoFinder#orthogroups-orthologs--paralogs&#34;&gt;What are orthogroups, orthologs &amp;amp; paralogs?&lt;/a&gt; &lt;a href=&#34;#fnref1&#34; class=&#34;footnote-backref&#34;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn2&#34; class=&#34;footnote-item&#34;&gt;&lt;p&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Gene_duplication&#34;&gt;Gene duplication&lt;/a&gt; &lt;a href=&#34;#fnref2&#34; class=&#34;footnote-backref&#34;&gt;↩︎&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
">「Comparative-Genomics」官方文档解读</a>
      </div>
      
    </div>
  </div>
</div>
<script>
  // var escape = "[{&#34;content&#34;:&#34;&lt;p&gt;在引言部分我们讲过离群样本的判别，很大程度上和实验设计相关，对于无样本异质性，变量较少的实验设计是一种方案，而对于存在样本异质性，或者引入了多样化变量的实验设计这里需要慎重去除...&lt;/p&gt;\n&lt;!--more--&gt;\n&lt;h2 id=\&#34;原理\&#34;&gt;原理&lt;/h2&gt;\n&lt;p&gt;离群样本（outlier）出现的原因，一方面可能是样本本身的原因，比如处理方式不当，生长状态，遗传背景变异等，也可能是实验操作问题，总之会影响结果的准确性。对于实验设计简单，引发差异变量较少的代谢组学实验，outlier判别相对简单，生物学重复之间差异较小，而组间差异较大，如果出现个别与整体差异显著的材料，应该是各种原因造成的离群样本，tidyMass提供了&lt;code&gt;detect_outlier()&lt;/code&gt;来判断离群值，其原理基于&lt;a href=\&#34;https://privefl.github.io/blog/detecting-outlier-samples-in-pca/\&#34;&gt;Detecting outlier samples in PCA – Florian Privé – R(cpp) enthusiast&lt;/a&gt; 结果会输出一个判断表格，基于以下判断结果我们可以根据自己的实验设计的实际情况，自助判断离群样本：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;\n&lt;p&gt;根据样本中代谢物的缺失率；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;根据标准偏差；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;根据绝对中为差（MAD）；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;根据稳健马氏距离推导的p值来判别；&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&#34;操作界面\&#34;&gt;操作界面&lt;/h2&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;1\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407290957499.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;操作相对简单，对应的设置好阈值之后点击&lt;code&gt;find outlier&lt;/code&gt;即可，MetMiner中默认的值和tidyMass提供的默认阈值一致。比如Demo中我们制造了一个虚拟的离群样本，根据缺失率和马氏距离该样本在正谱中都为离群样本，本试验的唯一变量是遗传背景的不同，所以这里可以将Outlier样本视为离群值去除，去除过程操作如下:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;\n&lt;p&gt;可以直接在Pick outliers中查找到Outlier去除，也可根据样本缺失值统计散点图直观的选择需要去除的样本；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;开启图形交互；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;将鼠标悬浮到缺失值统计的高缺失率的样本查看sample_id；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;在Pick outlier中选择要去除的样本；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;点击remove and update；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;在静态图模式下，可以看到去除前后缺失率统计图。&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;2\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgoiShot_2024-07-29_09.59.02.gif\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;h2 id=\&#34;其它\&#34;&gt;其它&lt;/h2&gt;\n&lt;p&gt;这里仍旧需要再次提醒包含不同物种、不同组织、时序效应等复杂实验设计，在离群值去除时需要慎重！&lt;/p&gt;\n&lt;p&gt;---The end---&lt;/p&gt;\n&lt;p&gt;Jul 27, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;metminer-datacleaing-outlier&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;在引言部分我们讲过离群样本的判别，很大程度上和实验设计相关，对于无样本异质性，变量较少的实验设计是一种方案，而对于存在样本异质性，或者引入了多样化变量的实验设计这里需要慎重去除...&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「MetMiner」数据清洗 - 离群样本&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;MetMiner&#34;,&#34;slug&#34;:&#34;L39wxwPVS&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/L39wxwPVS/&#34;},{&#34;name&#34;:&#34;metabolomics&#34;,&#34;slug&#34;:&#34;pj9WiqYdce&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/pj9WiqYdce/&#34;},{&#34;name&#34;:&#34;TBtools plugin&#34;,&#34;slug&#34;:&#34;8rkPmYxtv_&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/8rkPmYxtv_/&#34;},{&#34;name&#34;:&#34;Shiny app&#34;,&#34;slug&#34;:&#34;iiHZST6a6&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/iiHZST6a6/&#34;},{&#34;name&#34;:&#34;bioinformatics&#34;,&#34;slug&#34;:&#34;-7KH0PNTVn&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/-7KH0PNTVn/&#34;}],&#34;date&#34;:&#34;2024-07-29 08:43:47&#34;,&#34;dateFormat&#34;:&#34;2024-07-29&#34;,&#34;feature&#34;:&#34;https://shawnwx2019.github.io/post-images/metminer-datacleaing-outlier.jpg&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/metminer-datacleaing-outlier/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;3 min read&#34;,&#34;time&#34;:131000,&#34;words&#34;:623,&#34;minutes&#34;:3},&#34;description&#34;:&#34;在引言部分我们讲过离群样本的判别，很大程度上和实验设计相关，对于无样本异质性，变量较少的实验设计是一种方案，而对于存在样本异质性，或者引入了多样化变量的实验设计这里需要慎重去除...\n\n原理\n离群样本（outlier）出现的原因，一方面可能...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%8E%9F%E7%90%86\&#34;&gt;原理&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%93%8D%E4%BD%9C%E7%95%8C%E9%9D%A2\&#34;&gt;操作界面&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%85%B6%E5%AE%83\&#34;&gt;其它&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;数据清洗的第一步是根据统计样本中代谢物的缺失率（missing value rate）来标记噪音。MetMiner中标记噪音的具体方式较为多样化...&lt;/p&gt;\n&lt;!--more--&gt;\n&lt;h2 id=\&#34;原理\&#34;&gt;原理&lt;/h2&gt;\n&lt;p&gt;之前提到过理论上&lt;code&gt;QC&lt;/code&gt;样本包含了所有的代谢物信息，而且从实验操作也可以看出，不同时间段的&lt;code&gt;QC&lt;/code&gt;样本都来自于一个混样，所以&lt;strong&gt;理论上所有QC样本中代谢物的缺失率是较为一致的，且缺失率较低&lt;/strong&gt;；&lt;/p&gt;\n&lt;p&gt;经验上，我们认为在&lt;code&gt;QC&lt;/code&gt;样本中缺失率低于&lt;code&gt;20%&lt;/code&gt;的代谢物是较为稳定的，这些代谢物检出率较高，可信度也较高，针对大部分的实验设计，该评价条件式较为稳健的；&lt;/p&gt;\n&lt;p&gt;此外针对无样本异质性的实验设计，我们还可以结合对测试样本中代谢物的缺失率来判断，例如，在对&lt;code&gt;QC&lt;/code&gt;样本缺失率筛选过后的feature，我们也可以加上更加严格的条件，比如在测试样本中至少一般以上的样本要检测到，这里就可以针对筛选；&lt;/p&gt;\n&lt;p&gt;对于有样本异质性的实验设计，只需要关注他在&lt;code&gt;QC&lt;/code&gt;样本中的缺失率即可；&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;注意，QC中缺失阈值和样本中缺失阈值之间的关系是and！而不是or！可以理解为在符合QC阈值的情况下增加更加严格的条件！&lt;/strong&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;操作界面\&#34;&gt;操作界面&lt;/h2&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;1\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407271712403.png\&#34; alt=\&#34;noisy remove\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;首先看sidebar中的参数：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;Group by：&lt;/strong&gt; 比如下面sample information表格中，class将样本分为了QC和Subject，group代表了样本的分组，这里面包含了两个变量，一个是基因型（col0 or mutant）另一个是处理（water or drought），这样将样本分成了4组。如果我们想在控制QC缺失的同时至少在&lt;strong&gt;一半的测试样本中存在&lt;/strong&gt;，那么这里需要将Group by 选择为&lt;code&gt;class&lt;/code&gt;，同时&lt;code&gt;missing value frequency&lt;/code&gt;选择&lt;code&gt;50%&lt;/code&gt;; 如果我们想更加严格一点，至少&lt;strong&gt;在5个生物学重复中至少3个可以检测到&lt;/strong&gt;，那么这里需要将Group by选择为&lt;code&gt;group&lt;/code&gt;, &lt;code&gt;missing value frequency&lt;/code&gt;选择&lt;code&gt;40%&lt;/code&gt;;&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;Missing value frequency&lt;/strong&gt; 样本缺失率阈值，如果不卡测试样本的缺失阈值，这里直接拉到&lt;code&gt;100%&lt;/code&gt;；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;&lt;strong&gt;Missing value frequency in QC&lt;/strong&gt; &lt;code&gt;QC&lt;/code&gt;中的缺失率阈值；&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;style&gt;\n&lt;/style&gt;\n&lt;table&gt;\n&lt;thead&gt;\n&lt;tr&gt;\n&lt;th&gt;sample_id&lt;/th&gt;\n&lt;th&gt;injection.order&lt;/th&gt;\n&lt;th&gt;class&lt;/th&gt;\n&lt;th&gt;group&lt;/th&gt;\n&lt;th&gt;batch&lt;/th&gt;\n&lt;th&gt;group&lt;/th&gt;\n&lt;th&gt;treatment&lt;/th&gt;\n&lt;th&gt;genotype&lt;/th&gt;\n&lt;/tr&gt;\n&lt;/thead&gt;\n&lt;tbody&gt;\n&lt;tr&gt;\n&lt;td&gt;QC_01&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;QC_02&lt;/td&gt;\n&lt;td&gt;2&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;QC_03&lt;/td&gt;\n&lt;td&gt;3&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;QC_04&lt;/td&gt;\n&lt;td&gt;4&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;QC_05&lt;/td&gt;\n&lt;td&gt;5&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;QC_06&lt;/td&gt;\n&lt;td&gt;6&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0001&lt;/td&gt;\n&lt;td&gt;7&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;WT-Water&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;WT-Water-1&lt;/td&gt;\n&lt;td&gt;Water&lt;/td&gt;\n&lt;td&gt;col0&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0002&lt;/td&gt;\n&lt;td&gt;8&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;WT-Water&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;WT-Water-2&lt;/td&gt;\n&lt;td&gt;Water&lt;/td&gt;\n&lt;td&gt;col0&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0003&lt;/td&gt;\n&lt;td&gt;9&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;WT-Water&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;WT-Water-3&lt;/td&gt;\n&lt;td&gt;Water&lt;/td&gt;\n&lt;td&gt;col0&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0004&lt;/td&gt;\n&lt;td&gt;10&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;WT-Water&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;WT-Water-4&lt;/td&gt;\n&lt;td&gt;Water&lt;/td&gt;\n&lt;td&gt;col0&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0005&lt;/td&gt;\n&lt;td&gt;11&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;WT-Water&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;WT-Water-5&lt;/td&gt;\n&lt;td&gt;Water&lt;/td&gt;\n&lt;td&gt;col0&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0006&lt;/td&gt;\n&lt;td&gt;12&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;WT-drought&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;WT-drought-1&lt;/td&gt;\n&lt;td&gt;drought&lt;/td&gt;\n&lt;td&gt;col0&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0007&lt;/td&gt;\n&lt;td&gt;13&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;WT-drought&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;WT-drought-2&lt;/td&gt;\n&lt;td&gt;drought&lt;/td&gt;\n&lt;td&gt;col0&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0008&lt;/td&gt;\n&lt;td&gt;14&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;WT-drought&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;WT-drought-3&lt;/td&gt;\n&lt;td&gt;drought&lt;/td&gt;\n&lt;td&gt;col0&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0009&lt;/td&gt;\n&lt;td&gt;15&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;WT-drought&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;WT-drought-4&lt;/td&gt;\n&lt;td&gt;drought&lt;/td&gt;\n&lt;td&gt;col0&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0010&lt;/td&gt;\n&lt;td&gt;16&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;WT-drought&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;WT-drought-5&lt;/td&gt;\n&lt;td&gt;drought&lt;/td&gt;\n&lt;td&gt;col0&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;QC_07&lt;/td&gt;\n&lt;td&gt;17&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0011&lt;/td&gt;\n&lt;td&gt;18&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;MT-Water&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;MT-Water-1&lt;/td&gt;\n&lt;td&gt;Water&lt;/td&gt;\n&lt;td&gt;mutant&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0012&lt;/td&gt;\n&lt;td&gt;19&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;MT-Water&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;MT-Water-2&lt;/td&gt;\n&lt;td&gt;Water&lt;/td&gt;\n&lt;td&gt;mutant&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0013&lt;/td&gt;\n&lt;td&gt;20&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;MT-Water&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;MT-Water-3&lt;/td&gt;\n&lt;td&gt;Water&lt;/td&gt;\n&lt;td&gt;mutant&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0014&lt;/td&gt;\n&lt;td&gt;21&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;MT-Water&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;MT-Water-4&lt;/td&gt;\n&lt;td&gt;Water&lt;/td&gt;\n&lt;td&gt;mutant&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0015&lt;/td&gt;\n&lt;td&gt;22&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;MT-Water&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;MT-Water-5&lt;/td&gt;\n&lt;td&gt;Water&lt;/td&gt;\n&lt;td&gt;mutant&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0016&lt;/td&gt;\n&lt;td&gt;23&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;MT-drought&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;MT-drought-1&lt;/td&gt;\n&lt;td&gt;drought&lt;/td&gt;\n&lt;td&gt;mutant&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0017&lt;/td&gt;\n&lt;td&gt;24&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;MT-drought&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;MT-drought-2&lt;/td&gt;\n&lt;td&gt;drought&lt;/td&gt;\n&lt;td&gt;mutant&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0018&lt;/td&gt;\n&lt;td&gt;25&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;MT-drought&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;MT-drought-3&lt;/td&gt;\n&lt;td&gt;drought&lt;/td&gt;\n&lt;td&gt;mutant&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0019&lt;/td&gt;\n&lt;td&gt;26&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;MT-drought&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;MT-drought-4&lt;/td&gt;\n&lt;td&gt;drought&lt;/td&gt;\n&lt;td&gt;mutant&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;S_0020&lt;/td&gt;\n&lt;td&gt;27&lt;/td&gt;\n&lt;td&gt;Subject&lt;/td&gt;\n&lt;td&gt;MT-drought&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;MT-drought-5&lt;/td&gt;\n&lt;td&gt;drought&lt;/td&gt;\n&lt;td&gt;mutant&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;QC_08&lt;/td&gt;\n&lt;td&gt;28&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;QC_09&lt;/td&gt;\n&lt;td&gt;29&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;QC_10&lt;/td&gt;\n&lt;td&gt;30&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;QC_11&lt;/td&gt;\n&lt;td&gt;31&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;QC&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;/tr&gt;\n&lt;/tbody&gt;\n&lt;/table&gt;\n&lt;p&gt;---The end---&lt;/p&gt;\n&lt;p&gt;Jul 27, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;metminer-remove-noise&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;数据清洗的第一步是根据统计样本中代谢物的缺失率（missing value rate）来标记噪音。MetMiner中标记噪音的具体方式较为多样化...&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「MetMiner」数据清洗 - 去噪&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;MetMiner&#34;,&#34;slug&#34;:&#34;L39wxwPVS&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/L39wxwPVS/&#34;},{&#34;name&#34;:&#34;metabolomics&#34;,&#34;slug&#34;:&#34;pj9WiqYdce&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/pj9WiqYdce/&#34;},{&#34;name&#34;:&#34;TBtools plugin&#34;,&#34;slug&#34;:&#34;8rkPmYxtv_&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/8rkPmYxtv_/&#34;},{&#34;name&#34;:&#34;Shiny app&#34;,&#34;slug&#34;:&#34;iiHZST6a6&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/iiHZST6a6/&#34;},{&#34;name&#34;:&#34;bioinformatics&#34;,&#34;slug&#34;:&#34;-7KH0PNTVn&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/-7KH0PNTVn/&#34;}],&#34;date&#34;:&#34;2024-07-27 17:48:40&#34;,&#34;dateFormat&#34;:&#34;2024-07-27&#34;,&#34;feature&#34;:&#34;https://shawnwx2019.github.io/post-images/metminer-remove-noise.jpg&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/metminer-remove-noise/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;5 min read&#34;,&#34;time&#34;:241000,&#34;words&#34;:893,&#34;minutes&#34;:5},&#34;description&#34;:&#34;数据清洗的第一步是根据统计样本中代谢物的缺失率（missing value rate）来标记噪音。MetMiner中标记噪音的具体方式较为多样化...\n\n原理\n之前提到过理论上QC样本包含了所有的代谢物信息，而且从实验操作也可以看出，不同时...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%8E%9F%E7%90%86\&#34;&gt;原理&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%93%8D%E4%BD%9C%E7%95%8C%E9%9D%A2\&#34;&gt;操作界面&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;该部分是数据清洗前的准备工作，主要的作用是通过观测QC样本的峰面积的boxplot以及整体样本中代谢物的缺失情况来补充batch信息，如果没有观测到明显的批次效应则可以直接进行后续分析。&lt;/p&gt;\n&lt;!--more--&gt;\n&lt;h1 id=\&#34;操作界面\&#34;&gt;操作界面&lt;/h1&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;1\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407271550481.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;&lt;strong&gt;Data Cleaning =&amp;gt; Overview&lt;/strong&gt; 左侧&lt;code&gt;sidebar&lt;/code&gt; 一般为设置参数的选项，这部分参数主要是针对可视化颜色选项的，第一个图就是QC样本峰面积箱线图，这里提供了两个选项，一个是根据批次上色，另一个是根据上样顺序上色，比如这里我们已知该实验分了两个批次，批次产生的原因主要是前期样品通过上样瓶进行上样，而后期样品通过96孔板上样，在上样体积上出现了显著差异，如果前期不知道换了上样方式会带来批次效应，从该图也可以明显观测到。&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;2\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407271555589.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;同样，通过所有样本散点图的分布可以看出batch3的缺失值显著升高，这可能是更换上样方式后代谢物含量下降，低Intensity的代谢物检出效率变低，导致缺失率升高。&lt;/p&gt;\n&lt;p&gt;基于此我们一方面可以核对&lt;code&gt;sample info&lt;/code&gt;中的批次效应信息，同时结合实验记录我们也可以补充遗漏的批次效应信息。&lt;/p&gt;\n&lt;h2 id=\&#34;交互操作\&#34;&gt;交互操作&lt;/h2&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;3\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgooverview-interac.gif\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;交互操作使得我们可以很快的从图中提取出有用的信息，比如上图中我们发现在负谱中一个叫&lt;code&gt;Outlier&lt;/code&gt;的样本缺失值达到了90%以上，通过交互操作我们可以快速的获得该样本的id，方便我们后期对该离群样本进行删除或者重新补测。&lt;br&gt;\n---The end---&lt;br&gt;\nJul 27, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;metminer-datacleaning-overview&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;该部分是数据清洗前的准备工作，主要的作用是通过观测QC样本的峰面积的boxplot以及整体样本中代谢物的缺失情况来补充batch信息，如果没有观测到明显的批次效应则可以直接进行后续分析。&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「MetMiner」数据清洗 - Overview&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;MetMiner&#34;,&#34;slug&#34;:&#34;L39wxwPVS&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/L39wxwPVS/&#34;},{&#34;name&#34;:&#34;metabolomics&#34;,&#34;slug&#34;:&#34;pj9WiqYdce&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/pj9WiqYdce/&#34;},{&#34;name&#34;:&#34;TBtools plugin&#34;,&#34;slug&#34;:&#34;8rkPmYxtv_&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/8rkPmYxtv_/&#34;},{&#34;name&#34;:&#34;Shiny app&#34;,&#34;slug&#34;:&#34;iiHZST6a6&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/iiHZST6a6/&#34;},{&#34;name&#34;:&#34;bioinformatics&#34;,&#34;slug&#34;:&#34;-7KH0PNTVn&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/-7KH0PNTVn/&#34;}],&#34;date&#34;:&#34;2024-07-27 16:47:49&#34;,&#34;dateFormat&#34;:&#34;2024-07-27&#34;,&#34;feature&#34;:&#34;https://shawnwx2019.github.io/post-images/metminer-datacleaning-overview.jpg&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/metminer-datacleaning-overview/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;2 min read&#34;,&#34;time&#34;:99000,&#34;words&#34;:477,&#34;minutes&#34;:2},&#34;description&#34;:&#34;该部分是数据清洗前的准备工作，主要的作用是通过观测QC样本的峰面积的boxplot以及整体样本中代谢物的缺失情况来补充batch信息，如果没有观测到明显的批次效应则可以直接进行后续分析。\n\n操作界面\n\nData Cleaning =&amp;gt;...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%93%8D%E4%BD%9C%E7%95%8C%E9%9D%A2\&#34;&gt;操作界面&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%BA%A4%E4%BA%92%E6%93%8D%E4%BD%9C\&#34;&gt;交互操作&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;我们将代谢组学数据分析大致的分为了两部分，第一部分数据清洗，也就是将包含&lt;strong&gt;系统误差&lt;/strong&gt;、&lt;strong&gt;批次效应&lt;/strong&gt;、&lt;strong&gt;噪音&lt;/strong&gt;、&lt;strong&gt;离群样本&lt;/strong&gt;，等多种干扰因素的「原始数据」&lt;strong&gt;清洗&lt;/strong&gt;成「干净数据」。MetMiner在执行数据清洗前会对原始数据进行质控，尽早的基于质控样本（QC）来观测是否具有严重批次效应的出现，以及由于实验操作失误产生的异常数据；&lt;/p&gt;\n&lt;p&gt;该部分主要介绍两点：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;\n&lt;p&gt;代谢组数据误差来源原理和解决方案；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;数据清洗步骤简介；&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&lt;!--more--&gt;\n&lt;h1 id=\&#34;误差来源\&#34;&gt;误差来源&lt;/h1&gt;\n&lt;p&gt;在代谢组学实验中，&lt;strong&gt;仪器漂移和批次效应&lt;/strong&gt;是两个主要的系统误差来源，它们会影响数据的质量和分析结果的可靠性。以下是对这两个现象的详细解释：&lt;/p&gt;\n&lt;h3 id=\&#34;仪器漂移\&#34;&gt;仪器漂移&lt;/h3&gt;\n&lt;p&gt;&lt;strong&gt;定义&lt;/strong&gt;：仪器漂移是指在长时间的实验过程中，分析仪器（如质谱仪、色谱仪等）性能的逐渐变化。这种变化可能是由于温度、压力、样品负载、仪器部件老化等因素引起的。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;表现&lt;/strong&gt;：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;信号强度变化&lt;/strong&gt;：随着时间的推移，仪器的检测灵敏度可能会变化，导致相同样品在不同时间点测得的信号强度不同。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;保留时间漂移&lt;/strong&gt;：在色谱分离过程中，化合物的保留时间可能会随着时间的推移发生变化，导致峰位偏移。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;质量偏移&lt;/strong&gt;：质谱分析中，质量数（m/z）的测量可能会发生轻微的偏移，影响质量准确度。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;&lt;strong&gt;解决方法&lt;/strong&gt;：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;定期校准&lt;/strong&gt;：对仪器进行定期校准和维护，保持仪器性能的稳定。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;使用QC样品&lt;/strong&gt;：在实验过程中定期插入QC样品，通过比较QC样品的检测结果，监控和校正仪器漂移。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;数据归一化&lt;/strong&gt;：利用QC样品数据进行归一化处理，校正仪器漂移对实验数据的影响。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&#34;批次效应\&#34;&gt;批次效应&lt;/h3&gt;\n&lt;p&gt;&lt;strong&gt;定义&lt;/strong&gt;：批次效应是指在不同实验批次中，由于实验条件、操作人员、试剂、设备等的变化，导致的系统性误差。这种误差会使得不同批次之间的实验数据出现系统性差异。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;表现&lt;/strong&gt;：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;系统偏差&lt;/strong&gt;：同一实验在不同批次中进行时，测得的结果可能会存在系统性的偏差，导致无法直接比较不同批次的数据。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;变异增大&lt;/strong&gt;：不同批次之间的变异会增加数据的总变异，影响统计分析的结果和结论。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;&lt;strong&gt;解决方法&lt;/strong&gt;：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;实验设计&lt;/strong&gt;：在实验设计阶段，通过随机化和平衡化减少批次效应。例如，将样品随机分配到不同的批次中进行检测。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;使用QC样品&lt;/strong&gt;：在每个批次中都插入相同的QC样品，利用QC样品数据进行校正，减小批次效应对实验结果的影响。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;数据归一化和校正&lt;/strong&gt;：采用数据归一化和批次校正方法，如多元统计分析、批次效应校正，来减少批次效应的影响。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h1 id=\&#34;qc-based-normalization\&#34;&gt;QC-based normalization&lt;/h1&gt;\n&lt;h3 id=\&#34;qc-based-normalization的优点\&#34;&gt;QC-based Normalization的优点&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;校正系统误差&lt;/strong&gt;：通过使用QC样品，可以有效校正因仪器漂移和批次效应引起的系统误差，保证数据的准确性。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;提高数据一致性&lt;/strong&gt;：在实验过程中定期插入QC样品，确保数据在不同时间点和不同批次中的一致性，提高实验结果的可比性。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;增强数据的可靠性&lt;/strong&gt;：QC样品提供了一个标准参考，有助于减少假阳性和假阴性结果，增强数据分析的可靠性。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;监控实验过程&lt;/strong&gt;：QC样品可以用于实时监控仪器性能和实验过程，及时发现和纠正实验中的问题。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;简化数据处理&lt;/strong&gt;：QC样品的使用使得数据归一化和校正过程更加简便和标准化，提高数据处理的效率。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&#34;常用的qc-based-normalization算法\&#34;&gt;常用的QC-based Normalization算法&lt;/h3&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;LOESS（Locally Estimated Scatterplot Smoothing）&lt;/strong&gt;：&lt;/li&gt;\n&lt;/ol&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;原理&lt;/strong&gt;：LOESS算法通过局部回归的方法，对QC样品的信号强度进行平滑，校正仪器漂移和批次效应。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;优点&lt;/strong&gt;：能够处理复杂的非线性关系，适用于大规模数据集。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;ol start=\&#34;2\&#34;&gt;\n&lt;li&gt;&lt;strong&gt;SVR（Support Vector Regression）&lt;/strong&gt;：&lt;/li&gt;\n&lt;/ol&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;原理&lt;/strong&gt;：利用支持向量回归模型，对QC样品的信号强度进行建模，校正仪器漂移和批次效应。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;优点&lt;/strong&gt;：适用于高维数据，具有良好的泛化能力。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;ol start=\&#34;3\&#34;&gt;\n&lt;li&gt;&lt;strong&gt;SERRF（Systematic Error Removal using Random Forest）：&lt;/strong&gt;&lt;/li&gt;\n&lt;/ol&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;原理&lt;/strong&gt;：使用随机森林模型来校正系统误差。首先，利用QC样品的数据构建随机森林模型，学习QC样品的信号强度与实验条件（如批次、时间等）之间的关系。然后，利用训练好的模型预测每个样品的系统误差，并进行校正。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;优点&lt;/strong&gt;：SERRF能够有效地校正由于仪器漂移和批次效应引起的系统误差，提高数据的准确性。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h1 id=\&#34;数据清洗步骤简介\&#34;&gt;数据清洗步骤简介&lt;/h1&gt;\n&lt;h2 id=\&#34;检测批次效应和离群样本\&#34;&gt;检测批次效应和离群样本&lt;/h2&gt;\n&lt;p&gt;首先我们从上述原理可知QC样本的设置对于数据清洗来说是非常重要的，一般在我们的实验过程中，会在开头先上3针左右的QC，然后再上样本，每个10个样本左右穿插一针QC。在上样结束再补3针QC。&lt;/p&gt;\n&lt;p&gt;理论上QC样本是所有sample等量混样获得的，包含了所有的variable信息，而且他们是一致的，我们通过QC样本代谢物峰面积的boxplot、PCA、以及样本中的代谢物的缺失率可以观测到批次效应和系统偏移。通观测这些图，如果我们发现了随着上样时间的推移，QC样本呈现较大幅度的偏移，而且具有一定的规律，结合实验记录我们需要在&lt;code&gt;sample_info&lt;/code&gt;中补充实验的批次信息。其次，如果实验设计中不包括样本异质性，也就是说测试样本基本属于同一物种、同一（近似的）发育时期、相同组织的话，那么变量较为单一。分为以下情况：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;\n&lt;p&gt;同一材料不同处理： 变量为处理条件；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;不同遗传背景相同处理：变量为遗传背景；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;不同遗传背景不同处理：变量为遗传背景+处理；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;相同材料时序：变量为时间序列；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;不同遗传背景时序：变量为遗传背景+时间序列；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;...&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;总之实验设计越简单，差异构成因素越小，越容易从差异代谢物入手聚焦生物学问题；相反，需要更多的数据分析手段，逐步排除干扰，聚焦生物学问题。&lt;/p&gt;\n&lt;p&gt;针对这类实验设计，我们经验得知代谢水平 &lt;strong&gt;物种特异性 ≈ 组织特异性 &amp;gt;&amp;gt; 处理-对照 ≈ 遗传背景差异&lt;/strong&gt; 。那么当你的实验设计包含了样品异质性后，物种间特异性和组织间特异性会大幅度掩盖遗传背景和处理造成的差异，反映到代谢组数据上就是在不同物种，不同组织间的样本在代谢物类别上具有明显差异，通过样本中代谢物的缺失率（missing value rate）在不同组织间具有显著差异；这里我们提供一个参考的阈值，&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;\n&lt;p&gt;如果对于&lt;strong&gt;无样本异质性的实验设计&lt;/strong&gt;，mv &amp;gt; 0.5可以被认为是outlier，这个可能是样本本身的问题，也可能是实验操作的问题（进样瓶有气泡，浓度不足），因为同一种材料超过50%的代谢物检测不到肯定不正常。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;如果对于&lt;strong&gt;有样本异质性的实验设计&lt;/strong&gt;，mv &amp;gt; 0.8可以被认为是outlier，我们实操和经验中，这类样本一般是由于实验操作引起的失误，从TIC图可以看出这类样本提峰的结果就很奇怪，遇到这种情况需要及时在补一针样品，所以在遇到大样本量的非靶代谢时，需要阶段性的观测跑完样本结果，及时纠正实验失误引发的错误样本结果；&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&#34;标准数据清洗步骤\&#34;&gt;标准数据清洗步骤&lt;/h2&gt;\n&lt;p&gt;离群样本和批次效应在规范化的实验操作流程中根据实验记录和对结果的观测是可以提前避免的，但也不能保证每次实验均可以，那么在我们获得原始数据后，通过后期数据质控，数据清洗过程也可以亡羊补牢；&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;\n&lt;p&gt;在MetMiner中 Data cleaning的第一步是『Overview』这里展示了原始数据QC样本峰面积的统计结果；随着上样顺序的排列，我们可以观测是否具有批次效应或者系统偏移，如果观测到了批次效应，需要及时修改&lt;code&gt;sample_info&lt;/code&gt;中的&lt;code&gt;batch&lt;/code&gt;信息；第二块展示了所有样本的代谢物缺失率，同样可以观测到是否具有明显的&lt;code&gt;样本异质性&lt;/code&gt;或者&lt;code&gt;批次效应&lt;/code&gt;；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;第二步是『remove noisy features』称为去噪，通过统计每个feature在QC样本中或者测试Subject样本中的缺失率来判断是否为噪音；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;第三步是『remove outlier』去除离群值，这里tidymass提供了多种离群值检测指标&lt;a href=\&#34;https://privefl.github.io/blog/detecting-outlier-samples-in-pca/\&#34;&gt;Detecting outlier samples in PCA – Florian Privé – R(cpp) enthusiast&lt;/a&gt;, 这里不能非黑即白的刻板的套用软件提供的参考结果，正如前文提到的一样，需要结合自己的实验设计灵活的判断；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;第四步是『missing value imputation』缺失值的插补，在后续进行数据标准化时不允许出现缺失值，所以这里需要使用合适的算法对缺失的值进行插补；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;第四步为『Normalization』数据标准化，也就是前面提到的标准化的过程，其实还隐含了另外一个就是batch align，在tidymass中是通过batch integrate将不同batch的结果整合到一起。&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;---The end---&lt;br&gt;\nJul 27, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;metminer-datacleaning-Introduce&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;我们将代谢组学数据分析大致的分为了两部分，第一部分数据清洗，也就是将包含&lt;strong&gt;系统误差&lt;/strong&gt;、&lt;strong&gt;批次效应&lt;/strong&gt;、&lt;strong&gt;噪音&lt;/strong&gt;、&lt;strong&gt;离群样本&lt;/strong&gt;，等多种干扰因素的「原始数据」&lt;strong&gt;清洗&lt;/strong&gt;成「干净数据」。MetMiner在执行数据清洗前会对原始数据进行质控，尽早的基于质控样本（QC）来观测是否具有严重批次效应的出现，以及由于实验操作失误产生的异常数据；&lt;/p&gt;\n&lt;p&gt;该部分主要介绍两点：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;\n&lt;p&gt;代谢组数据误差来源原理和解决方案；&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;数据清洗步骤简介；&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&#34;,&#34;title&#34;:&#34;「MetMiner」数据清洗 - 引言&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;MetMiner&#34;,&#34;slug&#34;:&#34;L39wxwPVS&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/L39wxwPVS/&#34;},{&#34;name&#34;:&#34;metabolomics&#34;,&#34;slug&#34;:&#34;pj9WiqYdce&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/pj9WiqYdce/&#34;},{&#34;name&#34;:&#34;TBtools plugin&#34;,&#34;slug&#34;:&#34;8rkPmYxtv_&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/8rkPmYxtv_/&#34;},{&#34;name&#34;:&#34;bioinformatics&#34;,&#34;slug&#34;:&#34;-7KH0PNTVn&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/-7KH0PNTVn/&#34;},{&#34;name&#34;:&#34;R&#34;,&#34;slug&#34;:&#34;G_5eRHzJub&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/G_5eRHzJub/&#34;}],&#34;date&#34;:&#34;2024-07-26 17:06:15&#34;,&#34;dateFormat&#34;:&#34;2024-07-26&#34;,&#34;feature&#34;:&#34;https://shawnwx2019.github.io/post-images/metminer-datacleaning-Introduce.jpg&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/metminer-datacleaning-Introduce/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;9 min read&#34;,&#34;time&#34;:539000,&#34;words&#34;:2598,&#34;minutes&#34;:9},&#34;description&#34;:&#34;我们将代谢组学数据分析大致的分为了两部分，第一部分数据清洗，也就是将包含系统误差、批次效应、噪音、离群样本，等多种干扰因素的「原始数据」清洗成「干净数据」。MetMiner在执行数据清洗前会对原始数据进行质控，尽早的基于质控样本（QC）来观...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%AF%AF%E5%B7%AE%E6%9D%A5%E6%BA%90\&#34;&gt;误差来源&lt;/a&gt;&lt;br&gt;\n*\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%BB%AA%E5%99%A8%E6%BC%82%E7%A7%BB\&#34;&gt;仪器漂移&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%89%B9%E6%AC%A1%E6%95%88%E5%BA%94\&#34;&gt;批次效应&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#qc-based-normalization\&#34;&gt;QC-based normalization&lt;/a&gt;&lt;br&gt;\n*\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#qc-based-normalization%E7%9A%84%E4%BC%98%E7%82%B9\&#34;&gt;QC-based Normalization的优点&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%B8%B8%E7%94%A8%E7%9A%84qc-based-normalization%E7%AE%97%E6%B3%95\&#34;&gt;常用的QC-based Normalization算法&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97%E6%AD%A5%E9%AA%A4%E7%AE%80%E4%BB%8B\&#34;&gt;数据清洗步骤简介&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%A3%80%E6%B5%8B%E6%89%B9%E6%AC%A1%E6%95%88%E5%BA%94%E5%92%8C%E7%A6%BB%E7%BE%A4%E6%A0%B7%E6%9C%AC\&#34;&gt;检测批次效应和离群样本&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%A0%87%E5%87%86%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97%E6%AD%A5%E9%AA%A4\&#34;&gt;标准数据清洗步骤&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;MetMiner流程整合了mass_dataset数据输入格式，所以具有灵活多变的数据输入模式，本文介绍了通过metMiner进行代谢组数据分析前的数据准备及项目初始化工作。&lt;/p&gt;\n&lt;p&gt;主要从一下几方面说明：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;原始数据格式转换和文件结构（从原始数据导入）；&lt;/li&gt;\n&lt;li&gt;提峰表格准备（从其它软件提峰表格导入）；&lt;/li&gt;\n&lt;li&gt;mass_dataset准备（从mass_dataset类型数据导入）；&lt;/li&gt;\n&lt;/ol&gt;\n&lt;!--more--&gt;\n&lt;h2 id=\&#34;原始数据格式转换\&#34;&gt;原始数据格式转换&lt;/h2&gt;\n&lt;p&gt;这里以ThermoFisher的Q Exactive™ Plus产生的数据为例， LC-MS产生的原始数据为&lt;code&gt;.raw&lt;/code&gt;格式，需要通过&lt;a href=\&#34;https://proteowizard.sourceforge.io/download.html\&#34;&gt;ProteoWizard-MSCovert&lt;/a&gt;软件转换为包含&lt;code&gt;MS1&lt;/code&gt;信息的&lt;code&gt;mzXML&lt;/code&gt;格式和包含&lt;code&gt;MS2&lt;/code&gt;信息的&lt;code&gt;mgf&lt;/code&gt;格式。windows用户可以直接在界面软件按照下图进行格式转换：&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgoMSConvert.png\&#34; alt=\&#34;数据转换\&#34; loading=\&#34;lazy\&#34;&gt;, MSConvert图形化界面软件只可以在windows下运行，MacOS或者linux系统可以根据tidyMass project提供的基于docker的&lt;code&gt;massconverter&lt;/code&gt;的数据转换方式&lt;a href=\&#34;https://www.tidymass.org/docs/chapter3/2-data_convert/\&#34;&gt;Convert data using massconverter&lt;/a&gt;完成原始数据的转换，具体参数及设置参考以上连接。&lt;/p&gt;\n&lt;h2 id=\&#34;从原始数据输入\&#34;&gt;从原始数据输入&lt;/h2&gt;\n&lt;p&gt;前文提到MetMiner在数据导入时调用了&lt;code&gt;tidyMass project&lt;/code&gt;, tidyMass通过&lt;code&gt;xcms&lt;/code&gt;对原始数据进行&lt;code&gt;peak picking and grouping&lt;/code&gt;&lt;/p&gt;\n&lt;p&gt;我们这里了解下tidymass对原始数据进行格式转换的过程；&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;首先将LC-MS原始下机数据&lt;code&gt;.raw&lt;/code&gt;格式转换为开源的&lt;code&gt;.mzxml&lt;/code&gt;格式的文件，然后读取进来，然后通过&lt;code&gt;massprocesser::process_data()&lt;/code&gt;对原始数据进行&lt;code&gt;peak picking and grouping&lt;/code&gt;, 获得高可信的特征峰（features），这里定义为&lt;code&gt;variable&lt;/code&gt;;&lt;/li&gt;\n&lt;li&gt;这些&lt;code&gt;variable&lt;/code&gt;的一级质谱信息&lt;code&gt;m/z&lt;/code&gt;(质荷比)，&lt;code&gt;rt&lt;/code&gt;(保留时间)被记录在&lt;code&gt;variable_info&lt;/code&gt;表格中，而根据&lt;code&gt;m/z&lt;/code&gt; &lt;code&gt;rt&lt;/code&gt;, 这些variable被赋予了例如&lt;code&gt;M92T430_NEG&lt;/code&gt;的id，代表该代谢的质荷比为92, 保留时间为430，检出模式为负离子模式；&lt;/li&gt;\n&lt;li&gt;此外，根据提峰结果，从不同样本中提取这些variable的峰面积值，这样就形成了一个不同样本中代谢物的积累矩阵，纵向为variable_id, 横向为样本的名称，这个代谢物积累矩阵被称为&lt;code&gt;expression data&lt;/code&gt;；&lt;/li&gt;\n&lt;li&gt;同时tidymass还会提供一个初始化的&lt;code&gt;sample_info&lt;/code&gt;，也就是样本信息表，默认的包含了4个主要（必要）的元素，样本名称&lt;code&gt;sample_id&lt;/code&gt;,&lt;code&gt;injection order&lt;/code&gt;,&lt;code&gt;class&lt;/code&gt;,&lt;code&gt;group&lt;/code&gt;; 这些在后续会详细说明；&lt;/li&gt;\n&lt;li&gt;接下来，通过&lt;code&gt;.mgf&lt;/code&gt;格式的文件将捕获到的&lt;code&gt;ms2 spectra&lt;/code&gt;信息读取进来，通过比对代谢物&lt;code&gt;m/z&lt;/code&gt;信息和&lt;code&gt;MS2 spectra&lt;/code&gt;中的&lt;code&gt;precursor ion&lt;/code&gt;信息以及&lt;code&gt;rt&lt;/code&gt;信息，通过一定的阈值进行过滤筛选，最终给第一步提峰结果获得的&lt;code&gt;variables&lt;/code&gt;填匹配的&lt;code&gt;MS2&lt;/code&gt;信息;&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;下面是一个feature的MS2信息，&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;BEGIN IONS\nTITLE=QC_01.500.500. ## 该feature的ID\nRTINSECONDS=60.242274 ## 保留时间（秒）\nPEPMASS=146.044738769531 113043348.585899993777  ##（precursor 质荷比 | Intensity）\n51.51658919 2715.7590332031  ## 以下为碎裂片段的质荷比和Intensity\n57.03285633 7999.3442382813\n59.0122181 7026.62109375\n61.98706248 182087.59375\n70.4917399 4920.7504882813\n71.01212618 3894.3942871094\n74.02344975 9476.15234375\n82.02797575 2661.8305664063\n84.04428931 7634.880859375\n85.02770882 14845.5263671875\n87.00760154 13859.4775390625\n98.02348564 4059.72265625\n102.0547299 323569.375\n103.0582669 9390.1201171875\n128.0340961 135462.1875\n129.0372687 9628.765625\n146.0448944 58732.953125\n146.6037865 2932.517578125\n147.0289467 7400.3515625\n155.2126706 2777.9907226563\n160.1064809 2709.7451171875\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;在上集中我们准备好metadata, 组织好数据结构，设置好工作路径后准备将原始数据导入MetMiner，如下图：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;选则MS1和MS2文件路径；&lt;/li&gt;\n&lt;li&gt;点击&lt;code&gt;Check input file&lt;/code&gt;;&lt;/li&gt;\n&lt;li&gt;在MS file check页面检查输入文件统计和列表，看是否有遗漏或者错误文件，对应修改，比如有文件名不符合我们上篇提到的不符合命名规则以及和sample_info表格中不一致的，要做到统一；&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407131037694.png\&#34; alt=\&#34;输入文件检查\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;hr&gt;\n&lt;ul&gt;\n&lt;li&gt;点击&lt;code&gt;Peak picking&lt;/code&gt;页面，在parameter setting下面的&lt;code&gt;Show | Hide&lt;/code&gt;, 在左边可以弹出提峰参数选择的选项卡，进行提峰参数选择，如果对参数不熟悉，可以点击&lt;code&gt;Show | Hide&lt;/code&gt;下面的连接到&lt;code&gt;XCMS&lt;/code&gt;和&lt;code&gt;tidyMass&lt;/code&gt;网站了解具体参数意义，根据实际情况进行参数选择；&lt;/li&gt;\n&lt;li&gt;运行过程中在右下方会有一个progress bar，提醒提峰运行步骤，运行完毕，下面会有提峰结果自动保存路径和参数记录；&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407131052692.png\&#34; alt=\&#34;开始提峰\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;hr&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-r\&#34;&gt;-------------------- \nmassdataset version: 1.0.29 \n-------------------- \n1.expression_data:[ 4132 x 10 data.frame]\n2.sample_info:[ 10 x 4 data.frame]\n10 samples:QC_01 QC_02 QC_03 ... S_03 S_04\n3.variable_info:[ 4132 x 3 data.frame]\n4132 variables:M70T62_POS M70T72_POS M70T921_POS ... M1031T354_POS M1031T353_POS\n4.sample_info_note:[ 4 x 2 data.frame]\n5.variable_info_note:[ 3 x 2 data.frame]\n6.ms2_data:[ 1322 variables x 1207 MS2 spectra]\n-------------------- \nProcessing information\n3 processings in total\ncreate_mass_dataset ---------- \n      Package         Function.used                Time\n1 massdataset create_mass_dataset() 2024-07-13 10:51:07\nprocess_data ---------- \n        Package Function.used                Time\n1 massprocesser  process_data 2024-07-13 10:49:36\nmutate_ms2 ---------- \n      Package Function.used                Time\n1 massdataset  mutate_ms2() 2024-07-13 10:52:39\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;在完成从原始数据导入后，我们可以在mass_dataset information界面查看到目前质谱数据的状态。这里也直接显示了提峰结果，例如在正离子模式下，&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;code&gt;expression_data&lt;/code&gt;: 表达量表格，我们获得了4132个代谢物，共有10个sample(包括QC样本)；&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;sample_info&lt;/code&gt;: 样本信息，包含了10个样本，共有4列信息，包含了&lt;br&gt;\na. &lt;code&gt;sample_id&lt;/code&gt; 样本id;&lt;br&gt;\nb. &lt;code&gt;injection.order&lt;/code&gt; 上样顺序；&lt;br&gt;\nc. &lt;code&gt;class&lt;/code&gt; 样本分类，分为&lt;code&gt;QC&lt;/code&gt;和&lt;code&gt;Subject&lt;/code&gt;,说明样本属性，QC代表QC样本，Subject代表测试样本；&lt;br&gt;\nd. &lt;code&gt;group&lt;/code&gt; 样本分组，和前一篇文章提到的一样，这里代表样本的分组，比如case， control，该信息比较重要，是后续噪音去除，PCA，差异分析等的重要依赖信息。&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;variable_info&lt;/code&gt; 代谢物信息表, 包含4132个代谢物和3列信息：&lt;br&gt;\na. &lt;code&gt;variable_id&lt;/code&gt; 代谢物id，一般是MxxxTxxx，就是该代谢物的m/z+rt;&lt;br&gt;\nb. &lt;code&gt;m/z&lt;/code&gt; 质荷比，单位为道尔顿;&lt;br&gt;\nc. &lt;code&gt;rt&lt;/code&gt; 保留时间，单位为秒&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;sample_info_note&lt;/code&gt; 就是介绍&lt;code&gt;sample_info&lt;/code&gt;表格中每列的含义；&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;variable_info_note&lt;/code&gt; 同样，介绍&lt;code&gt;variable_info&lt;/code&gt;表格中每列的含义；&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;ms2_data&lt;/code&gt; 代谢物的ms2信息存储，只有通过&lt;code&gt;mutate_ms2()&lt;/code&gt;将&lt;code&gt;peak picking and grouping&lt;/code&gt;得到的feature和从&lt;code&gt;.mgf&lt;/code&gt;文件中得到的&lt;code&gt;ms2 spectra&lt;/code&gt;进行匹配，只有质荷比和保留时间均符合我们设定的tolerance时，才会匹配成功；&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&#34;从原提峰表格导入\&#34;&gt;从原提峰表格导入&lt;/h2&gt;\n&lt;p&gt;有时候，我们也会从一些经典的提峰软件，比如&lt;code&gt;xcms&lt;/code&gt;,&lt;code&gt;CD&lt;/code&gt;,&lt;code&gt;mzmine&lt;/code&gt;,&lt;code&gt;MS-DIAL&lt;/code&gt;等软件获得代谢物积累矩阵表格，那么，我们也可以从提峰表格导入&lt;code&gt;metMiner&lt;/code&gt;进行下游分析，这里我们需要从这些提峰软件导出提峰结果中的variable_info 和 expression data两个表格，然后合并成一个表格。如下图：&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202403201018539.png\&#34; alt=\&#34;peak picking table\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n&lt;code&gt;metMiner&lt;/code&gt;要求将正负谱检出结果合并到一个表格中，除了&lt;code&gt;variable_id&lt;/code&gt;,&lt;code&gt;mz&lt;/code&gt;,&lt;code&gt;rt&lt;/code&gt;外，还需要加入&lt;code&gt;ion&lt;/code&gt;,这里可以是&lt;code&gt;+ -&lt;/code&gt;,也可以是&lt;code&gt;pos neg&lt;/code&gt;,或者&lt;code&gt;positive negative&lt;/code&gt;，软件会自动判断；同时，还需要将原始数据转换过的&lt;code&gt;.mgf&lt;/code&gt;文件也准备好，后续同样会进行匹配；&lt;/p&gt;\n&lt;p&gt;整个数据导入过程如下图：&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;1\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407261551466.png\&#34; alt=\&#34;从提峰表格导入\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;同样，我们设置了&lt;code&gt;variable_info&lt;/code&gt; 表格审查，如果你上传的表格中&lt;code&gt;variable_id&lt;/code&gt;,&lt;code&gt;mz&lt;/code&gt;,&lt;code&gt;rt&lt;/code&gt;,&lt;code&gt;ion&lt;/code&gt;的列名或者顺序和&lt;code&gt;demo&lt;/code&gt;中不一致，需要在这里对应的调整；确保无误，同时上传了&lt;code&gt;MS2&lt;/code&gt;文件路径后点击&lt;code&gt;1. Input file summary&lt;/code&gt;后，会弹出数据核对信息⑤，variable_info⑥以及Accumulation profile⑦，确保这些信息都无误后，点击&lt;code&gt;2.Generate massdataset object&lt;/code&gt;来将质谱数据格式转换为&lt;code&gt;mass_dataset&lt;/code&gt; class，此时右下角会出现进度条，这时主要是进行&lt;code&gt;MS2 spectra&lt;/code&gt;的匹配; 完成后在&lt;code&gt;Mass_dataset information&lt;/code&gt;选项卡中查看mass_dataset打印的信息。&lt;/p&gt;\n&lt;h2 id=\&#34;从mass_dataset导入\&#34;&gt;从mass_dataset导入&lt;/h2&gt;\n&lt;p&gt;&lt;code&gt;Tidymass project&lt;/code&gt;最大的优点就是质谱数据处理的&lt;strong&gt;可重复性、透明性、可追溯性&lt;/strong&gt;，前面我们通过&lt;code&gt;mass_dataset&lt;/code&gt; class的内容就可以体会到&lt;code&gt;透明性、可追溯性&lt;/code&gt;，这里从mass_dataset导入也是&lt;code&gt;MetMiner&lt;/code&gt;实现可重复性的一种手段。在协作，或者重复已发表数据时，质谱数据已经经过依赖于&lt;code&gt;tidymass&lt;/code&gt;的流程处理获得了&lt;code&gt;mass_dataset&lt;/code&gt; class类型的质谱数据，我们可以直接加载前人分析的结果重新分析，或者继续下游分析，整个数据导入过程更加简单，只需要获得从R中导入的mass_dataset对象即可，这里我们一般会通过例如&lt;code&gt;save(object_neg, &amp;quot;object_neg.rda&amp;quot;)&lt;/code&gt;将数据保存为&lt;code&gt;.rda&lt;/code&gt;格式，整个操作过程如下图。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202407131740385.png\&#34; alt=\&#34;从mass_dataset导入\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;这里需要提醒的是，如果ms2信息在之前的分析中没有添加，才需要再这里上传&lt;code&gt;.mgf&lt;/code&gt;文件，如果已经包含，则不需要再次上传；&lt;/p&gt;\n&lt;p&gt;---The end---&lt;br&gt;\nJul 26, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;metminer-data-import&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;MetMiner流程整合了mass_dataset数据输入格式，所以具有灵活多变的数据输入模式，本文介绍了通过metMiner进行代谢组数据分析前的数据准备及项目初始化工作。&lt;/p&gt;\n&lt;p&gt;主要从一下几方面说明：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;原始数据格式转换和文件结构（从原始数据导入）；&lt;/li&gt;\n&lt;li&gt;提峰表格准备（从其它软件提峰表格导入）；&lt;/li&gt;\n&lt;li&gt;mass_dataset准备（从mass_dataset类型数据导入）；&lt;/li&gt;\n&lt;/ol&gt;\n&#34;,&#34;title&#34;:&#34;「MetMiner」数据导入&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;MetMiner&#34;,&#34;slug&#34;:&#34;L39wxwPVS&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/L39wxwPVS/&#34;},{&#34;name&#34;:&#34;metabolomics&#34;,&#34;slug&#34;:&#34;pj9WiqYdce&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/pj9WiqYdce/&#34;},{&#34;name&#34;:&#34;Shiny app&#34;,&#34;slug&#34;:&#34;iiHZST6a6&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/iiHZST6a6/&#34;},{&#34;name&#34;:&#34;TBtools插件&#34;,&#34;slug&#34;:&#34;e996CuUk8&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/e996CuUk8/&#34;}],&#34;date&#34;:&#34;2024-06-24 08:47:17&#34;,&#34;dateFormat&#34;:&#34;2024-06-24&#34;,&#34;feature&#34;:&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgoFig1.StructureAndStrategy.webp&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/metminer-data-import/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;9 min read&#34;,&#34;time&#34;:496000,&#34;words&#34;:2115,&#34;minutes&#34;:9},&#34;description&#34;:&#34;MetMiner流程整合了mass_dataset数据输入格式，所以具有灵活多变的数据输入模式，本文介绍了通过metMiner进行代谢组数据分析前的数据准备及项目初始化工作。\n主要从一下几方面说明：\n\n原始数据格式转换和文件结构（从原始数据...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2\&#34;&gt;原始数据格式转换&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%BB%8E%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5\&#34;&gt;从原始数据输入&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%BB%8E%E5%8E%9F%E6%8F%90%E5%B3%B0%E8%A1%A8%E6%A0%BC%E5%AF%BC%E5%85%A5\&#34;&gt;从原提峰表格导入&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%BB%8Emass_dataset%E5%AF%BC%E5%85%A5\&#34;&gt;从mass_dataset导入&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;MetMiner流程整合了mass_dataset数据输入格式，所以具有灵活多变的数据输入模式，本文介绍了通过metMiner进行代谢组数据分析前的数据准备及项目初始化工作。&lt;/p&gt;\n&lt;p&gt;主要从一下几方面说明：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;Metadata准备（实验数据管理及样本命名规则）；&lt;/li&gt;\n&lt;li&gt;原始数据格式转换和文件结构（从原始数据导入）；&lt;/li&gt;\n&lt;li&gt;提峰表格准备（从其它软件提峰表格导入）；&lt;/li&gt;\n&lt;li&gt;mass_dataset准备（从mass_dataset类型数据导入）；&lt;/li&gt;\n&lt;/ol&gt;\n&lt;!--more--&gt;\n&lt;h1 id=\&#34;1-实验数据准备和样本命名规则\&#34;&gt;1. 实验数据准备和样本命名规则&lt;/h1&gt;\n&lt;p&gt;为了对接&lt;code&gt;MetMiner&lt;/code&gt;分析流程，在实验时候需要严格遵守样本命名规则，这样后续的分析流程才会顺畅，不容易报错。&lt;/p&gt;\n&lt;p&gt;原因是在数据处理时，样本名称有时候会被当做&lt;code&gt;row names &lt;/code&gt;或者 &lt;code&gt;column names&lt;/code&gt;，在用bash脚本或者R语言处理文件时，一些特殊符号会造成报错，而我们又不可能耗费巨大的经理去写海量的判断语句来甄别这些错误，所以我们在数据分析流程端采用特定的命名规则，通过&lt;code&gt;meta data&lt;/code&gt;来规范样本名称。&lt;/p&gt;\n&lt;p&gt;规范化的元数据记录可以帮助我们更好的管理数据。&lt;/p&gt;\n&lt;h2 id=\&#34;11-准备元数据meta-data\&#34;&gt;1.1 准备元数据（meta data）&lt;/h2&gt;\n&lt;p&gt;元数据表格一般包含以下内容&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;原始样本名称(sample name raw)&lt;/strong&gt;: 这个是实验前期对于采样样本的原始命名，例如&lt;code&gt;col0-leaf-1 max2-leaf-1&lt;/code&gt;，这个按照自己的理解以及一定的命名规则对各个样本进行标记，这里不做要求，但尽量避免用中文，因为可能有些机器在处理中文字符时可能出现乱码；&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;样本类型(class)&lt;/strong&gt;: QC样本标记为大写的**&lt;code&gt;QC&lt;/code&gt;&lt;strong&gt;，测试样本标记为&lt;/strong&gt;&lt;code&gt;Subject&lt;/code&gt;**，S大写；&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;规范样本id(sample_id)&lt;/strong&gt;：这个id是我们在数据处理时对样本的编码，需要遵循以下规则：\n&lt;ul&gt;\n&lt;li&gt;对于QC（quality control）样本，以大写的**&lt;code&gt;&amp;quot;QC_&amp;quot;&lt;/code&gt;**开头，&lt;/li&gt;\n&lt;li&gt;对于测试（Subject）样本，以大写的**&lt;code&gt;&amp;quot;S_&amp;quot;&lt;/code&gt;**开头，&lt;/li&gt;\n&lt;li&gt;数字编号补齐：&lt;code&gt;QC_&lt;/code&gt;或者&lt;code&gt;S_ &lt;/code&gt;后面接序号，根据QC样本的数量增加&lt;code&gt;pad 0&lt;/code&gt;，意思是如果QC的数量为两位数，那么在QC 1-9的命名需要再1-9前面添加一个0即：&lt;code&gt;QC_01&lt;/code&gt;, &lt;code&gt;QC_02&lt;/code&gt;, &lt;code&gt;QC_03&lt;/code&gt; ...， 同样如果QC样本的数量为3位数，需要在1-9前面加两个&lt;code&gt;0&lt;/code&gt;，在10-99前面加一个&lt;code&gt;0&lt;/code&gt; ，即&lt;code&gt;QC_001&lt;/code&gt;， &lt;code&gt;QC_002&lt;/code&gt;， &lt;code&gt;QC_003&lt;/code&gt;， ... &lt;code&gt;QC_010&lt;/code&gt;。原因是&lt;code&gt;QC_xx&lt;/code&gt; 在excel以及R时字符型数据，在排序时，会根据第一个检测到的数字进行排序，如果不进行补零填充，那么对QC序列进行排序时顺序会变为&lt;code&gt;QC_1&lt;/code&gt;, &lt;code&gt;QC_10&lt;/code&gt;, &lt;code&gt;QC_100&lt;/code&gt; &lt;code&gt;QC_1000&lt;/code&gt;,&lt;code&gt;QC_1001&lt;/code&gt; ,在后续可视化或者分析过程中可能会出错；同样对于Subject样本编号方式也是如此。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;样本分组(group)&lt;/strong&gt;：样本所属的组别，对于设置了生物学重复的样本，需要表明每个样本所属的组别，比如&lt;code&gt;case&lt;/code&gt;， &lt;code&gt;control&lt;/code&gt;，&lt;code&gt;treat&lt;/code&gt;，&lt;code&gt;mock&lt;/code&gt;；&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;进样顺序(injection.order)&lt;/strong&gt;: 根据样本实际上样顺序标记，这里为纯数字形式；&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;其它信息&lt;/strong&gt;：如果对样本包含的变量非常丰富，可以依次增加信息，比如 &lt;code&gt;tissue&lt;/code&gt;， &lt;code&gt;treat&lt;/code&gt;， &lt;code&gt;day&lt;/code&gt;， &lt;code&gt;gender&lt;/code&gt;，&lt;code&gt;species&lt;/code&gt; 这些信息的加入，在数据清洗及数据挖掘步骤，可以通过选择这些属性来专注这些单一变量带来的代谢水平差异。对于QC样本这里可以不标注，空着即可，也可以标注为QC。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h1 id=\&#34;2-数据准备\&#34;&gt;2. 数据准备&lt;/h1&gt;\n&lt;p&gt;首先介绍从LC-MS下机数据开始处理。&lt;/p&gt;\n&lt;h2 id=\&#34;21-选项1-原始数据格式转换\&#34;&gt;2.1 选项1 - 原始数据格式转换&lt;/h2&gt;\n&lt;p&gt;获得LC-MS下机数据后，需要将原始数据转换为&lt;code&gt;.mzxml&lt;/code&gt;以及&lt;code&gt;.mgf&lt;/code&gt;格式，以Thermo QE Plus下机数据为例，获得&lt;code&gt;.raw&lt;/code&gt;文件后通过&lt;a href=\&#34;https://proteowizard.sourceforge.io/download.html\&#34;&gt;proteowizard&lt;/a&gt;提供的msConvert进行转换。整体数据格式转换过程可以参考TidyMass提供的教程：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;https://www.tidymass.org/docs/chapter3/1-proteowizard/\&#34;&gt;数据转换方法-proteowizard&lt;/a&gt;；&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;https://www.tidymass.org/docs/chapter3/2-data_convert/\&#34;&gt;数据转换方法-massconverter&lt;/a&gt;;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;&lt;em&gt;对于DIA采集的数据可能需要其它的软件导出.mgf文件，例如waters MSe需要通过UNIFI软件导出&lt;/em&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;22-原始数据文件路径结构\&#34;&gt;2.2 原始数据文件路径结构&lt;/h2&gt;\n&lt;p&gt;我们在 1.0 的部分建议的命名规则对数据进行整理，然后按照下图整理文件，文件夹的名字也必须和图片中一致。&lt;br&gt;\n&lt;strong&gt;MS1 文件结构&lt;/strong&gt;  MS1/MS2文件夹下分NEG和POS两个子文件夹，而后分别将QC和Subject的&lt;code&gt;.mzxml&lt;/code&gt;或者&lt;code&gt;.mgf&lt;/code&gt;格式的文件放到对应的文件夹下。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;MS1\n├── NEG\n│   ├── QC\n│   └── Subject\n└── POS\n    ├── QC\n    └── Subject\n&lt;/code&gt;&lt;/pre&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;MS2\n├── NEG\n│   ├── QC\n│   └── Subject\n└── POS\n    ├── QC\n    └── Subject\n&lt;/code&gt;&lt;/pre&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;1\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgoFigure01.png\&#34; alt=\&#34;文件结构\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;h2 id=\&#34;23-选项2-原始提峰表格\&#34;&gt;2.3  选项2 原始提峰表格&lt;/h2&gt;\n&lt;p&gt;当我们从其它提峰软件获得提峰表格后，将feature的MS1信息以及提峰表格信息整理成下表,&lt;br&gt;\n其中前4列为&lt;code&gt;variable information&lt;/code&gt; 尽量保证列名和图中一致，代谢物id，质荷比，保留时间，离子模式。后面为QC和样本中峰面积。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202403201018539.png\&#34; alt=\&#34;peak picking table\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;24-选项3-mass_dataset-object\&#34;&gt;2.4 选项3 mass_dataset object&lt;/h2&gt;\n&lt;p&gt;我们用TidyMass软件处理过数据后如果想重新分析，通过&lt;code&gt;save()&lt;/code&gt;将&lt;code&gt;mass_dataset&lt;/code&gt;数据保存为&lt;code&gt;.rda&lt;/code&gt;后缀的文件。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202406221746740.png\&#34; alt=\&#34;mass dataset\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;25-样品信息表-必须\&#34;&gt;2.5 样品信息表 (必须)&lt;/h2&gt;\n&lt;p&gt;基本和metadata中的信息一致 ，但是要注意添加了&lt;code&gt;injection.order&lt;/code&gt;和&lt;code&gt;batch&lt;/code&gt;两个信息, 这两个信息在数据清洗时用来校正系统误差。如果不确定是否存在批次效应，&lt;code&gt;batch&lt;/code&gt;可以全部填1，后续如果检查出批次效应，在回来校正该数据。&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;2\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo20240319180805.png\&#34; alt=\&#34;sample information\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;h1 id=\&#34;3-项目初始化\&#34;&gt;3. 项目初始化&lt;/h1&gt;\n&lt;p&gt;首先我们需要选择一个路径（文件夹）为项目的工作目录，最好将输入数据都放到该文件夹下，同时运行过程中需要保存的数据会自动保存到该路径下。&lt;/p&gt;\n&lt;p&gt;其次需要将样本信息表格上传，上传后在左侧&lt;code&gt;sidebar&lt;/code&gt;处会自动提取上传表格中的列名，如果顺序和软件默认顺序以及列名和默认列名不匹配，需要对前5列信息一一对应匹配，然后软件会校正统计表格；&lt;/p&gt;\n&lt;p&gt;确认好后点击&lt;code&gt;initialize project&lt;/code&gt;项目会初始化，&lt;code&gt;file check&lt;/code&gt;会返回工作目录的路径，sample information中包含的信息。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-yaml\&#34;&gt;File check\n----------------------\nThe working directory: /Volumes/ShawnWang/DemoHeter\nThe sample information: sample_id | injection.order | class | group | batch | tissue\nRestart your jobs from: Start from raw data.\nThe mass_dataset object:\nPositive file path: no old .rda file uploaded, skip this step\nNagetive file path: no old .rda file uploaded, skip this step\nAnnotation database: No need to upload this file, pass.\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;code&gt;Sample information&lt;/code&gt;部分会将初始化后的样品信息表格打印出来，详细检查下对应关系，确保没有问题，可以进行下一步。&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;3\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo202406221805830.png\&#34; alt=\&#34;项目初始化\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;---The end---&lt;br&gt;\nJun 22, 2024 by Shawn Wang, HENU, Kaifeng, Henan, China.&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;metminer-fei-ba-dai-xie-zu-shu-ju-zhun-bei-he-xiang-mu-chu-shi-hua&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;MetMiner流程整合了mass_dataset数据输入格式，所以具有灵活多变的数据输入模式，本文介绍了通过metMiner进行代谢组数据分析前的数据准备及项目初始化工作。&lt;/p&gt;\n&lt;p&gt;主要从一下几方面说明：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;Metadata准备（实验数据管理及样本命名规则）；&lt;/li&gt;\n&lt;li&gt;原始数据格式转换和文件结构（从原始数据导入）；&lt;/li&gt;\n&lt;li&gt;提峰表格准备（从其它软件提峰表格导入）；&lt;/li&gt;\n&lt;li&gt;mass_dataset准备（从mass_dataset类型数据导入）；&lt;/li&gt;\n&lt;/ol&gt;\n&#34;,&#34;title&#34;:&#34;「MetMiner」非靶代谢组数据准备和项目初始化&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;MetMiner&#34;,&#34;slug&#34;:&#34;L39wxwPVS&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/L39wxwPVS/&#34;},{&#34;name&#34;:&#34;metabolomics&#34;,&#34;slug&#34;:&#34;pj9WiqYdce&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/pj9WiqYdce/&#34;},{&#34;name&#34;:&#34;Shiny app&#34;,&#34;slug&#34;:&#34;iiHZST6a6&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/iiHZST6a6/&#34;}],&#34;date&#34;:&#34;2024-06-22 10:32:16&#34;,&#34;dateFormat&#34;:&#34;2024-06-22&#34;,&#34;feature&#34;:&#34;https://shawnwx2019.github.io/post-images/metminer-fei-ba-dai-xie-zu-shu-ju-zhun-bei-he-xiang-mu-chu-shi-hua.jpg&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/metminer-fei-ba-dai-xie-zu-shu-ju-zhun-bei-he-xiang-mu-chu-shi-hua/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:true,&#34;stats&#34;:{&#34;text&#34;:&#34;7 min read&#34;,&#34;time&#34;:380000,&#34;words&#34;:1692,&#34;minutes&#34;:7},&#34;description&#34;:&#34;MetMiner流程整合了mass_dataset数据输入格式，所以具有灵活多变的数据输入模式，本文介绍了通过metMiner进行代谢组数据分析前的数据准备及项目初始化工作。\n主要从一下几方面说明：\n\nMetadata准备（实验数据管理及样...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;&lt;a href=\&#34;#1-%E5%AE%9E%E9%AA%8C%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87%E5%92%8C%E6%A0%B7%E6%9C%AC%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%99\&#34;&gt;1. 实验数据准备和样本命名规则&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#11-%E5%87%86%E5%A4%87%E5%85%83%E6%95%B0%E6%8D%AEmeta-data\&#34;&gt;1.1 准备元数据（meta data）&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#2-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87\&#34;&gt;2. 数据准备&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#21-%E9%80%89%E9%A1%B91-%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2\&#34;&gt;2.1 选项1 - 原始数据格式转换&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#22-%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%E7%BB%93%E6%9E%84\&#34;&gt;2.2 原始数据文件路径结构&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#23-%E9%80%89%E9%A1%B92-%E5%8E%9F%E5%A7%8B%E6%8F%90%E5%B3%B0%E8%A1%A8%E6%A0%BC\&#34;&gt;2.3  选项2 原始提峰表格&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#24-%E9%80%89%E9%A1%B93-mass_dataset-object\&#34;&gt;2.4 选项3 mass_dataset object&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#25-%E6%A0%B7%E5%93%81%E4%BF%A1%E6%81%AF%E8%A1%A8-%E5%BF%85%E9%A1%BB\&#34;&gt;2.5 样品信息表 (必须)&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#3-%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96\&#34;&gt;3. 项目初始化&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;突然有个需求，然后花了差不多半个小时指挥GPT4干完了... 说实话，这效率也太快了，要是让我从头手打，估计要折腾一下午。&lt;/p&gt;\n&lt;p&gt;这篇博客就记录下如何和GPT打配合搞定ShinyApp，并且通过CLI program wapper creator工具将shinyapp制作成插件分享给大家。&lt;/p&gt;\n&lt;!--more--&gt;\n&lt;h1 id=\&#34;省流版本工具使用\&#34;&gt;省流版本（工具使用）&lt;/h1&gt;\n&lt;h2 id=\&#34;需求\&#34;&gt;需求&lt;/h2&gt;\n&lt;p&gt;在磕盐（ban zhuan）的过程中难免会遇到合并表格这种破事，比如你拿到了几百个基因，想去找他的注释，看表达量，当然可以通过vlookup等操作可以实现，但是遇到一对多的情况就比较捉🐔了，R语言的dplyr包提供了join系列函数来通过不同的方式连接两个表格，相当方便，博士期间为了搞定表格合并的问题整的人都快头秃了，所以我相信这一定会是一个重要的需求，不如通过shinyapp实现。简单的通过上传文件，选择连接方式，下载合并后的表格。&lt;/p&gt;\n&lt;h2 id=\&#34;连接方式解释\&#34;&gt;连接方式解释&lt;/h2&gt;\n&lt;p&gt;感觉文字是苍白的，&lt;a href=\&#34;https://www.garrickadenbuie.com/\&#34;&gt;Garrick Aden-Buie&lt;/a&gt; 大佬搞了个动态图来解释左连接（left join），右连接（right join），全连接（full join），半连接（semi join），内连接（inner join）和反连接（anti join）的解释，这个.... 再看不懂说不过去了吧....&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309190932854.gif\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;下载和使用\&#34;&gt;下载和使用&lt;/h2&gt;\n&lt;h3 id=\&#34;下载\&#34;&gt;下载&lt;/h3&gt;\n&lt;p&gt;目前还没登录TBtools插件商店，后续CJ会搞上去，安装方法就是在插件商店找到&lt;code&gt;File-Join ShinyApp&lt;/code&gt;插件，会定位到牛奶快传，下载安装。目前迫不及待想体验的可以去github下载，windows用户下载&lt;code&gt;FileJoin-win.plugin&lt;/code&gt;, intel mac用户下载&lt;code&gt;filejoin.plugin&lt;/code&gt;, arm mac用户再等等吧... 或者直接通过Rstudio启动。&lt;/p&gt;\n&lt;h3 id=\&#34;运行\&#34;&gt;运行&lt;/h3&gt;\n&lt;p&gt;使用很简单，运行插件弹出网页后，根据下图上传文件，设置参数直接会获得表格... 没啥门槛，上传表格后，程序会自动获得文件的列名，分别选择两个文件中用来查找的列名，然后选择合并方式进行合并，如果忘了，左侧选项卡还有对不同类型join的解释。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;Soure file demo&lt;/strong&gt;&lt;/p&gt;\n&lt;table&gt;\n&lt;thead&gt;\n&lt;tr&gt;\n&lt;th&gt;GeneID&lt;/th&gt;\n&lt;th&gt;Sample_01&lt;/th&gt;\n&lt;th&gt;Sample_02&lt;/th&gt;\n&lt;th&gt;Sample_03&lt;/th&gt;\n&lt;th&gt;Sample_04&lt;/th&gt;\n&lt;th&gt;Sample_05&lt;/th&gt;\n&lt;/tr&gt;\n&lt;/thead&gt;\n&lt;tbody&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_001&lt;/td&gt;\n&lt;td&gt;312&lt;/td&gt;\n&lt;td&gt;214&lt;/td&gt;\n&lt;td&gt;406&lt;/td&gt;\n&lt;td&gt;616&lt;/td&gt;\n&lt;td&gt;289&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_002&lt;/td&gt;\n&lt;td&gt;465&lt;/td&gt;\n&lt;td&gt;180&lt;/td&gt;\n&lt;td&gt;422&lt;/td&gt;\n&lt;td&gt;605&lt;/td&gt;\n&lt;td&gt;994&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_003&lt;/td&gt;\n&lt;td&gt;687&lt;/td&gt;\n&lt;td&gt;658&lt;/td&gt;\n&lt;td&gt;276&lt;/td&gt;\n&lt;td&gt;218&lt;/td&gt;\n&lt;td&gt;53&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_004&lt;/td&gt;\n&lt;td&gt;369&lt;/td&gt;\n&lt;td&gt;215&lt;/td&gt;\n&lt;td&gt;4&lt;/td&gt;\n&lt;td&gt;691&lt;/td&gt;\n&lt;td&gt;155&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_005&lt;/td&gt;\n&lt;td&gt;903&lt;/td&gt;\n&lt;td&gt;215&lt;/td&gt;\n&lt;td&gt;887&lt;/td&gt;\n&lt;td&gt;203&lt;/td&gt;\n&lt;td&gt;777&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_006&lt;/td&gt;\n&lt;td&gt;154&lt;/td&gt;\n&lt;td&gt;240&lt;/td&gt;\n&lt;td&gt;162&lt;/td&gt;\n&lt;td&gt;272&lt;/td&gt;\n&lt;td&gt;823&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_007&lt;/td&gt;\n&lt;td&gt;35&lt;/td&gt;\n&lt;td&gt;553&lt;/td&gt;\n&lt;td&gt;739&lt;/td&gt;\n&lt;td&gt;505&lt;/td&gt;\n&lt;td&gt;248&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_008&lt;/td&gt;\n&lt;td&gt;10&lt;/td&gt;\n&lt;td&gt;946&lt;/td&gt;\n&lt;td&gt;306&lt;/td&gt;\n&lt;td&gt;946&lt;/td&gt;\n&lt;td&gt;658&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_009&lt;/td&gt;\n&lt;td&gt;359&lt;/td&gt;\n&lt;td&gt;1&lt;/td&gt;\n&lt;td&gt;346&lt;/td&gt;\n&lt;td&gt;484&lt;/td&gt;\n&lt;td&gt;757&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_010&lt;/td&gt;\n&lt;td&gt;277&lt;/td&gt;\n&lt;td&gt;181&lt;/td&gt;\n&lt;td&gt;493&lt;/td&gt;\n&lt;td&gt;636&lt;/td&gt;\n&lt;td&gt;409&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_011&lt;/td&gt;\n&lt;td&gt;588&lt;/td&gt;\n&lt;td&gt;688&lt;/td&gt;\n&lt;td&gt;956&lt;/td&gt;\n&lt;td&gt;51&lt;/td&gt;\n&lt;td&gt;463&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_012&lt;/td&gt;\n&lt;td&gt;502&lt;/td&gt;\n&lt;td&gt;30&lt;/td&gt;\n&lt;td&gt;105&lt;/td&gt;\n&lt;td&gt;905&lt;/td&gt;\n&lt;td&gt;42&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_013&lt;/td&gt;\n&lt;td&gt;595&lt;/td&gt;\n&lt;td&gt;41&lt;/td&gt;\n&lt;td&gt;55&lt;/td&gt;\n&lt;td&gt;838&lt;/td&gt;\n&lt;td&gt;600&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_014&lt;/td&gt;\n&lt;td&gt;66&lt;/td&gt;\n&lt;td&gt;64&lt;/td&gt;\n&lt;td&gt;524&lt;/td&gt;\n&lt;td&gt;726&lt;/td&gt;\n&lt;td&gt;355&lt;/td&gt;\n&lt;/tr&gt;\n&lt;/tbody&gt;\n&lt;/table&gt;\n&lt;p&gt;&lt;strong&gt;Probe file demo&lt;/strong&gt;&lt;/p&gt;\n&lt;table&gt;\n&lt;thead&gt;\n&lt;tr&gt;\n&lt;th&gt;Probe&lt;/th&gt;\n&lt;th&gt;Type&lt;/th&gt;\n&lt;/tr&gt;\n&lt;/thead&gt;\n&lt;tbody&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_001&lt;/td&gt;\n&lt;td&gt;case&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_005&lt;/td&gt;\n&lt;td&gt;case&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_006&lt;/td&gt;\n&lt;td&gt;case&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_007&lt;/td&gt;\n&lt;td&gt;case&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_008&lt;/td&gt;\n&lt;td&gt;case&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_012&lt;/td&gt;\n&lt;td&gt;case&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_013&lt;/td&gt;\n&lt;td&gt;case&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_014&lt;/td&gt;\n&lt;td&gt;case&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_015&lt;/td&gt;\n&lt;td&gt;case&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_016&lt;/td&gt;\n&lt;td&gt;case&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_017&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_018&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_019&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_020&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_021&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_022&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_023&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_024&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_025&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_026&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_027&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_028&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_029&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;Gene_030&lt;/td&gt;\n&lt;td&gt;control&lt;/td&gt;\n&lt;/tr&gt;\n&lt;/tbody&gt;\n&lt;/table&gt;\n&lt;p&gt;&lt;strong&gt;start your job&lt;/strong&gt;&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;1\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309190947552.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;可以通过右侧预览合并结果。通过下载按钮下载合并文件，默认导出.csv格式。&lt;/p&gt;\n&lt;h1 id=\&#34;开发篇\&#34;&gt;开发篇&lt;/h1&gt;\n&lt;h2 id=\&#34;让gpt给你写shiny\&#34;&gt;让GPT给你写shiny&lt;/h2&gt;\n&lt;h3 id=\&#34;写初步框架\&#34;&gt;写初步框架&lt;/h3&gt;\n&lt;p&gt;有手就行有点夸张了，GPT虽然智能，但也很智障，灵活运用会提高干活的效率，所以这里有手就行的前提是你对shinyapp的开发已经有了一些了解。&lt;/p&gt;\n&lt;p&gt;比如在让这货写代码之前，脑子里已经有了UI大致的结构，所以我告诉他：&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;p&gt;写一个shiny插件，主要是用来做表格合并，数据导入用bruceR的import函数，需要两个输入数据框，输入文件大小控制在2GB，UI界面为一个tabPanel，sidesidebar中放置两个上传文件的组间，接着是两个selectInput，selectInput内容需要通过类似&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-r\&#34;&gt; observe({\n    updateSelectInput(session, &amp;quot;outlier&amp;quot;,choices = s_outlier())\n  })\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;根据输入文件的colname来提供选项，作用是在上传文件后自动获得文件的列名。&lt;br&gt;\n然后用户通过选择两个的列名，根据两个文件的这两列通过dplyr join系列函数进行合并，最后在mainPanel中通过renderDataTable预览结果，并且通过download下载。&lt;/p&gt;\n&lt;p&gt;它很快给出了整体的框架，但是运行后发现他造了个不存在的参数, 就是需求中让限制上传文件大小的代码正确的应该是&lt;br&gt;\n&lt;code&gt;options(shiny.maxRequestSize = 300*1024^2)&lt;/code&gt;&lt;br&gt;\n而&lt;code&gt; fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE, sizeLimit = 2*1024^3)&lt;/code&gt;中的 sizeLimit 参数并不存在。这需要修改下。 下面是它给的代码最终修改版本，也跳网页了，说明能用 就是丑了点。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-r\&#34;&gt;library(shiny)\nlibrary(DT)\nlibrary(bruceR)\nlibrary(dplyr)\noptions(shiny.maxRequestSize = 300*1024^2)\nui &amp;lt;- fluidPage(\n  tabsetPanel(\n    tabPanel(&amp;quot;数据合并&amp;quot;,\n             sidebarLayout(\n               sidebarPanel(\n                 # fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE, sizeLimit = 2*1024^3), ## sizeLimit参数不存在\n                 # fileInput(&amp;quot;file2&amp;quot;, &amp;quot;选择第二个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE, sizeLimit = 2*1024^3),\n                 fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),\n                 fileInput(&amp;quot;file2&amp;quot;, &amp;quot;选择第二个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),\n                 selectInput(&amp;quot;select1&amp;quot;, &amp;quot;选择第一个文件的列&amp;quot;, &amp;quot;&amp;quot;),\n                 selectInput(&amp;quot;select2&amp;quot;, &amp;quot;选择第二个文件的列&amp;quot;, &amp;quot;&amp;quot;)\n               ),\n               mainPanel(\n                 DTOutput(&amp;quot;table&amp;quot;),\n                 downloadButton(&amp;quot;downloadData&amp;quot;, &amp;quot;下载合并的数据&amp;quot;)\n               )\n             )\n    )\n  )\n)\n\nserver &amp;lt;- function(input, output, session) {\n  data1 &amp;lt;- reactive({\n    req(input$file1)\n    import(input$file1$datapath)\n  })\n  \n  data2 &amp;lt;- reactive({\n    req(input$file2)\n    import(input$file2$datapath)\n  })\n  \n  observe({\n    updateSelectInput(session, &amp;quot;select1&amp;quot;, choices = names(data1()))\n  })\n  \n  observe({\n    updateSelectInput(session, &amp;quot;select2&amp;quot;, choices = names(data2()))\n  })\n  \n  # merged_data &amp;lt;- reactive({\n  #   req(input$select1, input$select2)\n  #  left_join(data1(), data2(), by = c(input$select1 = input$select2))\n  #   \n  # })\n  merged_data &amp;lt;- reactive({\n    req(input$select1, input$select2)\n    left_join(data1(), data2(), by = setNames(input$select2, input$select1))\n  })\n\n  \n  output$table &amp;lt;- renderDT({\n    merged_data()\n  })\n  \n  output$downloadData &amp;lt;- downloadHandler(\n    filename = function() {\n      paste(&amp;quot;merged_data.csv&amp;quot;)\n    },\n    content = function(file) {\n      write.csv(merged_data(), file)\n    }\n  )\n}\n\nshinyApp(ui = ui, server = server)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;2\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309191004965.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;但是我们发现他没有理解我的意思，默认的只用了left join，所以我又让他加上其他类型的，然后在加上一个action button来执行。&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;p&gt;User 增加一个selectInput，合并方式，分为left ，right，inner，full，semi，默认为left，然后增加一个action button，参数设置好在显示表格。&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;p&gt;这次它没有出问题，添加了action button，而且在切换不同方法的时候聪明的使用了&lt;code&gt;switch&lt;/code&gt;函数。我也偷学了一招。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-r\&#34;&gt;library(shiny)\nlibrary(DT)\nlibrary(bruceR)\nlibrary(dplyr)\noptions(shiny.maxRequestSize = 300*1024^2)\n\nui &amp;lt;- fluidPage(\n  tabsetPanel(\n    tabPanel(&amp;quot;数据合并&amp;quot;,\n             sidebarLayout(\n               sidebarPanel(\n                 fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),\n                 fileInput(&amp;quot;file2&amp;quot;, &amp;quot;选择第二个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),\n                 selectInput(&amp;quot;select1&amp;quot;, &amp;quot;选择第一个文件的列&amp;quot;, &amp;quot;&amp;quot;),\n                 selectInput(&amp;quot;select2&amp;quot;, &amp;quot;选择第二个文件的列&amp;quot;, &amp;quot;&amp;quot;),\n                 selectInput(&amp;quot;joinType&amp;quot;, &amp;quot;选择合并方式&amp;quot;, choices = c(&amp;quot;left&amp;quot;, &amp;quot;right&amp;quot;, &amp;quot;inner&amp;quot;, &amp;quot;full&amp;quot;, &amp;quot;semi&amp;quot;), selected = &amp;quot;left&amp;quot;),\n                 actionButton(&amp;quot;mergeBtn&amp;quot;, &amp;quot;合并数据&amp;quot;)\n               ),\n               mainPanel(\n                 DTOutput(&amp;quot;table&amp;quot;),\n                 downloadButton(&amp;quot;downloadData&amp;quot;, &amp;quot;下载合并的数据&amp;quot;)\n               )\n             )\n    )\n  )\n)\n\nserver &amp;lt;- function(input, output, session) {\n  data1 &amp;lt;- reactive({\n    req(input$file1)\n    import(input$file1$datapath)\n  })\n  \n  data2 &amp;lt;- reactive({\n    req(input$file2)\n    import(input$file2$datapath)\n  })\n  \n  observe({\n    updateSelectInput(session, &amp;quot;select1&amp;quot;, choices = names(data1()))\n  })\n  \n  observe({\n    updateSelectInput(session, &amp;quot;select2&amp;quot;, choices = names(data2()))\n  })\n  \n  merged_data &amp;lt;- eventReactive(input$mergeBtn, {\n    req(input$select1, input$select2, input$joinType)\n    switch(input$joinType,\n           &amp;quot;left&amp;quot; = left_join(data1(), data2(), by = setNames(input$select2, input$select1)),\n           &amp;quot;right&amp;quot; = right_join(data1(), data2(), by = setNames(input$select2, input$select1)),\n           &amp;quot;inner&amp;quot; = inner_join(data1(), data2(), by = setNames(input$select2, input$select1)),\n           &amp;quot;full&amp;quot; = full_join(data1(), data2(), by = setNames(input$select2, input$select1)),\n           &amp;quot;semi&amp;quot; = semi_join(data1(), data2(), by = setNames(input$select2, input$select1))\n    )\n  })\n  \n  output$table &amp;lt;- renderDT({\n    req(merged_data())\n    merged_data()\n  })\n  \n  output$downloadData &amp;lt;- downloadHandler(\n    filename = function() {\n      paste(&amp;quot;merged_data.csv&amp;quot;)\n    },\n    content = function(file) {\n      write.csv(merged_data(), file)\n    }\n  )\n}\n\nshinyApp(ui = ui, server = server)\n\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;基本上没问题了，其实到这里就完全OK了，也好用，就是有点丑。所以我后续有加了一些要求&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;3\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309191010809.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;h3 id=\&#34;进阶美化\&#34;&gt;进阶美化&lt;/h3&gt;\n&lt;p&gt;首先我记得之前在学tidyverse的时候看到过join的动画，当时看了半天书没整明白一个gif图给我搞明白了，但是找不到了，就开了联网插件让他帮忙找了下，果然效率很高找到了大佬的github，然后就开始让&lt;br&gt;\n它搞定app终极形态。&lt;/p&gt;\n&lt;p&gt;首先让他将UI转换为dashboard。而且我手动的加上了依赖检测和安装的代码，并且添加了说明的链接。&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;p&gt;改下成shinydashboard风格，Gally中链接tidyexplain中对应的动画图片&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-r\&#34;&gt;# 检查依赖 --------------------------------------------------------------------\noptions(&amp;quot;repos&amp;quot; = c(CRAN=&amp;quot;https://mirrors.tuna.tsinghua.edu.cn/CRAN/&amp;quot;))\nif (!require(&amp;quot;DT&amp;quot;)) install.packages(&#39;DT&#39;);\nif (!require(&amp;quot;bruceR&amp;quot;)) install.packages(&#39;bruceR&#39;);\nif (!require(&amp;quot;shiny&amp;quot;)) install.packages(&#39;shiny&#39;);\nif (!require(&amp;quot;dplyr&amp;quot;)) install.packages(&#39;dplyr&#39;);\nif (!require(&amp;quot;shinydashboard&amp;quot;)) install.packages(&#39;shinydashboard&#39;);\nlibrary(shiny)\nlibrary(DT)\nlibrary(bruceR)\nlibrary(dplyr)\nlibrary(shinydashboard)\n\n# 设置输入文件大小限制 --------------------------------------------------------------\noptions(shiny.maxRequestSize = 300*1024^2)\n\n# 前端代码 --------------------------------------------------------------------\nui &amp;lt;- dashboardPage(\n  dashboardHeader(title = &amp;quot;数据合并工具&amp;quot;),\n  dashboardSidebar(\n    sidebarMenu(\n      menuItem(&amp;quot;数据合并&amp;quot;, tabName = &amp;quot;merge&amp;quot;, icon = icon(&amp;quot;database&amp;quot;))\n    )\n  ),\n  dashboardBody(\n    tabItems(\n      tabItem(tabName = &amp;quot;merge&amp;quot;,\n              fluidRow(\n                box(\n                  title = &amp;quot;文件上传与设置&amp;quot;,\n                  fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),\n                  fileInput(&amp;quot;file2&amp;quot;, &amp;quot;选择第二个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),\n                  selectInput(&amp;quot;select1&amp;quot;, &amp;quot;选择第一个文件的列&amp;quot;, &amp;quot;&amp;quot;),\n                  selectInput(&amp;quot;select2&amp;quot;, &amp;quot;选择第二个文件的列&amp;quot;, &amp;quot;&amp;quot;),\n                  selectInput(&amp;quot;joinType&amp;quot;, &amp;quot;选择合并方式&amp;quot;, choices = c(&amp;quot;left&amp;quot;, &amp;quot;right&amp;quot;, &amp;quot;inner&amp;quot;, &amp;quot;full&amp;quot;, &amp;quot;anti&amp;quot;), selected = &amp;quot;left&amp;quot;),\n                  actionButton(&amp;quot;mergeBtn&amp;quot;, &amp;quot;合并数据&amp;quot;)\n                ),\n                box(\n                  title = &amp;quot;合并结果&amp;quot;,\n                  dataTableOutput(&amp;quot;table&amp;quot;),\n                  htmlOutput(&amp;quot;linkDescription&amp;quot;),\n                  downloadButton(&amp;quot;downloadData&amp;quot;, &amp;quot;下载合并的数据&amp;quot;)\n                ),\n                box(\n                  title = &amp;quot;连接方式图解&amp;quot;,\n                  width = 12,\n                  tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/master/images/join-inner.gif&amp;quot;, width = &amp;quot;100%&amp;quot;)\n                )\n              )\n      )\n    )\n  )\n)\n\n# 后端代码 --------------------------------------------------------------------\nserver &amp;lt;- function(input, output, session) {\n  # ... [保持server部分代码不变]\n}\n\nshinyApp(ui = ui, server = server)\n\n&lt;/code&gt;&lt;/pre&gt;\n&lt;blockquote&gt;\n&lt;p&gt;这里的主要变化是：&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;blockquote&gt;\n&lt;p&gt;使用shinydashboard的dashboardPage, dashboardHeader, dashboardSidebar, 和 dashboardBody来创建一个dashboard风格的UI。&lt;br&gt;\n在Gallery部分，我链接了tidyexplain项目中的inner_join动画图片作为示例。您可以根据需要更改或添加其他图片。&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;blockquote&gt;\n&lt;p&gt;请确保您的Shiny应用程序目录中没有其他与这些动画图片同名的文件，否则可能会出现冲突。&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;4\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309191018733.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;和我想象中的不太一样，我想的是左边有两个选项卡，一个操作，一个帮助，而且图还挂了... 应该是连接搞错了。所以继续指挥：&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;p&gt;UI改下，shinydashboar中sidebarMenu中设置两个tag，一个为数据合并，另一个为合并方式说明，文件上传于设置的box宽度窄一些，大部分留给合并结果的box，链接方式图解制作成一个3*2的box，加入semi_join, 声明来源github地址。删除htmlOutput(&amp;quot;linkDescription&amp;quot;)相关信息&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;p&gt;这次没有啥问题了，除了最终我手动改了下连接和box的宽度,最终自动跳网页。完全成型了，达到了开始我脑补的效果，无论是从UI还是功能。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-r\&#34;&gt;# 检查依赖 --------------------------------------------------------------------\noptions(&amp;quot;repos&amp;quot; = c(CRAN=&amp;quot;https://mirrors.tuna.tsinghua.edu.cn/CRAN/&amp;quot;))\nif (!require(&amp;quot;DT&amp;quot;)) install.packages(&#39;DT&#39;);\nif (!require(&amp;quot;bruceR&amp;quot;)) install.packages(&#39;bruceR&#39;);\nif (!require(&amp;quot;shiny&amp;quot;)) install.packages(&#39;shiny&#39;);\nif (!require(&amp;quot;dplyr&amp;quot;)) install.packages(&#39;dplyr&#39;);\nif (!require(&amp;quot;shinydashboard&amp;quot;)) install.packages(&#39;shinydashboard&#39;);\nlibrary(shiny)\nlibrary(DT)\nlibrary(bruceR)\nlibrary(dplyr)\nlibrary(shinydashboard)\n\n# 设置输入文件大小限制 --------------------------------------------------------------\noptions(shiny.maxRequestSize = 300*1024^2)\n\n# 前端代码 --------------------------------------------------------------------\nui &amp;lt;- dashboardPage(\n  dashboardHeader(title = &amp;quot;数据合并工具&amp;quot;),\n  dashboardSidebar(\n    sidebarMenu(\n      menuItem(&amp;quot;数据合并&amp;quot;, tabName = &amp;quot;merge&amp;quot;, icon = icon(&amp;quot;database&amp;quot;)),\n      menuItem(&amp;quot;合并方式说明&amp;quot;, tabName = &amp;quot;explanation&amp;quot;, icon = icon(&amp;quot;info-circle&amp;quot;))\n    )\n  ),\n  dashboardBody(\n    tabItems(\n      tabItem(tabName = &amp;quot;merge&amp;quot;,\n              fluidRow(\n                box(title = &amp;quot;文件上传与设置&amp;quot;, width = 3,\n                    fileInput(&amp;quot;file1&amp;quot;, &amp;quot;选择第一个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),\n                    fileInput(&amp;quot;file2&amp;quot;, &amp;quot;选择第二个文件&amp;quot;, accept = c(&amp;quot;.csv&amp;quot;, &amp;quot;.txt&amp;quot;, &amp;quot;.xlsx&amp;quot;), multiple = FALSE),\n                    selectInput(&amp;quot;select1&amp;quot;, &amp;quot;选择第一个文件的列&amp;quot;, &amp;quot;&amp;quot;),\n                    selectInput(&amp;quot;select2&amp;quot;, &amp;quot;选择第二个文件的列&amp;quot;, &amp;quot;&amp;quot;),\n                    selectInput(&amp;quot;joinType&amp;quot;, &amp;quot;选择合并方式&amp;quot;, choices = c(&amp;quot;left&amp;quot;, &amp;quot;right&amp;quot;, &amp;quot;inner&amp;quot;, &amp;quot;full&amp;quot;, &amp;quot;anti&amp;quot;,&amp;quot;semi&amp;quot;), selected = &amp;quot;left&amp;quot;),\n                    actionButton(&amp;quot;mergeBtn&amp;quot;, &amp;quot;合并数据&amp;quot;)\n                ),\n                box(title = &amp;quot;合并结果&amp;quot;, width = 9,\n                    dataTableOutput(&amp;quot;table&amp;quot;),\n                    downloadButton(&amp;quot;downloadData&amp;quot;, &amp;quot;下载合并的数据&amp;quot;)\n                )\n              )\n      ),\n      tabItem(tabName = &amp;quot;explanation&amp;quot;,\n              fluidRow(\n                box(title = &amp;quot;连接方式图解&amp;quot;, width = 12,\n                    tags$div(tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/inner-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;),\n                             tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/left-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;),\n                             tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/right-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;)\n                    ),\n                    tags$div(tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/full-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;),\n                             tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/semi-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;),\n                             tags$img(src = &amp;quot;https://raw.githubusercontent.com/gadenbuie/tidyexplain/main/images/anti-join.gif&amp;quot;, width = &amp;quot;30%&amp;quot;)\n                    ),\n                    tags$div(style = &amp;quot;margin-top: 20px; text-align: center;&amp;quot;, \n                             &amp;quot;图片来源：&amp;quot;, tags$a(href = &amp;quot;https://github.com/gadenbuie/tidyexplain&amp;quot;, target = &amp;quot;_blank&amp;quot;, &amp;quot;tidyexplain GitHub项目&amp;quot;)\n                    )\n                )\n              )\n      )\n    )\n  )\n)\n\n\n\n# 后端代码 --------------------------------------------------------------------\nserver &amp;lt;- function(input, output, session) {\n  data1 &amp;lt;- reactive({\n    req(input$file1)\n    import(input$file1$datapath)\n  })\n  \n  data2 &amp;lt;- reactive({\n    req(input$file2)\n    import(input$file2$datapath)\n  })\n  \n  observe({\n    updateSelectInput(session, &amp;quot;select1&amp;quot;, choices = names(data1()))\n  })\n  \n  observe({\n    updateSelectInput(session, &amp;quot;select2&amp;quot;, choices = names(data2()))\n  })\n  \n  merged_data &amp;lt;- eventReactive(input$mergeBtn, {\n    req(input$select1, input$select2, input$joinType)\n    switch(input$joinType,\n           &amp;quot;left&amp;quot; = left_join(data1(), data2(), by = setNames(input$select2, input$select1)),\n           &amp;quot;right&amp;quot; = right_join(data1(), data2(), by = setNames(input$select2, input$select1)),\n           &amp;quot;inner&amp;quot; = inner_join(data1(), data2(), by = setNames(input$select2, input$select1)),\n           &amp;quot;full&amp;quot; = full_join(data1(), data2(), by = setNames(input$select2, input$select1)),\n           &amp;quot;anti&amp;quot; = anti_join(data1(), data2(), by = setNames(input$select2, input$select1)),\n           &amp;quot;semi&amp;quot; = semi_join(data1(), data2(), by = setNames(input$select2, input$select1))\n    )\n  })\n\n  \n  output$table &amp;lt;- renderDataTable({\n    req(merged_data())\n    merged_data()\n  })\n  \n  output$downloadData &amp;lt;- downloadHandler(\n    filename = function() {\n      paste(&amp;quot;merged_data.csv&amp;quot;)\n    },\n    content = function(file) {\n      write.csv(merged_data(), file = file,row.names = F)\n    }\n  )\n}\n\nshinyApp(ui = ui, server = server,options = list(launch.browser = TRUE))\n\n&lt;/code&gt;&lt;/pre&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;5\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309191032283.gif\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;h2 id=\&#34;tbtools-插件打包\&#34;&gt;TBtools 插件打包&lt;/h2&gt;\n&lt;p&gt;之前要搞个shiny插件，最头疼的就是依赖，最后都要麻烦CJ来搞定，CLI program wapper creator的出现直接把难度降低成了0。太xxx6了！！！ 根据下图... 直接搞定，然后就联系CJ分享你的ShinyApp吧！&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;6\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202309191027697.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&#34;,&#34;fileName&#34;:&#34;tbtools-plugin-you-shou-jiu-xing-rang-gpt4-gei-ni-xie-ge-shinyapp-shi-xian-wen-jian-he-bing&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;突然有个需求，然后花了差不多半个小时指挥GPT4干完了... 说实话，这效率也太快了，要是让我从头手打，估计要折腾一下午。&lt;/p&gt;\n&lt;p&gt;这篇博客就记录下如何和GPT打配合搞定ShinyApp，并且通过CLI program wapper creator工具将shinyapp制作成插件分享给大家。&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「TBtools Plugin」有手就行，让GPT4给你写个ShinyApp实现文件合并&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;TBtools plugin&#34;,&#34;slug&#34;:&#34;8rkPmYxtv_&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/8rkPmYxtv_/&#34;},{&#34;name&#34;:&#34;Shiny app&#34;,&#34;slug&#34;:&#34;iiHZST6a6&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/iiHZST6a6/&#34;},{&#34;name&#34;:&#34;TBtools&#34;,&#34;slug&#34;:&#34;7IQ4dQhrNC&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/7IQ4dQhrNC/&#34;},{&#34;name&#34;:&#34;插件&#34;,&#34;slug&#34;:&#34;fdXt7u8Hl5&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/fdXt7u8Hl5/&#34;}],&#34;date&#34;:&#34;2023-09-18 21:10:56&#34;,&#34;dateFormat&#34;:&#34;2023-09-18&#34;,&#34;feature&#34;:&#34;https://shawnwx2019.github.io/post-images/tbtools-plugin-you-shou-jiu-xing-rang-gpt4-gei-ni-xie-ge-shinyapp-shi-xian-wen-jian-he-bing.jpeg&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/tbtools-plugin-you-shou-jiu-xing-rang-gpt4-gei-ni-xie-ge-shinyapp-shi-xian-wen-jian-he-bing/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;17 min read&#34;,&#34;time&#34;:974000,&#34;words&#34;:3455,&#34;minutes&#34;:17},&#34;description&#34;:&#34;突然有个需求，然后花了差不多半个小时指挥GPT4干完了... 说实话，这效率也太快了，要是让我从头手打，估计要折腾一下午。\n这篇博客就记录下如何和GPT打配合搞定ShinyApp，并且通过CLI program wapper creator...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E7%9C%81%E6%B5%81%E7%89%88%E6%9C%AC%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8\&#34;&gt;省流版本（工具使用）&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E9%9C%80%E6%B1%82\&#34;&gt;需求&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BF%9E%E6%8E%A5%E6%96%B9%E5%BC%8F%E8%A7%A3%E9%87%8A\&#34;&gt;连接方式解释&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%B8%8B%E8%BD%BD%E5%92%8C%E4%BD%BF%E7%94%A8\&#34;&gt;下载和使用&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%B8%8B%E8%BD%BD\&#34;&gt;下载&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BF%90%E8%A1%8C\&#34;&gt;运行&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%BC%80%E5%8F%91%E7%AF%87\&#34;&gt;开发篇&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%AE%A9gpt%E7%BB%99%E4%BD%A0%E5%86%99shiny\&#34;&gt;让GPT给你写shiny&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%86%99%E5%88%9D%E6%AD%A5%E6%A1%86%E6%9E%B6\&#34;&gt;写初步框架&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BF%9B%E9%98%B6%E7%BE%8E%E5%8C%96\&#34;&gt;进阶美化&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#tbtools-%E6%8F%92%E4%BB%B6%E6%89%93%E5%8C%85\&#34;&gt;TBtools 插件打包&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;h1 id=\&#34;背景\&#34;&gt;背景&lt;/h1&gt;\n&lt;ul&gt;\n&lt;li&gt;参考基因组： &lt;a href=\&#34;https://download.maizegdb.org/B73_RefGen_v2/\&#34;&gt;玉米B73_v2,数据来源-MaizeGDB&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;基因注释文件：&lt;a href=\&#34;https://download.maizegdb.org/B73_RefGen_v2/ZmB73_5a.59_WGS.gff3.gz\&#34;&gt;ZmB73_5a.59_WGS.gff3.gz&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;数据源：本课题自测的20个玉米的40x重测序数据。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;!--more--&gt;\n&lt;h1 id=\&#34;软件安装\&#34;&gt;软件安装&lt;/h1&gt;\n&lt;p&gt;建议用conda新建环境安装，直接在其他环境下安装可能依赖会出问题。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;# 新建一个叫vep的环境并且安装ensembl-vep\nconda create -n vep -c bioconda ensembl-vep -y\n# 激活环境\nconda activate vep\n# 测试\n(vep) shawn@bio-Super-Server:~/02.project/01.maize_fatty_acid/04.result$ vep\n# 如果成功会出现下面的提示\nPossible precedence issue with control flow operator at /home/data/shawn/miniconda3/envs/vep/lib/site_perl/5.26.2/Bio/DB/IndexedBase.pm line 805.\n#----------------------------------#\n# ENSEMBL VARIANT EFFECT PREDICTOR #\n#----------------------------------#\n\nVersions:\n  ensembl              : 101.856c8e8\n  ensembl-funcgen      : 101.b918a49\n  ensembl-io           : 101.943b6c2\n  ensembl-variation    : 101.819eef2\n  ensembl-vep          : 101.0\n\nHelp: dev@ensembl.org , helpdesk@ensembl.org\nTwitter: @ensembl\n\nhttp://www.ensembl.org/info/docs/tools/vep/script/index.html\n\nUsage:\n./vep [--cache|--offline|--database] [arguments]\n\nBasic options\n=============\n\n--help                 Display this message and quit\n\n-i | --input_file      Input file\n-o | --output_file     Output file\n--force_overwrite      Force overwriting of output file\n--species [species]    Species to use [default: &amp;quot;human&amp;quot;]\n\n--everything           Shortcut switch to turn on commonly used options. See web\n                       documentation for details [default: off]\n--fork [num_forks]     Use forking to improve script runtime\n\nFor full option documentation see:\nhttp://www.ensembl.org/info/docs/tools/vep/script/vep_options.html\n&lt;/code&gt;&lt;/pre&gt;\n&lt;h1 id=\&#34;问题与解决方案\&#34;&gt;问题与解决方案&lt;/h1&gt;\n&lt;p&gt;根据本次流程的搭建解决下面问题：&lt;/p&gt;\n&lt;h2 id=\&#34;问题1-如果物种没有被官方收录怎么做\&#34;&gt;问题1 如果物种没有被官方收录怎么做&lt;/h2&gt;\n&lt;p&gt;参考链接：&lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_custom.html\&#34;&gt;vep custom annotation&lt;/a&gt;&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;p&gt;VEP can integrate custom annotation from standard format  files into your results by using the &lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_custom\&#34;&gt;--custom&lt;/a&gt; flag.&lt;/p&gt;\n&lt;p&gt;These files may be hosted locally or remotely, with no limit to the  number or size of the files. The files must be indexed using the &lt;a href=\&#34;http://samtools.sourceforge.net/tabix.shtml\&#34;&gt;tabix&lt;/a&gt;  utility (BED, GFF, GTF, VCF); bigWig files contain their own indices.&lt;/p&gt;\n&lt;p&gt;Annotations typically appear as key=value pairs in the Extra column of the VEP  output; they will also appear in the INFO column if using VCF format output.  The value for a particular annotation is defined as the identifier for each  feature; if not available, an identifier derived from the coordinates of the  annotation is used. Annotations will appear in each line of output for the  variant where multiple lines exist.&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;p&gt;通过增加&lt;code&gt;--custom&lt;/code&gt;标记来使用我们自己提供的注释文件，包括了&lt;code&gt;GFF,GTF,VCF,BED,BigWig&lt;/code&gt;等格式的文件。&lt;/p&gt;\n&lt;p&gt;本次使用&lt;code&gt;.gff&lt;/code&gt;文件作为注释文件，首先需要对&lt;code&gt;.gff&lt;/code&gt;文件清洗一下，包括去掉注释行，对染色体排序，将&lt;code&gt;.gff&lt;/code&gt;文件压缩成&lt;code&gt;bgzip&lt;/code&gt;格式，最后构建&lt;code&gt;tabix&lt;/code&gt;索引&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;p&gt;Custom annotation files must be prepared in a particular way in order to  work with tabix and therefore with VEP. Files must be stripped of comment lines,  sorted in chromosome and position order, compressed using bgzip  and finally indexed using tabix.&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;# myData.gff为原始的gff文件 数据清洗过程\ngrep -v &amp;quot;#&amp;quot; myData.gff | sort -k1,1 -k4,4n -k5,5n -t$&#39;\\t&#39; | bgzip -c &amp;gt; myData.gff.gz\n# 构建索引\ntabix -p gff myData.gff.gz\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;在使用的时候需要标清楚&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;./vep [...] --custom Filename , Short_name , File_type , Annotation_type , Force_report_coordinates , VCF_fields\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;这样你就可以使用多个注释文件同时对你的重测序结果进行注释了。&lt;/p&gt;\n&lt;p&gt;最终的使用方法, 官方的例子：&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;# Compressed VCF file\ncurl -O ftp://ftp.ncbi.nlm.nih.gov/pub/clinvar/vcf_GRCh38/clinvar.vcf.gz\n# Index file\ncurl -O ftp://ftp.ncbi.nlm.nih.gov/pub/clinvar/vcf_GRCh38/clinvar.vcf.gz.tbi\n\n/vep [...] --custom clinvar.vcf.gz,ClinVar,vcf,exact,0,CLNSIG,CLNREVSTAT,CLNDN\n\n## Where the selected ClinVar INFO fields (from the ClinVar VCF file) are:\n# - CLNSIG:     Clinical significance for this single variant\n# - CLNREVSTAT: ClinVar review status for the Variation ID\n# - CLNDN:      ClinVar&#39;s preferred disease name for the concept specified by disease identifiers in CLNDISDB\n# Of course you can select the INFO fields you want in the ClinVar VCF file\n\n# Quick example on GRCh38:\n./vep --id &amp;quot;1  230710048 230710048 A/G 1&amp;quot; --species homo_sapiens -o /path/to/output/output.txt --cache --offline --assembly GRCh38 --custom /path/to/custom_files/clinvar.vcf.gz,ClinVar,vcf,exact,0,CLNSIG,CLNREVSTAT,CLNDN\n\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;在使用转录本注释的&lt;code&gt;GFF&lt;/code&gt;时，如果搞不明白缓存&lt;code&gt;cache&lt;/code&gt;也可以不加，直接使用&lt;code&gt;--gff&lt;/code&gt;调用&lt;code&gt;gff&lt;/code&gt;文件也可以，也不需要使用&lt;code&gt;--custom&lt;/code&gt;来对&lt;code&gt;gff&lt;/code&gt;文件定义，例如：&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;p&gt;VEP can use transcript annotations defined in &lt;a href=\&#34;https://github.com/The-Sequence-Ontology/Specifications/blob/master/gff3.md\&#34;&gt;GFF&lt;/a&gt; or &lt;a href=\&#34;https://asia.ensembl.org/info/website/upload/gff.html\&#34;&gt;GTF&lt;/a&gt; files. The files must be bgzipped and indexed with tabix and a FASTA  file containing the genomic sequence is required in order to generate  transcript models.&lt;/p&gt;\n&lt;p&gt;Your GFF or GTF file must be sorted in chromosomal order. VEP does not use header lines so it is safe to remove them.&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;grep -v &amp;quot;#&amp;quot; data.gff | sort -k1,1 -k4,4n -k5,5n -t$&#39;\\t&#39; | bgzip -c &amp;gt; data.gff.gz\ntabix -p gff data.gff.gz\n# 直接进行注释，注意这里出来的结果为tab分割的.txt文件\n./vep -i input.vcf --gff data.gff.gz --fasta genome.fa.gz\n&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&#34;问题2-如何提高效率\&#34;&gt;问题2 如何提高效率&lt;/h2&gt;\n&lt;p&gt;参考链接：&lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_other.html#faster\&#34;&gt;Getting VEP to run faster&lt;/a&gt;&lt;/p&gt;\n&lt;p&gt;官方共提出了12点可以提高运行效率的方案，如果有精力可以都尝试一下，这里我采用了两个建议：&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;第一点：&lt;/strong&gt; 设置&lt;code&gt;--fork&lt;/code&gt; flag&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;p&gt;Using forking enables VEP to run multiple parallel &amp;quot;threads&amp;quot;, with each thread processing a subset of your input. Most modern computers have      more than one processor core, so running VEP with forking enabled can give huge speed increases (3-4x faster in most cases). Even computers with a  single core will see speed benefits due to overheads associated with using object-oriented code in Perl.&lt;/p&gt;\n&lt;p&gt;To use forking, you must choose a number of forks to use with the &lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_fork\&#34;&gt;--fork&lt;/a&gt; flag. We recommend using 4 forks:&lt;/p&gt;\n&lt;pre&gt;&lt;code&gt;./vep -i my_input.vcf --fork 4 --offline\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;but depending on various factors specific to your setup you may see faster performance with fewer or more forks.&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;p&gt;被这个&lt;code&gt;folk&lt;/code&gt; 整的有些懵逼，显然他不是线程数，而作者最后说由于设置不同，增加或者减少&lt;code&gt;forks&lt;/code&gt;的数量都有可能提速....&lt;/p&gt;\n&lt;p&gt;**第二点：**按染色体拆分&lt;code&gt;.vcf.gz&lt;/code&gt;，并行&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;p&gt;For very large files (for example those from whole-genome sequencing), VEP process can be easily parallelised by dividing your file into chunks      (e.g. by chromosome). VEP will also work with tabix-indexed, bgzipped  VCF files, and so the tabix utility could be used to divide the input file:&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;h2 id=\&#34;问题3-输出文件格式\&#34;&gt;问题3 输出文件格式&lt;/h2&gt;\n&lt;p&gt;参考链接：&lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#vcfout\&#34;&gt;Variant Effect Predictor&lt;img src=\&#34;data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==\&#34; alt=\&#34;img\&#34; loading=\&#34;lazy\&#34;&gt; Data formats&lt;/a&gt;&lt;/p&gt;\n&lt;p&gt;如果不指定的话默认tab输出，但是为了方便后续，我们希望直接把注释信息写入&lt;code&gt;vcf&lt;/code&gt;文件的&lt;code&gt;info&lt;/code&gt;部分。&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;p&gt;VEP can return the results in different formats:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#defaultout\&#34;&gt;Default VEP output&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#tab\&#34;&gt;Tab-delimited output&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#vcfout\&#34;&gt;VCF&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#json\&#34;&gt;JSON output&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;Along with the results VEP computes and returns some &lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/vep_formats.html#stats\&#34;&gt;statistics&lt;/a&gt;.&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;p&gt;这里统计了&lt;code&gt;VEP&lt;/code&gt;的输出格式，我们重点看下&lt;code&gt;vcf&lt;/code&gt;输出&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;h2 id=\&#34;vcf-output\&#34;&gt;VCF output&lt;/h2&gt;\n&lt;p&gt;The VEP script can also generate VCF output using the &lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_vcf\&#34;&gt;--vcf&lt;/a&gt; flag.&lt;/p&gt;\n&lt;p&gt;Main information about the specificity of the VEP VCF output format:&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;Consequences are added in the INFO field of the VCF file, using the key &amp;quot;&lt;strong&gt;CSQ&lt;/strong&gt;&amp;quot;           (you can change it using &lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_vcf_info_field\&#34;&gt;--vcf_info_field&lt;/a&gt;).&lt;/li&gt;\n&lt;li&gt;Data fields are encoded separated by the character &amp;quot;&lt;strong&gt;|&lt;/strong&gt;&amp;quot; (pipe). The order of fields is written in the VCF header.           Unpopulated fields are represented by an empty string.&lt;/li&gt;\n&lt;li&gt;Output fields in the &amp;quot;CSQ&amp;quot; INFO field can be configured by using &lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_fields\&#34;&gt;--fields&lt;/a&gt;.&lt;/li&gt;\n&lt;li&gt;Each prediction, for a given variant, is separated by the character &amp;quot;&lt;strong&gt;,&lt;/strong&gt;&amp;quot; in the CSQ INFO field (e.g. when a variant overlaps more than 1 transcript)&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;​    Here is a list of the (default) fields you can find within the CSQ field:&lt;/p&gt;\n&lt;pre&gt;&lt;code&gt;Allele|Consequence|IMPACT|SYMBOL|Gene|Feature_type|Feature|BIOTYPE|EXON|INTRON|HGVSc|HGVSp|cDNA_position|CDS_position|Protein_position|Amino_acids|Codons|Existing_variation|DISTANCE|STRAND|FLAGS|SYMBOL_SOURCE|HGNC_ID\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;Some fields are not reported by default and need configuring including HGVS, Symbol and Existing_variation.&lt;/p&gt;\n&lt;p&gt;Example of VEP command using the &lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_vcf\&#34;&gt;--vcf&lt;/a&gt; and &lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_options.html#opt_fields\&#34;&gt;--fields&lt;/a&gt; options:&lt;/p&gt;\n&lt;pre&gt;&lt;code&gt;./vep -i examples/homo_sapiens_GRCh38.vcf --cache --force_overwrite --vcf --fields &amp;quot;Allele,Consequence,Feature_type,Feature&amp;quot;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;VCFs produced by VEP can be filtered by &lt;a href=\&#34;https://asia.ensembl.org/info/docs/tools/vep/script/vep_filter.html\&#34;&gt;filter_vep.pl&lt;/a&gt; in the same way as standard format    output files.&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;p&gt;简单来说就是在最后加上&lt;code&gt;--vcf&lt;/code&gt;的flag，可以用&lt;code&gt;--fields&lt;/code&gt; 来控制&lt;code&gt;INFO&lt;/code&gt;部分&lt;code&gt;CSQ&lt;/code&gt;的格式，如果不想麻烦，就直接加一个&lt;code&gt;--vcf&lt;/code&gt;的flag就可以了。最后通过&lt;code&gt;-o&lt;/code&gt;参数自定义输出&lt;code&gt;vcf&lt;/code&gt;的文件名通过&lt;code&gt;--sf&lt;/code&gt;自定义输出&lt;code&gt;html&lt;/code&gt;统计结果的文件名。&lt;/p&gt;\n&lt;h1 id=\&#34;实战代码\&#34;&gt;实战代码&lt;/h1&gt;\n&lt;p&gt;看下工作目录的结构：&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;(vep) shawn@bio-Super-Server:~/working_dir/04.result$ tree\n.\n├── B73_RefGen_v2.fa -&amp;gt; /home/data/public/01.database/01.Database/01.genome_db/01.maize/03.B73_v2/B73_RefGen_v2.fa # B73_v2的参考基因组 \n├── ZmB73_5a.59_WGS.gff3 -&amp;gt; /home/data/public/01.database/01.Database/01.genome_db/01.maize/03.B73_v2/ZmB73_5a.59_WGS.gff3 # MaizeGDB下载B73_v2的gff3注释文件\n├── snp.all.filter.vcf.gz -&amp;gt; ../03.process/01.bamfile/vcf/snp.all.filter.vcf.gz # gatk call snp的结果\n├── snp.all.filter.vcf.gz.tbi -&amp;gt; ../03.process/01.bamfile/vcf/snp.all.filter.vcf.gz.tbi # tabix 索引\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;第一步，分析环境建立与软件安装:&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;## 建立重测序分析环境\nconda create -n wgs -c bioconda gatk samtools bedtools bcftools bwa sambamba fastqc -y\n## 安装vep \nconda create -n vep -c bioconda ensembl-vep=101.0 -y\n# 用tmux新建一个窗口，方便放后台跑\ntmux new -t vep\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;第二步，格式化&lt;code&gt;GFF&lt;/code&gt;文件&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;# 将GFF文件软连接到工作目录下\nln -s /home/data/public/01.database/01.Database/01.genome_db/01.maize/03.B73_v2/ZmB73_5a.59_WGS.gff3 ./\n# 格式化\ngrep -v &amp;quot;#&amp;quot; ZmB73_5a.59_WGS.gff3 | sort -k1,1 -k4,4n -k5,5n -t$&#39;\\t&#39; | bgzip -c &amp;gt; data.gff.gz\n# tabix索引\ntabix -p gff data.gff.gz\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;第三步，拆分&lt;code&gt;vcf&lt;/code&gt;文件，参考链接 &lt;a href=\&#34;https://www.biostars.org/p/9506417/\&#34;&gt;Easy way to split VCF file by chromosome--biostar&lt;/a&gt;&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;mkdir split\n# 脚本来自于 https://www.biostars.org/p/9506417/\n# 首先写一个运行脚本\nvim spilt.sh\n# 按i进入编辑模式，写入一下代码\nvcf_in=$1\n\nvcf_out_stem=$2\n\nfor i in {1..10} #10条染色体\ndo\n        bcftools view ${vcf_in} --regions Chr${i} -o ${vcf_out_stem}_${i}.vcf.gz -Oz$\ndone\n# 按esc退出编辑模式，按：进入命令模式，输入wq回车保存\n# 授予脚本执行权限\nchmod +x split.sh\n# 运行脚本\n./split.sh snp_all.vcf.gz split/snp_chr &amp;amp;\n\n# 跑完后查看结果\ntree split\nsplit/\n├── snp_chr_1.vcf.gz\n├── snp_chr_10.vcf.gz\n├── snp_chr_2.vcf.gz\n├── snp_chr_3.vcf.gz\n├── snp_chr_4.vcf.gz\n├── snp_chr_5.vcf.gz\n├── snp_chr_6.vcf.gz\n├── snp_chr_7.vcf.gz\n├── snp_chr_8.vcf.gz\n└── snp_chr_9.vcf.gz\n\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;第四步，进行注释&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;## 写一个vep注释的单行脚本\nvim run_vep_anno.sh\nvep -i split/snp_chr_${1}.vcf.gz --gff data.gff.gz --fasta B73_RefGen_v2.fa --fork 4 --vcf -o split/snp_anno_chr_${1}.vcf --sf split/snp_anno_chr_${1}.html\n## wq保存退出\n## parallel 并行注释\nparallel bash run_vep_anno.sh ::: 1 2 3 4 5 6 7 8 9 10 &amp;amp;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;第五步，查看结果&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;split/\n├── snp_anno_chr_1.html # 统计结果报告\n├── snp_anno_chr_1.vcf # 带注释的vcf文件\n├── snp_anno_chr_1.vcf_warnings.txt # 运行过程的警告信息\n├── snp_anno_chr_10.html\n├── snp_anno_chr_10.vcf\n├── snp_anno_chr_10.vcf_warnings.txt\n├── snp_anno_chr_2.html\n├── snp_anno_chr_2.vcf\n├── snp_anno_chr_2.vcf_warnings.txt\n├── snp_anno_chr_3.html\n├── snp_anno_chr_3.vcf\n├── snp_anno_chr_3.vcf_warnings.txt\n├── snp_anno_chr_4.html\n├── snp_anno_chr_4.vcf\n├── snp_anno_chr_4.vcf_warnings.txt\n├── snp_anno_chr_5.html\n├── snp_anno_chr_5.vcf\n├── snp_anno_chr_5.vcf_warnings.txt\n├── snp_anno_chr_6.html\n├── snp_anno_chr_6.vcf\n├── snp_anno_chr_6.vcf_warnings.txt\n├── snp_anno_chr_7.html\n├── snp_anno_chr_7.vcf\n├── snp_anno_chr_7.vcf_warnings.txt\n├── snp_anno_chr_8.html\n├── snp_anno_chr_8.vcf\n├── snp_anno_chr_8.vcf_warnings.txt\n├── snp_anno_chr_9.html\n├── snp_anno_chr_9.vcf\n├── snp_anno_chr_9.vcf_warnings.txt\n├── snp_chr_1.vcf.gz\n├── snp_chr_10.vcf.gz\n├── snp_chr_2.vcf.gz\n├── snp_chr_3.vcf.gz\n├── snp_chr_4.vcf.gz\n├── snp_chr_5.vcf.gz\n├── snp_chr_6.vcf.gz\n├── snp_chr_7.vcf.gz\n├── snp_chr_8.vcf.gz\n└── snp_chr_9.vcf.gz\n\n\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;查看下结果发现&lt;code&gt;INFO&lt;/code&gt;以及加入了注释信息。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-tab\&#34;&gt;#CHROM  POS     ID      REF     ALT     QUAL    FILTER  INFO    FORMAT  L01_114 L01_115 L01_117 L01_25  L01_26  L01_28  L01_29  L01_30  L01_32  L01_33  L01_34  L01_35  L01_36  L01_37  L01_38  L01_39  L01_49  L01_50\nChr1    15      .       A       G       289.14  PASS    AC=5;AF=0.139;AN=36;BaseQRankSum=1.53;DP=174;ExcessHet=0;FS=2.831;InbreedingCoeff=0.5213;MLEAC=4;MLEAF=0.111;MQ=51.54;MQRankSum=0.536;QD=12.57;ReadPosRankSum=-0.438;SOR=1.179;CSQ=G|downstream_gene_variant|MODIFIER|GRMZM2G059865|GRMZM2G059865|Transcript|GRMZM2G059865_T01|protein_coding|||||||||||4839|-1||||data.gff.gz|,G|downstream_gene_variant|MODIFIER|GRMZM2G059865|GRMZM2G059865|Transcript|GRMZM2G059865_T02|protein_coding|||||||||||4842|-1||||data.gff.gz|,G|downstream_gene_variant|MODIFIER|GRMZM2G059865|GRMZM2G059865|Transcript|GRMZM2G059865_T03|protein_coding|||||||||||4842|-1||||data.gff.gz|,G|5_prime_UTR_variant|MODIFIER|GRMZM2G060082|GRMZM2G060082|Transcript|GRMZM2G060082_T01|protein_coding|1/5||||13|||||||1||||data.gff.gz|,G|upstream_gene_variant|MODIFIER|GRMZM2G060082|GRMZM2G060082|Transcript|GRMZM2G060082_T02|protein_coding|||||||||||2592|1||||data.gff.gz|    GT:AD:DP:GQ:PL  0/0:5,0:5:15:0,15,197   0/1:14,4:18:99:113,0,429        0/0:3,0:3:9:0,9,126     0/0:6,0:6:18:0,18,190   0/0:4,0:4:12:0,12,169   0/0:3,0:3:9:0,9,89      0/0:12,0:12:36:0,36,464 0/0:6,0:6:18:0,18,199   0/0:11,0:11:33:0,33,425 0/0:9,0:9:27:0,27,287   0/0:9,0:9:0:0,0,252     0/0:5,0:5:15:0,15,192   0/0:5,0:5:15:0,15,191   0/0:4,0:4:12:0,12,148   1/1:0,2:2:6:85,6,0      1/1:0,3:3:9:126,9,0     0/0:11,0:11:33:0,33,412 0/0:10,0:10:30:0,30,318\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;建议输出表格形式，方便信息查阅&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-r\&#34;&gt;## 只需要把脚本里的代码修改一下\nvep -i split/snp_chr_${1}.vcf.gz  --gff data.gff.gz --fasta B73_RefGen_v2.fa --fork 4 --tab -o\nsplit/snp_anno_chr_${1}.xls split/snp_anno_chr_${1}.html \n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;=== END ===&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;wgs_vep_snp_annotation&#34;,&#34;abstract&#34;:&#34;&lt;h1 id=\&#34;背景\&#34;&gt;背景&lt;/h1&gt;\n&lt;ul&gt;\n&lt;li&gt;参考基因组： &lt;a href=\&#34;https://download.maizegdb.org/B73_RefGen_v2/\&#34;&gt;玉米B73_v2,数据来源-MaizeGDB&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;基因注释文件：&lt;a href=\&#34;https://download.maizegdb.org/B73_RefGen_v2/ZmB73_5a.59_WGS.gff3.gz\&#34;&gt;ZmB73_5a.59_WGS.gff3.gz&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;数据源：本课题自测的20个玉米的40x重测序数据。&lt;/li&gt;\n&lt;/ul&gt;\n&#34;,&#34;title&#34;:&#34;「WGS」VEP进行SNP注释&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;WGS&#34;,&#34;slug&#34;:&#34;8A8QYSxzz&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/8A8QYSxzz/&#34;},{&#34;name&#34;:&#34;bioinformatics&#34;,&#34;slug&#34;:&#34;-7KH0PNTVn&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/-7KH0PNTVn/&#34;}],&#34;date&#34;:&#34;2023-03-28 10:07:15&#34;,&#34;dateFormat&#34;:&#34;2023-03-28&#34;,&#34;feature&#34;:&#34;https://shawnwx2019.github.io/post-images/wgs_vep_snp_annotation.jpg&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/wgs_vep_snp_annotation/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;15 min read&#34;,&#34;time&#34;:862000,&#34;words&#34;:2708,&#34;minutes&#34;:15},&#34;description&#34;:&#34;背景\n\n参考基因组： 玉米B73_v2,数据来源-MaizeGDB\n基因注释文件：ZmB73_5a.59_WGS.gff3.gz\n数据源：本课题自测的20个玉米的40x重测序数据。\n\n\n软件安装\n建议用conda新建环境安装，直接在其他环境...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%83%8C%E6%99%AF\&#34;&gt;背景&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85\&#34;&gt;软件安装&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88\&#34;&gt;问题与解决方案&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E9%97%AE%E9%A2%981-%E5%A6%82%E6%9E%9C%E7%89%A9%E7%A7%8D%E6%B2%A1%E6%9C%89%E8%A2%AB%E5%AE%98%E6%96%B9%E6%94%B6%E5%BD%95%E6%80%8E%E4%B9%88%E5%81%9A\&#34;&gt;问题1 如果物种没有被官方收录怎么做&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E9%97%AE%E9%A2%982-%E5%A6%82%E4%BD%95%E6%8F%90%E9%AB%98%E6%95%88%E7%8E%87\&#34;&gt;问题2 如何提高效率&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E9%97%AE%E9%A2%983-%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F\&#34;&gt;问题3 输出文件格式&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#vcf-output\&#34;&gt;VCF output&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%AE%9E%E6%88%98%E4%BB%A3%E7%A0%81\&#34;&gt;实战代码&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;h1 id=\&#34;介绍\&#34;&gt;介绍&lt;/h1&gt;\n&lt;p&gt;SERRF是 U.C Davis Fiehn Lab的&lt;em&gt;S.L Fan&lt;/em&gt;开发的一款&lt;code&gt;QC-based&lt;/code&gt;数据标准化工具，用于校正非靶代谢组学数据的系统误差，具有出色的能力，校正后features RSD显著降低。目前使用方式有3种：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;通过网页工具&lt;a href=\&#34;https://slfan2013.github.io/SERRF-online/#\&#34;&gt;https://slfan2013.github.io/SERRF-online/#&lt;/a&gt; 进行上传数据分析；&lt;/li&gt;\n&lt;li&gt;通过本地运行shiny app，需要在将仓库克隆到本地，然后用Rstudio打开脚本运行&lt;code&gt;run app&lt;/code&gt;;&lt;/li&gt;\n&lt;li&gt;通过本地运行normalize function运行。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;emmm... 经过尝试，第三种运行比较顺利。但是文件准备设置输出等步骤还是太麻烦，所以打算对&lt;code&gt;SERRF&lt;/code&gt;方法单独拿出来进行重构。并且接入&lt;code&gt;Tidymass&lt;/code&gt;的&lt;code&gt;massdataset&lt;/code&gt;，加入分析流程。&lt;/p&gt;\n&lt;!--more--&gt;\n&lt;h1 id=\&#34;脚本结构分析\&#34;&gt;脚本结构分析&lt;/h1&gt;\n&lt;p&gt;&lt;code&gt;Tidymass&lt;/code&gt;本身自带了很多数据标准化的方法，所以像&lt;code&gt;SERRF&lt;/code&gt;脚本中的其他标准化算法先不重构。主要对SERRF这种基于随机森林的标准化算法进行重构，当然方向也是趋于&lt;code&gt;tidyverse&lt;/code&gt;的风格。 首先看看这个脚本的步骤和逻辑。&lt;/p&gt;\n&lt;h2 id=\&#34;数据清洗\&#34;&gt;数据清洗&lt;/h2&gt;\n&lt;ul&gt;\n&lt;li&gt;首先对样品信息的数据进行了数据清洗，最后转换为&lt;code&gt;data.table&lt;/code&gt;格式。p&lt;/li&gt;\n&lt;li&gt;然后对&lt;code&gt;feature&lt;/code&gt;的信息进行了清洗，同样转换为&lt;code&gt;data.table&lt;/code&gt;形式。f&lt;/li&gt;\n&lt;li&gt;最后对代谢物积累矩阵的标准化, 最后转换为&lt;code&gt;matrix&lt;/code&gt;形式。e&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;我们观察了&lt;code&gt;SERRF&lt;/code&gt;的数据格式，和&lt;code&gt;tidymass&lt;/code&gt;的有很大的相似之处。所以打算将输入数据改成&lt;code&gt;tidymass&lt;/code&gt;的&lt;code&gt;mass_dataset&lt;/code&gt;&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;首先尝试都做&lt;code&gt;data.frame&lt;/code&gt;处理&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&#34;serrf算法实现过程\&#34;&gt;SERRF算法实现过程&lt;/h2&gt;\n&lt;p&gt;整体将不同的&lt;code&gt;batch&lt;/code&gt;分开计算。所有的迭代也是建立在&lt;code&gt;batch&lt;/code&gt;个数上的&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;首先第一步把&lt;code&gt;dataset&lt;/code&gt;按照&lt;code&gt;batch&lt;/code&gt;拆开, 按&lt;code&gt;batch&lt;/code&gt;计算训练集和目标集的&lt;code&gt;spearman&lt;/code&gt;相关。&lt;/li&gt;\n&lt;li&gt;第二步根据&lt;code&gt;feature&lt;/code&gt;个数进行迭代，对每个&lt;code&gt;feature&lt;/code&gt;分析建模做标准化。\n&lt;ul&gt;\n&lt;li&gt;首先从第一步计算的训练集和目标集相关性矩阵中分别将对应&lt;code&gt;feature&lt;/code&gt;的相关性结果提取出来；&lt;/li&gt;\n&lt;li&gt;对该结果进行排序，不考虑相关性的正负属性，只要是高度相关就排在前面&lt;code&gt;corr_train_order = order(abs(corr_train[,j]),decreasing = TRUE)&lt;/code&gt;；&lt;/li&gt;\n&lt;li&gt;第三步，从整体表达矩阵中筛选测试集，简单讲就是求第二步两个相关性向量的交集，但是有条件，具体方法如下：\n&lt;ul&gt;\n&lt;li&gt;首先设定一个交集数量的上限值&lt;code&gt;num&lt;/code&gt;，脚本这里默认10，然后引入一个空置的参数&lt;strong&gt;筛选出的变异值&lt;/strong&gt;&lt;code&gt;sel_var&lt;/code&gt;对该值进行迭代计算，迭代的条件是&lt;code&gt;sel_var&lt;/code&gt;中元素的数量 &lt;code&gt;&amp;gt;= 0&lt;/code&gt;的时候终止, 也就是说比对训练集和目标集相关性向量的排序表，从各自的&lt;code&gt;top10&lt;/code&gt;个开始做交集，每次迭代增加一个材料（第二次1:11，第三次1:12 ....）直到交集的数量大于了我们刚设定的&lt;code&gt;10&lt;/code&gt;这个阈值就终止。&lt;/li&gt;\n&lt;li&gt;这样我们就确定了用作训练数据的材料（最终的交集）。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;首先训练集会对该&lt;code&gt;batch&lt;/code&gt;下的所有&lt;code&gt;qc&lt;/code&gt;做一个中心化&lt;code&gt;scale(x,center = T,scale = F)&lt;/code&gt;, 然后对交集材料做标准化；&lt;/li&gt;\n&lt;li&gt;对应测试集只做标准化，这样我们就得到了这10个材料在&lt;code&gt;qc&lt;/code&gt;和&lt;code&gt;sample&lt;/code&gt;各自的标准化表；后续会检查有是否存在这些&lt;code&gt;feature&lt;/code&gt;在&lt;code&gt;sample&lt;/code&gt;是否都缺失了，只有在训练集和测试集中都不含&lt;code&gt;NA&lt;/code&gt;的&lt;code&gt;feature&lt;/code&gt;才会被保留；&lt;/li&gt;\n&lt;li&gt;最终将去中心化的&lt;code&gt;train_data_x&lt;/code&gt;和标准化的&lt;code&gt;train_data_y&lt;/code&gt;合并为新的训练集；&lt;/li&gt;\n&lt;li&gt;用&lt;code&gt;ranger&lt;/code&gt;构建模型；&lt;/li&gt;\n&lt;li&gt;吐槽一下，这&lt;code&gt;baseR&lt;/code&gt;的代码直接给我看吐了。&lt;/li&gt;\n&lt;li&gt;分解下下面鬼见愁就的代码（针对训练集的&lt;code&gt;qc&lt;/code&gt;）具体标准化过程如下：&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;norm[train.index_current_batch==&#39;qc&#39;] = e_current_batch[j, train.index_current_batch==&#39;qc&#39;]/((predict(model, data = train_data)$prediction+mean(e_current_batch[j,train.index_current_batch==&#39;qc&#39;],na.rm=TRUE))/mean(all[j,sampleType.==&#39;qc&#39;],na.rm=TRUE))\nnorm[train.index_current_batch==&#39;qc&#39;] = norm[train.index_current_batch==&#39;qc&#39;]/(median(norm[train.index_current_batch==&#39;qc&#39;],na.rm=TRUE)/median(all[j,sampleType.==&#39;qc&#39;],na.rm=TRUE))\n&lt;/code&gt;&lt;/pre&gt;\n&lt;pre&gt;&lt;code&gt;  - 首先通过`predict`用构建的模型对`train_data`进行预测，取得观测值后加上该`batch`中`feature`所有QC样本峰面积的均值，然后用该数值除以所有QC样本峰面积的均值，得到一个比值，最后用该`batch`中`feature`所有QC样本峰面积对应的除去该比值实现对`QC`样本的的标准化。\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;span class=\&#34;katex\&#34;&gt;&lt;span class=\&#34;katex-mathml\&#34;&gt;&lt;math&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/mfrac&gt;&lt;/mrow&gt;&lt;annotation encoding=\&#34;application/x-tex\&#34;&gt;QC_{norm} = \\frac {QC_{raw}}{\\frac {QC_{model}+QC_{mean}}{ALL_{mean}}}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=\&#34;katex-html\&#34; aria-hidden=\&#34;true\&#34;&gt;&lt;span class=\&#34;base\&#34;&gt;&lt;span class=\&#34;strut\&#34; style=\&#34;height:0.8777699999999999em;vertical-align:-0.19444em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord mathdefault\&#34;&gt;Q&lt;/span&gt;&lt;span class=\&#34;mord\&#34;&gt;&lt;span class=\&#34;mord mathdefault\&#34; style=\&#34;margin-right:0.07153em;\&#34;&gt;C&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.151392em;\&#34;&gt;&lt;span style=\&#34;top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.7em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size6 size3 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;n&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;o&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.02778em;\&#34;&gt;r&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.15em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;mspace\&#34; style=\&#34;margin-right:0.2777777777777778em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mrel\&#34;&gt;=&lt;/span&gt;&lt;span class=\&#34;mspace\&#34; style=\&#34;margin-right:0.2777777777777778em;\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;base\&#34;&gt;&lt;span class=\&#34;strut\&#34; style=\&#34;height:1.818174em;vertical-align:-0.893735em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord\&#34;&gt;&lt;span class=\&#34;mopen nulldelimiter\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mfrac\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.924439em;\&#34;&gt;&lt;span style=\&#34;top:-2.4470650000000003em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size6 size3 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mopen nulldelimiter sizing reset-size3 size6\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mfrac\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:1.0613357142857143em;\&#34;&gt;&lt;span style=\&#34;top:-2.656em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size3 size1 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;A&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;L&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;L&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.23056em;\&#34;&gt;&lt;span style=\&#34;top:-2.3em;margin-left:0em;margin-right:0.1em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.5em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;e&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;a&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.2em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\&#34;top:-3.2255000000000003em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;frac-line mtight\&#34; style=\&#34;border-bottom-width:0.049em;\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\&#34;top:-3.573242857142857em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size3 size1 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;Q&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.07153em;\&#34;&gt;C&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.3448em;\&#34;&gt;&lt;span style=\&#34;top:-2.3448em;margin-left:-0.07153em;margin-right:0.1em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.69444em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;o&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;d&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;e&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.01968em;\&#34;&gt;l&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.34963999999999995em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;mbin mtight\&#34;&gt;+&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;Q&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.07153em;\&#34;&gt;C&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.23056em;\&#34;&gt;&lt;span style=\&#34;top:-2.3em;margin-left:-0.07153em;margin-right:0.1em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.5em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;e&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;a&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.2em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.4868571428571429em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;mclose nulldelimiter sizing reset-size3 size6\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\&#34;top:-3.23em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;frac-line\&#34; style=\&#34;border-bottom-width:0.04em;\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\&#34;top:-3.446108em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size6 size3 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;Q&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.07153em;\&#34;&gt;C&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.16454285714285719em;\&#34;&gt;&lt;span style=\&#34;top:-2.357em;margin-left:-0.07153em;margin-right:0.07142857142857144em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.5em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size3 size1 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.02778em;\&#34;&gt;r&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;a&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.02691em;\&#34;&gt;w&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.143em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.893735em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;mclose nulldelimiter\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n&lt;pre&gt;&lt;code&gt;  - 得到标准化后的$QC_{norm}$后，用该值的中位值除以所有`QC`样品的中位值，然后每个值再除以这个比值\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;span class=\&#34;katex\&#34;&gt;&lt;span class=\&#34;katex-mathml\&#34;&gt;&lt;math&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi mathvariant=\&#34;normal\&#34;&gt;.&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/mfrac&gt;&lt;/mrow&gt;&lt;annotation encoding=\&#34;application/x-tex\&#34;&gt;QC_{norm} = \\frac {QC_{norm}} {\\frac {QC_{norm.median}}{ALL_{median}}}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=\&#34;katex-html\&#34; aria-hidden=\&#34;true\&#34;&gt;&lt;span class=\&#34;base\&#34;&gt;&lt;span class=\&#34;strut\&#34; style=\&#34;height:0.8777699999999999em;vertical-align:-0.19444em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord mathdefault\&#34;&gt;Q&lt;/span&gt;&lt;span class=\&#34;mord\&#34;&gt;&lt;span class=\&#34;mord mathdefault\&#34; style=\&#34;margin-right:0.07153em;\&#34;&gt;C&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.151392em;\&#34;&gt;&lt;span style=\&#34;top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.7em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size6 size3 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;n&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;o&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.02778em;\&#34;&gt;r&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.15em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;mspace\&#34; style=\&#34;margin-right:0.2777777777777778em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mrel\&#34;&gt;=&lt;/span&gt;&lt;span class=\&#34;mspace\&#34; style=\&#34;margin-right:0.2777777777777778em;\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;base\&#34;&gt;&lt;span class=\&#34;strut\&#34; style=\&#34;height:1.8929939999999998em;vertical-align:-0.9685549999999999em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord\&#34;&gt;&lt;span class=\&#34;mopen nulldelimiter\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mfrac\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.924439em;\&#34;&gt;&lt;span style=\&#34;top:-2.4470650000000003em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size6 size3 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mopen nulldelimiter sizing reset-size3 size6\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mfrac\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:1.0613357142857143em;\&#34;&gt;&lt;span style=\&#34;top:-2.656em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size3 size1 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;A&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;L&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;L&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.3448em;\&#34;&gt;&lt;span style=\&#34;top:-2.3448em;margin-left:0em;margin-right:0.1em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.69444em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;e&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;d&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;i&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;a&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.34963999999999995em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\&#34;top:-3.2255000000000003em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;frac-line mtight\&#34; style=\&#34;border-bottom-width:0.049em;\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\&#34;top:-3.573242857142857em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size3 size1 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;Q&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.07153em;\&#34;&gt;C&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.3448em;\&#34;&gt;&lt;span style=\&#34;top:-2.3448em;margin-left:-0.07153em;margin-right:0.1em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.69444em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;n&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;o&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.02778em;\&#34;&gt;r&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;.&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;e&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;d&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;i&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;a&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.34963999999999995em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.5937428571428571em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;mclose nulldelimiter sizing reset-size3 size6\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\&#34;top:-3.23em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;frac-line\&#34; style=\&#34;border-bottom-width:0.04em;\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\&#34;top:-3.446108em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:3em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size6 size3 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;Q&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.07153em;\&#34;&gt;C&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.16454285714285719em;\&#34;&gt;&lt;span style=\&#34;top:-2.357em;margin-left:-0.07153em;margin-right:0.07142857142857144em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.5em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size3 size1 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;n&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;o&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.02778em;\&#34;&gt;r&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.143em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.9685549999999999em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;mclose nulldelimiter\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;下面分解对训练集中&lt;code&gt;sample&lt;/code&gt;标准化的部分&lt;/li&gt;\n&lt;/ul&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;norm[!train.index_current_batch==&#39;qc&#39;] =(e_current_batch[j,!train.index_current_batch==&#39;qc&#39;])/((predict(model,data = test_data)$predictions  + mean(e_current_batch[j, !train.index_current_batch==&#39;qc&#39;],na.rm=TRUE))/(median(all[j,!sampleType.==&#39;qc&#39;],na.rm = TRUE)))\nnorm[!train.index_current_batch==&#39;qc&#39;][norm[!train.index_current_batch==&#39;qc&#39;]&amp;lt;0]=e_current_batch[j,!train.index_current_batch==&#39;qc&#39;][norm[!train.index_current_batch==&#39;qc&#39;]&amp;lt;0]\nnorm[!train.index_current_batch==&#39;qc&#39;] = norm[!train.index_current_batch==&#39;qc&#39;]/(median(norm[!train.index_current_batch==&#39;qc&#39;],na.rm=TRUE)/median(all[j,!sampleType.==&#39;qc&#39;],na.rm=TRUE))\nnorm[!is.finite(norm)] = rnorm(length(norm[!is.finite(norm)]),sd = sd(norm[is.finite(norm)],na.rm=TRUE)*0.01)\nout = boxplot.stats(norm, coef = 3)$out\nnorm[!train.index_current_batch==&#39;qc&#39;][norm[!train.index_current_batch==&#39;qc&#39;]%in%out] = ((e_current_batch[j,!train.index_current_batch==&#39;qc&#39;])-((predict(model,data = test_data)$predictions  + mean(e_current_batch[j, !train.index_current_batch==&#39;qc&#39;],na.rm=TRUE))-(median(all[j,!sampleType.==&#39;qc&#39;],na.rm = TRUE))))[norm[!train.index_current_batch==&#39;qc&#39;]%in%out];\nnorm[!train.index_current_batch==&#39;qc&#39;][norm[!train.index_current_batch==&#39;qc&#39;]&amp;lt;0]=e_current_batch[j,!train.index_current_batch==&#39;qc&#39;][norm[!train.index_current_batch==&#39;qc&#39;]&amp;lt;0]\n&lt;/code&gt;&lt;/pre&gt;\n&lt;pre&gt;&lt;code&gt;  - 第一步和上面一样同样的算法；第二步是探测了标准化后的`sample`值，如果有`＜0`的值，用原始的值填充；\n  - 接下来和上面一样用标准化的值除以两中位值的比值；\n  - 下一步检查结果中是否有无穷值，如果有的话用随机数填充，标准差选择非无穷值的标准差，最终的值`*0.01`；\n  - 筛选出离群的值，然后填充离群值；\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;span class=\&#34;katex\&#34;&gt;&lt;span class=\&#34;katex-mathml\&#34;&gt;&lt;math&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;S&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;Q&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi mathvariant=\&#34;normal\&#34;&gt;.&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;annotation encoding=\&#34;application/x-tex\&#34;&gt;Sample_{raw}-((QC_{model}+QC_{mean}) - ALL_{all.median})&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=\&#34;katex-html\&#34; aria-hidden=\&#34;true\&#34;&gt;&lt;span class=\&#34;base\&#34;&gt;&lt;span class=\&#34;strut\&#34; style=\&#34;height:0.8888799999999999em;vertical-align:-0.19444em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord mathdefault\&#34; style=\&#34;margin-right:0.05764em;\&#34;&gt;S&lt;/span&gt;&lt;span class=\&#34;mord mathdefault\&#34;&gt;a&lt;/span&gt;&lt;span class=\&#34;mord mathdefault\&#34;&gt;m&lt;/span&gt;&lt;span class=\&#34;mord mathdefault\&#34;&gt;p&lt;/span&gt;&lt;span class=\&#34;mord mathdefault\&#34; style=\&#34;margin-right:0.01968em;\&#34;&gt;l&lt;/span&gt;&lt;span class=\&#34;mord\&#34;&gt;&lt;span class=\&#34;mord mathdefault\&#34;&gt;e&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.151392em;\&#34;&gt;&lt;span style=\&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.7em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size6 size3 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.02778em;\&#34;&gt;r&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;a&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.02691em;\&#34;&gt;w&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.15em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;mspace\&#34; style=\&#34;margin-right:0.2222222222222222em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mbin\&#34;&gt;−&lt;/span&gt;&lt;span class=\&#34;mspace\&#34; style=\&#34;margin-right:0.2222222222222222em;\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;base\&#34;&gt;&lt;span class=\&#34;strut\&#34; style=\&#34;height:1em;vertical-align:-0.25em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mopen\&#34;&gt;(&lt;/span&gt;&lt;span class=\&#34;mopen\&#34;&gt;(&lt;/span&gt;&lt;span class=\&#34;mord mathdefault\&#34;&gt;Q&lt;/span&gt;&lt;span class=\&#34;mord\&#34;&gt;&lt;span class=\&#34;mord mathdefault\&#34; style=\&#34;margin-right:0.07153em;\&#34;&gt;C&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.33610799999999996em;\&#34;&gt;&lt;span style=\&#34;top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.7em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size6 size3 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;o&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;d&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;e&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.01968em;\&#34;&gt;l&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.15em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;mspace\&#34; style=\&#34;margin-right:0.2222222222222222em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mbin\&#34;&gt;+&lt;/span&gt;&lt;span class=\&#34;mspace\&#34; style=\&#34;margin-right:0.2222222222222222em;\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;base\&#34;&gt;&lt;span class=\&#34;strut\&#34; style=\&#34;height:1em;vertical-align:-0.25em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord mathdefault\&#34;&gt;Q&lt;/span&gt;&lt;span class=\&#34;mord\&#34;&gt;&lt;span class=\&#34;mord mathdefault\&#34; style=\&#34;margin-right:0.07153em;\&#34;&gt;C&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.151392em;\&#34;&gt;&lt;span style=\&#34;top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.7em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size6 size3 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;e&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;a&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.15em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;mclose\&#34;&gt;)&lt;/span&gt;&lt;span class=\&#34;mspace\&#34; style=\&#34;margin-right:0.2222222222222222em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mbin\&#34;&gt;−&lt;/span&gt;&lt;span class=\&#34;mspace\&#34; style=\&#34;margin-right:0.2222222222222222em;\&#34;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;base\&#34;&gt;&lt;span class=\&#34;strut\&#34; style=\&#34;height:1em;vertical-align:-0.25em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;mord mathdefault\&#34;&gt;A&lt;/span&gt;&lt;span class=\&#34;mord mathdefault\&#34;&gt;L&lt;/span&gt;&lt;span class=\&#34;mord\&#34;&gt;&lt;span class=\&#34;mord mathdefault\&#34;&gt;L&lt;/span&gt;&lt;span class=\&#34;msupsub\&#34;&gt;&lt;span class=\&#34;vlist-t vlist-t2\&#34;&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.33610799999999996em;\&#34;&gt;&lt;span style=\&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\&#34;&gt;&lt;span class=\&#34;pstrut\&#34; style=\&#34;height:2.7em;\&#34;&gt;&lt;/span&gt;&lt;span class=\&#34;sizing reset-size6 size3 mtight\&#34;&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;a&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.01968em;\&#34;&gt;l&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34; style=\&#34;margin-right:0.01968em;\&#34;&gt;l&lt;/span&gt;&lt;span class=\&#34;mord mtight\&#34;&gt;.&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;m&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;e&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;d&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;i&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;a&lt;/span&gt;&lt;span class=\&#34;mord mathdefault mtight\&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-s\&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;vlist-r\&#34;&gt;&lt;span class=\&#34;vlist\&#34; style=\&#34;height:0.15em;\&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&#34;mclose\&#34;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n&lt;pre&gt;&lt;code&gt;  - 先用`QC`模型+`QC`均值减去所有矩阵中非`QC`的中位值，然后用sample的原始峰面积减去该值。然后用该值填充离群值\n  - 如果有引入的负数，再用上面的公式填充一下负数。\n&lt;/code&gt;&lt;/pre&gt;\n&lt;ul&gt;\n&lt;li&gt;最终标准化完毕。&lt;/li&gt;\n&lt;li&gt;完成所有&lt;code&gt;feature&lt;/code&gt;的标准化后会对NA和负数进行重新填充；\n&lt;ul&gt;\n&lt;li&gt;对于NA进行随机数填充，均值为其他非NA值的最小值，sd为其他非NA值的sd，最终得到的随机数&lt;code&gt;*0.1&lt;/code&gt;；&lt;/li&gt;\n&lt;li&gt;对负数的填充，&lt;code&gt;1*&lt;/code&gt;非负数值的最小值。&lt;/li&gt;\n&lt;li&gt;至此SERRF标准化过程完毕&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;交叉检验\n&lt;ul&gt;\n&lt;li&gt;使用的数据集是原始的&lt;code&gt;qc&lt;/code&gt;峰面积数据。默认&lt;code&gt;5-fold&lt;/code&gt;。为啥要做5折？&lt;/li&gt;\n&lt;li&gt;这里发现个错误，我们看下&lt;code&gt;any&lt;/code&gt;函数的用法&lt;/li&gt;\n&lt;li&gt;，很明显作者在这里是想看所有&lt;code&gt;batch&lt;/code&gt;中是否存在某个&lt;code&gt;batch&lt;/code&gt;中的&lt;code&gt;qc&lt;/code&gt;样本数量小于&lt;code&gt;7&lt;/code&gt;，按照目前的代码&lt;code&gt;any(table(p_qc$batch))&lt;/code&gt;总是会返回一个逻辑值&lt;code&gt;TRUE&lt;/code&gt;，&lt;code&gt;any&lt;/code&gt;本来就是个做判断的函数，所以把&lt;code&gt;&amp;lt;7&lt;/code&gt;移动到括号内。这... 之前所有工作中&lt;code&gt;ratio&lt;/code&gt;都被默认成了&lt;code&gt;0.7&lt;/code&gt;. 0.7和0.8差异大吗？&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;## 原始的\nif(any(table(p_qc$batch))&amp;lt;7){\n  ratio = 0.7\n}else{\n  ratio = 0.8\n}\n## 改造后的\nif(any(table(p_qc$batch)&amp;lt;7)){\n  ratio = 0.7\n}else{\n  ratio = 0.8\n}\n&lt;/code&gt;&lt;/pre&gt;\n&#34;,&#34;fileName&#34;:&#34;metabolomics-serrf-dai-ma-chong-gou&#34;,&#34;abstract&#34;:&#34;&lt;h1 id=\&#34;介绍\&#34;&gt;介绍&lt;/h1&gt;\n&lt;p&gt;SERRF是 U.C Davis Fiehn Lab的&lt;em&gt;S.L Fan&lt;/em&gt;开发的一款&lt;code&gt;QC-based&lt;/code&gt;数据标准化工具，用于校正非靶代谢组学数据的系统误差，具有出色的能力，校正后features RSD显著降低。目前使用方式有3种：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;通过网页工具&lt;a href=\&#34;https://slfan2013.github.io/SERRF-online/#\&#34;&gt;https://slfan2013.github.io/SERRF-online/#&lt;/a&gt; 进行上传数据分析；&lt;/li&gt;\n&lt;li&gt;通过本地运行shiny app，需要在将仓库克隆到本地，然后用Rstudio打开脚本运行&lt;code&gt;run app&lt;/code&gt;;&lt;/li&gt;\n&lt;li&gt;通过本地运行normalize function运行。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;emmm... 经过尝试，第三种运行比较顺利。但是文件准备设置输出等步骤还是太麻烦，所以打算对&lt;code&gt;SERRF&lt;/code&gt;方法单独拿出来进行重构。并且接入&lt;code&gt;Tidymass&lt;/code&gt;的&lt;code&gt;massdataset&lt;/code&gt;，加入分析流程。&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「Metabolomics」SERRF代码重构&#34;,&#34;tags&#34;:[],&#34;date&#34;:&#34;2023-03-01 09:17:30&#34;,&#34;dateFormat&#34;:&#34;2023-03-01&#34;,&#34;feature&#34;:&#34;&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/metabolomics-serrf-dai-ma-chong-gou/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;8 min read&#34;,&#34;time&#34;:445000,&#34;words&#34;:1844,&#34;minutes&#34;:8},&#34;description&#34;:&#34;介绍\nSERRF是 U.C Davis Fiehn Lab的S.L Fan开发的一款QC-based数据标准化工具，用于校正非靶代谢组学数据的系统误差，具有出色的能力，校正后features RSD显著降低。目前使用方式有3种：\n\n通过网页...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%BB%8B%E7%BB%8D\&#34;&gt;介绍&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%84%9A%E6%9C%AC%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90\&#34;&gt;脚本结构分析&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97\&#34;&gt;数据清洗&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#serrf%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B\&#34;&gt;SERRF算法实现过程&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;之前在使用&lt;code&gt;rvest&lt;/code&gt;,&lt;code&gt;RCurl&lt;/code&gt;以及&lt;code&gt;XML&lt;/code&gt;包编写爬虫时只是单纯的考虑到了信息提取和格式转换，没有考虑到爬虫对目标服务器的负载压力，之前也使用过暴力并行，虽然速度很快，但是对目标网站服务器负载造成了很大压力，这样既不道德，也不安全。被反爬机制检测到会封ip等。本次就实战中遇到问题解决问题做个总结。&lt;/p&gt;\n&lt;!--more--&gt;\n&lt;h1 id=\&#34;爬虫代码\&#34;&gt;爬虫代码&lt;/h1&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;mda_knapsack_spider &amp;lt;- function(input_data,type = &amp;quot;multiple&amp;quot;) {\n  #&amp;gt; message setting\n  msg_yes = green$bold$italic;\n  msg_no = red$bold$italic;\n  msg_warning = yellow$bold$italic;\n  message(msg_yes(&amp;quot;---------------------------------------------------------\\nStart analysis....\\nGet compound information from KNApSAcK database. please wait...\\n--------------------------------------------------------- &amp;quot;))\n  #&amp;gt; functions\n  #&amp;gt; name2cid\n  name2cid_fun = function(x) {\n    tbl &amp;lt;- \n      data.frame(\n        Lab.ID = x,\n        CAS.ID = NA,\n        Compound_name = NA,\n        Formula = NA,\n        mw = NA,\n        organism = NA,\n        synonyms = NA,\n        Judge_plant = FALSE,\n        InChIKey = NA,\n        SMILE = NA,\n        Species_all = NA\n      )\n    tryCatch({\n      ID = x\n      ## use different user_agents.\n      user_agents = c(\n        &amp;quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.3 Safari/605.1.15&amp;quot;,\n        &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/110.0&#39;,\n        &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36 Edg/103.0.1264.37&#39;,\n        &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36 Edg/103.0.1264.37&#39;,\n        &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36&#39;,\n        &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36&#39;,\n        &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:101.0) Gecko/20100101 Firefox/101.0&#39;\n      )\n      random_agent &amp;lt;- sample(user_agents,1)\n      \n      headers = c(&#39;User_Agent&#39; = random_agent,&#39;Accept&#39; = &amp;quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&amp;quot;)\n      url &amp;lt;- &amp;quot;http://www.knapsackfamily.com/knapsack_core/result.php?sname=all&amp;amp;word=&amp;quot;\n      \n      # fetch the HTML content of the page\n      html &amp;lt;- RCurl::getURL(url = paste0(url,ID),header = headers,.encoding = &#39;UTF-8&#39;)\n      \n      # parse the HTML using XML package\n      doc &amp;lt;- XML::htmlParse(html, asText = TRUE)\n      \n      # find the table on the page\n      table &amp;lt;- XML::getNodeSet(doc, &amp;quot;//table&amp;quot;)[[1]]\n      \n      cell &amp;lt;- XML::xpathApply(table,&amp;quot;//td&amp;quot;)\n      metabolite &amp;lt;- XML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;)[[1]]\n      \n      Lab.ID &amp;lt;- XML::xmlValue(cell[[1]])\n      CAS.ID &amp;lt;- XML::xmlValue(cell[[2]])\n      Compound_name &amp;lt;- XML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;)[[1]] %&amp;gt;% XML::xmlValue()\n      Formula &amp;lt;- XML::xmlValue(cell[[4]])\n      mw &amp;lt;- XML::xmlValue(cell[[5]])\n      organism &amp;lt;- XML::xmlValue(cell[[6]])\n      synonyms &amp;lt;- XML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;) %&amp;gt;% \n  \t\t\t\t\t\tmap_chr(.x = .,function(.x){ifelse(XML::xmlName(.x)==&amp;quot;br&amp;quot;, NA, XML::xmlValue(.x))}) %&amp;gt;% \n  \t\t\t\t\t\tna.omit %&amp;gt;% \n  \t\t\t\t\t\tpaste(.,collapse = &amp;quot;|&amp;quot;) \n      url2 &amp;lt;- &amp;quot;http://www.knapsackfamily.com/knapsack_core/information.php?word=&amp;quot;\n      html &amp;lt;- RCurl::getURL(url = paste0(url2,ID),header = headers)\n      \n      parsed_html &amp;lt;- XML::htmlParse(html, asText = TRUE)\n      table_nodes &amp;lt;- XML::getNodeSet(parsed_html, &amp;quot;//table&amp;quot;)  # 选择所有表格节点\n      table &amp;lt;- XML::readHTMLTable(table_nodes[[2]])  # 提取第一个表格节点的表格数据\n      tbl = data.frame(\n        Lab.ID = Lab.ID,\n        CAS.ID = CAS.ID,\n        Compound_name = Compound_name,\n        Formula = Formula,\n        mw = mw,\n        organism = organism,\n        synonyms = synonyms,\n        Judge_plant = case_when(\n          str_detect(table[9,2],&amp;quot;Plantae&amp;quot;) ~ TRUE,\n          TRUE ~ FALSE\n        ),\n        InChIKey = table[5,2],\n        SMILE = table[7,2],\n        Species_all = table %&amp;gt;% pull(V3) %&amp;gt;% na.omit() %&amp;gt;% paste(.,collapse = &amp;quot;|&amp;quot;)\n      )\n    },error = function(e) {\n      message(msg_no(x,&amp;quot; no match results\\n&amp;quot;))\n    })\n  }\n  \n  multi_run_fun = function(name_list) {\n    name &amp;lt;- name_list %&amp;gt;% pull(knapsack_id)\n    p &amp;lt;- progressr::progressor(steps = length(name));\n    repeat {\n      b &amp;lt;- tryCatch({\n        b &amp;lt;- purrr::map_dfr(.x = name, .f = function(.x) {\n          s.time = sample(runif(n = 50,1,3) %&amp;gt;% round(.,digits = 2),1)\n          Sys.sleep(s.time);\n          p()\n          a &amp;lt;- name2cid_fun(x = .x)\n          return(a)\n        })\n        return(b)\n      }, error = function(e) {\n        message(&amp;quot;Error occurred: &amp;quot;, conditionMessage(e), &amp;quot;\\n&amp;quot;)\n        NULL\n      })\n      if (!is.null(b)) {\n        if (nrow(b) == length(name)) {\n          break\n        } else {\n          missing_names &amp;lt;- setdiff(name, b$Lab.ID)\n          message(paste0(&amp;quot;Missing &amp;quot;, length(missing_names), &amp;quot; entries, retrying...&amp;quot;))\n          name &amp;lt;- missing_names\n        }\n      } else {\n        message(&amp;quot;Retrying...&amp;quot;)\n      }\n    }\n    return(b)\n  }\n  \n  #&amp;gt; run single search\n  if(type == &#39;single&#39;) {\n    cid_tbl &amp;lt;- name2cid_fun(\n      x = input_data\n    )\n    message(msg_yes(&amp;quot;Done!&amp;quot;))\n  }\n  #&amp;gt; run multiple search\n  if(type == &#39;multiple&#39;) {\n    #&amp;gt; check format\n    if (&amp;quot;knapsack_id&amp;quot; %in% colnames(input_data) ) {\n      Name_clean = input_data %&amp;gt;% \n        select(knapsack_id) %&amp;gt;% \n        distinct() %&amp;gt;% \n        drop_na() %&amp;gt;% \n        mutate(order = seq(1:nrow(.)))\n    } else {\n      return();\n      message(msg_no(&#39;Error in input data infomation, please set the colname of kanpsack id as &amp;quot;knapsack_id&amp;quot;&#39;))\n    } \n    #&amp;gt; run\n    with_progress({\n      kns_tbl = multi_run_fun(name_list = Name_clean)\n    })\n    message(msg_yes(&amp;quot;Done!&amp;quot;))\n    return(kns_tbl)\n  }\n}\n\n\nlibrary(RCurl)\nlibrary(XML)\nlibrary(tidyverse)\nlibrary(crayon)\nlibrary(progressr)\n\nquery &amp;lt;- read.csv(&amp;quot;~/SynologyDrive/database/02.MS/KNApSAcK/KNApSAcK_MS1_db.csv&amp;quot;)\nquery &amp;lt;- \n  query %&amp;gt;% \n  dplyr::select(Lab.ID,RT) %&amp;gt;% \n  setNames(c(&amp;quot;knapsack_id&amp;quot;,&amp;quot;tag&amp;quot;))\n\n\nt.start &amp;lt;- Sys.time()\npart1 &amp;lt;- mda_knapsack_spider(input_data = query[1:1000,])\nt.end &amp;lt;- Sys.time()\ncat(t.end -t.start)\n\n\n&lt;/code&gt;&lt;/pre&gt;\n&lt;h1 id=\&#34;代码解析\&#34;&gt;代码解析&lt;/h1&gt;\n&lt;p&gt;首先我们去目标网站&lt;br&gt;\n我们在KNApSAcK网站输入C_ID后首先会出现上面页面，从页面看，主要为一个表格，那么我们只需要把这个表格提取出来，该网站无需用户登录信息，所以一般request method为GET，从下图打开开发者模式后可以看到。所以在请求的时候思路就是用&lt;code&gt;RCurl::getURL&lt;/code&gt;函数请求网址，然后通过&lt;code&gt;XML::htmlParse&lt;/code&gt;函数来解析网址，再通过&lt;code&gt;XML::getNodeSet&lt;/code&gt;定位表格，用&lt;code&gt;XML::xpathApply&lt;/code&gt;将HTML转换为包含每个条目的&lt;code&gt;list&lt;/code&gt;。达到信息提取的目的。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202303010907129.png\&#34; alt=\&#34;xml\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;问题一化合物名字无法和同义词区分开\&#34;&gt;问题一：化合物名字无法和同义词区分开&lt;/h2&gt;\n&lt;p&gt;我们发现KNApSAcK数据库在化合物``Metabolite&lt;code&gt;这一栏会把名字和同义词放在一个&lt;/code&gt;cell&lt;code&gt;中，用换行符隔开（回车），那么在HTML中换行符的标志是&lt;/code&gt;&lt;br/&gt;&lt;code&gt;,所以我们看定位到表格后,直接输出&lt;/code&gt;cell`后结果如下：&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-html\&#34;&gt;cell\n[[1]]\n&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;\n  &amp;lt;a href=&amp;quot;information.php?word=C00000001&amp;quot; target=&amp;quot;_blank&amp;quot;&amp;gt;C00000001&amp;lt;/a&amp;gt;\n&amp;lt;/td&amp;gt; \n\n[[2]]\n&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;545-97-1&amp;lt;/td&amp;gt; \n\n[[3]]\n&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;Gibberellin A1&amp;lt;br/&amp;gt;GA1&amp;lt;/td&amp;gt; \n\n[[4]]\n&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;C19H24O6&amp;lt;/td&amp;gt; \n\n[[5]]\n&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;348.1572885&amp;lt;/td&amp;gt; \n\n[[6]]\n&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;Solanum lycopersicum&amp;lt;/td&amp;gt; \n\nattr(,&amp;quot;class&amp;quot;)\n[1] &amp;quot;XMLNodeSet&amp;quot;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;我们发现化合物名字这个&lt;code&gt;cell&lt;/code&gt;中的内容为&lt;code&gt;&amp;lt;td class=&amp;quot;d1&amp;quot;&amp;gt;Gibberellin A1&amp;lt;br/&amp;gt;GA1&amp;lt;/td&amp;gt;&lt;/code&gt;。这样就会发生一个问题，如果我们直接用&lt;code&gt;XML::xmlValue&lt;/code&gt;函数将HTML转换为字符后所有的HTML标志都会被去掉，这样中间的&lt;code&gt;&amp;lt;br/&amp;gt;&lt;/code&gt;也被去掉了，这样输出的结果为：&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;XML::xmlValue(cell[[3]])\n[1] &amp;quot;Gibberellin A1GA1&amp;quot;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;那么，化合物名字Gibberellin A1和它的同义词GA1就收尾相连，这在后续处理的时候是非常麻烦的。&lt;/p&gt;\n&lt;h2 id=\&#34;问题一处理方式\&#34;&gt;问题一：处理方式&lt;/h2&gt;\n&lt;p&gt;既然不能等到先把表格提取出来再进行格式转换，那么就直接用xpathApply把这个cell的内容提取出来转换成list，然后选择第一个作为Compound_name, 剩下的通过&lt;code&gt;paste(x,collapse=”|“)&lt;/code&gt;将他们粘贴在一起然后用&lt;code&gt;|&lt;/code&gt;分开。具体实现代码如下：&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;## 先看下这几对这个cell进行提取结果\nXML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;)\n[[1]]\nGibberellin A1 ## 每个元素都被提取出来，转换成字符，最后构建了个list\n\n[[2]]\n&amp;lt;br/&amp;gt; ## 换行符也被转换成了字符串\n\n[[3]]\nGA1 ## 同义词也被转换出来\n\nattr(,&amp;quot;class&amp;quot;)\n[1] &amp;quot;XMLNodeSet&amp;quot;\n## 那么只要用[[1]]提取上述输出结果的第一个元素然后转换为字符即可提取化合物名字\n## 注意，这个list里面每个元素并不是字符串格式，而是以下格式的数据类型，需要用xmlValue函数转换为字符串\nclass(cell[[1]])\n[1] &amp;quot;XMLInternalElementNode&amp;quot; &amp;quot;XMLInternalNode&amp;quot;        &amp;quot;XMLAbstractNode&amp;quot;   \n##&amp;gt; 提取化合物名字\nCompound_name &amp;lt;- \n\t\t\t\t\t\t XML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;)[[1]] %&amp;gt;% ## 提取\n\t\t\t\t\t\t XML::xmlValue()\n##&amp;gt; 提取同义词\nsynonyms &amp;lt;- XML::xpathApply(table, &amp;quot;//td[3]/node()&amp;quot;) %&amp;gt;% \n  \t\t\tmap_chr(.x = .,function(.x){ifelse(XML::xmlName(.x)==&amp;quot;br&amp;quot;, NA, XML::xmlValue(.x))}) %&amp;gt;% ## 如果html标识是&amp;lt;br/&amp;gt;,转换为NA，反之转换为字符串\n  \t\t\tna.omit %&amp;gt;% ## 去掉NA，也就是换行符\n  \t\t\tpaste(.,collapse = &amp;quot;|&amp;quot;) ## 将字符串拼接用 | 隔开。\n\n\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;然后将这些元素拼接到一个表格中。&lt;/p&gt;\n&lt;h2 id=\&#34;问题二缺少inchikey及smile等信息\&#34;&gt;问题二：缺少&lt;code&gt;InChIKey&lt;/code&gt;及&lt;code&gt;SMILE&lt;/code&gt;等信息&lt;/h2&gt;\n&lt;p&gt;后续分类的时候我们有可能会使用&lt;code&gt;pubchem&lt;/code&gt;数据库去再次确认这些化合物的信息，并且调取&lt;code&gt;Pubchem&lt;/code&gt;数据库的&lt;code&gt;InChIKey&lt;/code&gt;用于分类，因为&lt;code&gt;ClassyfireR&lt;/code&gt;貌似对&lt;code&gt;Pubchem&lt;/code&gt;数据库收录的&lt;code&gt;InChIKey&lt;/code&gt;支持较好。这是可能需要化合物名字和SMILE。&lt;br&gt;\n这些信息在点击该网页的&lt;code&gt;C_ID&lt;/code&gt;的链接里面：&lt;/p&gt;\n&lt;h2 id=\&#34;问题二处理方式\&#34;&gt;问题二：处理方式&lt;/h2&gt;\n&lt;p&gt;于是我们对这个网页信息继续进行提取，该表格比较复杂，不过最终通过对源码的解析我们也顺利抓取到了需要的信息&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;url2 &amp;lt;- &amp;quot;http://www.knapsackfamily.com/knapsack_core/information.php?word=&amp;quot;\n      html &amp;lt;- RCurl::getURL(url = paste0(url2,ID),header = headers)\n      \n      parsed_html &amp;lt;- XML::htmlParse(html, asText = TRUE)\n      table_nodes &amp;lt;- XML::getNodeSet(parsed_html, &amp;quot;//table&amp;quot;)  # 选择所有表格节点\n      table &amp;lt;- XML::readHTMLTable(table_nodes[[2]])  # 提取第一个表格节点的表格数据\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;再&lt;code&gt;table_nodes&lt;/code&gt; 的第二个元素中，我们找到了我们需要的内容，于是继续提取，同时我们把&lt;code&gt;kingdom&lt;/code&gt;列中的结果进行了检测，看该化合物是否来源于植物，用&lt;code&gt;str_detected&lt;/code&gt;如果检测到&lt;code&gt;Plantae&lt;/code&gt;我们认为该化合物在植物中存在。同时提取了物种信息，后续可能在做指定物种的非靶代谢时优先考虑这些化合物。&lt;/p&gt;\n&lt;h2 id=\&#34;结果整合\&#34;&gt;结果整合&lt;/h2&gt;\n&lt;p&gt;这个比较简单，就是构造一个数据框，把结果填写进去。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;      tbl = data.frame(\n        Lab.ID = Lab.ID,\n        CAS.ID = CAS.ID,\n        Compound_name = Compound_name,\n        Formula = Formula,\n        mw = mw,\n        organism = organism,\n        synonyms = synonyms,\n        Judge_plant = case_when(\n          str_detect(table[9,2],&amp;quot;Plantae&amp;quot;) ~ TRUE,\n          TRUE ~ FALSE\n        ),\n        InChIKey = table[5,2],\n        SMILE = table[7,2],\n        Species_all = table %&amp;gt;% pull(V3) %&amp;gt;% na.omit() %&amp;gt;% paste(.,collapse = &amp;quot;|&amp;quot;)\n      )\n## 提前构造好的空df\n    tbl &amp;lt;- \n      data.frame(\n        Lab.ID = x,\n        CAS.ID = NA,\n        Compound_name = NA,\n        Formula = NA,\n        mw = NA,\n        organism = NA,\n        synonyms = NA,\n        Judge_plant = FALSE,\n        InChIKey = NA,\n        SMILE = NA,\n        Species_all = NA\n      )\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;此外在爬虫function中我们加入了&lt;code&gt;tryCatch&lt;/code&gt;机制，如果报错了，跳过该条目继续进行下一个，这是就要去我们有个default。也就是代码开头构造的&lt;code&gt;tbl&lt;/code&gt;，如果没有这个条目，或者网络方位失败，会跳过返回该提前构造的表格，不至于循环被打断。而且最终会提醒你哪些没有结果。&lt;/p&gt;\n&lt;h2 id=\&#34;迭代运行\&#34;&gt;迭代运行&lt;/h2&gt;\n&lt;p&gt;这里使用了&lt;code&gt;purrr&lt;/code&gt;包的map函数进行泛函迭代，使用&lt;code&gt;progressr&lt;/code&gt;监视脚本运行的进程。这里尝试了下对失败的结果重新爬取，但是失败了，还是需要优化。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;multi_run_fun = function(name_list) {\n    name &amp;lt;- name_list %&amp;gt;% pull(knapsack_id) # 循环总数\n    p &amp;lt;- progressr::progressor(steps = length(name)); # progress bar\n    repeat {\n      b &amp;lt;- tryCatch({\n        b &amp;lt;- purrr::map_dfr(.x = name, .f = function(.x) { ## 泛函迭代\n          s.time = sample(runif(n = 50,1,3) %&amp;gt;% round(.,digits = 2),1) ##生成随机间隔时间\n          Sys.sleep(s.time);\n          p()\n          a &amp;lt;- name2cid_fun(x = .x) # 爬虫\n          return(a)\n        })\n        return(b)\n      }, error = function(e) {\n        message(&amp;quot;Error occurred: &amp;quot;, conditionMessage(e), &amp;quot;\\n&amp;quot;)\n        NULL\n      })\n      if (!is.null(b)) {\n        if (nrow(b) == length(name)) {\n          break\n        } else {\n          missing_names &amp;lt;- setdiff(name, b$Lab.ID)\n          message(paste0(&amp;quot;Missing &amp;quot;, length(missing_names), &amp;quot; entries, retrying...&amp;quot;))\n          name &amp;lt;- missing_names\n        }\n      } else {\n        message(&amp;quot;Retrying...&amp;quot;)\n      }\n    }\n    return(b)\n  }\n&lt;/code&gt;&lt;/pre&gt;\n&lt;h1 id=\&#34;规范化和规避反爬机制老六必备\&#34;&gt;规范化和规避反爬机制（老六必备）&lt;/h1&gt;\n&lt;p&gt;规范化的爬虫代码不仅有利于我们快速批量获取信息，也能最大程度上不影响目标网站的负载，如果我们不考虑这些，直接上多线程，不设置间隔时间暴力爬取信息很可能造成网站服务器崩溃，或者被反爬机制检测到，被ban。&lt;br&gt;\n逻辑上就是爬虫表现的越像人类的操作越好，人类不可能每秒进行上百次的网页点击操作。我们试想一下，同时全网有1000个人在某时段访问目标网页，使用的终端，访问的内容，查找的频率都不同。那么想模拟人类的操作注意：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;ip地址不同&lt;/li&gt;\n&lt;li&gt;使用的终端不同&lt;/li&gt;\n&lt;li&gt;访问间隔不同&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;其中解决不同ip的问题可以使用代理池，获得稳定的代理池具有一定的难度，如果目标网站反爬机制没有那么严格的话，我感觉没必要折腾这个，特别是对于GET类型的请求。&lt;br&gt;\n其次通过不同终端，这个比较好解决，多开几个不同厂家的浏览器，然后打开开发人员模式在&lt;code&gt;network&lt;/code&gt;查看&lt;code&gt;User_Agent&lt;/code&gt;,记录下来。然后建池，在R语言汇中使用&lt;code&gt;sample&lt;/code&gt;函数每次迭代随机选择。MAC电脑safari浏览器可以模拟不同的浏览器进行访问，这样就比较简单了，只需要在&lt;code&gt;Develop =&amp;gt; User Agent&lt;/code&gt;选项卡切换浏览器就可以了。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;user_agents = c(\n  &amp;quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.3 Safari/605.1.15&amp;quot;,\n  &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/110.0&#39;,\n  &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36 Edg/103.0.1264.37&#39;,\n  &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36 Edg/103.0.1264.37&#39;,\n  &#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36&#39;,\n  &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36&#39;,\n  &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:101.0) Gecko/20100101 Firefox/101.0&#39;\n)\nrandom_agent &amp;lt;- sample(user_agents,1)\n\nheaders = c(&#39;User_Agent&#39; = random_agent,&#39;Accept&#39; = &amp;quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&amp;quot;)\nurl &amp;lt;- &amp;quot;http://www.knapsackfamily.com/knapsack_core/result.php?sname=all&amp;amp;word=&amp;quot;\n\nhtml &amp;lt;- RCurl::getURL(url = paste0(url,ID),header = headers,.encoding = &#39;UTF-8&#39;)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;第三设置随机访问间隔，同样，我们随机生成n个&lt;code&gt;1-3&lt;/code&gt;秒之间的随机数，用&lt;code&gt;round&lt;/code&gt;把他控制在两位小数（没啥卵用），然后在开头用&lt;code&gt;Sys.sleep()&lt;/code&gt;设置停顿，这样每次迭代的时等待的时间长短不一样。也就模拟了你两次点击网站的间隔也是不同的。&lt;br&gt;\n这样我们每个1-3秒访问一次网站，对网站的负载影响也不会太剧烈。&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;r-crawler-gui-fan-hua-yu-ji-qiao&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;之前在使用&lt;code&gt;rvest&lt;/code&gt;,&lt;code&gt;RCurl&lt;/code&gt;以及&lt;code&gt;XML&lt;/code&gt;包编写爬虫时只是单纯的考虑到了信息提取和格式转换，没有考虑到爬虫对目标服务器的负载压力，之前也使用过暴力并行，虽然速度很快，但是对目标网站服务器负载造成了很大压力，这样既不道德，也不安全。被反爬机制检测到会封ip等。本次就实战中遇到问题解决问题做个总结。&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「R-Crawler」规范化与技巧&#34;,&#34;tags&#34;:[],&#34;date&#34;:&#34;2023-03-01 09:02:36&#34;,&#34;dateFormat&#34;:&#34;2023-03-01&#34;,&#34;feature&#34;:&#34;&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/r-crawler-gui-fan-hua-yu-ji-qiao/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;16 min read&#34;,&#34;time&#34;:928000,&#34;words&#34;:3293,&#34;minutes&#34;:16},&#34;description&#34;:&#34;之前在使用rvest,RCurl以及XML包编写爬虫时只是单纯的考虑到了信息提取和格式转换，没有考虑到爬虫对目标服务器的负载压力，之前也使用过暴力并行，虽然速度很快，但是对目标网站服务器负载造成了很大压力，这样既不道德，也不安全。被反爬机制...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E7%88%AC%E8%99%AB%E4%BB%A3%E7%A0%81\&#34;&gt;爬虫代码&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90\&#34;&gt;代码解析&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E9%97%AE%E9%A2%98%E4%B8%80%E5%8C%96%E5%90%88%E7%89%A9%E5%90%8D%E5%AD%97%E6%97%A0%E6%B3%95%E5%92%8C%E5%90%8C%E4%B9%89%E8%AF%8D%E5%8C%BA%E5%88%86%E5%BC%80\&#34;&gt;问题一：化合物名字无法和同义词区分开&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E9%97%AE%E9%A2%98%E4%B8%80%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F\&#34;&gt;问题一：处理方式&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E9%97%AE%E9%A2%98%E4%BA%8C%E7%BC%BA%E5%B0%91inchikey%E5%8F%8Asmile%E7%AD%89%E4%BF%A1%E6%81%AF\&#34;&gt;问题二：缺少&lt;code&gt;InChIKey&lt;/code&gt;及&lt;code&gt;SMILE&lt;/code&gt;等信息&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E9%97%AE%E9%A2%98%E4%BA%8C%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F\&#34;&gt;问题二：处理方式&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E7%BB%93%E6%9E%9C%E6%95%B4%E5%90%88\&#34;&gt;结果整合&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BF%AD%E4%BB%A3%E8%BF%90%E8%A1%8C\&#34;&gt;迭代运行&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%A7%84%E8%8C%83%E5%8C%96%E5%92%8C%E8%A7%84%E9%81%BF%E5%8F%8D%E7%88%AC%E6%9C%BA%E5%88%B6%E8%80%81%E5%85%AD%E5%BF%85%E5%A4%87\&#34;&gt;规范化和规避反爬机制（老六必备）&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;年前CJ大佬深度体验了下WGCNAshiny， 提了一些非常好的建议和意见，过年的时候折腾了几天，改善了一些东西，距离上次发布更新已经过去很久了，期间随着课题的进展，我自己也添加了一些内容。&lt;/p&gt;\n&lt;!--more--&gt;\n&lt;h2 id=\&#34;太长不看省流版本\&#34;&gt;太长不看省流版本&lt;/h2&gt;\n&lt;p&gt;&lt;strong&gt;安装方法：&lt;/strong&gt;&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;通过TBtools插件：&lt;a href=\&#34;https://zhuanlan.zhihu.com/p/590982545\&#34;&gt;新插件更新-TBtools&lt;/a&gt; 直接安装打包好的插件即可，非常方便！&lt;/li&gt;\n&lt;li&gt;Rstudio &lt;a href=\&#34;https://github.com/ShawnWx2019/WGCNA-shinyApp\&#34;&gt;ShawnWx2019/WGCNA-shinyApp&lt;/a&gt; ， 更新shinyapp之前，通过下面代码更新依赖包.&lt;/li&gt;\n&lt;/ol&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;devtools::install_github(&amp;quot;ShawnWx2019/WGCNAShinyFun&amp;quot;,ref = &amp;quot;master&amp;quot;)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;更新内容：&lt;/strong&gt;&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;🔨 改动了表达量矩阵输入类型。从之前的&lt;code&gt;count&lt;/code&gt;和&lt;code&gt;FPKM&lt;/code&gt;更新为&lt;code&gt;count&lt;/code&gt; 、&lt;code&gt;expected count&lt;/code&gt; 、&lt;code&gt;normalized count&lt;/code&gt;、&lt;code&gt;peak area&lt;/code&gt; 以及&lt;code&gt;protein abundance&lt;/code&gt;。更加准确和符合逻辑；&lt;/li&gt;\n&lt;li&gt;🍭 保留基因数量（reserved genes number）超过过滤后的基因数量会自动选择过滤后的基因数量；&lt;/li&gt;\n&lt;li&gt;🎊 去除离群样本（Remove outlier）；&lt;/li&gt;\n&lt;li&gt;🎊 在网络构建和模块-性状关系构建步骤增加progress bar，防止多次点击导致程序重复运行；&lt;/li&gt;\n&lt;li&gt;💪加入迭代WGCNA（iterative WGCNA）选项，开发中.... 不过可以通过&lt;code&gt;method2&lt;/code&gt;的方式净化模块。&lt;/li&gt;\n&lt;li&gt;🍭 参数输出，这里增加了&lt;code&gt;Env output&lt;/code&gt;选项卡，方便有R语言基础的同学保留shinyapp运行时使用的参数配置，结合R语言进行进一步分析，同时方便复现之前的结果。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&#34;啰嗦版本\&#34;&gt;啰嗦版本&lt;/h2&gt;\n&lt;h3 id=\&#34;为何要加入代谢组和蛋白组数据\&#34;&gt;为何要加入代谢组和蛋白组数据&lt;/h3&gt;\n&lt;p&gt;细心的同学注意到我在新版本中输入数据的&lt;code&gt;format&lt;/code&gt;有了很大改动。当然之前的count和FPKM太过随意了。下面从两部分解释下为何要修改成目前这样，当然也广泛接受大家的意见和建议，会在下个版本继续更新。&lt;/p&gt;\n&lt;p&gt;首先整体其实还是分了两大块，总结一下就是read count类型数据和其他类型数据。&lt;/p&gt;\n&lt;table&gt;\n&lt;thead&gt;\n&lt;tr&gt;\n&lt;th&gt;格式&lt;/th&gt;\n&lt;th&gt;特征&lt;/th&gt;\n&lt;th&gt;备注&lt;/th&gt;\n&lt;th&gt;标准化方法&lt;/th&gt;\n&lt;/tr&gt;\n&lt;/thead&gt;\n&lt;tbody&gt;\n&lt;tr&gt;\n&lt;td&gt;count&lt;/td&gt;\n&lt;td&gt;整数&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;vst&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;expected count&lt;/td&gt;\n&lt;td&gt;不全是整数&lt;/td&gt;\n&lt;td&gt;通过向上取整的方式转换为整数&lt;/td&gt;\n&lt;td&gt;vst&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;normalized count&lt;/td&gt;\n&lt;td&gt;归一化后的readcount&lt;/td&gt;\n&lt;td&gt;Fpkm tpm cpm rpkm 等&lt;/td&gt;\n&lt;td&gt;Raw/log10(x+1)&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;peak area（metabolomics）&lt;/td&gt;\n&lt;td&gt;一般数值会非常大&lt;/td&gt;\n&lt;td&gt;不推荐直接使用原始峰面积，需要使用标准化后的数值，比如商业软件CD，开源软件tidymass等进行数据过滤和归一化后的代谢物积累矩阵&lt;/td&gt;\n&lt;td&gt;Log10（x）&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;protein abundance&lt;/td&gt;\n&lt;td&gt;&lt;/td&gt;\n&lt;td&gt;同样需要归一化以后的蛋白质丰度。&lt;/td&gt;\n&lt;td&gt;Log10（x）&lt;/td&gt;\n&lt;/tr&gt;\n&lt;/tbody&gt;\n&lt;/table&gt;\n&lt;p&gt;这里值得注意的是我把非靶代谢和蛋白质组学的数据也放进来了，&lt;strong&gt;这并不意味着这类型的数据无论从数学原理出发还是生物学原理出发适合构建共表达网络。&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;我这里将非靶代谢组学的数据和蛋白质组学数据加入进来，&lt;strong&gt;本意是并不是非要通过WGCNA构建共表达网络，而是将WGCNA作为一种高效数据挖掘的方法。&lt;/strong&gt; 例如当我们在做大规模（large-scale）非靶代谢组学数据分析时，会发现我们会面临很多问题，比如对自然群体的非靶代谢组学分析，如果通过k-means，hclust等方法去归纳群体材料和代谢物类型之间的关系会很吃力，但是同过WGCNA将积累规律类似的代谢物进行模块划分，有很大几率总结出材料-代谢物之间的规律，提高了数据挖掘的效率。而后续的代谢物共积累网络构建则成为锦上添花的内容，并非重点。后续有机会可能会展开讲一下想法，不一定准确。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;UI改动：&lt;/strong&gt;&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;1\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732870.png\&#34; alt=\&#34;Figure 1. 数据输入改动\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;&lt;strong&gt;代码改动：&lt;/strong&gt;&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;getdatExpr = function(rawdata,RcCutoff,samplePerc,datatype,method){\n  ##&amp;gt; Noise filtering\n  x &amp;lt;-\n    rawdata %&amp;gt;%\n    setNames(c(&amp;quot;id&amp;quot;,colnames(.)[-1])) %&amp;gt;%\n    mutate(id = as.character(id)) %&amp;gt;% ## aviod numeric columns.\n    column_to_rownames(&amp;quot;id&amp;quot;) %&amp;gt;%\n    filter(\n      rowSums(. &amp;gt; RcCutoff) &amp;gt; (samplePerc*ncol(.))\n    )\n  if (\n    datatype == &amp;quot;expected count&amp;quot;\n  ) {\n    x &amp;lt;- x %&amp;gt;%\n      mutate_if(is.numeric,ceiling)\n  }\n  ##&amp;gt; Normalization\n  if(method == &amp;quot;vst&amp;quot;) {\n    dx &amp;lt;- x %&amp;gt;%\n      as.matrix() %&amp;gt;%\n      varianceStabilizingTransformation(., blind = TRUE)\n  } else if (method == &amp;quot;logarithm&amp;quot;) {\n    if (datatype == &amp;quot;normalized count&amp;quot;) {\n      dx &amp;lt;- log10(x+1)\n    } else {\n      dx &amp;lt;- log10(x)\n    }\n  } else if (method == &amp;quot;raw&amp;quot;) {\n    dx &amp;lt;- x\n  } else {\n    return()\n  }\n  return(dx)\n}\n&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&#34;程序防呆设计\&#34;&gt;程序防呆设计&lt;/h3&gt;\n&lt;p&gt;这些错误可以忽略掉了，放心造&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;&lt;strong&gt;规避纯数字基因名称&lt;/strong&gt; 根据用户的反馈，发现某些转录组数据的gene id是纯数字的，在R对纯数字的列转换成rownames如果不连续会报错，所以这里会把第一列直接转换成字符格式，防止该错误发生。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;自动转换标准化方式&lt;/strong&gt;，上面介绍了不同数据类型有对应的标准化方法，当然我知道不是每个用户都会认真读手册，所以这里做了自适应，在&lt;code&gt;format&lt;/code&gt;确定了格式后，&lt;code&gt;Normalized method&lt;/code&gt;只会显示对应的标准化方式选项。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;保留基因数量大于了过滤后总数&lt;/strong&gt; 这个也是常见的报错，如果你填写的&lt;code&gt;reserved gene Num.&lt;/code&gt;大于了过滤后的基因数量会导致报错，这里加了判断，如果这种情况发生，直接保留过滤后的基因数目。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h3 id=\&#34;进度条\&#34;&gt;进度条&lt;/h3&gt;\n&lt;p&gt;CJ大佬在体验的时候发现在等待时间较长的Module-net阶段，不知道运行完没有，有些用户可能会觉得是不是没点到&lt;code&gt;start&lt;/code&gt; 于是就又按了几次，特别是对于没有更新新版本&lt;code&gt;Rserver&lt;/code&gt;以及Rstudio用户中没有折腾&lt;code&gt;blas&lt;/code&gt;的用户，这个等待时间会更长，所以现在在module-net和module-trait加入了和&lt;code&gt;SFT&lt;/code&gt;步骤中一样的进度条，你点了就会跳&lt;code&gt;progress bar&lt;/code&gt;运行完消失。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;UI画面：&lt;/strong&gt;&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;2\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732854.png\&#34; alt=\&#34;Figure 2. Progress bar 添加\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;3\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732855.png\&#34; alt=\&#34;Figure 3. Module-Trait改动\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;h3 id=\&#34;去除离群样本\&#34;&gt;去除离群样本&lt;/h3&gt;\n&lt;p&gt;有时候数据量大的时候可能会出现离群样本，如下图，我们可以通过&lt;code&gt;RemoveOutlier（option）&lt;/code&gt;来去掉离群样本，由于shiny中比较难实现&lt;code&gt;do-over&lt;/code&gt;这样的过程，所以就得麻烦大家重新开始了，**开始上传前最好刷新下网页，并把鼠标点到第一个选项卡&lt;code&gt;input file check&lt;/code&gt;。然后再点&lt;code&gt;update information&lt;/code&gt;&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;4\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732856.png\&#34; alt=\&#34;Figure 4. 离群样本检测\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;5\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732858.png\&#34; alt=\&#34;Figure 5. 离群样本去除\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;h3 id=\&#34;迭代wgcna\&#34;&gt;迭代WGCNA&lt;/h3&gt;\n&lt;p&gt;关于迭代WGCNA，推荐看&lt;a href=\&#34;https://www.biorxiv.org/content/10.1101/234062v1\&#34;&gt;iterativeWGCNA: iterative refinement to improve module detection from WGCNA co-expression networks&lt;/a&gt; 作者用python搭建的流程，有需要的可以通过&lt;a href=\&#34;https://github.com/cstoeckert/iterativeWGCNA\&#34;&gt;cstoechert/iterativeWGCNA&lt;/a&gt; 实现。&lt;strong&gt;这部分我并没有用shinyapp复现&lt;/strong&gt; 确实难度比较大，加上之前说的do over很难，基本做不到自动迭代。所以&lt;code&gt;method1&lt;/code&gt;是没有用的。可能后续有精力了尝试折腾下。&lt;/p&gt;\n&lt;p&gt;这里&lt;code&gt;method2&lt;/code&gt;提到的迭代，原理和方法和上面是不一样的，我的目的也很明确，就是首先在可以获得到一个非常趋近于无标度网络的情况下（有非常合适的软阈值），这个网络首先是比较稳健的。然后在此基础上去掉无法分类的基因和一部分kME（eigengene based connectivity）较低的基因来纯化模块，迭代过程中sft可能发生细微的变化，但整体不会发生很大的变化。这样无论在数据挖掘还是后续的共表达网络可视化都会有一定程度的优化。&lt;/p&gt;\n&lt;p&gt;基本操作就是&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;基本原理：&lt;/strong&gt;&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;6\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202206081018077.png\&#34; alt=\&#34;Figure 6.基本原理\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;&lt;strong&gt;方法：&lt;/strong&gt;&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;7\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732279.png\&#34; alt=\&#34;Figure 7.筛选方法\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;&lt;strong&gt;项目示例：&lt;/strong&gt;&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;8\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732859.png\&#34; alt=\&#34;Figure 8. 迭代去除结果\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;h3 id=\&#34;环境变量导出\&#34;&gt;环境变量导出&lt;/h3&gt;\n&lt;p&gt;经常遇到这种问题，过了很长时间，想回来复现一下当时通过WGCNAshiny跑的结果，发现怎么也对应不上，后来发现是当时设置的参数忘记了，这里加入了&lt;code&gt;Env output&lt;/code&gt;，当做完&lt;code&gt;module-trait&lt;/code&gt;之后会看见该选项卡，点击数据整合&lt;code&gt;Integrate data&lt;/code&gt;会立刻把所有中间变量以&lt;code&gt;.rsd&lt;/code&gt;的形式保存下来，然后点击下载可以得到一个&lt;code&gt;EnvImg.rsd&lt;/code&gt;的文件。这个可以在Rstudio中通过&lt;code&gt;readRDS(&#39;filepath/EnvImg.rsd&#39;)&lt;/code&gt; 加载出来，这样不仅可以看到当时所有的参数，而且运行数据所有的中间变量都被保存，有R基础的可以直接拿去进行下游分析。&lt;/p&gt;\n&lt;p&gt;比如我们把EnvImg.rsd放在家目录下的&lt;code&gt;Download&lt;/code&gt;文件夹下&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;x &amp;lt;- readRDS(&amp;quot;~/Downloads/EnvImg.rds&amp;quot;)\n# 我们通过x$ 就可以查看参数和中间变量\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;x是一个列表&lt;code&gt;list&lt;/code&gt;，存放这所有的中间变量和参数&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;9\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202302281732860.png\&#34; alt=\&#34;Figure 9. 环境变量预览\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;h2 id=\&#34;最后\&#34;&gt;最后&lt;/h2&gt;\n&lt;p&gt;多谢CJ大佬提意见，还有群里的老铁们不断鞭策，鸽王又鸽了大家一回！😂&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;tbtools-plugin-wgcna-shiny-app-geng-xin&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;年前CJ大佬深度体验了下WGCNAshiny， 提了一些非常好的建议和意见，过年的时候折腾了几天，改善了一些东西，距离上次发布更新已经过去很久了，期间随着课题的进展，我自己也添加了一些内容。&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「TBtools-Plugin」WGCNA shiny app 更新&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;TBtools plugin&#34;,&#34;slug&#34;:&#34;8rkPmYxtv_&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/8rkPmYxtv_/&#34;},{&#34;name&#34;:&#34;Shiny app&#34;,&#34;slug&#34;:&#34;iiHZST6a6&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/iiHZST6a6/&#34;},{&#34;name&#34;:&#34;WGCNA&#34;,&#34;slug&#34;:&#34;1gwqOzUkvu&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/1gwqOzUkvu/&#34;},{&#34;name&#34;:&#34;TBtools&#34;,&#34;slug&#34;:&#34;7IQ4dQhrNC&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/7IQ4dQhrNC/&#34;},{&#34;name&#34;:&#34;插件&#34;,&#34;slug&#34;:&#34;fdXt7u8Hl5&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/fdXt7u8Hl5/&#34;}],&#34;date&#34;:&#34;2023-02-28 17:29:23&#34;,&#34;dateFormat&#34;:&#34;2023-02-28&#34;,&#34;feature&#34;:&#34;https://shawnwx2019.github.io/post-images/tbtools-plugin-wgcna-shiny-app-geng-xin.jpg&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/tbtools-plugin-wgcna-shiny-app-geng-xin/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:true,&#34;stats&#34;:{&#34;text&#34;:&#34;8 min read&#34;,&#34;time&#34;:467000,&#34;words&#34;:2099,&#34;minutes&#34;:8},&#34;description&#34;:&#34;年前CJ大佬深度体验了下WGCNAshiny， 提了一些非常好的建议和意见，过年的时候折腾了几天，改善了一些东西，距离上次发布更新已经过去很久了，期间随着课题的进展，我自己也添加了一些内容。\n\n太长不看省流版本\n安装方法：\n\n通过TBtoo...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%A4%AA%E9%95%BF%E4%B8%8D%E7%9C%8B%E7%9C%81%E6%B5%81%E7%89%88%E6%9C%AC\&#34;&gt;太长不看省流版本&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%95%B0%E5%97%A6%E7%89%88%E6%9C%AC\&#34;&gt;啰嗦版本&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%B8%BA%E4%BD%95%E8%A6%81%E5%8A%A0%E5%85%A5%E4%BB%A3%E8%B0%A2%E7%BB%84%E5%92%8C%E8%9B%8B%E7%99%BD%E7%BB%84%E6%95%B0%E6%8D%AE\&#34;&gt;为何要加入代谢组和蛋白组数据&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E7%A8%8B%E5%BA%8F%E9%98%B2%E5%91%86%E8%AE%BE%E8%AE%A1\&#34;&gt;程序防呆设计&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BF%9B%E5%BA%A6%E6%9D%A1\&#34;&gt;进度条&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%8E%BB%E9%99%A4%E7%A6%BB%E7%BE%A4%E6%A0%B7%E6%9C%AC\&#34;&gt;去除离群样本&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BF%AD%E4%BB%A3wgcna\&#34;&gt;迭代WGCNA&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%AF%BC%E5%87%BA\&#34;&gt;环境变量导出&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%9C%80%E5%90%8E\&#34;&gt;最后&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;emmm， 这篇文章后半部分还是面向TBtools插件开发者。原因和上一篇一样，因为操作太简单了&lt;/p&gt;\n&lt;p&gt;...&lt;/p&gt;\n&lt;!--more--&gt;\n&lt;p&gt;&lt;strong&gt;国际惯例，先上图&lt;/strong&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/shinyTBtoolsPlugin.jpg\&#34; alt=\&#34;Bubble_shiny\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;扯在前面的蛋\&#34;&gt;扯在前面的蛋&lt;/h2&gt;\n&lt;p&gt;&lt;strong&gt;紧急插播：&lt;/strong&gt;&lt;br&gt;\nmac用户在安装插件之前，需要先打开Rserver输入以下代码：&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;install.packages(&amp;quot;https://cran.r-project.org/bin/macosx/contrib/4.0/cachem_1.0.3.tgz&amp;quot;, repo=NULL,type=&amp;quot;source&amp;quot;)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;原因是&lt;code&gt;cachem&lt;/code&gt;包前几天更新了，是shiny的依赖包，不知道是tuna没有更新&lt;code&gt;cachem&lt;/code&gt;在macos下的二进制包还是怎么回事，R会从源码（src）编译，在win下没问题，但是貌似在mac下编译会出错... 所以mac用户这段时期只能安装&lt;code&gt;cran&lt;/code&gt;的&lt;code&gt;binaries&lt;/code&gt;，而且测试了下新的1.0.4版本貌似不能用，（不清楚是shiny没更新还是tuna的问题）1.0.3版本目前没问题。&lt;/p&gt;\n&lt;hr&gt;\n&lt;p&gt;自从CJ大佬打包了R之后，实现了不需要折腾linux或者unix终端，或者windows下用Rscript运行R脚本，直接通过点点点实现，其实这个操作在之前的Shiny中早就实现了，但是一直没有勇气去折腾... 潜哥和邵博建议我去鼓捣下，过年这段日子也没法干活，就跟着B站搬运油管的shiny app入门的视频教程学了起来。&lt;br&gt;\n传送门：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;B站： &lt;a href=\&#34;https://www.bilibili.com/video/BV1RJ411E7Fx?from=search&amp;amp;seid=4694507056464394541\&#34;&gt;手把手 如何制作R Shiny app&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;油管： &lt;a href=\&#34;https://www.youtube.com/watch?v=_0ORRJqctHE&amp;amp;list=UUbck9jjLpwj7U6HHNps_9Gw&amp;amp;t=0s\&#34;&gt;R Shiny app tutorial # 1 - How to make shiny apps - An introduction to Shiny&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;github: &lt;a href=\&#34;https://github.com/aagarw30/R-Shinyapp-Tutorial\&#34;&gt;R-Shinyapp-Tutorial&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;作者：&lt;em&gt;Abhinav Agrawal&lt;/em&gt;&lt;br&gt;\n这位老哥的教程可以说是一勺一勺喂，感觉在稍微精通R的情况下，只要不憨，把视频啃完，上手shiny App没问题...&lt;br&gt;\n额，时间有限，没有看完大佬的讲解，直接上github把代码撸下来看着理解。现在也基本看了不到1/5，了解一点点皮毛，就开始上手搞了...依样画葫芦，用辣眼睛的代码把之前的那个bubble plot做成了shiny app。虽然很粗糙，but，又不是不能用！&lt;/p&gt;\n&lt;p&gt;Shiny App的优点在于你可以实时调整参数而且看到调参后的结果，这个就很爽了。试想一下之后吧OneStepWGCNA写成Shiny App，可以放更多的参数，甚至可以分步做，第一步样品聚类剔除掉离群值，然后看sft选择合适的power，接着根据分模块的情况选择最小模块基因数量...后续还有拿出感兴趣的基因做GS MM，导出关系等...（我好像给自己挖了个坑...）&lt;/p&gt;\n&lt;p&gt;而今天的推文主要是我发现shiny app其实可以写成脚本用Rscript启动，然后本地测试，既然能用Rscript跑，那么就能搞成插件... 所以在情人节那天，搞了一天整出来了。后续还是CJ大佬的一个常规操作，点击运行后直接弹出浏览器，运行Shiny App。&lt;/p&gt;\n&lt;h2 id=\&#34;shiny-app界面\&#34;&gt;Shiny App界面&lt;/h2&gt;\n&lt;p&gt;简单来讲可以把它看做一个网页工具。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/shiny1.jpg\&#34; alt=\&#34;shiny app page\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n我们把左边的灰色的这一栏叫做&lt;code&gt;side bar&lt;/code&gt;里面是一些调节参数的部件，&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;Browse...&lt;/strong&gt; 点击后上传你的富集分析结果，&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Input File Type&lt;/strong&gt; 选择你输入的文件是什么软件导出的结果，TBtools的GO enrichment工具还是kegg enrichment工具，这两种结果可以直接上传软件生成的原始表格，但是其他富集分析的结果比如&lt;code&gt;David&lt;/code&gt;等一些其他软件导出的结果需要按照我之前提到的格式修改表格并且保存成&lt;strong&gt;制表符分隔符的txt文件&lt;/strong&gt;再进行导入。这里我放了GSEA的结果，这个是新加的。如果有GSEA的结果想要展示需要按照以下格式整理，就是将GSEA结果中&lt;code&gt;gsea_report_for_xxx.A.tsv&lt;/code&gt;和&lt;code&gt;gsea_report_for_xxx.B.tsv&lt;/code&gt;两个文件中的term合并，当然筛选条目的标准自己定义，这里不做推荐。GSEA结果的可视化现在还不完美，后续会继续调整...&lt;/li&gt;\n&lt;/ul&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;1\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/GSEA.jpg\&#34; alt=\&#34;GSEA demo\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;strong&gt;Select the value from Slider&lt;/strong&gt; 额，这里偷懒忘了改label了，这里其实想说的是&lt;strong&gt;The number of GO term (KEGG pathway) to be displayed&lt;/strong&gt; 就是图片上想展示的GO Term或者KEGG pathway数量。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Pvalue color Minimum/maxmum&lt;/strong&gt; pvalue的颜色范围，这个好理解，点开就是个取色板，玩过PS或者AI的同学应该熟悉。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Project name&lt;/strong&gt; 我执意保留的一个没啥用的选项... 用来区分你不同的富集分析结果导出图片的名字。&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;Graph size-width/height&lt;/strong&gt; 在插件版中，我自己写了一个&lt;code&gt;figsize&lt;/code&gt;的函数来自动调整图片大小随着 longest term和term number变化自动调节，这里吧这个权利还给了用户，让你自定义大小，输出自己看的顺眼的图片。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;右边有两个页面，一个Table，一个plot&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;table目前没有做扩展，只是简单的将你输入的表格显示出来，后续可能会出一些选项实现筛选，过滤等操作....&lt;/li&gt;\n&lt;li&gt;plot就是简洁明了的图片展示，现在还没有找到调整height的合适方法，不过可以达到预览的效果... 凑合用吧...&lt;/li&gt;\n&lt;li&gt;Download按钮\n&lt;ul&gt;\n&lt;li&gt;如果你GO term（或者kegg pathway）中最长的那个term又臭又长，我建议把size-width调大一点，如果你选择的GO term很多，比如100，建议把height也调大一点。不过那么大的图片基本放论文里不可能了....&lt;/li&gt;\n&lt;li&gt;后续可能会把上限调高一点... 看用户反馈&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;hr&gt;\n&lt;p&gt;下面内容适合插件开发者。&lt;/p&gt;\n&lt;h2 id=\&#34;tbtools-plugin-shiny-app-脚本结构\&#34;&gt;TBtools plugin Shiny App 脚本结构&lt;/h2&gt;\n&lt;p&gt;可能有人觉得我是脱了裤放屁，多此一举，都整成shiny app了，为啥还要打成TBtools插件，难道是在搞套娃吗..&lt;br&gt;\n其实不然，&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;首先，我没有自己的服务器去部署shiny app，即便之前买了3年的腾讯云，但是1核2G... 还是鸡肋。所以不如打包在自己的pc上跑；&lt;/li&gt;\n&lt;li&gt;其次，就算写好了R脚本，运行起来，不管通过Rstudio还是Rscript，都有一定的门槛，虽然很低...&lt;/li&gt;\n&lt;li&gt;不是说写成插件就所有人都会用了，还可能有一部分同学搞不明白，根据之前的反馈，多半是死在了包安装上... 但这是我能想到的目前可行的最方便的方法了...&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;我们看Shiny App的脚本结构基本分为&lt;code&gt;ui&lt;/code&gt;和&lt;code&gt;server&lt;/code&gt;两部分，最后&lt;code&gt;shinyApp(ui = ui, server = server)&lt;/code&gt;,当然要让软件跑起来，还需要预先做好准备工作所以我的脚本大概分为下面4部分：&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBtools-plugin%20ShinyApp.png\&#34; alt=\&#34;代码结构\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;准备工作\&#34;&gt;&lt;strong&gt;准备工作&lt;/strong&gt;&lt;/h2&gt;\n&lt;p&gt;一些预设选项和包加载，其中&lt;code&gt;shiny&lt;/code&gt;和&lt;code&gt;htmltools&lt;/code&gt;是必须装的，而且独立安装htmltools的版本和&lt;code&gt;shiny&lt;/code&gt;要求的版本不符,所以建议先装shiny，然后library一下，会提示需要装哪个版本的&lt;code&gt;htmltools&lt;/code&gt; 然后再装&lt;code&gt;htmltools&lt;/code&gt;就搞定了，另外&lt;code&gt;jscode&lt;/code&gt;这里和&lt;code&gt;shinyjs&lt;/code&gt;也写上，这些是为后面在界面上出现一个关闭APP按钮而设置的，不然你用插件打开shinny app后没办法关闭它，在你关机或重启之前，你那个localhost的端口会一直被占用。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;## options and import packages\noptions(stringsAsFactors = F)\noptions(&amp;quot;repos&amp;quot; = c(CRAN=&amp;quot;https://mirrors.tuna.tsinghua.edu.cn/CRAN/&amp;quot;))\njscode &amp;lt;- &amp;quot;shinyjs.closeWindow = function() { window.close(); }&amp;quot; # using shinyjs to stop shiny app\nif (!require(&#39;shiny&#39;)) install.packages(&#39;shiny&#39;)\nlibrary(shiny)\nif (!require(&#39;htmltools&#39;)) install.packages(&#39;htmltools&#39;)\nif (!require(&#39;ggplot2&#39;)) install.packages(&#39;ggplot2&#39;)\nif (!require(&#39;dplyr&#39;)) install.packages(&#39;dplyr&#39;)\nif (!require(&#39;stringr&#39;)) install.packages(&#39;stringr&#39;)\nif (!require(&#39;magrittr&#39;)) install.packages(&#39;magrittr&#39;)\nif (!require(&#39;shinyjs&#39;)) install.packages(&#39;shinyjs&#39;)\nif (!require(&#39;colourpicker&#39;)) install.packages(&#39;colourpicker&#39;)\nlibrary(shiny)\nlibrary(shinyjs)\nlibrary(colourpicker)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(magrittr)\nlibrary(stringr)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&#34;提前写好function\&#34;&gt;&lt;strong&gt;提前写好function&lt;/strong&gt;&lt;/h2&gt;\n&lt;p&gt;主要是方便后面调用，如果到了server中再去写这些会使server部分的代码看起来很臃肿，其次是这些function我提前写好了....&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;## functions\n## 01.GO Bubble Plot\n## function中内容太长了，省略掉了\nGOBubblePlot = function(expfile, num, name,colormin,colormax,Gtype){...}\nKEGGBubblePlot = function(expfile, num, name,colormin,colormax,Gtype){...}\ncustomBubblePlot = function(expfile, num, name,colormin,colormax,Gtype){...}\nGSEAplot = function(expfile, num, name,colormin,colormax,Gtype){...}\n&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&#34;ui界面\&#34;&gt;&lt;strong&gt;ui（界面）&lt;/strong&gt;&lt;/h2&gt;\n&lt;p&gt;没有用shinydashboard，就默认的...美化之类的是以后有空琢磨的事，现在的任务就是把它跑出来。 节省版面，具体设置省略 代码放在gitee.&lt;br&gt;\n大框架就是先整一个fluidPage，下层分别是：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;标题框&lt;/li&gt;\n&lt;li&gt;调用shinyjs&lt;/li&gt;\n&lt;li&gt;动作是关闭窗口&lt;/li&gt;\n&lt;li&gt;动作按钮设置&lt;/li&gt;\n&lt;li&gt;sidebar 框架\n&lt;ul&gt;\n&lt;li&gt;sidebar (参数调整界面）&lt;/li&gt;\n&lt;li&gt;mainPanel （结果呈现界面）&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;ui = shinyUI(fluidPage(\n  titlePanel(h4(&amp;quot;Enrichment Bubble Plot&amp;quot;)),\n  \n  # stop shiny app via js code\n  useShinyjs(),\n  extendShinyjs(text = jscode, functions = c(&amp;quot;closeWindow&amp;quot;)),\n  actionButton(&amp;quot;close&amp;quot;, &amp;quot;Stop the App&amp;quot;, class = &amp;quot;btn-warning&amp;quot;),\n  # sidebar setting\n  sidebarLayout(\n    sidebarPanel(\n      # Input files\n      fileInput(inputId = &amp;quot;file&amp;quot;,\n                label = &amp;quot;Upload enrichment result&amp;quot;),\n      help(&amp;quot;The results of TBtools enrichment can be uploaded directly, results generated from other softwares need to be input in the required format&amp;quot;),\n      # Select the input file type.\n      radioButtons(...),\n      # Term number, how many terms do you want to demonstrate\n      sliderInput(...),\n      # Min color\n      colourpicker::colourInput(...),\n      # Max color\n      colourpicker::colourInput(...),\n      # Graph type, bubble plot or bar plot\n      radioButtons(...),\n      # Project name\n      textInput(...),\n      # output graph size width\n      sliderInput(...),\n      # output graph size height\n      sliderInput(...),\n      p( &amp;quot;If there is a longer GO term or Pathway name, it is recommended to increase the width of the picture. If the number of terms you select is to large, it is recommended to increase the height of the picture.&amp;quot;)\n    ),\n    # demonstration part\n    mainPanel(\n      uiOutput(&amp;quot;tb&amp;quot;)\n      )\n    )\n  )\n)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&#34;server代码执行\&#34;&gt;&lt;strong&gt;server(代码执行)&lt;/strong&gt;&lt;/h2&gt;\n&lt;p&gt;辣眼睛的来了...&lt;br&gt;\n如果把ui界面想成参数设置的板块，那么server这块就是用之前的参数，数据进行处理，最终生成结果。&lt;br&gt;\n学艺不精... 本着能用就行的态度写了这一串又臭又长的reactive... 早上邵阳老铁指出可以精简的方法，哈哈，正在消化。其实也可以看出在写server板块之前先把function写好，确实会让server代码看起来更加清爽一点..&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;\nserver &amp;lt;- shinyServer(function(input,output){\n  ## set para\n  DataF &amp;lt;- reactive({\n    as.character(input$DataF)\n  })\n  num &amp;lt;- reactive({\n    as.numeric(input$num)\n  })\n  name &amp;lt;- reactive({\n    as.character(input$name)\n  })\n  colormin &amp;lt;- reactive({\n    as.character(input$colormin)\n  })\n  colormax &amp;lt;- reactive({\n    as.character(input$colormax)\n  })\n  Gtype &amp;lt;- reactive({\n    as.character(input$Gtype)\n  })\n  w &amp;lt;- reactive({\n    as.numeric(input$w)\n  })\n  h &amp;lt;- reactive({\n    as.numeric(input$h)\n  })\n  # import file\n  data &amp;lt;- reactive({...\n  })\n  ## show tables\n  output$finalTable &amp;lt;- renderTable({...\n  })\n\n  p &amp;lt;- reactive({\n    if(is.null(data())){return()}\n    if (DataF() == &amp;quot;TBtools_GO&amp;quot;) {\n      GOBubblePlot(...)\n    } else if (DataF() == &amp;quot;TBtools_KEGG&amp;quot;) {\n      KEGGBubblePlot(...)\n    } else if (DataF() == &amp;quot;customized&amp;quot;) {\n      customBubblePlot(...)\n    } else if (DataF() == &amp;quot;GSEA&amp;quot;) {\n      GSEAplot(...)\n    }\n  })\n  ## exhibit plot\n  output$finalplot &amp;lt;- renderPlot({\n    p()\n  })\n  ## download\n  output$down &amp;lt;- downloadHandler(\n    filename = function(){\n      paste0(name(),&amp;quot;Bubble_plot.pdf&amp;quot;)\n    },\n    content = function(file){\n      ggsave(file,plot = p(),width = w(),height = h(),dpi = 300)\n    }\n  )\n  ## table sets\n  output$tb &amp;lt;- renderUI({\n    if(is.null(data()))\n      h5(&amp;quot;Please upload your enrichment result&amp;quot;)\n    else\n      tabsetPanel(tabPanel(title = &amp;quot;Table&amp;quot;,tableOutput(&amp;quot;finalTable&amp;quot;)),\n#                  tabPanel(title = &amp;quot;Information&amp;quot;,tableOutput(&amp;quot;info&amp;quot;)),\n                  tabPanel(title = &amp;quot;plot&amp;quot;,\n                           plotOutput(&amp;quot;finalplot&amp;quot;),\n                           downloadButton(&amp;quot;down&amp;quot;,&amp;quot;Download the plot in PDF formate&amp;quot;)))\n})\n  ## close window\n  observeEvent(input$close, {\n    js$closeWindow()\n    stopApp()\n  })\n}) \n&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&#34;总结\&#34;&gt;总结&lt;/h2&gt;\n&lt;p&gt;写shiny的确是一种挑战，我这次小试牛刀就感觉真的麻烦无比，但是这种感觉好像刚开始学习R一样，或许写着写着就熟练了... 先达到能用，再到界面布局优化，再到代码高效，整洁。蹒跚学步，抛砖引玉... 最后期待下各位大神的作品吧！&lt;br&gt;\n献丑了...&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;「TBtools-Plugin」如何把Shiny-App搞成TBtools插件&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;emmm， 这篇文章后半部分还是面向TBtools插件开发者。原因和上一篇一样，因为操作太简单了&lt;/p&gt;\n&lt;p&gt;...&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「TBtools Plugin」如何把Shiny App搞成TBtools插件 &#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;Shiny app&#34;,&#34;slug&#34;:&#34;iiHZST6a6&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/iiHZST6a6/&#34;},{&#34;name&#34;:&#34;TBtools&#34;,&#34;slug&#34;:&#34;7IQ4dQhrNC&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/7IQ4dQhrNC/&#34;},{&#34;name&#34;:&#34;插件&#34;,&#34;slug&#34;:&#34;fdXt7u8Hl5&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/fdXt7u8Hl5/&#34;},{&#34;name&#34;:&#34;富集分析&#34;,&#34;slug&#34;:&#34;juU6QRjoHA&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/juU6QRjoHA/&#34;}],&#34;date&#34;:&#34;2023-02-27 17:09:45&#34;,&#34;dateFormat&#34;:&#34;2023-02-27&#34;,&#34;feature&#34;:&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202208250844719.jpg&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/「TBtools-Plugin」如何把Shiny-App搞成TBtools插件/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;12 min read&#34;,&#34;time&#34;:671000,&#34;words&#34;:2705,&#34;minutes&#34;:12},&#34;description&#34;:&#34;emmm， 这篇文章后半部分还是面向TBtools插件开发者。原因和上一篇一样，因为操作太简单了\n...\n\n国际惯例，先上图\n\n扯在前面的蛋\n紧急插播：\nmac用户在安装插件之前，需要先打开Rserver输入以下代码：\ninstall.pa...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%89%AF%E5%9C%A8%E5%89%8D%E9%9D%A2%E7%9A%84%E8%9B%8B\&#34;&gt;扯在前面的蛋&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#shiny-app%E7%95%8C%E9%9D%A2\&#34;&gt;Shiny App界面&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#tbtools-plugin-shiny-app-%E8%84%9A%E6%9C%AC%E7%BB%93%E6%9E%84\&#34;&gt;TBtools plugin Shiny App 脚本结构&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C\&#34;&gt;&lt;strong&gt;准备工作&lt;/strong&gt;&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%8F%90%E5%89%8D%E5%86%99%E5%A5%BDfunction\&#34;&gt;&lt;strong&gt;提前写好function&lt;/strong&gt;&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#ui%E7%95%8C%E9%9D%A2\&#34;&gt;&lt;strong&gt;ui（界面）&lt;/strong&gt;&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#server%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C\&#34;&gt;&lt;strong&gt;server(代码执行)&lt;/strong&gt;&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%80%BB%E7%BB%93\&#34;&gt;总结&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;上次从uniprot网站用rvest提取了亚细胞定为的信息，这次还是冲uniprot用爬虫提取每个uniprotid对应的GOterm信息。&lt;/p&gt;\n&lt;p&gt;...&lt;/p&gt;\n&lt;!-- more --&gt;\n&lt;h2 id=\&#34;原理和收获\&#34;&gt;原理和收获&lt;/h2&gt;\n&lt;p&gt;这次又尝试了两个函数&lt;code&gt;html_elements&lt;/code&gt;和&lt;code&gt;html_attr&lt;/code&gt;&lt;br&gt;\n之前直接粗暴的从&lt;code&gt;read_html&lt;/code&gt;+&lt;code&gt;html_text&lt;/code&gt;提取一堆信息，而这次则是有条理的查找，首先我们从edge（chrome）浏览器打开&lt;a href=\&#34;https://www.uniprot.org/uniprot/C0LGQ9\&#34;&gt;GOLGQ9&lt;/a&gt;的信息，然后用开发者模式查看html代码,我们可以通过移动鼠标选择特定位置查看他对应网页元素，最终我们一层一层打开后发现我们需要的GO ID在&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-html\&#34;&gt;&amp;lt;div class = &amp;quot;section&amp;quot; id = &amp;quot;function&amp;quot;&amp;gt;\n    &amp;lt;ul class = noBumbering xxx&amp;gt;\n        &amp;lt;li class=&amp;quot;GOxxx&amp;quot;&amp;gt;\n            &amp;lt;a href=&amp;quot;http://url&amp;quot;...&amp;gt;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;当然除了BP应该还有CC，MF。 所以思路就是定位到&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20211129094658.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;「R-Crawler」根据uniprot-ID批量提取GO-ID&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;上次从uniprot网站用rvest提取了亚细胞定为的信息，这次还是冲uniprot用爬虫提取每个uniprotid对应的GOterm信息。&lt;/p&gt;\n&lt;p&gt;...&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「R-Crawler」根据uniprot ID批量提取GO ID&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;爬虫&#34;,&#34;slug&#34;:&#34;WI8rOT5yu&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/WI8rOT5yu/&#34;},{&#34;name&#34;:&#34;R&#34;,&#34;slug&#34;:&#34;G_5eRHzJub&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/G_5eRHzJub/&#34;}],&#34;date&#34;:&#34;2021-11-25 12:24:07&#34;,&#34;dateFormat&#34;:&#34;2021-11-25&#34;,&#34;feature&#34;:&#34;&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/「R-Crawler」根据uniprot-ID批量提取GO-ID/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;1 min read&#34;,&#34;time&#34;:49000,&#34;words&#34;:206,&#34;minutes&#34;:1},&#34;description&#34;:&#34;上次从uniprot网站用rvest提取了亚细胞定为的信息，这次还是冲uniprot用爬虫提取每个uniprotid对应的GOterm信息。\n...\n\n原理和收获\n这次又尝试了两个函数html_elements和html_attr\n之前直接...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%8E%9F%E7%90%86%E5%92%8C%E6%94%B6%E8%8E%B7\&#34;&gt;原理和收获&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;课题遇到一个需求，需要从&lt;code&gt;uniprot&lt;/code&gt; 网站数据库中查询目标蛋白的亚细胞定位情况，徒手一个一个搞肯定不行，这就需要使用爬虫了&lt;/p&gt;\n&lt;p&gt;...&lt;/p&gt;\n&lt;!-- more --&gt;\n&lt;h2 id=\&#34;应用场景\&#34;&gt;应用场景&lt;/h2&gt;\n&lt;p&gt;得到一组基因后想看这些基因或者蛋白质在&lt;a href=\&#34;https://www.uniprot.org/\&#34;&gt;uniprot&lt;/a&gt;中亚细胞定位的结果，我们以一个actin基因为例，我们之前从蛋白组数据中得知该基因的&lt;code&gt;UniprotKB&lt;/code&gt;号为：&lt;code&gt;P07830&lt;/code&gt;，打开uniprot搜索P07830得到：&lt;a href=\&#34;https://www.uniprot.org/uniprot/P07830\&#34;&gt;uniprot-P07830&lt;/a&gt;.&lt;br&gt;\n在&lt;code&gt;uniprot annotation&lt;/code&gt;中我们发现定位只有细胞骨架（cytoskeleton），此外还有一个&lt;code&gt;GO term cell component&lt;/code&gt;的注释，这里面除了在细胞骨架外还有注释到其他部位。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20211103090404.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20211103090437.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;如果一个一个搜，5000多个要搜很久，关键是数量阅读，手工搜越容易出错，所以通过对网页观察，写一个爬虫，批量搜索是必要的。&lt;/p&gt;\n&lt;h2 id=\&#34;特征\&#34;&gt;特征&lt;/h2&gt;\n&lt;p&gt;首先我们在点击左边导航栏的Subcellular location，我们再看地址栏的url变成了&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-html\&#34;&gt;https://www.uniprot.org/uniprot/P07830#subcellular_location\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;其实对于不同的基因来说，亚细胞定位的网址规则就为&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-html\&#34;&gt;https://www.uniprot.org/uniprot/ + UniprotKB + #subcellular_location\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;整体信息提取的思路就清晰了：&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;通过上述网址规则逐个将每个基因的亚细胞定位信息从uniprot爬取下来。&lt;/li&gt;\n&lt;li&gt;通过正则或者其他手段检测我们需要的亚细胞定位信息。&lt;/li&gt;\n&lt;li&gt;整理表格输出。&lt;/li&gt;\n&lt;/ol&gt;\n&lt;h2 id=\&#34;运行\&#34;&gt;运行&lt;/h2&gt;\n&lt;p&gt;这里我们检测一系列蛋白是否会定位到叶绿体，&lt;br&gt;\n所以我们需要提取的信息就很简单了，看亚细胞定位的结果中包不包含叶绿体（chloroplastic）&lt;/p&gt;\n&lt;p&gt;这里用R的rvest包进行&lt;/p&gt;\n&lt;p&gt;首先我们看用rvest爬取效果&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;## 先测试下 UniprotKB 为 P19366 \nurl_test = &amp;quot;https://www.uniprot.org/uniprot/P19366#subcellular_location&amp;quot;\nread_html(url_test) %&amp;gt;% \n      rvest::html_text() \n## 结果\n[1] &amp;quot;atpB - ATP synthase subunit beta, chloroplastic - Arabidopsis thaliana (Mouse-ear cress) - atpB gene &amp;amp; protein\\n\\t\\t\\tvar BASE = &#39;/&#39;;\\n\\t\\t\\n\\t\\t\\t\\tuniprot.isInternal = false;\\n\\t\\t\\t\\tuniprot.namespace = &#39;uniprot&#39;;\\n\\t\\t\\t\\tuniprot.releasedate = &#39;2021_03&#39;;\\n\\t\\t\\t\\n\\t\\t\\t;\\n\\t\\t\\n\\t\\t\\t\\t// variable to store annotation data\\n\\t\\t\\t\\tvar annotations = [];\\n\\t\\t\\t\\tvar entryId = &#39;P19366&#39;;\\n\\t\\t\\t\\tvar isObsolete = false || !true;\\n\\t\\t\\t\\r\\n                                    &amp;lt;p&amp;gt;An evidence describes the source of an annotation, e.g. an experiment that has been published in the scientific literature, an orthologous protein, a record from another database, etc.&amp;lt;/p&amp;gt;\\r\\n\\r\\n&amp;lt;p&amp;gt;&amp;lt;a href=\\&amp;quot;/manual/evidences\\&amp;quot;&amp;gt;More...&amp;lt;/a&amp;gt;&amp;lt;/p&amp;gt;\\r\\n                                Skip Header   UniProtKBxUniProtKBProtein knowledgebaseUniParcSequence archiveHelpHelp pages, FAQs, UniProtKB manual, documents, news archive and Biocuration projects.UniRefSequence clustersProteomesProtein sets from fully sequenced genomesAnnotation systemsSystems used to automatically annotate proteins with high accuracy:UniRule (Expertly curated rules)ARBA (System generated rules)Supporting dataSelect one of the options below to target your search:Literature citationsTaxonomyKeywordsSubcellular locationsCross-referenced databasesHuman diseasesAdvancedSearchxHomeBLASTAlignRetrieve/ID mappingPeptide searchSPARQLContactHelpYou are using a version of browser that may not display all the features of this website. Please consider upgrading your browser.\\n\\t\\tThe new UniProt website is here! \\n\\t\\tTake me to UniProt BETAxUniProtKB - P19366\\n\\t\\t\\t(ATPB_ARATH)Basket 0(max 400 entries)x\\n\\t\\t\\t\\t\\tYou...\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;我们看结果中有对该基因的注释中有大量的叶绿体（chloroplast）字段，看了下这些字段首先出现在.svg的图片中，说明是亚细胞定位的图片，其次是【pubmed】引用文献，最后是同源基因的描述，所以基本可以确定这个&lt;code&gt;P19366&lt;/code&gt;是定位在叶绿体了，同时从他的基因annotation中也可以看出这个基因是叶绿体基因组编码的。所以接下来就直接用&lt;code&gt;grepl&lt;/code&gt;去判断爬出来的这段乱七八糟的字符串中包不包含叶绿体（chloroplast）就可以判断了。&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-r\&#34;&gt;# 加载包\nlibrary(rvest)\nlibrary(tidyverse)\n## 读取UniprotKB 信息\ntest.p = read.delim(&amp;quot;~/15.PostDoc/02.Project/13.cyl/result.txt&amp;quot;,header = T,sep = &amp;quot;\\t&amp;quot;)\nhead(test.p)\n## 提取accession\nacc = test.p$Accession\n## 制作一个acc为第一列，第二列先填写0，用于后面循环中提取结果的放置\ndf = data.frame(\n  Accession = acc,\n  Chlo_TorF = 0\n)\n\n## 开始爬数据\nfor (i in 1:length(acc)) {\n  Sys.sleep(0.5)\n  tryCatch({\n    url = paste0(&amp;quot;https://www.uniprot.org/uniprot/&amp;quot;,acc[i],&amp;quot;#subcellular_location&amp;quot;)\n    torf = read_html(url) %&amp;gt;% \n      rvest::html_text() %&amp;gt;% \n      grepl(pattern = &amp;quot;chloroplast&amp;quot;,x = .)\n    df[i,2] = as.character(torf)\n    print(paste0(acc[i],&amp;quot; finish&amp;quot;))\n  },error = function(e) {\n    print(paste0(acc[i],&amp;quot; has no search result in uniprot&amp;quot;))}\n  )\n}\n## 由于网络问题，有部分基因可能会爬取失败，没有打包function，就找到他们再来一遍最后合并一下。如果还有没有爬出来的，再重复一遍\n## 给每个基因编号\ndf$seq = c(1:nrow(df)\n## 找到搜索失败的基因对应的编号\ndf %&amp;gt;% \n  filter(x == 0) %&amp;gt;% \n  select(seq) %&amp;gt;% -&amp;gt;xx\n## 处理成向量形式\nxx = xx$seq\n## 重新填充\nfor (i in xx) {\n  Sys.sleep(0.5)\n  tryCatch({\n    url = paste0(&amp;quot;https://www.uniprot.org/uniprot/&amp;quot;,acc[i],&amp;quot;#subcellular_location&amp;quot;)\n    torf = read_html(url) %&amp;gt;% \n      rvest::html_text() %&amp;gt;% \n      grepl(pattern = &amp;quot;chloroplast&amp;quot;,x = .)\n    df[i,2] = as.character(torf)\n    print(paste0(acc[i],&amp;quot; finish&amp;quot;))\n  },error = function(e) {\n    print(paste0(acc[i],&amp;quot; has no search result in uniprot&amp;quot;))}\n  )\n}\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;结果我们会得到一张表格，第一列是UniprotKB ID，第二列是判断是否包含叶绿体，这样就把我们query中的基因是否在亚细胞定位结果中出现叶绿体做了批量判断。&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;「R-Crawler」根据uniprot-ID批量检测基因的亚细胞定位&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;课题遇到一个需求，需要从&lt;code&gt;uniprot&lt;/code&gt; 网站数据库中查询目标蛋白的亚细胞定位情况，徒手一个一个搞肯定不行，这就需要使用爬虫了&lt;/p&gt;\n&lt;p&gt;...&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「R-Crawler」根据uniprot ID批量检测基因的亚细胞定位&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;爬虫&#34;,&#34;slug&#34;:&#34;WI8rOT5yu&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/WI8rOT5yu/&#34;},{&#34;name&#34;:&#34;R&#34;,&#34;slug&#34;:&#34;G_5eRHzJub&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/G_5eRHzJub/&#34;}],&#34;date&#34;:&#34;2021-11-03 08:48:52&#34;,&#34;dateFormat&#34;:&#34;2021-11-03&#34;,&#34;feature&#34;:&#34;&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/「R-Crawler」根据uniprot-ID批量检测基因的亚细胞定位/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;6 min read&#34;,&#34;time&#34;:345000,&#34;words&#34;:1271,&#34;minutes&#34;:6},&#34;description&#34;:&#34;课题遇到一个需求，需要从uniprot 网站数据库中查询目标蛋白的亚细胞定位情况，徒手一个一个搞肯定不行，这就需要使用爬虫了\n...\n\n应用场景\n得到一组基因后想看这些基因或者蛋白质在uniprot中亚细胞定位的结果，我们以一个actin基...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF\&#34;&gt;应用场景&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E7%89%B9%E5%BE%81\&#34;&gt;特征&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BF%90%E8%A1%8C\&#34;&gt;运行&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;原本以为毕业了就起飞了，没想到，喵的比没毕业还累...&lt;br&gt;\n又鸽了仨月，这个小插件到时完善了不少，但是上次承诺的视频还是没有录。原因不说了，准备手打！ 还是写个教程为好。录视频，怕是要不知何年何月了...&lt;/p&gt;\n&lt;p&gt;对比大佬的下班时间发现，忙从来不是借口，懒才是....&lt;/p&gt;\n&lt;!-- more --&gt;\n&lt;p&gt;本文只是对WGCNAShiny软件使用的介绍，关于WGCNA原理建议阅读文献，简书知乎B站各位大佬也有讲解，我自己并没有把握讲清楚。下面放一个生信技能树的原理讲解，推荐大家花点时间看一下。有能力的跟着操作一遍加深理解。关于结果怎么看，这个听别人讲听不明白，多看几篇文献就搞清楚了。&lt;/p&gt;\n&lt;p&gt;&lt;a href=\&#34;https://www.bilibili.com/video/BV1584y1F7pw?from=search&amp;amp;seid=2638791580096845062&amp;amp;spm_id_from=333.337.0.0\&#34;&gt;生信技能树-WGCNA原理与实践part1 &lt;/a&gt;&lt;/p&gt;\n&lt;p&gt;&lt;a href=\&#34;https://www.bilibili.com/video/BV1tf4y1s7fy?from=search&amp;amp;seid=2638791580096845062&amp;amp;spm_id_from=333.337.0.0\&#34;&gt;生信技能树-WGCNA原理与实践part2&lt;/a&gt;&lt;/p&gt;\n&lt;p&gt;&lt;a href=\&#34;https://elifesciences.org/articles/29655\&#34;&gt;elife-WGCNA经典文献&lt;/a&gt;&lt;/p&gt;\n&lt;p&gt;篇幅太长 就不扯淡了&lt;/p&gt;\n&lt;h2 id=\&#34;怎么安装\&#34;&gt;怎么安装&lt;/h2&gt;\n&lt;p&gt;&lt;strong&gt;方法一：&lt;/strong&gt; 对于熟练使用R和Rstudio的老铁们，而且遇见报错能通过google，Stack Overflow等途径自己搞定的同学，直接去我的&lt;a href=\&#34;https://github.com/ShawnWx2019/WGCNA-shinyApp\&#34;&gt;github仓库&lt;/a&gt; 克隆到本地或者直接下载&lt;code&gt;WGCNAbyClick.v1.R&lt;/code&gt;脚本。然后用Rstudio打开，点击下图中位置的&lt;code&gt;RunApp&lt;/code&gt;直接运行，如果你运气好，直接就装上了，然后弹出网页就可以直接做了，但大概率你运气会不太好，底下一堆报错，然后就靠你自己的本事debug把没有装上的包装上了，我的锅，为了让这个shinyapp更好用，调了一堆奇葩包。😂 &lt;strong&gt;「友情提示」：务必将你的R升级到4.1！！！！&lt;/strong&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA2.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;方法二：&lt;/strong&gt; 如果你不想折腾，就用TBtools插件安装吧！！CJ大佬为了帮大家搞定包安装专门开发了R Plugin Installer Helper插件！由于我太菜了，😭目前WGCNAShiny的&lt;code&gt;meta-package&lt;/code&gt;木有搞出来，不过很快会向大家见面。使用方法:&lt;a href=\&#34;https://mp.weixin.qq.com/s/cYte0z-m1J6Rr22I-vRVvw\&#34;&gt;&lt;strong&gt;生信药丸 解决方案！TBtools R Plugin 安装~ 终极奥义&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;更新内容\&#34;&gt;更新内容&lt;/h2&gt;\n&lt;p&gt;和之前的&lt;code&gt;OneStepWGCNA插件&lt;/code&gt;相比确实改变了很多，开放和更多的参数，也使大家体验一下调参侠的日常，&lt;code&gt;WGCNAshiny&lt;/code&gt;推出后我考虑要下架&lt;code&gt;OneStepWGCNA&lt;/code&gt;因为他不够&lt;strong&gt;智能&lt;/strong&gt;，很可能一些数据格式或者设置的错误会导致错误的结果。&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;☆☆☆☆ 保留了极低表达量筛选的步骤，这个根据&lt;a href=\&#34;https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/faq.html\&#34;&gt;WGCNA-FAQ&lt;/a&gt;(对于所有想做WGCNA分析的同学，不管你会不会敲代码，这个真的推荐所有人看一遍，即使你不看WGCNA的原文，WGCNA tutorials，这个还是非常值得看一下的。因为你头顶很多问号这里面都给你掰扯明白了)&lt;/li&gt;\n&lt;li&gt;☆ 增加了数据变异程度筛选方法&lt;code&gt;var&lt;/code&gt;,可以选择通过绝对中位差（MAD）筛还是变异系数（Var）筛。&lt;/li&gt;\n&lt;li&gt;☆ 增加了原始数据格式防呆，比如有NA啦，有非数字形式的字符串啦。&lt;/li&gt;\n&lt;li&gt;☆☆☆☆☆ 增加了sft的自由选择，这次直接把软阈值的选择权利完全放给你，可以通过软阈值计算结果自由选择，而不是在选择不到合适的软阈值时强行使用经验的软阈值。&lt;/li&gt;\n&lt;li&gt;☆☆☆☆☆ 增加了当前软阈值下网络的non-scale检测。&lt;/li&gt;\n&lt;li&gt;☆☆☆☆☆☆ 放开了&lt;code&gt;MaxBlockSize&lt;/code&gt;参数，这样就可以摆脱电脑内存大小的限制，可以加入更多的基因进行WGCNA分析，不过如果硬件条件允许的情况下尽量把所有的基因放到一个block计算。&lt;/li&gt;\n&lt;li&gt;☆☆☆☆☆☆ 放开了&lt;code&gt;minModuleSize&lt;/code&gt;和&lt;code&gt;mergeCutHeight&lt;/code&gt;参数, 这样你就可以灵活的调整模块大小和模块数量。&lt;/li&gt;\n&lt;li&gt;☆☆☆☆☆☆ 用&lt;code&gt;ggplot&lt;/code&gt;重画了WGCNA主要的图，修正了上一个shinyapp版本的一个错误。&lt;/li&gt;\n&lt;li&gt;☆☆☆☆☆☆ 用&lt;code&gt;ComplexHeatmap&lt;/code&gt;画&lt;strong&gt;module-trait&lt;/strong&gt;图，放开了颜色选择，可以根据自己的喜好调整颜色，毕竟颜值即正义。&lt;/li&gt;\n&lt;li&gt;☆☆☆☆☆☆ 用&lt;code&gt;updateSelectInput&lt;/code&gt;升级了之前手动填写module，trait的智障操作，现在可以根据module-trait的结果自动升级后续感兴趣模块性状和模块名字，直接选择就好。&lt;/li&gt;\n&lt;li&gt;☆☆☆☆☆☆☆☆☆☆☆☆ 完善了WGCNA后续分析板块：hubgene筛选和cytoscape网络图数据导出。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&#34;准备工作\&#34;&gt;准备工作&lt;/h2&gt;\n&lt;p&gt;&lt;strong&gt;首先建议所有用户折腾下这个：&lt;/strong&gt;&lt;a href=\&#34;http://www.shawnlearnbioinfo.top/2021/03/11/%E3%80%8CTBtools-Plugin%E3%80%8D%E4%BD%BF%E7%94%A8openBLAS%E6%88%96Apple-s-BLAS%E6%98%AF%E4%BD%A0%E7%9A%84R%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E9%80%9F%E5%BA%A6%E8%B5%B7%E9%A3%9E/\&#34;&gt;BLAS加速矩阵运算&lt;/a&gt;&lt;br&gt;\n简单总结就是windows先去&lt;a href=\&#34;http://pan.baidu.com/s/1gdow6sz\&#34;&gt;这里下载文件&lt;/a&gt;，然后把这些文件复制到你R路径下比如&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-r\&#34;&gt;C:\\Program Files\\R\\R-4.1\\bin\\x64\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;文件夹中，覆盖掉原来的文件。&lt;br&gt;\nmac用户根据我博客那篇文章操作就好，linux用户直接搜索linux怎么装&lt;code&gt;openblas&lt;/code&gt;，跟着操作就ok啦。如果不替换&lt;code&gt;BLAS&lt;/code&gt;，你会发现WGCNA跑得非常非常慢！因为系统自带的BLAS矩阵处理速度太拉胯了.....&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;其次，基因名称最好不要是数字，材料名称也不要以数字开头,材料名称中有&#39;-&#39;号，转换成下划线&#39;_&#39;或者&#39;.&#39;同时最好不要有各种奇葩符合，中文空格等。&lt;/strong&gt; 有几个老铁发邮件问我老跑不出来，结果发现是这些问题，建议你们自己做的时候发现&lt;code&gt;geneid&lt;/code&gt;是纯数字的时候，自己新建一个excel做一个类似这个的表，然后用后面符合规则的基因名字和样品名称替代你上传的表达矩阵中的&lt;code&gt;geneid&lt;/code&gt;和&lt;code&gt;samplename&lt;/code&gt;。具体为啥有空再讲。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/wgcna.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;界面上的所有步骤请一步一步来，不要直接跳过步骤做后面，因为后面所有的步骤都是基于前面所有结果才能运行的&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;我自己承认这个shinyapp的操作可能有点反人类，毕竟不是商业软件会考虑到易用性，是根据我的思维模式来的，所以这里也没办法，只能你适应我，做不到我适应你&lt;/strong&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;使用方法\&#34;&gt;使用方法&lt;/h2&gt;\n&lt;h3 id=\&#34;第一步-数据上传和数据清洗\&#34;&gt;第一步 数据上传和数据清洗&lt;/h3&gt;\n&lt;p&gt;手头没有数据的同学可以从&lt;a href=\&#34;https://gitee.com/shawnmagic/swtbplugin/tree/master/02.testfile/03.OneStepWGCNA\&#34;&gt;这里下载demo数据&lt;/a&gt;&lt;br&gt;\n遵循图中7个步骤，每个步骤都有默认的参数，如果你不想改动可以不动他，需要再改动。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA4.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n点击升级信息后会出现一个小进度条，显示进度，&lt;strong&gt;如果屏幕变灰了说明报错了&lt;/strong&gt; 可能的原因就是你输入的文件有问题，或者想保留的基因数大于你总基因数之类的。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA6.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;看到进化树后，恭喜你，&lt;strong&gt;你的数据清洗步骤完成了！&lt;/strong&gt;，可以点击下面的download下载nwk文件，这个文件就可以用&lt;code&gt;figtree&lt;/code&gt;，&lt;code&gt;itol&lt;/code&gt;等工具美化了，而且这个树下面有个小三角，可以随意拖动改变图的大小。如果在这个树中你发下个别离群样本，就是几个样品和其他样品分的很开,比如第二个图中的&lt;code&gt;F2_221&lt;/code&gt;，就用excel打开你的表达量矩阵，对应删掉这个样品所在的列,重新上传。同样在&lt;code&gt;trait&lt;/code&gt;表中也删掉这个样品。如果要重新上传表达量数据，刷新一下网页就好了，运行开后如果遇见也没变灰，说明报错了，此后后面的步骤就不能运行了，这时候刷新下网页也能恢复到初始状态，不过你就要从头开始了。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA11.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA10.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n接下来就可以点击导航栏的&lt;code&gt;SFT and Power Select&lt;/code&gt;进入下一步软阈值筛选步骤了！&lt;/p&gt;\n&lt;h3 id=\&#34;软阈值筛选和网络无标度鉴定\&#34;&gt;软阈值筛选和网络无标度鉴定&lt;/h3&gt;\n&lt;p&gt;选择合适的软阈值（sft 或者 power）对于构建无标度网络来说至关重要，往往无法筛选出合适软阈值的原因和你输入的表达矩阵直接相关，最常见的原因就是样品异质性，比如说不同组织（器官），差别很大的发育时期等，或者有明显批次效应的样品，比如网上down的不同测序平台，不同文献来源的RNAseq数据合并一起。具体解决方案还是看&lt;a href=\&#34;https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/faq.html\&#34;&gt;WGCNA-FAQ&lt;/a&gt; 我说的没作者明白....&lt;/p&gt;\n&lt;p&gt;选择&lt;code&gt;SFT and Power Select&lt;/code&gt;标签页（当时脑抽随便起的名字懒得改了），就是软阈值筛选的意思，我设定的默认&lt;code&gt;R2&lt;/code&gt;是0.8，不过有篇中文文献（忘记哪个了，具体大家可以知网搜一下）说R2到0.85时对应的软阈值构建的网络接近无标度网络，但是&lt;code&gt;power&lt;/code&gt;值越大，假阳性越高。所以尽量选择第一次到达0.8时对应的&lt;code&gt;power&lt;/code&gt;值。选择好&lt;code&gt;R2&lt;/code&gt;的cutoff后点击&lt;code&gt;start analysis&lt;/code&gt;就可以了，这里的R2阈值指的是让软件判断当R2等于xx是对应的&lt;code&gt;power&lt;/code&gt;是多少。如果你选择0.85，执行这个步骤后就会生成一个第一次&lt;code&gt;R2 ≥ 0.8&lt;/code&gt;时对应的&lt;code&gt;power&lt;/code&gt;值。 具体看下图2&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;1\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA9.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;该图就是点击&lt;code&gt;start analysis&lt;/code&gt;运行完成之后的界面，会返回一个图，左边是&lt;code&gt;power&lt;/code&gt;和&lt;code&gt;R2&lt;/code&gt;的关系，右边是&lt;code&gt;power&lt;/code&gt;和平均连连接度（Mean connectivity）之间的关系，&lt;code&gt;R2&lt;/code&gt;越接近1,平均连接度越接近0，网络越接近无标度。&lt;br&gt;\n这次结果我设定的&lt;code&gt;R2&lt;/code&gt;阈值是0.8，对应的&lt;code&gt;Power&lt;/code&gt;值是5，屏幕中会出现&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;The power recommended by WGCNA is : 5\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;，说明在&lt;code&gt;power&lt;/code&gt;等于5时，&lt;code&gt;R2≥0.8&lt;/code&gt;，但是我们发下你当&lt;code&gt;Power&lt;/code&gt;等于7时&lt;code&gt;R2&lt;/code&gt;可以达到0.9，这是如果我们想选择&lt;code&gt;power = 7&lt;/code&gt;只需要把&lt;code&gt;Power type&lt;/code&gt;里面改成&lt;code&gt;customized&lt;/code&gt;,然后滑动下面滑块到7就可以了，这一步是为后续&lt;code&gt;scale free estimate&lt;/code&gt;设计的。同样在&lt;code&gt;set fig size&lt;/code&gt;之后可以下载到pdf格式的图片，win下网页中预览的字体可能有点丑，渲染问题，但是下载下来就没问题了。图片的大小同样可以通过拖动三角形调节。&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;2\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA12.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;3\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA13.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;第三部分是对你选择的&lt;code&gt;power&lt;/code&gt;所构建的网络进行无标度拓扑结构检测的，看在这个&lt;code&gt;power&lt;/code&gt;值下构建的网络是否符合无标度网络。我们首先对&lt;code&gt;R2=0.8&lt;/code&gt;对应的&lt;code&gt;power = 5&lt;/code&gt;进行检测这时&lt;code&gt;Power Type&lt;/code&gt;选择&lt;code&gt;Recommended&lt;/code&gt;系统使用刚才自动生成的&lt;code&gt;power&lt;/code&gt;值5,具体无标度网络（无尺度网络）和随机网络的区别我推荐生信技能树的视频中有讲解，当然你数学学的好也能理解（数学学渣撸过）..&lt;/p&gt;\n&lt;p&gt;这里你可以测试所有Power值构成的网络，但是不推荐你这么玩，因为每次都要重新构建网络，这个速度还是很慢的，一般第一个图&lt;code&gt;R2&lt;/code&gt;最高能到多少你就检测对应的&lt;code&gt;power&lt;/code&gt;，但是不建议选择太大的&lt;code&gt;power&lt;/code&gt;，会造成假阳性，&lt;strong&gt;这个一般是在实在选择不到合适的软阈值，最高只有0.5，0.6之类的，不过这种数据一般也不会构成无标度网络，后续再去做共表达分析意义不是很大，但是这时你可以把WGCNA简单的当做类似Hclust或者K-means来用，直到表达模块分类之前都是可以用的，看你提供的基因到底可以分为多少个module，这些module内的基因是具有相似表达模式的。而后续的hubgene，调控网络就别做了，意义不大&lt;/strong&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA14.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA15.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;检测这一步必须进行，因为我写的脑残设定后续使用的power就是最后一次检测时你用的power，如果你不检测，没有power值。后续会报错。&lt;/strong&gt;&lt;/p&gt;\n&lt;p&gt;这里我们用&lt;code&gt;R2&lt;/code&gt;第一次大于0.9时对应的&lt;code&gt;power&lt;/code&gt;值7进行后续测试。&lt;/p&gt;\n&lt;h3 id=\&#34;构建模块\&#34;&gt;构建模块&lt;/h3&gt;\n&lt;p&gt;点击最上面&lt;code&gt;module-net&lt;/code&gt;标签进入模块构建步骤。这里仍旧使用一步法构建模块，而且释放了3个关键参数用来调整模块数量，并且在CJ大佬的指点下开放了&lt;code&gt;MaxBlockSize&lt;/code&gt;参数来使低内存的PC也能跑上万+基因。&lt;strong&gt;请按照下表填写这里的数字，这里只能填整数！！！！！&lt;/strong&gt; 具体我也没有测试过，可能会报内存溢出的错误，报错了就吧数字调小点再来亿遍！（鬼知道我测试这玩意重跑了多少回...）&lt;br&gt;\n&lt;strong&gt;tips:&lt;/strong&gt; 如果你的pc内存足够大，尽量把所有你选择做WGCNA的基因都放到一个&lt;code&gt;block&lt;/code&gt;中。比如你之前选择了2w个做，你的pc内存又大于等于16G，这里就选2w，如果内存溢出了就搞个1.5w也行。&lt;/p&gt;\n&lt;table&gt;\n&lt;thead&gt;\n&lt;tr&gt;\n&lt;th&gt;内存大小&lt;/th&gt;\n&lt;th&gt;数字&lt;/th&gt;\n&lt;/tr&gt;\n&lt;/thead&gt;\n&lt;tbody&gt;\n&lt;tr&gt;\n&lt;td&gt;0-4GB&lt;/td&gt;\n&lt;td&gt;5000-8000&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;4-8GB&lt;/td&gt;\n&lt;td&gt;8000-12000&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;8-16GB&lt;/td&gt;\n&lt;td&gt;12000-20000&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;16-32GB&lt;/td&gt;\n&lt;td&gt;20000-40000&lt;/td&gt;\n&lt;/tr&gt;\n&lt;tr&gt;\n&lt;td&gt;&amp;gt; 32GB&lt;/td&gt;\n&lt;td&gt;土豪你好，请随意&lt;/td&gt;\n&lt;/tr&gt;\n&lt;/tbody&gt;\n&lt;/table&gt;\n&lt;p&gt;整体步骤就是确定最小模块内基因数，确定剪枝高度（推荐不用动这俩参数）然后根据电脑内存大小选择好blocksize之后点击运行。如果模块数量太多了，可以适当提高前面两个参数。比如这次结果产生了很多模块，我们尝试把&lt;code&gt;min module size&lt;/code&gt; 提高到&lt;code&gt;50&lt;/code&gt;，把剪枝高度提高到&lt;code&gt;0.35&lt;/code&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA16.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;结果显示模块总数少了，&lt;code&gt;min Module Size&lt;/code&gt;的变大必然导致&lt;code&gt;grey&lt;/code&gt;模块基因数量的增加。同时模块数量的变少可能会导致&lt;code&gt;module-trait&lt;/code&gt;相关性变低。因为这种剪枝高度的提高可能会导致模块划分更加粗放。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA17.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;对比上面图显然模块数量变少了。第二个选项卡是邻接基因构建的相关性热图&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA18.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;第三个选项卡是一个很重要的结果，模块-基因的对应关系表&lt;/strong&gt; 可以下载下来，同样是点击download下载。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA19.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;module构建完毕之后，就是和性状，材料分类，或者其他你感兴趣的数据做相关性分析。&lt;/p&gt;\n&lt;h3 id=\&#34;模块-表型相关性分析\&#34;&gt;模块-表型相关性分析&lt;/h3&gt;\n&lt;p&gt;具体表型数据的格式参考&lt;a href=\&#34;https://gitee.com/shawnmagic/OneStepWGCNA\&#34;&gt;这个链接&lt;/a&gt; 由于代码里默认之后两列的表型数据表会转换成分类的0，1矩阵，所以想只和一个性状做关联的我写的这个shiny做不了.... 后续可能会改把。&lt;/p&gt;\n&lt;p&gt;这里可以直接跑，也可以自己选择颜色后在跑&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;4\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA21.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;我们发现demo数据中&lt;code&gt;Luminal&lt;/code&gt;和&lt;code&gt;yellow&lt;/code&gt;模块成极显著负相关和&lt;code&gt;blue&lt;/code&gt;模块成极显著正相关。所以后续会分析这个性状和对应模块的关系。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA22.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n第二个选项卡是具体的画图数据，就是邻接基因和对应性状之间的相关性及显著性值。&lt;br&gt;\n第三个选项卡非常重要，里面是基因的模块内连接度（kME），我们单纯从module角度出发kME越高，说明该基因在模块内越处于中心位置，可以被选为&lt;code&gt;hubgene&lt;/code&gt;。如果你的&lt;code&gt;module-trait&lt;/code&gt;结果不理想，也没必要非得死磕，换一个角度对所有的&lt;code&gt;module&lt;/code&gt;做富集分析，看这些模块哪个可以解释你的科学问题，对应的根据&lt;code&gt;kME&lt;/code&gt;筛选出&lt;code&gt;hubgene&lt;/code&gt;（排名前10，或者 &amp;gt; 0.9）,然后围绕&lt;code&gt;hubgene&lt;/code&gt;构建该模块的共表达网络。这时你把这个表下载下来，选择对应模块排序找出&lt;code&gt;kME&lt;/code&gt;排名靠前的基因拟定为&lt;code&gt;hubgene&lt;/code&gt;即可。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA23.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;我们从&lt;code&gt;module-trait&lt;/code&gt;找到感兴趣的模块和性状后可以进行后续&lt;code&gt;interested module&lt;/code&gt;步骤&lt;/p&gt;\n&lt;h3 id=\&#34;感兴趣模块信息挖掘\&#34;&gt;感兴趣模块信息挖掘&lt;/h3&gt;\n&lt;p&gt;首先是看基因显著性（GS gene significance）和模块特征值（MM module membership）之间的关系，如何理解基因显著性，我们在做module-trait时起始是用的该模块降维后的第一主成分或者叫邻接基因与表型做的相关，但是这个模块中有很多基因，邻接基因和表型相关不一定代表模块中所有基因都和表型相关，所以为了验证模块内基因与表型相关性，直接去做这个基因与表型的相关得到基因显著性（GS），同时我们看这个基因和邻接基因之间的关系也就是该基因模块内连接度（kME）来反映该基因的模块特征值（MM），当该基因既在模块中处于网络中心地位，又显著与性状相关，那么该基因极有可能是控制该性状的&lt;code&gt;hubgene&lt;/code&gt;。&lt;br&gt;\n操作很简单，beta版本的用户可能知道这里之前需要纯手动输入，现在不需要了，只要前面&lt;code&gt;module-trait&lt;/code&gt;的结果作完，这里相应的选项会更新。只需要点击选择即可。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA24.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;然后我们会看模块内所有基因的表达模式热图，而下部柱状图表示邻接基因的表达模式。&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;5\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA25.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;下图表示你选择的表型和其他所有模块的&lt;code&gt;GS vs MM&lt;/code&gt;关系&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA26.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;我们对感兴趣模块探索完就可以进行下一步&lt;code&gt;hubgene&lt;/code&gt;筛选过程了。&lt;/p&gt;\n&lt;h3 id=\&#34;hubgene筛选和共表达网络关系输出\&#34;&gt;hubgene筛选和共表达网络关系输出&lt;/h3&gt;\n&lt;p&gt;我们点击&lt;code&gt;hubgene&lt;/code&gt;选项卡同样是选择好&lt;code&gt;trait&lt;/code&gt;和&lt;code&gt;module&lt;/code&gt;点击开始分析&lt;/p&gt;\n&lt;p&gt;第一个选项卡给的hubgene 一般不推荐.. 这个是同过WGCNA作者的一个function实现的，但是往往感觉GS和MM都很低...&lt;/p&gt;\n&lt;p&gt;第二个选项卡是基于GS和MM筛选的&lt;br&gt;\n如果你的&lt;code&gt;module-trait&lt;/code&gt;中出现了R &amp;gt; 0.8的模块甚至0.9的模块，这时可以适当的把阈值卡严格一点，比如&lt;br&gt;\n&lt;code&gt;|GS| &amp;gt; 0.85 &amp;amp; |MM| &amp;gt; 0.9&lt;/code&gt;&lt;br&gt;\n来筛选hubgene，但是如果像本次demo数据一样，只有0.7左右或者更低，卡如此严格的阈值很可能筛选不到hubgene，这样就可以适当降低阈值。这里的阈值并没有一个金标准，当然越严格说明设计越合理，参数越准确。 如果发现这种情况，可以返回&lt;code&gt;module-net&lt;/code&gt;步骤，降低剪枝高度，缩小最小模块大小参数，让模块划分更加精细，再试一下。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA27.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;p&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA28.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n其实和你做湿实验一样，对于不同的材料，不同的仪器要灵活调整配方，仪器参数，如果老用default，很可能做不出来，这也是调参侠的日常，我们的目的是解决生物学问题，而不是死磕所谓的金标准。当然调整是否合理，这需要大量的实践和你对WGCNA背后算法的理解深度，这个无捷径可走，所以真的要做好WGCNA分析还是需要下功夫读点文献，多做几次尝试的。&lt;/p&gt;\n&lt;p&gt;最后一部分就是输出共表达网络关系，用&lt;code&gt;cytoscape&lt;/code&gt;作图了&lt;/p&gt;\n&lt;p&gt;操作也很简单，选一个阈值（建议不要大于0.1）点击开始下面就会出现edgefile 和nodefile的预览，具体权重阈值怎么选，选多少，我的建议是你自己选选看，default是0.02. 这个也没有标准。预览表出来后向下拉就可以下载nodefile 和edgefile了，然后就是cytoscape的事了，具体怎么可视化，B站教学一大堆，加油吧少年！&lt;/p&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;6\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA29.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;h2 id=\&#34;终于写完了\&#34;&gt;终于写完了！！&lt;/h2&gt;\n&lt;p&gt;后续大概率会直接写个R包，更新一些内容，希望各位及时反馈软件的问题到我的gitee issue&lt;br&gt;\n目前先在这个issue下吧 ：https://gitee.com/shawnmagic/swtbplugin/issues/I2DMHS&lt;br&gt;\n各位大佬如果有好的建议也提一下，如果发现有错误请及时提醒我，用的人多了才能更好的完善。&lt;/p&gt;\n&lt;p&gt;通过WGCNAshiny的开发我第一次深度接触shinyApp的编写，开启了我对R包编写的兴趣，并且把function打成了R package放在 https://github.com/ShawnWx2019/WGCNAShinyFun/tree/master&lt;/p&gt;\n&lt;p&gt;虽然app和package写的都很辣眼睛，但我学到了更多知识，不断突破自己。作为副产品这个小脚本小插件或许会为方便各位，这就足够了，由于本人太菜怕自己的错误导致大家的分析出错，所以这个插件还是以一个beta版本出现，这需要大家共同努力积极反馈才能使这个小玩意更加完善。&lt;/p&gt;\n&lt;p&gt;半条命已经废了...&lt;br&gt;\n没时间扯淡了... 干活去了😭&lt;br&gt;\n祝各位磕盐顺利！！&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;「TBtools-Plugin」WGCNAShiny保姆级教程&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;原本以为毕业了就起飞了，没想到，喵的比没毕业还累...&lt;br&gt;\n又鸽了仨月，这个小插件到时完善了不少，但是上次承诺的视频还是没有录。原因不说了，准备手打！ 还是写个教程为好。录视频，怕是要不知何年何月了...&lt;/p&gt;\n&lt;p&gt;对比大佬的下班时间发现，忙从来不是借口，懒才是....&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「TBtools-Plugin」WGCNAShiny保姆级教程&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;Shiny app&#34;,&#34;slug&#34;:&#34;iiHZST6a6&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/iiHZST6a6/&#34;},{&#34;name&#34;:&#34;WGCNA&#34;,&#34;slug&#34;:&#34;1gwqOzUkvu&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/1gwqOzUkvu/&#34;},{&#34;name&#34;:&#34;TBtools插件&#34;,&#34;slug&#34;:&#34;e996CuUk8&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/e996CuUk8/&#34;},{&#34;name&#34;:&#34;R&#34;,&#34;slug&#34;:&#34;G_5eRHzJub&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/G_5eRHzJub/&#34;}],&#34;date&#34;:&#34;2021-09-23 11:17:23&#34;,&#34;dateFormat&#34;:&#34;2021-09-23&#34;,&#34;feature&#34;:&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/picgo/202208250844719.jpg&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/「TBtools-Plugin」WGCNAShiny保姆级教程/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:true,&#34;stats&#34;:{&#34;text&#34;:&#34;18 min read&#34;,&#34;time&#34;:1068000,&#34;words&#34;:5057,&#34;minutes&#34;:18},&#34;description&#34;:&#34;原本以为毕业了就起飞了，没想到，喵的比没毕业还累...\n又鸽了仨月，这个小插件到时完善了不少，但是上次承诺的视频还是没有录。原因不说了，准备手打！ 还是写个教程为好。录视频，怕是要不知何年何月了...\n对比大佬的下班时间发现，忙从来不是借口...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%80%8E%E4%B9%88%E5%AE%89%E8%A3%85\&#34;&gt;怎么安装&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%9B%B4%E6%96%B0%E5%86%85%E5%AE%B9\&#34;&gt;更新内容&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C\&#34;&gt;准备工作&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\&#34;&gt;使用方法&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E6%95%B0%E6%8D%AE%E4%B8%8A%E4%BC%A0%E5%92%8C%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97\&#34;&gt;第一步 数据上传和数据清洗&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BD%AF%E9%98%88%E5%80%BC%E7%AD%9B%E9%80%89%E5%92%8C%E7%BD%91%E7%BB%9C%E6%97%A0%E6%A0%87%E5%BA%A6%E9%89%B4%E5%AE%9A\&#34;&gt;软阈值筛选和网络无标度鉴定&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%9E%84%E5%BB%BA%E6%A8%A1%E5%9D%97\&#34;&gt;构建模块&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%A8%A1%E5%9D%97-%E8%A1%A8%E5%9E%8B%E7%9B%B8%E5%85%B3%E6%80%A7%E5%88%86%E6%9E%90\&#34;&gt;模块-表型相关性分析&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%84%9F%E5%85%B4%E8%B6%A3%E6%A8%A1%E5%9D%97%E4%BF%A1%E6%81%AF%E6%8C%96%E6%8E%98\&#34;&gt;感兴趣模块信息挖掘&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#hubgene%E7%AD%9B%E9%80%89%E5%92%8C%E5%85%B1%E8%A1%A8%E8%BE%BE%E7%BD%91%E7%BB%9C%E5%85%B3%E7%B3%BB%E8%BE%93%E5%87%BA\&#34;&gt;hubgene筛选和共表达网络关系输出&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E7%BB%88%E4%BA%8E%E5%86%99%E5%AE%8C%E4%BA%86\&#34;&gt;终于写完了！！&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;失踪人口回归... 鸽了近半年，终于又要更新推文了...&lt;br&gt;\n上次说过要把WGCNA后续的模块整理完成。这个工作其实过年的时候就做的差不多了，只是没有写成插件释放。前两天啃了些资料怎么制作R包，然后把我自己搞的辣眼睛的function打包了放在github。然后这个WGCNA的插件才顺利诞生，没有难产。&lt;/p&gt;\n&lt;p&gt;...&lt;/p&gt;\n&lt;!-- more --&gt;\n&lt;h2 id=\&#34;插件安装\&#34;&gt;插件安装&lt;/h2&gt;\n&lt;p&gt;目前可以在我的&lt;a href=\&#34;https://gitee.com/shawnmagic/swtbplugin/tree/master/01.plugin\&#34;&gt;gitee仓库&lt;/a&gt;下载，后续会在高速插件商店上架，到时候直接在软件内下载即可。&lt;br&gt;\n这个插件安装比较麻烦，因为依赖太多了！！！ &lt;code&gt;shiny&lt;/code&gt;相关的，&lt;code&gt;WGCNA&lt;/code&gt;相关,&lt;code&gt;tidyvers&lt;/code&gt;家族。还有我写的那个辣眼睛的插件专用函数包&lt;a href=\&#34;https://github.com/ShawnWx2019/WGCNAShinyFun/tree/master\&#34;&gt;github地址&lt;/a&gt;。&lt;br&gt;\n如果不用插件的话，可以去&lt;a href=\&#34;https://github.com/ShawnWx2019/WGCNA-shinyApp\&#34;&gt;WGCNA-shinyApp&lt;/a&gt;下载脚本，在Rstudio中运行，或者在terminal中&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;Rscript WGCNAbyClick.v1.R\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;直接运行Shiny App&lt;/p&gt;\n&lt;h3 id=\&#34;安装时报错解决方案\&#34;&gt;安装时报错解决方案&lt;/h3&gt;\n&lt;ul&gt;\n&lt;li&gt;校园网的话大概率会出现网络问题，我在家装插件就没遇见过问题😭，但是在所里就老出错，老样子，连热点，换wifi啥的多试几次&lt;/li&gt;\n&lt;li&gt;目前发现第一次安装多少会出现点问题，但是多装几次就ok了。&lt;/li&gt;\n&lt;li&gt;xfun版本问题，静等清华镜像更新。&lt;/li&gt;\n&lt;li&gt;xxx退出状态不是0，可能是包版本和R版本的冲突。这个动手能力强的话可以自行百度解决。&lt;/li&gt;\n&lt;li&gt;【谨慎操作】各种方法都没法搞定，各种奇葩报错的话，可能是一些奇怪操作把TBtools的R环境给搞凌乱了。win用户可以进c盘下的用户文件夹，选择你当前用户名的文件夹可以看见一个&lt;code&gt;.TBtools&lt;/code&gt;的文件进去后删掉Rserver文件夹，这样你TBtools中R环境就删掉了，重新再群里下载Rserver插件重新安装，安装好后再安装其他基于R的插件。mac用户插件在&lt;code&gt;~/.TBtools/.plugin&lt;/code&gt;&lt;strong&gt;这么操作的话你之前装的基于R的插件会重新安装依赖包，所以谨慎操作&lt;/strong&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&#34;准备工作\&#34;&gt;准备工作&lt;/h2&gt;\n&lt;p&gt;建议按照&lt;a href=\&#34;http://www.shawnlearnbioinfo.top/2021/03/11/%E3%80%8CTBtools-Plugin%E3%80%8D%E4%BD%BF%E7%94%A8openBLAS%E6%88%96Apple-s-BLAS%E6%98%AF%E4%BD%A0%E7%9A%84R%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E9%80%9F%E5%BA%A6%E8%B5%B7%E9%A3%9E/\&#34;&gt;BLAS加速R矩阵计算&lt;/a&gt;帖子加速R的矩阵运算速度，可以将&lt;code&gt;WGCNA&lt;/code&gt;在计算TOM矩阵的速度提高100倍。如果不这么搞，可能你计算10000个基因的WGCNA需要等上40分钟-1小时，如果用强化版的blas，也就一分钟出结果。&lt;/p&gt;\n&lt;h2 id=\&#34;插件结构\&#34;&gt;插件结构&lt;/h2&gt;\n&lt;p&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/WGCNA%20Shiny.png\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n大体还和之前OneStepWGCNA的一样，多了后续的分析，更有助于hubgene的挖掘。&lt;/p&gt;\n&lt;h2 id=\&#34;使用方法\&#34;&gt;使用方法&lt;/h2&gt;\n&lt;p&gt;插件安装完成后运行会弹出网页。&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210616182425.jpg\&#34; alt=\&#34;\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n这个后续录个视频讲吧... 如果截屏写博客估计累死....&lt;/p&gt;\n&lt;h2 id=\&#34;最后have-fun\&#34;&gt;最后have fun&lt;/h2&gt;\n&lt;p&gt;ps： 正在鼓捣final cut pro. 后续会有详细视频讲解。目前大家先安装上玩玩吧.&lt;br&gt;\n估计有会鸽一段时间。等尘埃落定，一定在会完善他！&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;「TBtools-Plugin」用shinyApp体验调参侠的日常工作-WGCNA-shiny尝鲜版&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;失踪人口回归... 鸽了近半年，终于又要更新推文了...&lt;br&gt;\n上次说过要把WGCNA后续的模块整理完成。这个工作其实过年的时候就做的差不多了，只是没有写成插件释放。前两天啃了些资料怎么制作R包，然后把我自己搞的辣眼睛的function打包了放在github。然后这个WGCNA的插件才顺利诞生，没有难产。&lt;/p&gt;\n&lt;p&gt;...&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「TBtools-Plugin」用shinyApp体验调参侠的日常工作-WGCNA shiny尝鲜版&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;WGCNA&#34;,&#34;slug&#34;:&#34;1gwqOzUkvu&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/1gwqOzUkvu/&#34;},{&#34;name&#34;:&#34;TBtools插件&#34;,&#34;slug&#34;:&#34;e996CuUk8&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/e996CuUk8/&#34;},{&#34;name&#34;:&#34;R&#34;,&#34;slug&#34;:&#34;G_5eRHzJub&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/G_5eRHzJub/&#34;}],&#34;date&#34;:&#34;2021-06-16 16:37:28&#34;,&#34;dateFormat&#34;:&#34;2021-06-16&#34;,&#34;feature&#34;:&#34;&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/「TBtools-Plugin」用shinyApp体验调参侠的日常工作-WGCNA-shiny尝鲜版/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;3 min read&#34;,&#34;time&#34;:156000,&#34;words&#34;:741,&#34;minutes&#34;:3},&#34;description&#34;:&#34;失踪人口回归... 鸽了近半年，终于又要更新推文了...\n上次说过要把WGCNA后续的模块整理完成。这个工作其实过年的时候就做的差不多了，只是没有写成插件释放。前两天啃了些资料怎么制作R包，然后把我自己搞的辣眼睛的function打包了放在...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85\&#34;&gt;插件安装&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%AE%89%E8%A3%85%E6%97%B6%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88\&#34;&gt;安装时报错解决方案&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C\&#34;&gt;准备工作&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%8F%92%E4%BB%B6%E7%BB%93%E6%9E%84\&#34;&gt;插件结构&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\&#34;&gt;使用方法&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%9C%80%E5%90%8Ehave-fun\&#34;&gt;最后have fun&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;h2 id=\&#34;问题与思考\&#34;&gt;问题与思考&lt;/h2&gt;\n&lt;p&gt;在写&lt;strong&gt;OneStepWGCNA&lt;/strong&gt;插件的时候我就遇到过一个奇怪的现象，在Rstudio下计算TOM矩阵那一步很快，8000个基因基本是几十秒算完，但是一旦打包成插件，或者用Rscript跑脚本的时候，那一步会巨慢无比，8000个要等好几分钟。&lt;/p&gt;\n&lt;!--more--&gt;\n&lt;p&gt;当时也不知道怎么回事，就先放着，最近正在做WGCNA，想用插件跑跑，发现实在是太慢了！！！！然后就开始研究怎么回事，知道我看到terminal下卡主的步骤：&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;    TOM calculation: adjacency..\n    ..will not use multithreading.\n     Fraction of slow calculations: 0.000000\n    ..connectivity..\n    ..matrix multiplication (system BLAS)..\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;strong&gt;BLAS&lt;/strong&gt; 之前在WGCNA-FAQ中好像看到过这么个名词，于是就回去查看了一下文件。果然，当时没搞懂的，现在一下明朗了：&lt;/p&gt;\n&lt;blockquote&gt;\n&lt;p&gt;&lt;strong&gt;1 How can I make network construction execute faster?&lt;/strong&gt;&lt;br&gt;\nWhen constructing a network from a data set of a typical genomic size (i.e., between 10 000 and 30 000 genes or other variables), the most time consuming step is the calculation of Topological Overlap Matrix which involves multiplying matrices with tens of thousands of rows and columns. With a standard R distribution, this may take multiple hours even on a modern workstation since matrix multiplication in standard R does not take advantage of multi-threading (parallel execution). It is possible to speed up this process by a factor of 10-100 by installing a speed-optimized Basic Linear Algebra Subprograms (BLAS) library and compiling R against it. The process of compiling R against an enhanced BLAS library is described in the R installation and adminitration manual. Compiling R on Linux and Unix flavors is usually relatively simple and straightforward. On Mac OSX and (more so) on Windows it requires installing additional tools and packages. Although it is helpful to have administrator privileges to compile and install R, it is usually not necessary. See the R installation and adminitration manual for full details.&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;p&gt;作者大致意思是如果你想提高R的矩阵运算能力，需要使用强化版的BLAS，R默认调用的是基础班的BLAS，强化版的要比基础版的快10-100倍。但是这玩意不好装，需要从源码编译，linux下简单，但是win和mac下就比较蛋疼了。&lt;/p&gt;\n&lt;p&gt;But！ 我发现在win和mac下其实也没有那么难，虽然我也不懂什么BLAS，但是作为一个调包侠，最基础也是最重要的一个技能就是，善用各种搜索。不断的google下终于发下了mac和win下的解决方案，不需要编译，mac只需要敲两行命令，win复制几个文件就搞定了.&lt;/p&gt;\n&lt;p&gt;先发参考链接：&lt;/p&gt;\n&lt;p&gt;&lt;a href=\&#34;https://mpopov.com/blog/2019/06/04/faster-matrix-math-in-r-on-macos/\&#34;&gt;Faster matrix math in R on macOS&lt;/a&gt;&lt;/p&gt;\n&lt;p&gt;&lt;a href=\&#34;https://blog.csdn.net/a358463121/article/details/42713307\&#34;&gt;Windows使用OpenBLAS加速R语言计算速度&lt;/a&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;方法\&#34;&gt;方法&lt;/h2&gt;\n&lt;h3 id=\&#34;macos-big-sur-1121测试成功\&#34;&gt;MacOS big sur 11.2.1测试成功&lt;/h3&gt;\n&lt;p&gt;其实就是苹果系统下，调用苹果自己的BLAS，具体：&lt;a href=\&#34;https://developer.apple.com/documentation/accelerate/blas\&#34;&gt;Apple’s implementation of the Basic Linear Algebra Subprograms (BLAS).&lt;/a&gt;  参考上面大胡子老哥的操作，就是把苹果自己的BLAS文库替换掉R默认的BLAS&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;## TBtools的R安装在Rserver下，所以TBtoolsR的lib位置如下，先进入这个路径\ncd ~/.TBtools/.Plugin/Rserver/bin/macR/lib \n## 将系统Apple的BLAS软连接过来\nln -sf /System/Library/Frameworks/Accelerate.framework/Frameworks/vecLib.framework/Versions/Current/libBLAS.dylib libRblas.dylib\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;如果这个操作过后发现你的Rserver挂了，用下面的命令恢复：&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;ln -sf libRblas.0.dylib libRblas.dylib\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;虽然你测试&lt;code&gt;sessionInfo()&lt;/code&gt;发现没有和帖子里说的一样出现下面提示，但是确实是快了！反正我的Nuc8是直接风扇起飞了....感觉至少快了30倍，当然随着基因数目的增多，这个倍数也会翻倍....&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib\n&lt;/code&gt;&lt;/pre&gt;\n&lt;h3 id=\&#34;win10下测试成功\&#34;&gt;Win10下测试成功&lt;/h3&gt;\n&lt;p&gt;win10下用的是openBLAS，具体请看&lt;a href=\&#34;https://github.com/xianyi/OpenBLAS\&#34;&gt;Github-openBLAS&lt;/a&gt;&lt;/p&gt;\n&lt;p&gt;原贴实在豆瓣看到的：&lt;a href=\&#34;https://www.douban.com/note/296114898/\&#34;&gt;让R在windows下开足马力进行计算&lt;/a&gt; 后来CSDN那个老哥都给下载整理好了，直接拿来用，刚开始担心版本问题，后来看来是想多了，直接把帖子中作者整理好的网盘里的文件替换掉：&lt;strong&gt;在操作之前先把x64文件夹下的文件备份一下&lt;/strong&gt;&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-yml\&#34;&gt;## 按顺序打开：\n我的电脑 -&amp;gt; c盘 -&amp;gt; 用户 -&amp;gt; 你的用户名对应的文件夹 -&amp;gt; .TBtools -&amp;gt; .Plugin -&amp;gt; Rserver -&amp;gt; bin -&amp;gt; winR -&amp;gt; bin -&amp;gt; x64(32的对应打开32) -&amp;gt; 粘贴\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;然后就搞定了，再试试OneStepWGCNA吧，速度嗖嗖的！&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;「TBtools-Plugin」使用openBLAS或Apple-s-BLAS是你的R矩阵运算速度起飞&#34;,&#34;abstract&#34;:&#34;&lt;h2 id=\&#34;问题与思考\&#34;&gt;问题与思考&lt;/h2&gt;\n&lt;p&gt;在写&lt;strong&gt;OneStepWGCNA&lt;/strong&gt;插件的时候我就遇到过一个奇怪的现象，在Rstudio下计算TOM矩阵那一步很快，8000个基因基本是几十秒算完，但是一旦打包成插件，或者用Rscript跑脚本的时候，那一步会巨慢无比，8000个要等好几分钟。&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「TBtools Plugin」使用openBLAS或Apple&#39;s BLAS是你的R矩阵运算速度起飞 &#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;TBtools&#34;,&#34;slug&#34;:&#34;7IQ4dQhrNC&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/7IQ4dQhrNC/&#34;},{&#34;name&#34;:&#34;插件&#34;,&#34;slug&#34;:&#34;fdXt7u8Hl5&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/fdXt7u8Hl5/&#34;},{&#34;name&#34;:&#34;富集分析&#34;,&#34;slug&#34;:&#34;juU6QRjoHA&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/juU6QRjoHA/&#34;}],&#34;date&#34;:&#34;2021-03-11 20:16:14&#34;,&#34;dateFormat&#34;:&#34;2021-03-11&#34;,&#34;feature&#34;:&#34;&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/「TBtools-Plugin」使用openBLAS或Apple-s-BLAS是你的R矩阵运算速度起飞/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;5 min read&#34;,&#34;time&#34;:264000,&#34;words&#34;:1023,&#34;minutes&#34;:5},&#34;description&#34;:&#34;问题与思考\n在写OneStepWGCNA插件的时候我就遇到过一个奇怪的现象，在Rstudio下计算TOM矩阵那一步很快，8000个基因基本是几十秒算完，但是一旦打包成插件，或者用Rscript跑脚本的时候，那一步会巨慢无比，8000个要等好...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E9%97%AE%E9%A2%98%E4%B8%8E%E6%80%9D%E8%80%83\&#34;&gt;问题与思考&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%96%B9%E6%B3%95\&#34;&gt;方法&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#macos-big-sur-1121%E6%B5%8B%E8%AF%95%E6%88%90%E5%8A%9F\&#34;&gt;MacOS big sur 11.2.1测试成功&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#win10%E4%B8%8B%E6%B5%8B%E8%AF%95%E6%88%90%E5%8A%9F\&#34;&gt;Win10下测试成功&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;说出来你可能不信，我刚才用TBtools插件卡了个Bug！&lt;/p&gt;\n&lt;!--more--&gt;\n&lt;p&gt;不过CJ大佬看完我调皮操作之后，马上甩出了一个功能：&lt;code&gt;支持输入路径（文件夹）&lt;/code&gt;，因为之前只支持输入单个文件。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;额，插件使用其实很简单，这次blog主要面向插件制作用户...&lt;/strong&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;如何卡bug成功\&#34;&gt;如何卡Bug成功....&lt;/h2&gt;\n&lt;p&gt;最近在搞多组合的转录组分析，于是有了好多个富集分析的结果，虽然我以及在电脑上写好了富集分析-出图的代码流程（全程TBtools+R）写一个配置文件，一键批量做，但是之前的出图代码多少有点粗糙，我也不想再回去改R代码..毕竟我这水平，改自己的代码如同在写bug，所以就直接把出图的代码给注释掉了，后续大概有40个go和kegg富集分析结果，一个一个扔插件里跑要累死... 于是想着把bubble plot插件改一下，最后出图的时候写个循环。那么就存在一个问题。批量读入R的过程。&lt;/p&gt;\n&lt;p&gt;总结起来做TBtools的插件太简单了，如果你之前有现成的Rscript。完全可以直接写个config.txt的配置文件一打包就做成插件了...&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;我们先看下TBtools是怎么实现把你的参数可视化的。&lt;/strong&gt;&lt;br&gt;\n首先看下config.txt的配置文件&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-ruby\&#34;&gt;App=Demo R-ggplot BarPlot\nScript=script.r\n# Optional\nIcon=Icon.jpg\n# Optional\nLayout=2\n# Optional\nDemo=fpkm.xls\n# Optional\nManual=Readme.txt\n# Optional\nLink=https://github.com/CJ-Chen/TBtools/releases\n# All lines start with a &amp;quot;#&amp;quot; will be ignored.\n# an input file/paste =&amp;gt; Type=Note\nFile=Set a Tab-delimited Table\n# text input =&amp;gt; Type=Note=DefaultValue\nText=Plot Title:=R-ggplot2 BarPlot\n# yes or no options =&amp;gt; Type=Note\nCheckBox=Log-tranformed\n# multiple choice  =&amp;gt; Type=Note=Choice1,Choice2,Choice3\nChoice=Color Palette:=Set1,Set2,Set3\n# Specify a Color\nColor=Set a Color:=#e31a1c\n# Demo Directory Select Panel\nDirectory=Set a Directory\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;这个是CJ释放的最新的插件demo中的config。最全参数的。其中&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-ruby\&#34;&gt;# an input file/paste =&amp;gt; Type=Note\nFile=Set a Tab-delimited Table\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;到了TBtools界面上就是&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210202090840.jpg\&#34; alt=\&#34;File\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\nCJ也对File这个选项进行了说明，就是&lt;code&gt;输入的一个文件&lt;/code&gt;,而且存在一个&lt;code&gt;Paste input&lt;/code&gt;，虽然不太理解&lt;code&gt;Type=Note&lt;/code&gt;这种类型是什么，但是可以盲猜是&lt;strong&gt;字符&lt;/strong&gt;，比如在我GO bubble Plot插件中，在把Term Number这个变量赋值R的时候要用as.numeric转换成数字。实际上在使用R脚本的时候读入文件，&lt;code&gt;Rscript /path/file&lt;/code&gt; 这里变量所使用的也是路径，说白了就是一串字符。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;那么可以先做两个假设：&lt;/strong&gt;&lt;/p&gt;\n&lt;ol&gt;\n&lt;li&gt;CJ大佬使用了基于TBtools或者Java的骚操作把你读入的**“文件”**最后一顿操作最后生成一个专有的路径读近R... （可能产生一些中间文件，临时文件等...）&lt;/li&gt;\n&lt;li&gt;大道至简，直接把你输入的路径给了R...（感觉是这样的....）&lt;/li&gt;\n&lt;/ol&gt;\n&lt;p&gt;我感觉是第二个，这个就意味着我可以卡个bug。我把路径扔到文件选项框里，TBtools会提示你放入的不是一个文件，如果软件逻辑里面这里有个报错打断的话，后面可能就gg了，但是没有，这里估计会有个提示，但是后面的代码还是运行了。那么就实现了后面还继续跑，我把路径下包含特征字符的文件批量读近TBtools，最后批量生产气泡图。&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;Bug成功截图&lt;/strong&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/B8BFBA566496114A5916C78480FC3A98.png\&#34; alt=\&#34;Bug\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n虽然提示文件不可用，但是跑出来了，哈哈。&lt;/p&gt;\n&lt;p&gt;然后群里卖了个萌，大佬一个滑铲插件的两个新功能诞生了：&lt;/p&gt;\n&lt;p&gt;&lt;a href=\&#34;https://mp.weixin.qq.com/s/6eM4T9pEbZ8kyz9MwSH1Bg\&#34;&gt;Update | TBtools R Plugin 制备套件更新&lt;/a&gt;&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;Color，不需要在手动输入16进制颜色代码，直接调用TBtools的调色板，点击选择就可以&lt;/li&gt;\n&lt;li&gt;Directory，支持了路径输入。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&#34;插件的使用\&#34;&gt;插件的使用&lt;/h2&gt;\n&lt;p&gt;先看下新的界面：&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210202093240.jpg\&#34; alt=\&#34;Batch Enrichment\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;界面和&lt;code&gt;GO bubble Plot&lt;/code&gt;类似，file input改成了directory input。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;blockquote&gt;\n&lt;p&gt;这里把你做好的富集分析文件放到一个文件夹下，为了不必要的麻烦，这些文件中最好不要有特殊字符（比如引号，括号，空格，/ \\ |等....）而且&lt;strong&gt;这些文件名要有共同的特征&lt;/strong&gt; 比如TBtools直接输入的GO富集分析最终结果文件最后都有。 &lt;code&gt;*.final.xls&lt;/code&gt;如果有一定coding基础或者知道通配符的话可以知道，后续批量读入就是靠这些特征读取的。&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;ul&gt;\n&lt;li&gt;pattern只的就是你要批量富集的这些结果文件名共有的特征。&lt;/li&gt;\n&lt;li&gt;剩下的参数参考GO Bubble Plot那篇文章：&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;&lt;a href=\&#34;https://mp.weixin.qq.com/s/AOuVZShZXBnmKH9ie_Vplg\&#34;&gt;『TBtools-plugin』Bubble plot插件&lt;/a&gt;&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;这里吧min和max改成了TBtools新设定的Color类型。不在是之前的Text类型。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;&lt;strong&gt;如果你对TBtools插件制作感兴趣，继续看下面的内容&lt;/strong&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;配置文件和批量读入\&#34;&gt;配置文件和批量读入&lt;/h2&gt;\n&lt;p&gt;看下我的配置文件&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-ruby\&#34;&gt;App=Batch Bubble plot ## 插件显示的名字\nScript=BatchBubble.R ## 执行的脚本文件名\n# Optional\nIcon=Icon.png  ## 插件上显示图片文件名\n# Optional\nLayout=4 ## 布局\n# Optional\nManual=BatchBubble.html ## 操作手册\n# Optional\nLink=https://gitee.com/shawnmagic/swtbplugin ## 你想放入的链接\n# All lines start with a &amp;quot;#&amp;quot; will be ignored.\n# input dir\n## 最后一个等号后面的值相当于默认值（default）会直接显示在插件上。\nDirectory=Set a Directory ## Directory就是设定插件上输入路径的方框 对应脚本中的第一个变量\n## Pattern\nText=pattern:=*.final.xls ## 这里是输入参数Pattern这个参数，对应第二个变量\n## go terms num \nText=Term Number:=30 ## 展示的GOterm个数 对应第三个变量\n# multiple choice  =&amp;gt; Type=Note=Choice1,Choice2,Choice3\nChoice=Input Data Form:=TBtools_GO,TBtools_KEGG,customized ## 富集文件类型选项 第四个变量\nChoice=Graph Type:=Bubble,bar ##图片类型选项 第5个变量\n# color\nColor=min:=#e41a1c ## 最小值颜色 第6个选项\nColor=max:=#3300ff ## 最大值颜色 第7个选项\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;就这么多，这样就把插件的布局做好了。再看下对应脚本内的设置&lt;/p&gt;\n&lt;p&gt;&lt;strong&gt;参数设置和调试信息&lt;/strong&gt;&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;##########################################################\n#     prj:  Enrichment result Enrichment Visualization\n#     date: 06 Jan 2021\n#     Author: Shawn Wang\n##########################################################\noptions(stringsAsFactors = F)\noptions(&amp;quot;repos&amp;quot; = c(CRAN=&amp;quot;https://mirrors.tuna.tsinghua.edu.cn/CRAN/&amp;quot;))\nargv &amp;lt;- commandArgs(TRUE)\nexpfile &amp;lt;- argv[1] # &#39;file &#39;\npattern &amp;lt;- argv[2]\nnum &amp;lt;- argv[3] #  &amp;quot;how many go terms do you want to show&amp;quot;\nnum = as.numeric(num)\nDataF &amp;lt;- argv[4] # &amp;quot;data formate&amp;quot;\nGtype &amp;lt;- argv[5] # &#39;barplot or Bubble&#39;\ncolormin &amp;lt;- argv[6] # &#39;pvalue color&#39;\ncolormax &amp;lt;- argv[7] # &#39;pvalue color&#39;\n# print(Gtype)\nif (!require(&#39;ggplot2&#39;)) install.packages(&#39;ggplot2&#39;)\nif (!require(&#39;dplyr&#39;)) install.packages(&#39;dplyr&#39;)\nif (!require(&#39;stringr&#39;)) install.packages(&#39;stringr&#39;)\nif (!require(&#39;magrittr&#39;)) install.packages(&#39;magrittr&#39;)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(magrittr)\nlibrary(stringr)\n## test set\n# setwd(&amp;quot;~/03.project/01.Heterosis/03.process/02.Enrichment/01.GOEnrich/03.graph/&amp;quot;)\n# expfile = &amp;quot;~/03.project/01.Heterosis/03.process/02.Enrichment/01.GOEnrich/03.graph/&amp;quot;\n# pattern = &amp;quot;*.DEList.xls.GO.Enrichment.final.xls&amp;quot;\n# num = 30\n# DataF = &amp;quot;TBtools_GO&amp;quot;\n# Gtype = &amp;quot;Bubble&amp;quot;\n# colormin = &amp;quot;red&amp;quot;\n# colormax = &amp;quot;blue&amp;quot;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;ul&gt;\n&lt;li&gt;\n&lt;p&gt;开始的两个&lt;code&gt;option&lt;/code&gt;是我的习惯... 根据自己习惯来&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;变量设置，可以对应回&lt;code&gt;config&lt;/code&gt;，config中的参数顺序和这里面argv中变量的顺序要保持一致。最好按顺序来，防止把自己搞懵逼了。&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;argv &amp;lt;- commandArgs(TRUE)\nexpfile &amp;lt;- argv[1] # &#39;file &#39;\npattern &amp;lt;- argv[2]\nnum &amp;lt;- argv[3] #  &amp;quot;how many go terms do you want to show&amp;quot;\nnum = as.numeric(num)\nDataF &amp;lt;- argv[4] # &amp;quot;data formate&amp;quot;\nGtype &amp;lt;- argv[5] # &#39;barplot or Bubble&#39;\ncolormin &amp;lt;- argv[6] # &#39;pvalue color&#39;\ncolormax &amp;lt;- argv[7] # &#39;pvalue color&#39;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;下面是检查有没有你需要的包，没有的话安装&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;if (!require(&#39;ggplot2&#39;)) install.packages(&#39;ggplot2&#39;)\nif (!require(&#39;dplyr&#39;)) install.packages(&#39;dplyr&#39;)\nif (!require(&#39;stringr&#39;)) install.packages(&#39;stringr&#39;)\nif (!require(&#39;magrittr&#39;)) install.packages(&#39;magrittr&#39;)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(magrittr)\nlibrary(stringr)\n&lt;/code&gt;&lt;/pre&gt;\n&lt;ul&gt;\n&lt;li&gt;调试，我有个习惯，写完脚本会先拿示例数据在Rstudio中调试一下能不能跑明白，所以我保留了调试信息，最后记得（cmd+shift+c或者ctrl+shift+c把这段代码注释掉...）;然后会用Rscript 在终端下跑一遍...最后再打包，不然打包好，再拆了改代码特别蛋疼....&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;&lt;strong&gt;最后放一个批量读入文件的function&lt;/strong&gt;&lt;br&gt;\n当然大家有自己熟悉的方式，这里只是提供一个我习惯的解法...&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;## readfile\nBatchReadTable = function(path, pattern,sep = &amp;quot;\\t&amp;quot;, header = TRUE, quote = &amp;quot;&amp;quot;, stringsAsFactors = FALSE){\n  fileNames.raw &amp;lt;- dir(path, pattern = pattern) \n  filePath.raw &amp;lt;- sapply(fileNames.raw, function(x){ \n    paste(path,x,sep=&#39;/&#39;)})\n  data.raw &amp;lt;- lapply(filePath.raw, function(x){\n    read.table(x, sep = sep,header = header,quote = quote,stringsAsFactors = FALSE)}) \n  x = list(Name = fileNames.raw,\n           file = data.raw)\n  return(x)\n}\n## 批量读入文件\nraw = BatchReadTable(path = expfile,pattern = pattern, quote = NULL)\n## 输出\nrawdata = raw$file ## 输入富集分析文件\nrawname = gsub(pattern,&amp;quot;&amp;quot;,raw$Name) ## 去掉共有的Pattern就是每个文件剩下独有的特征字符串.这些rawnames会作为最后输出文件的特征\n&lt;/code&gt;&lt;/pre&gt;\n&lt;ul&gt;\n&lt;li&gt;\n&lt;p&gt;function最后返回一个&lt;code&gt;list&lt;/code&gt;, &lt;code&gt;list&lt;/code&gt;包含两个内容&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;Name&lt;/code&gt;是文件名，后续会用&lt;code&gt;gsub&lt;/code&gt;把你输入的&lt;code&gt;pattern&lt;/code&gt;去掉，留下每个文件独有的特征字符串。这个字符串最后会被用作命名输出文件，或者图片的title等。&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;file&lt;/code&gt;也是一个list，里面包含了读入的文件。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;下面是输出的选项，分了3部分，第一部分根据你选择画图，第二部分根据最长的GO term或者KEGG Pathway确定输出图片的宽度，根据你挑选的输出的GO term数量确定高度生成图片的size。最后一部分输出图片。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;这里对list的取索引的操作就是&lt;code&gt;[[i]]&lt;/code&gt;&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-R\&#34;&gt;for (i in 1:length(rawdata)) {\n  x = rawdata[[i]]\n  y = rawname[i]\n  colnames(x)\n  if (DataF == &amp;quot;TBtools_GO&amp;quot;) {\n    out = GOBubblePlot(dataraw = x,\n                       num = num,\n                       name = y,\n                       colormin = colormin,\n                       colormax = colormax,\n                       Gtype = Gtype)\n  } else if (DataF == &amp;quot;TBtools_KEGG&amp;quot;) {\n    out = KEGGBubblePlot(dataraw = x,\n                         num = num,\n                         name = y,\n                         colormin = colormin,\n                         colormax = colormax,\n                         Gtype = Gtype)\n  } else if (DataF == &amp;quot;customized&amp;quot;) {\n    out = customBubblePlot(dataraw = x,\n                           num = num,\n                           name = y,\n                           colormin = colormin,\n                           colormax = colormax,\n                           Gtype = Gtype)\n  }\n  \n  figsize = function(y,num){\n    z = data.frame(ID = y,\n                   wc = 0)\n    \n    for (i in 1:nrow(z)) {\n      z[i,2] = nchar(as.character(z$ID[i]))\n    }\n    maxwc = max(z$wc)\n    if (maxwc &amp;lt;= 50) {\n      figwidth = 10\n    } else if (maxwc &amp;gt;50 &amp;amp; maxwc &amp;lt;100) {\n      figwidth = 12\n    } else {\n      figwidth = 15+(maxwc-50)/25\n    }\n    if (nrow(z) &amp;lt;= 30) {\n      fighight = 10\n    } else if (nrow(z) &amp;gt;30 &amp;amp; nrow(z) &amp;lt;60) {\n      fighight = 12\n    } else {\n      fighight = nrow(z)/4\n    }\n    size = list(figwidth = figwidth,\n                fighight = fighight)\n    return(size)\n  }\n  size = figsize(y = out$y,\n                 num = num)\n  \n  ggsave(filename = paste(rawname[i],DataF,Gtype,&amp;quot;plot.pdf&amp;quot;,sep = &amp;quot;.&amp;quot;),\n         plot = out$p,\n         width=size$figwidth,\n         height=size$fighight,\n         dpi = 300)\n  \n}\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;感觉工作就这么多啦，也挺简单的。菜鸟先抛转引玉，&lt;br&gt;\n&lt;strong&gt;坐等各位大佬贡献更牛批的TBtools插件！&lt;/strong&gt;&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;「TBtools-Plugin」批量生成气泡图&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;说出来你可能不信，我刚才用TBtools插件卡了个Bug！&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「TBtools Plugin」批量生成气泡图&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;TBtools&#34;,&#34;slug&#34;:&#34;7IQ4dQhrNC&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/7IQ4dQhrNC/&#34;},{&#34;name&#34;:&#34;插件&#34;,&#34;slug&#34;:&#34;fdXt7u8Hl5&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/fdXt7u8Hl5/&#34;},{&#34;name&#34;:&#34;富集分析&#34;,&#34;slug&#34;:&#34;juU6QRjoHA&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/juU6QRjoHA/&#34;}],&#34;date&#34;:&#34;2021-02-02 08:40:59&#34;,&#34;dateFormat&#34;:&#34;2021-02-02&#34;,&#34;feature&#34;:&#34;https://shawnwx2019.github.io/post-images/「TBtools-Plugin」批量生成气泡图.jpg&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/「TBtools-Plugin」批量生成气泡图/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;11 min read&#34;,&#34;time&#34;:652000,&#34;words&#34;:2518,&#34;minutes&#34;:11},&#34;description&#34;:&#34;说出来你可能不信，我刚才用TBtools插件卡了个Bug！\n\n不过CJ大佬看完我调皮操作之后，马上甩出了一个功能：支持输入路径（文件夹），因为之前只支持输入单个文件。\n额，插件使用其实很简单，这次blog主要面向插件制作用户...\n如何卡B...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%A6%82%E4%BD%95%E5%8D%A1bug%E6%88%90%E5%8A%9F\&#34;&gt;如何卡Bug成功....&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8\&#34;&gt;插件的使用&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E6%89%B9%E9%87%8F%E8%AF%BB%E5%85%A5\&#34;&gt;配置文件和批量读入&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;h2 id=\&#34;写在前面的废话\&#34;&gt;写在前面的废话&lt;/h2&gt;\n&lt;p&gt;之前有老铁在群里问kegg的气泡图能不能整，其实基于TBtools-kegg富集结果的气泡图代码很早就撸好了，无非就是GO气泡图代码中数据清洗的时候改改df索引位置。后面一毛一样。&lt;/p&gt;\n&lt;p&gt;大家好像还是比较喜欢这种视觉冲击力强的图，确实在投文章的时候也能会加分。所以后来慢慢从搬运代码到&lt;a href=\&#34;https://www.jianshu.com/p/59428e69da05\&#34;&gt;自己用ggplot2实现&lt;/a&gt;，最终是山寨了一下...&lt;/p&gt;\n&lt;p&gt;当然，如果要原汁原味的bubble plot还是推荐用Y叔的&lt;a href=\&#34;http://bioconductor.org/packages/release/bioc/html/clusterProfiler.html\&#34;&gt;clusterProfiler&lt;/a&gt;包。这里放一个我之前基于所里测&lt;a href=\&#34;https://gitee.com/shawnmagic/TM1_CRIv2_OrgDb\&#34;&gt;陆地棉TM-1v2的OrgDB&lt;/a&gt;,喜欢折腾的小伙伴可以玩一下，不过kegg目前无解，kegg数据库里收录的陆地棉的注释实在是太老了。&lt;/p&gt;\n&lt;!--more--&gt;\n&lt;h2 id=\&#34;参数\&#34;&gt;参数&lt;/h2&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;1\&#34;&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/Bubble%20plot.png\&#34; alt=\&#34;参数\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;这次干脆一勺烩了，柱状图，气泡图，基于GOplot那几个弦图，热图数据清洗起来有点麻烦，应该近期不会整....&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210126073636.jpg\&#34; alt=\&#34;界面\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;\n&lt;p&gt;input file 输入文件：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;如果是TBtools 生成的GO和KEGG结果，直接把输出的文件拖进来就好。注意如果GO富集分析想分别按照GOterm类别可视化，需要输入padj校正过的那个文件。&lt;/li&gt;\n&lt;li&gt;如果自己定制的（customized）需要按照下表整理：&lt;strong&gt;表头写啥无所谓，顺序一定要正确！&lt;/strong&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;| GO_Name                                                                                      | Gene_ratio  | HitsGenesCountsInSelectedSet | corrected p-value(BH method) |&lt;br&gt;\n|----------------------------------------------------------------------------------------------|-------------|------------------------------|------------------------------|&lt;br&gt;\n| steroid dehydrogenase activity, acting on the CH-OH group of donors, NAD or NADP as acceptor | 0.004023409 | 11                           | 0.496511055                  |&lt;br&gt;\n| quinone binding                                                                              | 0.004754938 | 13                           | 0.281163809                  |&lt;br&gt;\n| indole-3-acetic acid amido synthetase activity                                               | 0.002560351 | 7                            | 0.394598487                  |&lt;br&gt;\n| peptide receptor activity                                                                    | 0.001828822 | 5                            | 0.441252581                  |&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;Term Number: 你想展示的GO term 或者KEGG Pathway数量，有时候富集分析结果会非常多，几百个结果全画出来不可能，这里筛选的条件就是Qvalue排名前&lt;code&gt;Term number&lt;/code&gt;的数量。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;Input Data Form： 输入数据的格式，有三个选项&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;TBtools_GO&lt;/li&gt;\n&lt;li&gt;TBtools_KEGG&lt;/li&gt;\n&lt;li&gt;customized&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;Graph type: 你想画什么图&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;Bubble， 气泡图&lt;/li&gt;\n&lt;li&gt;bar， 柱状图&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;min/max： 颜色是由Qvalue的大小定义的，越小越显著，这里是颜色变化范围的定义，从min到max渐变。&lt;/p&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;p&gt;output file label： 输出文件标签，为了区分你做的不同结果。&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&#34;使用方法\&#34;&gt;使用方法&lt;/h2&gt;\n&lt;p&gt;这个.... 拖进去，选好参数，点点点，然后看结果...&lt;/p&gt;\n&lt;p&gt;颜色方面...推荐下TBtools的colorPicker在&lt;/p&gt;\n&lt;pre&gt;&lt;code&gt;Graphics -&amp;gt; color palette -&amp;gt;colorpicker\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/20210126090047.jpg\&#34; alt=\&#34;color picker\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n选中一个颜色后复制类似&lt;code&gt;#fb8072&lt;/code&gt;这种颜色代码，关闭&lt;code&gt;colorpicker&lt;/code&gt;，粘贴到&lt;code&gt;min&lt;/code&gt;或者&lt;code&gt;max&lt;/code&gt;中。&lt;/p&gt;\n&lt;h2 id=\&#34;多图预警\&#34;&gt;多图预警&lt;/h2&gt;\n&lt;p&gt;&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBkeggbubble.jpg\&#34; alt=\&#34;kegg bubble\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBkeggBar.jpg\&#34; alt=\&#34;kegg bar\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBGObubble.jpg\&#34; alt=\&#34;GO bubble\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/TBGObar.jpg\&#34; alt=\&#34;GO bar\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/csbar.jpg\&#34; alt=\&#34;cs bubble\&#34; loading=\&#34;lazy\&#34;&gt;&lt;br&gt;\n&lt;img src=\&#34;https://shawnmagic-1257599720.cos.ap-chengdu.myqcloud.com/cbub.jpg\&#34; alt=\&#34;cs bar\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;下期预告\&#34;&gt;下期预告&lt;/h2&gt;\n&lt;p&gt;下期会增加一个OneStepWGCNA的伴侣插件，有朋友反映如果取不到合适的&lt;code&gt;power&lt;/code&gt;官网提供的那个经验&lt;code&gt;power&lt;/code&gt;过于智障，想自己选择&lt;code&gt;power&lt;/code&gt;构建...那么初步想法是把第一步跑完的结果写一个Rdata出来，然后扔到伴侣插件调参，包括&lt;code&gt;power&lt;/code&gt;,&lt;code&gt;最小module size&lt;/code&gt;，用新的&lt;code&gt;traitdata&lt;/code&gt;和&lt;code&gt;datExpr&lt;/code&gt;关联，还有后续关注的模块的&lt;code&gt;GS MM，hub&lt;/code&gt;基因等...&lt;/p&gt;\n&lt;p&gt;毕竟不能辱没了我调包狗，调参侠的名头...&lt;/p&gt;\n&#34;,&#34;fileName&#34;:&#34;「TBtools-Plugin」Bubble-Plot升级版-TBtools插件&#34;,&#34;abstract&#34;:&#34;&lt;h2 id=\&#34;写在前面的废话\&#34;&gt;写在前面的废话&lt;/h2&gt;\n&lt;p&gt;之前有老铁在群里问kegg的气泡图能不能整，其实基于TBtools-kegg富集结果的气泡图代码很早就撸好了，无非就是GO气泡图代码中数据清洗的时候改改df索引位置。后面一毛一样。&lt;/p&gt;\n&lt;p&gt;大家好像还是比较喜欢这种视觉冲击力强的图，确实在投文章的时候也能会加分。所以后来慢慢从搬运代码到&lt;a href=\&#34;https://www.jianshu.com/p/59428e69da05\&#34;&gt;自己用ggplot2实现&lt;/a&gt;，最终是山寨了一下...&lt;/p&gt;\n&lt;p&gt;当然，如果要原汁原味的bubble plot还是推荐用Y叔的&lt;a href=\&#34;http://bioconductor.org/packages/release/bioc/html/clusterProfiler.html\&#34;&gt;clusterProfiler&lt;/a&gt;包。这里放一个我之前基于所里测&lt;a href=\&#34;https://gitee.com/shawnmagic/TM1_CRIv2_OrgDb\&#34;&gt;陆地棉TM-1v2的OrgDB&lt;/a&gt;,喜欢折腾的小伙伴可以玩一下，不过kegg目前无解，kegg数据库里收录的陆地棉的注释实在是太老了。&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「TBtools-Plugin」Bubble Plot升级版-TBtools插件&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;TBtools&#34;,&#34;slug&#34;:&#34;7IQ4dQhrNC&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/7IQ4dQhrNC/&#34;},{&#34;name&#34;:&#34;插件&#34;,&#34;slug&#34;:&#34;fdXt7u8Hl5&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/fdXt7u8Hl5/&#34;},{&#34;name&#34;:&#34;富集分析&#34;,&#34;slug&#34;:&#34;juU6QRjoHA&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/juU6QRjoHA/&#34;}],&#34;date&#34;:&#34;2021-01-26 10:15:17&#34;,&#34;dateFormat&#34;:&#34;2021-01-26&#34;,&#34;feature&#34;:&#34;&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/「TBtools-Plugin」Bubble-Plot升级版-TBtools插件/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;3 min read&#34;,&#34;time&#34;:171000,&#34;words&#34;:753,&#34;minutes&#34;:3},&#34;description&#34;:&#34;写在前面的废话\n之前有老铁在群里问kegg的气泡图能不能整，其实基于TBtools-kegg富集结果的气泡图代码很早就撸好了，无非就是GO气泡图代码中数据清洗的时候改改df索引位置。后面一毛一样。\n大家好像还是比较喜欢这种视觉冲击力强的图，...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2%E7%9A%84%E5%BA%9F%E8%AF%9D\&#34;&gt;写在前面的废话&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%8F%82%E6%95%B0\&#34;&gt;参数&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\&#34;&gt;使用方法&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%A4%9A%E5%9B%BE%E9%A2%84%E8%AD%A6\&#34;&gt;多图预警&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E4%B8%8B%E6%9C%9F%E9%A2%84%E5%91%8A\&#34;&gt;下期预告&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;},{&#34;content&#34;:&#34;&lt;p&gt;在基因组进化分析和基因家族分析中少不了对同源基因（homologs）的分析,当然同源基因又分为直系同源(orthologs)和旁系同源(paralogs)，如图：&lt;/p&gt;\n&lt;!-- more --&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;1\&#34;&gt;&lt;img src=\&#34;http://bitesizebio.s3.amazonaws.com/wp-content/uploads/2015/11/05153902/Homology.png\&#34; alt=\&#34;homologs\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;p&gt;...&lt;/p&gt;\n&lt;p&gt;&lt;font color = grey size =2&gt; Photo courtesy of:  Popo H. Liao (Own work), via Wikimedia Commons&lt;/font&gt;&lt;br&gt;\n如何区分请看：&lt;a href=\&#34;https://bitesizebio.com/26762/homology-terminology-never-say-wrong-word/\&#34;&gt;Homology Terminology: Never Say the Wrong Word Again&lt;/a&gt;&lt;!--more--&gt;&lt;/p&gt;\n&lt;h2 id=\&#34;名词解释\&#34;&gt;名词解释&lt;/h2&gt;\n&lt;figure data-type=\&#34;image\&#34; tabindex=\&#34;2\&#34;&gt;&lt;img src=\&#34;https://github.com/davidemms/OrthoFinder/raw/master/assets/Orthogroups_Orthologues_Paralogues.png\&#34; alt=\&#34;Orthologues, Orthogroups &amp;amp; Paralogues\&#34; loading=\&#34;lazy\&#34;&gt;&lt;/figure&gt;\n&lt;blockquote&gt;\n&lt;p&gt;Orthologs are pairs of genes that descended from a single gene in the last common ancestor (LCA) of two species (Figure 2A &amp;amp; B). An orthogroup is the extension of the concept of orthology to groups of species. An orthogroup is the group of genes descended from a single gene in the LCA of a group of species (Figure 2A).&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;blockquote&gt;\n&lt;p&gt;The example Figure 2 contains an orthogroup from three species, human, mouse and chicken. Human and mouse each have one gene in this orthogroup (HuA and MoA, respectively) while chicken has two genes (ChA1 and ChA2). The human and mouse genes are a pair of genes descended from a single gene in the last common ancestor of the two species, therefore these two genes are orthologs and there is a one-to-one orthology relationship between the two genes.&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;blockquote&gt;\n&lt;p&gt;The two chicken genes arose from a gene duplication event after the lineage leading to chicken split from the lineage leading to human and mouse. As gene duplication events give rise to paralogs, ChA1 and ChA2 are paralogs of each other. However, both chicken genes are descended from a single gene in the last common ancestor of the three species. Therefore, both chicken genes are orthologs of the human gene and the mouse gene. Although they are orthologs, sometimes these complex relationships are referred to as co-orthologs (e.g. ChA1 and ChA2 are co-orthologs of HuA). In this case there is a many-to-one orthology relationship between the chicken genes and the human gene. There are only three kinds of orthology relationships one-to-one, many-to-one, and many-to-many. All of these relationships are identified by OrthoFinder.&lt;/p&gt;\n&lt;/blockquote&gt;\n&lt;p&gt;&lt;strong&gt;Speak English, 说人话:&lt;/strong&gt;  👴🏻、🐭和🐔有一个最近的共同的祖先（Last common ancestor，LCA），这个&lt;strong&gt;LCA&lt;/strong&gt;在进化中分化出了👴🏻，🐭和🐔，LCA的一个基因&lt;font color = red&gt;&lt;strong&gt;A&lt;/strong&gt;&lt;/font&gt;在🐔中复制了一次变成&lt;font color=green&gt;ChA1、ChA2&lt;/font&gt;,但是在哺乳动物中没有变，👴🏻中&lt;font color = orange&gt;HuA&lt;/font&gt;和🐭中&lt;font color = blue&gt;MoA&lt;/font&gt;，来掰扯下这4个基因的关系：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;直系同源: 可以理解为从老祖宗LCA那传下来的，压根没变就是figure2B中&lt;font color = orange&gt;HuA&lt;/font&gt;和&lt;font color = blue&gt;MoA&lt;/font&gt;，&lt;font color = orange&gt;HuA&lt;/font&gt;分别和&lt;font color=green&gt;ChA1、ChA2&lt;/font&gt;，&lt;font color = blue&gt;MoA&lt;/font&gt;分别和&lt;font color=green&gt;ChA1、ChA2&lt;/font&gt;。&lt;/li&gt;\n&lt;li&gt;直系同源组： 这4个基因并称为直系同源组（有点基因家族的意思）&lt;/li&gt;\n&lt;li&gt;旁系同源：在🐔中这个基因出现了复制事件，那么🐔里面的这两个基因：&lt;font color=green&gt;ChA1、ChA2&lt;/font&gt;称作旁系同源。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h2 id=\&#34;软件介绍\&#34;&gt;软件介绍&lt;/h2&gt;\n&lt;p&gt;奉上软件地址：&lt;a href=\&#34;https://github.com/davidemms/OrthoFinder\&#34;&gt;davidemms/OrthoFinder&lt;/a&gt;&lt;br&gt;\n官方分析流程：&lt;a href=\&#34;https://davidemms.github.io/orthofinder_tutorials/exploring-orthofinders-results.html\&#34;&gt;OrthoFinder Tutorials&lt;/a&gt;&lt;/p&gt;\n&lt;h3 id=\&#34;orthofinder-能干啥\&#34;&gt;orthofinder 能干啥&lt;/h3&gt;\n&lt;p&gt;对于比较基因组学（comparative genomics）&lt;code&gt;OrthoFinder&lt;/code&gt;是一个快速的，准确的以及全面的平台，作用：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;找到同源群组orthogroups &lt;sup class=\&#34;footnote-ref\&#34;&gt;&lt;a href=\&#34;#fn1\&#34; id=\&#34;fnref1\&#34;&gt;[1]&lt;/a&gt;&lt;/sup&gt;（不知道怎么翻译合适）&lt;/li&gt;\n&lt;li&gt;找到同源基因（orthologs）；&lt;/li&gt;\n&lt;li&gt;对orthogroups构建有根树&lt;/li&gt;\n&lt;li&gt;鉴定基因复制时间（gene duplication events）&lt;sup class=\&#34;footnote-ref\&#34;&gt;&lt;a href=\&#34;#fn2\&#34; id=\&#34;fnref2\&#34;&gt;[2]&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;\n&lt;li&gt;构建物种树。&lt;/li&gt;\n&lt;li&gt;将基因的复制时间对应到物种树上。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;h3 id=\&#34;软件安装\&#34;&gt;软件安装&lt;/h3&gt;\n&lt;p&gt;总结为2点：&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;linux和Mac用conda：这里要注意&lt;code&gt;orthofinder&lt;/code&gt;的&lt;code&gt;Python&lt;/code&gt;环境为python2，我之前在mac上装在&lt;code&gt;python3&lt;/code&gt;的&lt;code&gt;env&lt;/code&gt;下结果出现了各种奇葩报错，什么&lt;code&gt;diamond&lt;/code&gt;不在环境变量，python出错等，装到python2下面立马就消停了...&lt;/li&gt;\n&lt;/ul&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;## 最好给orthoFinder建一个新的conda environment。\nconda creat -n orthofinder orthofinder=2.27\n&lt;/code&gt;&lt;/pre&gt;\n&lt;ul&gt;\n&lt;li&gt;windows 最好用docker, 没试过，不评价，官方给的教程应该没问题。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-docker\&#34;&gt;docker pull davidemms/orthofinder\ndocker run -it --rm davidemms/orthofinder orthofinder -h\ndocker run --ulimit nofile=1000000:1000000 -it --rm -v /full/path/to/fastas:/input:Z davidemms/orthofinder orthofinder -f /input\n&lt;/code&gt;&lt;/pre&gt;\n&lt;h2 id=\&#34;软件使用\&#34;&gt;软件使用&lt;/h2&gt;\n&lt;p&gt;官方给的命令也很简单,只需要把你要做的物种的蛋白序列放到一个空路径下，然后：&lt;/p&gt;\n&lt;pre&gt;&lt;code class=\&#34;language-bash\&#34;&gt;OrthoFinder/orthofinder -f OrthoFinder/ExampleDataset &amp;amp;\n&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;这个只是初级阶段的用法，还有大量的参数可以调。&lt;/p&gt;\n&lt;h2 id=\&#34;分析过程\&#34;&gt;分析过程&lt;/h2&gt;\n&lt;p&gt;自己尝试看了下没看懂，这里引用&lt;a href=\&#34;https://www.jianshu.com/p/16e0bbb2ba19\&#34;&gt;徐州更hoptop&lt;/a&gt;的博文&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;BLAST all-vs-all搜索。使用BLASTP以evalue=10e-3进行搜索，寻找潜在的同源基因。(除了BLAST, 还可以选择DIAMOND和MMSeq2)&lt;/li&gt;\n&lt;li&gt;基于基因长度和系统发育距离对BLAST bit得分进行标准化。&lt;/li&gt;\n&lt;li&gt;使用RBNHs确定同源组序列性相似度的阈值&lt;/li&gt;\n&lt;li&gt;构建直系同源组图(orthogroup graph)，用作MCL的输入&lt;/li&gt;\n&lt;li&gt;使用MCL对基因进行聚类，划分直系同源组&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;OrthoFinder2在OrthoFinder的基础上增加了物种系统发育树的构建，流程如下&lt;/p&gt;\n&lt;ul&gt;\n&lt;li&gt;为每个直系同源组构建基因系统发育树&lt;/li&gt;\n&lt;li&gt;使用STAG算法从无根基因树上构建无根物种树&lt;/li&gt;\n&lt;li&gt;使用STRIDE算法构建有根物种树&lt;/li&gt;\n&lt;li&gt;有根物种树进一步辅助构建有根基因树。&lt;/li&gt;\n&lt;/ul&gt;\n&lt;p&gt;--未完待续...&lt;/p&gt;\n&lt;hr class=\&#34;footnotes-sep\&#34;&gt;\n&lt;section class=\&#34;footnotes\&#34;&gt;\n&lt;ol class=\&#34;footnotes-list\&#34;&gt;\n&lt;li id=\&#34;fn1\&#34; class=\&#34;footnote-item\&#34;&gt;&lt;p&gt;&lt;a href=\&#34;https://github.com/davidemms/OrthoFinder#orthogroups-orthologs--paralogs\&#34;&gt;What are orthogroups, orthologs &amp;amp; paralogs?&lt;/a&gt; &lt;a href=\&#34;#fnref1\&#34; class=\&#34;footnote-backref\&#34;&gt;↩︎&lt;/a&gt;&lt;/p&gt;\n&lt;/li&gt;\n&lt;li id=\&#34;fn2\&#34; class=\&#34;footnote-item\&#34;&gt;&lt;p&gt;&lt;a href=\&#34;https://en.wikipedia.org/wiki/Gene_duplication\&#34;&gt;Gene duplication&lt;/a&gt; &lt;a href=\&#34;#fnref2\&#34; class=\&#34;footnote-backref\&#34;&gt;↩︎&lt;/a&gt;&lt;/p&gt;\n&lt;/li&gt;\n&lt;/ol&gt;\n&lt;/section&gt;\n&#34;,&#34;fileName&#34;:&#34;「Comparative-Genomics」Orthofinder官方文件解读&#34;,&#34;abstract&#34;:&#34;&lt;p&gt;在基因组进化分析和基因家族分析中少不了对同源基因（homologs）的分析,当然同源基因又分为直系同源(orthologs)和旁系同源(paralogs)，如图：&lt;/p&gt;\n&#34;,&#34;title&#34;:&#34;「Comparative-Genomics」官方文档解读&#34;,&#34;tags&#34;:[{&#34;name&#34;:&#34;orthofinder&#34;,&#34;slug&#34;:&#34;6gwYvvd5G0&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/6gwYvvd5G0/&#34;},{&#34;name&#34;:&#34;Mac&#34;,&#34;slug&#34;:&#34;vfComFSggu&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/vfComFSggu/&#34;},{&#34;name&#34;:&#34;bioinformatics&#34;,&#34;slug&#34;:&#34;-7KH0PNTVn&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/-7KH0PNTVn/&#34;},{&#34;name&#34;:&#34;基因家族&#34;,&#34;slug&#34;:&#34;LdICAmrgCC&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/LdICAmrgCC/&#34;},{&#34;name&#34;:&#34;进化&#34;,&#34;slug&#34;:&#34;IULlUUCusE&#34;,&#34;used&#34;:true,&#34;link&#34;:&#34;https://shawnwx2019.github.io/IULlUUCusE/&#34;}],&#34;date&#34;:&#34;2020-03-06 07:23:39&#34;,&#34;dateFormat&#34;:&#34;2020-03-06&#34;,&#34;feature&#34;:&#34;&#34;,&#34;link&#34;:&#34;https://shawnwx2019.github.io/「Comparative-Genomics」Orthofinder官方文件解读/&#34;,&#34;hideInList&#34;:false,&#34;isTop&#34;:false,&#34;stats&#34;:{&#34;text&#34;:&#34;5 min read&#34;,&#34;time&#34;:292000,&#34;words&#34;:1092,&#34;minutes&#34;:5},&#34;description&#34;:&#34;在基因组进化分析和基因家族分析中少不了对同源基因（homologs）的分析,当然同源基因又分为直系同源(orthologs)和旁系同源(paralogs)，如图：\n\n\n...\n Photo courtesy of:  Popo H. Lia...&#34;,&#34;toc&#34;:&#34;&lt;ul class=\&#34;markdownIt-TOC\&#34;&gt;\n&lt;li&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A\&#34;&gt;名词解释&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BD%AF%E4%BB%B6%E4%BB%8B%E7%BB%8D\&#34;&gt;软件介绍&lt;/a&gt;\n&lt;ul&gt;\n&lt;li&gt;&lt;a href=\&#34;#orthofinder-%E8%83%BD%E5%B9%B2%E5%95%A5\&#34;&gt;orthofinder 能干啥&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85\&#34;&gt;软件安装&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E8%BD%AF%E4%BB%B6%E4%BD%BF%E7%94%A8\&#34;&gt;软件使用&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\&#34;#%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B\&#34;&gt;分析过程&lt;/a&gt;&lt;/li&gt;\n&lt;/ul&gt;\n&lt;/li&gt;\n&lt;/ul&gt;\n&#34;}]";
  // var json = escape.substr(1, escape.length - 2);
  // var datas = json.split(',');
  // for (let i=0; i < datas.length; i++) {
  //   let item = datas[i];
  //   let attrs = item.split('34;:&#34')
  //   debugger
  //   console.log(datas[i])
  // }
  let escapeMap = new Map();
  escapeMap.set('&#34;', '"');
  escapeMap.set('&gt;', '>');
  escapeMap.set('&#39;', "'");
  escapeMap.set('&lt;', '<');
  escapeMap.set('&quot;', '"');
  escapeMap.set('&amp;', '&');
</script> -->

<script src="/media/js/mouse/peace.js"></script>


</html>